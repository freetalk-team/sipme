/*! For license information please see app.min.js.LICENSE.txt */
import*as __WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_app_js_97f2d8e8__ from"https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";import*as __WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_auth_js_2c88a4ff__ from"https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";import*as __WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_database_js_4fdd5b49__ from"https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";import*as __WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_storage_js_e5eea211__ from"https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";import*as __WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_messaging_js_6c0776cf__ from"https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js";var __webpack_modules__={867:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{E:()=>GameMixin});const kStat={win:0,loss:0,score:{win:0,loss:0},total:{win:0,loss:0}},kGameStateDS="games",GameMixin={initGame(){this.game={states:new Map,games:new Map,async params(e){let t=this.games.get(e);return t||(t=await Game.load(e),this.games.set(e,t)),t.params},async load(e,t,s){if(!e){const e=app.dsFilter(kGameStateDS,(e=>!!e.state&&!e.own));return await e.ls()}const i="string"==typeof e?e:e.id;return this.current=await this.loadState(i,t,s),this.current},async loadState(e,t,s){let i,n=e;t?i=`${e}@${t}`:(i=e,[n,t]=e.split("@"));let o,a,r,c=!1,l=this.states.get(i);if(l?s&&(l.state=l.game.init(s),c=s):(o=this.games.get(t),o||(o=await Game.load(t),this.games.set(t,o)),[a,r,c]=await loadGameState(i,o,s),l={game:o,state:a,stat:r},this.states.set(i,l)),!l.state){if(!s)throw console.error("GAME failed to execute move"),new Error("GAME non-existing state without 'params'");l.state={}}return o=l.game,a=l.state,r=l.stat,{uid:n,state:a,id:i,type:t,stat:r,game:o,invite:c}},async reload(e){const t=this.states.get(e);t&&t.game.reset(t.state,!0)},async onmove(e,t){const s=t.id,{params:i}=t;console.debug("ON MOVE prams:",i);const n="string"==typeof e?e:e.id;let{id:o,game:a,state:r,stat:c}=await this.loadState(n,s,i);t.last;const[l,d]=a.onmove(r,t.last);if(!t.last)return;const h=!1,u={own:h,params:i,stat:kStat,user:n,type:s},p={own:h,state:r};updateStat(c,l,d)&&(p.stat=c,p.own=!1,l&&(p.state=void 0,p.last=void 0,p.ts=Date.seconds()));const m=app.ds("games");return await m.update(o,p,u),[{id:o,user:e,type:s,own:h,stat:c,state:r,game:a},l]},async send(e,t,s){const{id:i,state:n,uid:o,type:a,stat:r,game:c,invite:l}=this.current,d={id:i,stat:kStat,user:o,type:a},h={last:e,state:n,own:!0};updateStat(r,t,s)&&(h.stat=r,t&&(h.state=void 0,h.own=void 0,h.last=void 0,h.ts=Date.seconds()));const u=app.ds(kGameStateDS);await u.update(i,h,d);const p={_type:"game",id:a,last:e};l&&(delete this.current.invite,p.params=l),await app.sendMessage(o,p);const m={id:i,user:await app.loadContact(o),type:a,score:s,stat:r,own:!0,ts:Date.seconds()};app.emit(t?"gameover":"gamemove",m)},async resign(e,t){let{id:s,uid:i,type:n,stat:o}=await this.loadState(e,t);this.states.delete(s),o.loss++;const a=app.ds(kGameStateDS);await a.update(s,{state:null,stat:o},{user:i,type:n}),app.emit("gameover",{id:s,user:i,type:n,stat:o})}}},async handleGameMessage(e){try{const t=e.msg;console.debug("GAME onmove:",t);const[s,i,n]=await this.game.onmove(e.user,t);i?this.emit("gameover",s):this.emit("gamemove",s)}catch(e){console.error("Failed to handle game move",e)}}};function updateStat(e,t,s){if(!s)return!1;let i;return s<0?(e.score.loss-=s,e.total.loss-=s,i="loss"):(e.score.win+=s,e.total.win+=s,i="win"),t&&(e.last={...e.score},e.score.win=0,e.score.loss=0,e[i]++),!0}async function loadGameState(e,t,s){const i=app.ds(kGameStateDS);if(s)return[t.init(s),kStat,s];const n=await i.get(e);return n?[n.state,n.stat]:[t.init(s),kStat,s]}class Game{#e={};#t=1;#s=()=>({});#i=()=>{};#n=()=>{};#o=()=>{};#a=()=>"";get ratio(){return this.#t}get params(){return this.#e}constructor(code){const ratio=e=>"number"==typeof e?this.#t=e:isNaN(e)?1:parseFloat(e),option=(e,t)=>this.#e[e]=t,init=e=>this.#s=e,render=e=>this.#i=e,onclick=e=>this.#n=e,onmove=e=>this.#o=e,param=()=>{},short=e=>this.#a=e;eval(code)}init(e){return this.#s(e)}render(e,t){this.#i.bind(e)(t)}onclick(e,t,s){t.width=s.canvas.width,t.height=s.canvas.height;const i=this.#n.bind(e)(t);return!!i&&(this.render(e,s),Array.isArray(i)&&app.game.send(...i),i.isover)}onmove(e,t){return this.#o.bind(e)(t)}static async load(e){const t=await app.cache.load("game",e);return new Game(t)}}},278:()=>{function e(e){let t,s=!1;"object"==typeof e?(t=e.content,s=!0):t=e;let i,n,o,a=t;i=t.match(/^(!\[[^\]]+\]\((.*)\))?[ \n]*(.*)/),i&&(o=i[2],a=i[3],i=a.match(/^(#{1,6}[ ]+(.*))?[ \n]*(.*)/),i&&(n=i[2],a=i[3]||n));const r=Object.deleteUndefined({title:n,thumb:o});return s&&Object.assign(e,r),r.content=a,r}Object.assign(window,{toMarkdown:function(e,t=e.type){if("string"==typeof e)return e.replace(/"(.*?)"/g,((e,t)=>`***${t}***`)).replace(/\((.*?)\)/g,((e,t)=>`(*${t}*)`));switch(t){case"files":return function(e){let t,s="### Files share\n\n|name|size||\n|:-----|:-:|:-:|";for(const i of e)t=i.link,s+=`\n|${i.name}|${fileX.formatSize(i.size)}|[link](${t})|`;return s}(e);case"task":return function(e){let t="### "+e.title||0;if(e.user){t+=`\n<font size="2">*Author:* **${e.user.name}**</font>`}if(e.ts){t+=`\n<font size="2">*Created: ${new Date(1e3*e.ts).formatTimeDate()}*</font>`}e.md&&(t+="\n\n"+e.md.replace(/^#{1,3}/gm,"####"));return t}(e);case"article":return function(e){let t,s="";e.channel&&(t="string"==typeof e.channel?e.channel:e.channel.id);e.thumb&&(s+=`![thumb alt <](${e.thumb})\n`);if(s+="### "+e.title+"\n\n",!e.logo){const t=new URL(e.link);e.logo=t.origin+"/favicon.ico"}let i=e.date;if(!i){i=new Date(e.time||1e3*e.ts).formatTimeDate()}return s+=`![logo alt <](${e.logo}) <font size="3">[link](${e.link}) *${i}*</font>`,s}(e)}return null},fromMarkdown:function(t,s){return"post"===s?e(t):{content:t}},getPostInfo:e})},831:()=>{function e(e,t={},s=!0){return console.log("HTTPX Sending request:",e),new Promise(((i,n)=>{const o=new XMLHttpRequest;o.onreadystatechange=()=>{if(o.readyState===XMLHttpRequest.DONE){var e=o.status;if(0===e||e>=200&&e<400){const t=o.getResponseHeader("content-type");let n=o.responseText;if(s)/application\/json/.test(t)&&(n=JSON.parse(n)),console.log("XHTTP response:",e,t);else{const e=o.response;console.log("RESPONSE:",typeof e,e);const t=inflate(e,{to:"string"});n=JSON.parse(t)}i(n)}else n(e)}},o.open("GET",e,!0),s||(o.responseType="arraybuffer");for(const[e,s]of Object.entries(t))o.setRequestHeader(e,s);o.send()}))}function t(e,t={},s={}){return new Promise(((i,n)=>{const o=new XMLHttpRequest,a=t.constructor===Object;let r,c=t;o.onreadystatechange=()=>{if(o.readyState===XMLHttpRequest.DONE){var e=o.status;if(0===e||e>=200&&e<400){let e;if(o.responseText){const t=o.getResponseHeader("content-type");e=/application\/json/.test(t)?JSON.parse(o.responseText):o.responseText}i(e)}else n(e)}},o.open("POST",e,!0),a?(r="application/json",c=JSON.stringify(t)):t instanceof Blob?r="application/octet-stream":FormData,r&&o.setRequestHeader("content-type",r);for(const[e,t]of Object.entries(s))o.setRequestHeader(e,t);o.send(c)}))}window.ajax={get:e,post:t,delete:function(e,t={}){return new Promise(((s,i)=>{const n=new XMLHttpRequest;n.onreadystatechange=()=>{if(n.readyState===XMLHttpRequest.DONE){var e=n.status;0===e||e>=200&&e<400?s():i(e)}},n.open("DELETE",e,!0);for(const[e,s]of Object.entries(t))n.setRequestHeader(e,s);n.send()}))},fetch:async function(e,t){const s=await fetch(e,t);return"application/json"==s.headers.get("content-type")?await s.json():s.text()},submit:function(e,t){const s=document.createElement("form");s.method="POST",s.action=e;for(const[e,i]of Object.entries(t)){const t=document.createElement("input");t.type="hidden",t.name=e,t.value=i,s.appendChild(t)}document.body.appendChild(s),s.submit(),document.body.removeChild(s)},token:s=>({get:(t,i={})=>(i.authorization="Bearer "+s,e(t,i)),post:(e,i,n={})=>(n.authorization="Bearer "+s,t(e,i,n)),async post2(e,t,i={}){i.authorization="Bearer "+s,i["content-type"]="application/json";return(await fetch(e,{method:"POST",headers:i,body:JSON.stringify(t),mode:"no-cors"})).json()},options:(e,t={})=>(t.authorization="Bearer "+s,t.Origin=window.location.origin,function(e,t={}){return new Promise(((s,i)=>{const n=new XMLHttpRequest;n.onreadystatechange=()=>{if(n.readyState===XMLHttpRequest.DONE){var e=n.status;0===e||e>=200&&e<400?s():i(e)}},n.open("OPTIONS",e,!0);for(const[e,s]of Object.entries(t))n.setRequestHeader(e,s);n.send()}))}(e,t))})}},910:()=>{function e(e){const t=atob(e),s=new Uint8Array(t.length);return Array.prototype.forEach.call(t,((e,t)=>s[t]=e.charCodeAt(0))),s}window.aes={generateKey:function(e=256){return console.log("# Generating new AES key ..."),crypto.subtle.generateKey({name:"AES-CTR",length:e},!0,["encrypt","decrypt"])},importKey:function(t,s="jwt",i=!0){let n;switch(s){case"raw":n=e(t);break;case"jwt":n=JSON.parse(atob(t))}return crypto.subtle.importKey(s,n,{name:"AES-CTR"},i,["encrypt","decrypt"])},exportKey:async function(e){const t=await crypto.subtle.exportKey("jwk",e);return btoa(JSON.stringify(t))},encrypt:async function(t,s,i){const n=new TextEncoder,o="string"==typeof i?e(i):i;let a=n.encode(t);const r=await crypto.subtle.encrypt({name:"aes-ctr",counter:o,length:64},s,a);return c=r,btoa(String.fromCharCode.apply(null,c instanceof Uint8Array?c:new Uint8Array(c)));var c},decrypt:async function(t,s,i){const n=e(t),o="string"==typeof i?e(i):i;let a=await crypto.subtle.decrypt({name:"aes-ctr",counter:o,length:64},s,n);return(new TextDecoder).decode(a)}}},788:()=>{const e=86400;(new Date).getTimezoneOffset();function t(e){return e instanceof Date?e:"string"==typeof e?new Date(e):new Date(1e3*e)}Date.prototype.toLocalDateString=function(e,t){if("bg"===e){let e="";if(t.weekday){const s=["Неделя","Понеделник","Вторник","Сряда","Четвъртък","Петък","Събота"],i=this.getDay();e+="short"==t.weekday?s[i].slice(3)+".":s[i],e+=" "}if(t.day&&(e+=this.getDate().toString(),e+=" "),t.month)if("numeric"==t.month);else{const s=["Януари","Февруари","Март","Април","Май","Юни","Юли","Август","Септември","Октомври","Ноември","Декември"][this.getMonth()];e+="short"==t.month&&s.length>4?s.slice(0,3)+".":s,e+=" "}return e.trimEnd()}return this.toLocaleDateString(`${e}-${e.toUpperCase()}`,t)},Date.prototype.toLocalDateStringShort=function(e,t={weekday:"long",month:"short",day:"numeric"}){return this.toLocalDateString(e,t)},Date.prototype.seconds=function(){return Date.toSeconds(this.getTime())},Date.prototype.age=function(e=new Date){return e.getFullYear()-this.getFullYear()},Date.seconds=function(e=1){const t=(new Date).seconds();return Math.floor(t/e)*e},Date.toSeconds=function(e=new Date){return"string"==typeof e&&(e=new Date(e)),e instanceof Date&&(e=e.getTime()),Math.floor(e/1e3)},Date.fromSeconds=function(e){return new Date(1e3*e)},Date.daysToSeconds=function(e){return 24*e*60*60},Date.secondsToString=function(e){return new Date(1e3*e).toISOString()},Date.prototype.offsetFrom=function(e=Date.now(),t=""){const s=Math.floor((e-this.getTime())/1e3);let i,n;return s<3600?(i=Math.floor((s+40)/60),n=0==i?"now":`${i} min`):s<86400?(i=Math.floor(s/3600),n=`${i} h`):s<604800?(i=Math.floor(s/86400),n=`${i} d`):(t=null,n=this.toLocaleDateString("en-US",{month:"short",day:"numeric"})),t&&(n+=" "+t),n},Date.timeElapsed=function(e,t=Date.now()){return new Date(e).offsetFrom(t)},Date.timeElapsedLong=function(e,t=Date.now()){return new Date(e).offsetFrom(t,"ago")},Date.secondsElapsed=function(e=Date.seconds(),t=Date.now()){return Date.timeElapsed(1e3*e,t)},Date.prototype.formatTimeDate=function(){return`${("0"+this.getHours()).slice(-2)}:${("0"+this.getMinutes()).slice(-2)} ${this.toLocaleString("default",{month:"short"})} ${("0"+this.getDate()).slice(-2)}`},Date.formatTimeDate=function(e=Date.seconds()){return t(e).formatTimeDate()},Date.formatDate=function(e=Date.seconds()){return t(e).toDateString()},Date.formatDateShort=function(e=Date.seconds()){return t(e).toLocalDateStringShort("en")},Date.formatDateShorter=function(e=Date.seconds()){return t(e).toLocalDateStringShort("en",{month:"short",day:"numeric"})},Date.todayUTC=function(e=new Date){"number"==typeof e&&(e=new Date(1e3*e));const t=e.setUTCHours(0,0,0,0);return Date.toSeconds(t)},Date.today=function(e=new Date){"number"==typeof e&&(e=new Date(1e3*e));const t=e.setHours(0,0,0,0);return Date.toSeconds(t)},Date.dayStartSeconds=function(t=Date.seconds(),s=0){const i=60*(new Date).getTimezoneOffset();return Math.floor(t/e)*e+s*e+i},Date.tomorrowSeconds=function(){return Date.dayStartSeconds(Date.seconds(),1)},Date.days=function(e,t=Date.now()){return new Date(t+24*e*3600*1e3)}},976:()=>{function e(e,t,s={}){return new Promise(((i,n)=>e.getDirectory(t,s,i,n)))}function t(e){return new Promise(((t,s)=>{e.createReader().readEntries((function(e){t(e)}))}))}function s(e,t){return new Promise(((s,i)=>{e.getFile(t,{},(function(e){e.file((function(e){const t=new FileReader;t.file=e,s(t)}),i)}),i)}))}function i(e,t=0,s){return new Promise(((i,n)=>{e.onloadend=function(e){i(this.result)},e.onerror=n;let o=e.file;s&&(o=o.slice(t,t+s)),e.readAsArrayBuffer(o)}))}function n(e){return new Promise(((t,s)=>e.remove(t,s)))}window.fs={init:function(e=1073741824){return new Promise(((t,s)=>{navigator.webkitPersistentStorage.requestQuota(e,(e=>webkitRequestFileSystem(window.PERSISTENT,e,t,s)))}))},ls:t,directory:e,rmdir:async function(s,i){const o=await e(s,i),a=await t(o);for(const e of a)await n(e);return n(o)},save:async function(e,t){const n=await showSaveFilePicker(),o=await n.createWritable(),a=await s(e,t),r=await i(a);await o.write(r),await o.close()},writer:function(e,t,s=!1){return new Promise(((i,n)=>{e.getFile(t,{create:!0,exclusive:s},(function(e){e.createWriter((function(e){i(e)}))}),n)}))},write:function(e,t){return new Promise(((s,i)=>{e.onwriteend=s,e.onerror=i;const n=new Blob(Array.isArray(t)?t:[t]);e.write(n)}))},truncate:function(e,t){return new Promise(((s,i)=>{e.onwriteend=s,e.onerror=i,e.truncate(t)}))},read:i,reader:s,readFile:async function(e,t){return i(await s(e,t))},getFile:function(e,t){return new Promise(((s,i)=>{e.getFile(t,{},(function(e){e.file((e=>s(e)),i)}),i)}))},metadata:function(e){return new Promise(((t,s)=>{e.getMetadata(t,s)}))},dump:function(e){return new Promise(((t,s)=>{e.createReader().readEntries((function(e){t(e.map((e=>e.name)))}))}))}}},265:()=>{Object.assign(window,{AsyncFunction:Object.getPrototypeOf((async function(){})).constructor,GeneratorFunction:Object.getPrototypeOf((function*(){})).constructor,AsyncGeneratorFunction:Object.getPrototypeOf((async function*(){})).constructor})},537:()=>{Object.toArray=function(e,t=function(){}){const s=[];if(e)for(const[i,n]of Object.entries(e))n.id=n.id||i,t(n),s.push(n);return s},Object.fromArray=function(e){const t={};for(const s of e)t[s.id]=s;return t},Object.empty=function(e){return 0===Object.keys(e).length&&e.constructor===Object},Object.deleteUndefined=function(e){return Object.keys(e).forEach((t=>void 0===e[t]&&delete e[t])),e},Object.flipEntries=function(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>[t,e])))},Object.hash=function(e){let t=4294967279;for(const s of Object.values(e))"object"==typeof s?t^=Array.isArray(s)?Array.hash(s):Object.hash(s):"string"==typeof s?t^=s.hashCode():"number"==typeof s?t^=s:"boolean"==typeof s&&(t^=s?1549556828:3318072773);return t>>>0},Object.normalize=function(e){for(const[t,s]of Object.entries(e))if("object"==typeof s)if(Array.isArray(s)){const i=s.filter((e=>!!e));for(const e of i)Object.normalize(e);e[t]=i}else Object.keys(s).length>0?Object.normalize(s):delete e[s]},Object.merge=function(e,t="info"){const s=e=>{e[t]&&(Object.assign(e,e[t]),delete e[t])};if(Array.isArray(e))for(const t of e)s(t);else s(e);return e},Array.hash=function(e){let t=3326489;for(const s of e)"object"==typeof s?t^=Array.isArray(s)?Array.hash(s):Object.hash(s):"string"==typeof s?t^=s.hashCode():"number"==typeof s?t^=s:"boolean"==typeof s&&(t^=s?1549556828:3318072773);return t>>>0},Array.prototype.unique=function(){return this.filter(((e,t,s)=>s.indexOf(e)===t))},Array.prototype.uniqueId=function(e="id"){return Array.from(new Set(this.map((t=>t[e])))).map((t=>this.find((s=>s[e]==t))))},Array.prototype.rotate=function(e){return e%=this.length,this.slice(e,this.length).concat(this.slice(0,e))},Array.prototype.sum=function(){return this.reduce(((e,t)=>e+t),0)},Array.prototype.avg=function(){return this.sum()/this.length},Array.prototype.avgi=function(){return Math.floor(this.avg())},Array.prototype.max=function(e=-2147483648){return this.reduce(((e,t)=>e>t?e:t),e)},Array.prototype.min=function(e=4294967295){return this.reduce(((e,t)=>e<t?e:t),e)},Array.prototype.sortTimestamp=function(){this.sort(((e,t)=>t.ts-e.ts))}},345:()=>{String.prototype.hashCode=function(){for(var e=5381,t=this.length;t;)e=33*e^this.charCodeAt(--t);return e>>>0},String.prototype.hashCodeSigned=function(){return this.hashCode()|0},String.prototype.hashHex=function(){return this.hashCode().toString(16)},String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.splitByCapital=function(){return this.split(/(?=[A-Z])/).join(" ").replace(/(?<=\b[A-Z]) (?=[A-Z]\b)/g,"")},String.prototype.toHex=function(){let e="";for(let t=0;t<this.length;t++)e+=this.charCodeAt(t).toString(16);return e},String.prototype.toByteArray=function(){const e=[];for(let t=0;t<this.length;t+=1){const s=this.charCodeAt(t);if(s<128)e.push(s);else if(s<2048)e.push(192|s>>6,128|63&s);else if(s<55296||s>=57344)e.push(224|s>>12,128|s>>6&63,128|63&s);else{if(t+=1,!(t<this.length))break;{const i=65536+(1023&s)<<10|1023&this.charCodeAt(t);e.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i)}}}return e},String.prototype.eval=function(ctx,..._){const exp=this.valueOf();return function(..._){return eval(exp)}.call(ctx,..._)},String.prototype.evalCtx=function(e,t=!0){const s=e,i={};let n=this;const o=n.match(/^var\s+(.*?);(.*)$/);if(o){o[1].split(",").map((e=>e.trim())).map((e=>e.split("=").map((e=>e.trim())))).map((([e,t])=>i[e]=t.evalCtx(s))),n=o[2]}let a=Object.keys(s).concat(Object.keys(i)),r=Object.values(s).concat(Object.values(i)),c=n.replace(/(\.?)(val|len|arr|sum|avgi?|max)\((.*?)\)/,((e,t,s,i)=>{if(t)return e;switch(s){case"len":return`(typeof ${i} == "undefined" ? 0 : (Array.isArray(${i}) ? ${i}.length : 0))`;case"arr":return`(typeof ${i} == "undefined" ? [] : (Array.isArray(${i}) ? ${i} : []))`;case"sum":case"avg":case"avgi":case"max":return`(typeof ${i} == "undefined" ? 0 : (Array.isArray(${i}) ? ${i}.${s}() : 0))`}return`(typeof ${i} == "undefined" ? null : ${i})`}));return Function(...a,t?"return "+c:c)(...r)},String.prototype.replacex=function(e,...t){return this.replace(/\{\{(.+?)\}\}/g,((s,i)=>{const n=i.replace(/len\((.*?)\)/,((s,i)=>{const n=i.match(/_([0-9])/);if(n){const e=parseInt(n[1]);return t[e]?t[e].length:0}return i.eval(e,...t).length})).replace(/_([0-9])/g,((e,t)=>`_[${t}]`||"")).eval(e,...t);return null!=n?n:""}))},String.prototype.localeCompareNocase=function(e){return this.localeCompare(e,"en",{sensitivity:"base"})},String.prototype.startsWithNocase=function(e){return this.toLowerCase().startsWith(e.toLowerCase())},String.prototype.reverse=function(){let e="";for(let t=this.length-1;t>=0;t--)e+=this[t];return e},String.prototype.removeComments=function(e="c"){return this.replace(/\/\*[\s\S]*?\*\/|(?<=[^:])\/\/.*|^\/\/.*/g,"").trim()},String.prototype.align=function(e,t=!0){const s=e>=this.length?" ".repeat(e-this.length):"";return t?this.concat(s):s.concat(this)},String.prototype.display=function(){return this.replace(/[_-]+/g," ").splitByCapital().capitalizeFirstLetter()};const kExpressionPrefix="$>";String.ExpressionPrefix=kExpressionPrefix,String.prototype.isExpression=function(){return this.startsWith(kExpressionPrefix)},String.prototype.expressionValue=function(){return this.slice(kExpressionPrefix.length)},String.prototype.evalExpression=function(e){return this.expressionValue().trim().evalCtx(e)},String.prototype.makeExpression=function(){return kExpressionPrefix+this},String.prototype.matchIndex=function(){const[,e,,t]=this.match(/^([A-z]+)(\[(\d+)\])?$/);return[e,t?parseInt(t):void 0]},String.longestCommonPrefix=function(e){let t=e.reduce(((e,t)=>t.length<e.length?t:e));for(let s of e)for(;s.slice(0,t.length)!=t;)t=t.slice(0,-1);return t},String.evalCtx=function(e,...t){exp.join("\n").evalCtx(e.false)},String.prototype.isEmail=function(){return/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(this.toLowerCase())},String.prototype.getInitials=function(){const e=this.split(/[ _-]/);return e.length>1?e[0][0]+e[1][0]:this[0]+this[1]},String.isString=function(e){return"string"==typeof e},String.prototype.splitLast=function(e){let t,s=this.valueOf();const i=this.lastIndexOf(e);return-1!=i&&(s=this.slice(0,i),t=this.slice(i+e.length)),[s,t]},String.sort=function(e,t){return e<t?-1:e>t?1:0}},830:()=>{const e=(e,t)=>{const s=t[0]-e[0],i=t[1]-e[1];return{length:Math.sqrt(Math.pow(s,2)+Math.pow(i,2)),angle:Math.atan2(i,s)}};var t,s;const i=(e=>(t,s,i)=>{const[n,o]=e(i[s-1],i[s-2],t),[a,r]=e(t,i[s-1],i[s+1],!0);return`C ${n},${o} ${a},${r} ${t[0]},${t[1]}`})((t=e,s=.2,(e,i,n,o)=>{const a=t(i||e,n||e),r=a.angle+(o?Math.PI:0),c=a.length*s;return[e[0]+Math.cos(r)*c,e[1]+Math.sin(r)*c]}));const n={width:400,marginX:10,marginY:15,maxLinesY:10},o={create(e,t,s,o={...n}){o.height||(o.height=3*o.width/4);const{width:a,height:r,marginX:c,marginY:l}=o,d=a-2*c-16,h=r-2*l-22,u=c+16,p=l;let m,g;const f=t.map((e=>e.min())),w=t.map((e=>e.max()));m=f.min(),g=w.max();let y=g-m;const b=[1,2,5,10,25,50,100,200,500,1e3];let v=0;for(;10*b[v]<y;++v);y/b[v]>10&&v++;const k=b[v];g+=k-g%k,m-=m%k;const _=function(e,t,s,i,n,o){const a=s-t,r=o/a,c=Math.ceil(a/i)+1,l=[],d=e.length,h=Math.floor(n/d);for(let t=0,s=0;s<e.length;++s,t+=h)l.push({x1:t,x2:t,y1:0,y2:o});for(let e=t,s=0;s<c;e+=i,++s){const e=o-s*i*r;l.push({x1:0,x2:n,y1:e,y2:e})}return console.debug("GRID points:",l),l}(e,m,g,k,d,h);_.map((e=>(e.x1+=u,e.x2+=u,e.y1+=p,e.y2+=p)));const x=t.map((t=>function(e,t,s,i,n,o){const a=e.length,r=n,c=Math.floor(r/a),l=o,d=o/(i-s),h=[];let u;console.debug("Values:",s,i);for(let i=0,n=0;n<e.length;++n,i+=c)u=l-(t[n]-s)*d,h.push([i,u]);return h}(e,t,m,g,d,h)));x.map((e=>e.map((e=>(e[0]+=u,e[1]+=p))))),x.map((e=>e.path=((e,t)=>e.reduce(((e,s,i,n)=>0===i?`M ${s[0]},${s[1]}`:`${e} ${t(s,i,n)}`),""))(e,i)));const C=[];for(let e=m;e<=g;e+=k)C.push(e);const E=h/(C.length-1),S={width:a,height:r,labels:e,series:t,grid:_,points:x,values:C,labelX:{start:u,step:d/e.length,Y:r-22},labelY:{start:r-22-p,step:-E,X:-16}};return dom.renderTemplate(s,S)},render(e,t,s){const i=(new Date).getDay(),n=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].rotate(i);return this.create(n,t,"weekly-chart").innerHTML}};window.chart=o},489:()=>{function e(e){return!!e.match(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/)}function t(e){return!!e.match(/(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))/)}function s(s){return e(s)||t(s)}window.validate={host:function(e){return function(e){return!!e.match(/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+$/)}(e)||s(e)},domain:function(e){return/^((?:(?:(?:\w[\.\-\+]?)*)\w)+)((?:(?:(?:\w[\.\-\+]?){0,62})\w)+)\.(\w{2,6})$/.test(e)},ipv4:e,ipv6:t,ip:s,url:function(e){return/^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[/?#]\S*)?$/i.test(e)},email:function(e){return/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(e.toLowerCase())},tags:function(e){return/^[a-z]{3,}( [a-z]{3,}){0,4}$/.test(e)},slug:function(e){return/^[a-z][0-9a-z]{3,11}$/.test(e)}}},650:e=>{function t(e){return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}))}t.keys=()=>[],t.resolve=t,t.id=650,e.exports=t},753:()=>{CodeMirror.commands.tabAndIndentMarkdownList=function(e){var t=e.listSelections()[0].head;if(!1!==e.getStateAfter(t.line).list)e.execCommand("indentMore");else if(e.options.indentWithTabs)e.execCommand("insertTab");else{var s=Array(e.options.tabSize+1).join(" ");e.replaceSelection(s)}},CodeMirror.commands.shiftTabAndUnindentMarkdownList=function(e){var t=e.listSelections()[0].head;if(!1!==e.getStateAfter(t.line).list)e.execCommand("indentLess");else if(e.options.indentWithTabs)e.execCommand("insertTab");else{var s=Array(e.options.tabSize+1).join(" ");e.replaceSelection(s)}}}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var s=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](s,s.exports,__webpack_require__),s.exports}__webpack_require__.d=(e,t)=>{for(var s in t)__webpack_require__.o(t,s)&&!__webpack_require__.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};(()=>{__webpack_require__.d(__webpack_exports__,{g:()=>Xm});var t={};__webpack_require__.r(t),__webpack_require__.d(t,{Lexer:()=>P,Parser:()=>B,Renderer:()=>R,Slugger:()=>z,TextRenderer:()=>$,Tokenizer:()=>j,defaults:()=>n,getDefaults:()=>i,lexer:()=>G,marked:()=>N,options:()=>F,parse:()=>V,parseInline:()=>W,parser:()=>X,setOptions:()=>q,use:()=>U,walkTokens:()=>H});var s={};__webpack_require__.r(s),__webpack_require__.d(s,{render:()=>se,renderContainer:()=>ie,renderHtml:()=>ee,renderText:()=>ne});__webpack_require__(278),__webpack_require__(345),__webpack_require__(788),__webpack_require__(265),__webpack_require__(537);function i(){return{baseUrl:null,breaks:!1,extensions:null,gfm:!0,headerIds:!0,headerPrefix:"",highlight:null,langPrefix:"language-",mangle:!0,pedantic:!1,renderer:null,sanitize:!1,sanitizer:null,silent:!1,smartLists:!1,smartypants:!1,tokenizer:null,walkTokens:null,xhtml:!1,externalLinks:!1}}let n={baseUrl:null,breaks:!1,extensions:null,gfm:!0,headerIds:!0,headerPrefix:"",highlight:null,langPrefix:"language-",mangle:!0,pedantic:!1,renderer:null,sanitize:!1,sanitizer:null,silent:!1,smartLists:!1,smartypants:!1,tokenizer:null,walkTokens:null,xhtml:!1,externalLinks:!1};const o=/[&<>"']/,a=/[&<>"']/g,r=/[<>"']|&(?!#?\w+;)/,c=/[<>"']|&(?!#?\w+;)/g,l={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},d=e=>l[e];function h(e,t){if(t){if(o.test(e))return e.replace(a,d)}else if(r.test(e))return e.replace(c,d);return e}const u=/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi;function p(e){return e.replace(u,((e,t)=>"colon"===(t=t.toLowerCase())?":":"#"===t.charAt(0)?"x"===t.charAt(1)?String.fromCharCode(parseInt(t.substring(2),16)):String.fromCharCode(+t.substring(1)):""))}const m=/(^|[^\[])\^/g;function g(e,t){e="string"==typeof e?e:e.source,t=t||"";const s={replace:(t,i)=>(i=(i=i.source||i).replace(m,"$1"),e=e.replace(t,i),s),getRegex:()=>new RegExp(e,t)};return s}const f=/[^\w:]/g,w=/^$|^[a-z][a-z0-9+.-]*:|^[?#]/i;function y(e,t,s){if(e){let e;try{e=decodeURIComponent(p(s)).replace(f,"").toLowerCase()}catch(e){return null}if(0===e.indexOf("javascript:")||0===e.indexOf("vbscript:")||0===e.indexOf("data:"))return null}t&&!w.test(s)&&(s=function(e,t){b[" "+e]||(v.test(e)?b[" "+e]=e+"/":b[" "+e]=S(e,"/",!0));e=b[" "+e];const s=-1===e.indexOf(":");return"//"===t.substring(0,2)?s?t:e.replace(k,"$1")+t:"/"===t.charAt(0)?s?t:e.replace(_,"$1")+t:e+t}(t,s));try{s=encodeURI(s).replace(/%25/g,"%")}catch(e){return null}return s}const b={},v=/^[^:]+:\/*[^/]*$/,k=/^([^:]+:)[\s\S]*$/,_=/^([^:]+:\/*[^/]*)[\s\S]*$/;const x={exec:function(){}};function C(e){let t,s,i=1;for(;i<arguments.length;i++)for(s in t=arguments[i],t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}function E(e,t){const s=e.replace(/\|/g,((e,t,s)=>{let i=!1,n=t;for(;--n>=0&&"\\"===s[n];)i=!i;return i?"|":" |"})),i=s.split(/ \|/);let n=0;if(i[0].trim()||i.shift(),i.length>0&&!i[i.length-1].trim()&&i.pop(),i.length>t)i.splice(t);else for(;i.length<t;)i.push("");for(;n<i.length;n++)i[n]=i[n].trim().replace(/\\\|/g,"|");return i}function S(e,t,s){const i=e.length;if(0===i)return"";let n=0;for(;n<i;){const o=e.charAt(i-n-1);if(o!==t||s){if(o===t||!s)break;n++}else n++}return e.slice(0,i-n)}function T(e){e&&e.sanitize&&!e.silent&&console.warn("marked(): sanitize and sanitizer parameters are deprecated since version 0.7.0, should not be used and will be removed in the future. Read more here: https://marked.js.org/#/USING_ADVANCED.md#options")}function A(e,t){if(t<1)return"";let s="";for(;t>1;)1&t&&(s+=e),t>>=1,e+=e;return s+e}function L(e,t,s,i){const n=t.href,o=t.title?h(t.title):null,a=e[1].replace(/\\([\[\]])/g,"$1");if("!"!==e[0].charAt(0)){i.state.inLink=!0;const e={type:"link",raw:s,href:n,title:o,text:a,tokens:i.inlineTokens(a,[])};return i.state.inLink=!1,e}return{type:"image",raw:s,href:n,title:o,text:h(a)}}class j{constructor(e){this.options=e||n}space(e){const t=this.rules.block.newline.exec(e);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(e){const t=this.rules.block.code.exec(e);if(t){const e=t[0].replace(/^ {1,4}/gm,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?e:S(e,"\n")}}}fences(e){const t=this.rules.block.fences.exec(e);if(t){const e=t[0],s=function(e,t){const s=e.match(/^(\s+)(?:```)/);if(null===s)return t;const i=s[1];return t.split("\n").map((e=>{const t=e.match(/^\s+/);if(null===t)return e;const[s]=t;return s.length>=i.length?e.slice(i.length):e})).join("\n")}(e,t[3]||"");return{type:"code",raw:e,lang:t[2]?t[2].trim():t[2],text:s}}}heading(e){const t=this.rules.block.heading.exec(e);if(t){let e=t[2].trim();if(/#$/.test(e)){const t=S(e,"#");this.options.pedantic?e=t.trim():t&&!/ $/.test(t)||(e=t.trim())}const s={type:"heading",raw:t[0],depth:t[1].length,text:e,tokens:[]};return this.lexer.inline(s.text,s.tokens),s}}hr(e){const t=this.rules.block.hr.exec(e);if(t)return{type:"hr",raw:t[0]}}blockquote(e){const t=this.rules.block.blockquote.exec(e);if(t){const e=t[0].replace(/^ *>[ \t]?/gm,"");return{type:"blockquote",raw:t[0],tokens:this.lexer.blockTokens(e,[]),text:e}}}list(e){let t=this.rules.block.list.exec(e);if(t){let s,i,n,o,a,r,c,l,d,h,u,p,m=t[1].trim();const g=m.length>1,f={type:"list",raw:"",ordered:g,start:g?+m.slice(0,-1):"",loose:!1,items:[]};m=g?`\\d{1,9}\\${m.slice(-1)}`:`\\${m}`,this.options.pedantic&&(m=g?m:"[*+-]");const w=new RegExp(`^( {0,3}${m})((?:[\t ][^\\n]*)?(?:\\n|$))`);for(;e&&(p=!1,t=w.exec(e))&&!this.rules.block.hr.test(e);){if(s=t[0],e=e.substring(s.length),l=t[2].split("\n",1)[0],d=e.split("\n",1)[0],this.options.pedantic?(o=2,u=l.trimLeft()):(o=t[2].search(/[^ ]/),o=o>4?1:o,u=l.slice(o),o+=t[1].length),r=!1,!l&&/^ *$/.test(d)&&(s+=d+"\n",e=e.substring(d.length+1),p=!0),!p){const t=new RegExp(`^ {0,${Math.min(3,o-1)}}(?:[*+-]|\\d{1,9}[.)])((?: [^\\n]*)?(?:\\n|$))`),i=new RegExp(`^ {0,${Math.min(3,o-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`);for(;e&&(h=e.split("\n",1)[0],l=h,this.options.pedantic&&(l=l.replace(/^ {1,4}(?=( {4})*[^ ])/g,"  ")),!t.test(l))&&!i.test(e);){if(l.search(/[^ ]/)>=o||!l.trim())u+="\n"+l.slice(o);else{if(r)break;u+="\n"+l}r||l.trim()||(r=!0),s+=h+"\n",e=e.substring(h.length+1)}}f.loose||(c?f.loose=!0:/\n *\n *$/.test(s)&&(c=!0)),this.options.gfm&&(i=/^\[[ xX]\] /.exec(u),i&&(n="[ ] "!==i[0],u=u.replace(/^\[[ xX]\] +/,""))),f.items.push({type:"list_item",raw:s,task:!!i,checked:n,loose:!1,text:u}),f.raw+=s}f.items[f.items.length-1].raw=s.trimRight(),f.items[f.items.length-1].text=u.trimRight(),f.raw=f.raw.trimRight();const y=f.items.length;for(a=0;a<y;a++){this.lexer.state.top=!1,f.items[a].tokens=this.lexer.blockTokens(f.items[a].text,[]);const e=f.items[a].tokens.filter((e=>"space"===e.type)),t=e.every((e=>{const t=e.raw.split("");let s=0;for(const e of t)if("\n"===e&&(s+=1),s>1)return!0;return!1}));!f.loose&&e.length&&t&&(f.loose=!0,f.items[a].loose=!0)}return f}}html(e){const t=this.rules.block.html.exec(e);if(t){const e={type:"html",raw:t[0],pre:!this.options.sanitizer&&("pre"===t[1]||"script"===t[1]||"style"===t[1]),text:t[0]};return this.options.sanitize&&(e.type="paragraph",e.text=this.options.sanitizer?this.options.sanitizer(t[0]):h(t[0]),e.tokens=[],this.lexer.inline(e.text,e.tokens)),e}}def(e){const t=this.rules.block.def.exec(e);if(t){t[3]&&(t[3]=t[3].substring(1,t[3].length-1));return{type:"def",tag:t[1].toLowerCase().replace(/\s+/g," "),raw:t[0],href:t[2],title:t[3]}}}table(e){const t=this.rules.block.table.exec(e);if(t){const e={type:"table",header:E(t[1]).map((e=>({text:e}))),align:t[2].replace(/^ *|\| *$/g,"").split(/ *\| */),rows:t[3]&&t[3].trim()?t[3].replace(/\n[ \t]*$/,"").split("\n"):[]};if(e.header.length===e.align.length){e.raw=t[0];let s,i,n,o,a=e.align.length;for(s=0;s<a;s++)/^ *-+: *$/.test(e.align[s])?e.align[s]="right":/^ *:-+: *$/.test(e.align[s])?e.align[s]="center":/^ *:-+ *$/.test(e.align[s])?e.align[s]="left":e.align[s]=null;for(a=e.rows.length,s=0;s<a;s++)e.rows[s]=E(e.rows[s],e.header.length).map((e=>({text:e})));for(a=e.header.length,i=0;i<a;i++)e.header[i].tokens=[],this.lexer.inline(e.header[i].text,e.header[i].tokens);for(a=e.rows.length,i=0;i<a;i++)for(o=e.rows[i],n=0;n<o.length;n++)o[n].tokens=[],this.lexer.inline(o[n].text,o[n].tokens);return e}}}lheading(e){const t=this.rules.block.lheading.exec(e);if(t){const e={type:"heading",raw:t[0],depth:"="===t[2].charAt(0)?1:2,text:t[1],tokens:[]};return this.lexer.inline(e.text,e.tokens),e}}paragraph(e){const t=this.rules.block.paragraph.exec(e);if(t){const e={type:"paragraph",raw:t[0],text:"\n"===t[1].charAt(t[1].length-1)?t[1].slice(0,-1):t[1],tokens:[]};return this.lexer.inline(e.text,e.tokens),e}}text(e){const t=this.rules.block.text.exec(e);if(t){const e={type:"text",raw:t[0],text:t[0],tokens:[]};return this.lexer.inline(e.text,e.tokens),e}}escape(e){const t=this.rules.inline.escape.exec(e);if(t)return{type:"escape",raw:t[0],text:h(t[1])}}tag(e){const t=this.rules.inline.tag.exec(e);if(t)return!this.lexer.state.inLink&&/^<a /i.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&/^<\/a>/i.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&/^<(pre|code|kbd|script)(\s|>)/i.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&/^<\/(pre|code|kbd|script)(\s|>)/i.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:this.options.sanitize?"text":"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,text:this.options.sanitize?this.options.sanitizer?this.options.sanitizer(t[0]):h(t[0]):t[0]}}link(e){const t=this.rules.inline.link.exec(e);if(t){const e=t[2].trim();if(!this.options.pedantic&&/^</.test(e)){if(!/>$/.test(e))return;const t=S(e.slice(0,-1),"\\");if((e.length-t.length)%2==0)return}else{const e=function(e,t){if(-1===e.indexOf(t[1]))return-1;const s=e.length;let i=0,n=0;for(;n<s;n++)if("\\"===e[n])n++;else if(e[n]===t[0])i++;else if(e[n]===t[1]&&(i--,i<0))return n;return-1}(t[2],"()");if(e>-1){const s=(0===t[0].indexOf("!")?5:4)+t[1].length+e;t[2]=t[2].substring(0,e),t[0]=t[0].substring(0,s).trim(),t[3]=""}}let s=t[2],i="";if(this.options.pedantic){const e=/^([^'"]*[^\s])\s+(['"])(.*)\2/.exec(s);e&&(s=e[1],i=e[3])}else i=t[3]?t[3].slice(1,-1):"";return s=s.trim(),/^</.test(s)&&(s=this.options.pedantic&&!/>$/.test(e)?s.slice(1):s.slice(1,-1)),L(t,{href:s?s.replace(this.rules.inline._escapes,"$1"):s,title:i?i.replace(this.rules.inline._escapes,"$1"):i},t[0],this.lexer)}}reflink(e,t){let s;if((s=this.rules.inline.reflink.exec(e))||(s=this.rules.inline.nolink.exec(e))){let e=(s[2]||s[1]).replace(/\s+/g," ");if(e=t[e.toLowerCase()],!e||!e.href){const e=s[0].charAt(0);return{type:"text",raw:e,text:e}}return L(s,e,s[0],this.lexer)}}emStrong(e,t,s=""){let i=this.rules.inline.emStrong.lDelim.exec(e);if(!i)return;if(i[3]&&s.match(/[\p{L}\p{N}]/u))return;const n=i[1]||i[2]||"";if(!n||n&&(""===s||this.rules.inline.punctuation.exec(s))){const s=i[0].length-1;let n,o,a=s,r=0;const c="*"===i[0][0]?this.rules.inline.emStrong.rDelimAst:this.rules.inline.emStrong.rDelimUnd;for(c.lastIndex=0,t=t.slice(-1*e.length+s);null!=(i=c.exec(t));){if(n=i[1]||i[2]||i[3]||i[4]||i[5]||i[6],!n)continue;if(o=n.length,i[3]||i[4]){a+=o;continue}if((i[5]||i[6])&&s%3&&!((s+o)%3)){r+=o;continue}if(a-=o,a>0)continue;if(o=Math.min(o,o+a+r),Math.min(s,o)%2){const t=e.slice(1,s+i.index+o);return{type:"em",raw:e.slice(0,s+i.index+o+1),text:t,tokens:this.lexer.inlineTokens(t,[])}}const t=e.slice(2,s+i.index+o-1);return{type:"strong",raw:e.slice(0,s+i.index+o+1),text:t,tokens:this.lexer.inlineTokens(t,[])}}}}codespan(e){const t=this.rules.inline.code.exec(e);if(t){let e=t[2].replace(/\n/g," ");const s=/[^ ]/.test(e),i=/^ /.test(e)&&/ $/.test(e);return s&&i&&(e=e.substring(1,e.length-1)),e=h(e,!0),{type:"codespan",raw:t[0],text:e}}}br(e){const t=this.rules.inline.br.exec(e);if(t)return{type:"br",raw:t[0]}}del(e){const t=this.rules.inline.del.exec(e);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2],[])}}autolink(e,t){const s=this.rules.inline.autolink.exec(e);if(s){let e,i;return"@"===s[2]?(e=h(this.options.mangle?t(s[1]):s[1]),i="mailto:"+e):(e=h(s[1]),i=e),{type:"link",raw:s[0],text:e,href:i,tokens:[{type:"text",raw:e,text:e}]}}}url(e,t){let s;if(s=this.rules.inline.url.exec(e)){let e,i;if("@"===s[2])e=h(this.options.mangle?t(s[0]):s[0]),i="mailto:"+e;else{let t;do{t=s[0],s[0]=this.rules.inline._backpedal.exec(s[0])[0]}while(t!==s[0]);e=h(s[0]),i="www."===s[1]?"http://"+e:e}return{type:"link",raw:s[0],text:e,href:i,tokens:[{type:"text",raw:e,text:e}]}}}inlineText(e,t){const s=this.rules.inline.text.exec(e);if(s){let e;return e=this.lexer.state.inRawBlock?this.options.sanitize?this.options.sanitizer?this.options.sanitizer(s[0]):h(s[0]):s[0]:h(this.options.smartypants?t(s[0]):s[0]),{type:"text",raw:s[0],text:e}}}}const I={newline:/^(?: *(?:\n|$))+/,code:/^( {4}[^\n]+(?:\n(?: *(?:\n|$))*)?)+/,fences:/^ {0,3}(`{3,}(?=[^`\n]*\n)|~{3,})([^\n]*)\n(?:|([\s\S]*?)\n)(?: {0,3}\1[~`]* *(?=\n|$)|$)/,hr:/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,blockquote:/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/,list:/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/,html:"^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n *)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n *)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n *)+\\n|$))",def:/^ {0,3}\[(label)\]: *(?:\n *)?<?([^\s>]+)>?(?:(?: +(?:\n *)?| *\n *)(title))? *(?:\n+|$)/,table:x,lheading:/^([^\n]+)\n {0,3}(=+|-+) *(?:\n+|$)/,_paragraph:/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,text:/^[^\n]+/,_label:/(?!\s*\])(?:\\.|[^\[\]\\])+/,_title:/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/};I.def=g(I.def).replace("label",I._label).replace("title",I._title).getRegex(),I.bullet=/(?:[*+-]|\d{1,9}[.)])/,I.listItemStart=g(/^( *)(bull) */).replace("bull",I.bullet).getRegex(),I.list=g(I.list).replace(/bull/g,I.bullet).replace("hr","\\n+(?=\\1?(?:(?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$))").replace("def","\\n+(?="+I.def.source+")").getRegex(),I._tag="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|section|source|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",I._comment=/<!--(?!-?>)[\s\S]*?(?:-->|$)/,I.html=g(I.html,"i").replace("comment",I._comment).replace("tag",I._tag).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),I.paragraph=g(I._paragraph).replace("hr",I.hr).replace("heading"," {0,3}#{1,6} ").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",I._tag).getRegex(),I.blockquote=g(I.blockquote).replace("paragraph",I.paragraph).getRegex(),I.normal=C({},I),I.gfm=C({},I.normal,{table:"^ *([^\\n ].*\\|.*)\\n {0,3}(?:\\| *)?(:?-+:? *(?:\\| *:?-+:? *)*)(?:\\| *)?(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)"}),I.gfm.table=g(I.gfm.table).replace("hr",I.hr).replace("heading"," {0,3}#{1,6} ").replace("blockquote"," {0,3}>").replace("code"," {4}[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",I._tag).getRegex(),I.gfm.paragraph=g(I._paragraph).replace("hr",I.hr).replace("heading"," {0,3}#{1,6} ").replace("|lheading","").replace("table",I.gfm.table).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",I._tag).getRegex(),I.pedantic=C({},I.normal,{html:g("^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:\"[^\"]*\"|'[^']*'|\\s[^'\"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))").replace("comment",I._comment).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:x,paragraph:g(I.normal._paragraph).replace("hr",I.hr).replace("heading"," *#{1,6} *[^\n]").replace("lheading",I.lheading).replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").getRegex()});const D={escape:/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,autolink:/^<(scheme:[^\s\x00-\x1f<>]*|email)>/,url:x,tag:"^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>",link:/^!?\[(label)\]\(\s*(href)(?:\s+(title))?\s*\)/,reflink:/^!?\[(label)\]\[(ref)\]/,nolink:/^!?\[(ref)\](?:\[\])?/,reflinkSearch:"reflink|nolink(?!\\()",emStrong:{lDelim:/^(?:\*+(?:([punct_])|[^\s*]))|^_+(?:([punct*])|([^\s_]))/,rDelimAst:/^[^_*]*?\_\_[^_*]*?\*[^_*]*?(?=\_\_)|[^*]+(?=[^*])|[punct_](\*+)(?=[\s]|$)|[^punct*_\s](\*+)(?=[punct_\s]|$)|[punct_\s](\*+)(?=[^punct*_\s])|[\s](\*+)(?=[punct_])|[punct_](\*+)(?=[punct_])|[^punct*_\s](\*+)(?=[^punct*_\s])/,rDelimUnd:/^[^_*]*?\*\*[^_*]*?\_[^_*]*?(?=\*\*)|[^_]+(?=[^_])|[punct*](\_+)(?=[\s]|$)|[^punct*_\s](\_+)(?=[punct*\s]|$)|[punct*\s](\_+)(?=[^punct*_\s])|[\s](\_+)(?=[punct*])|[punct*](\_+)(?=[punct*])/},code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,br:/^( {2,}|\\)\n(?!\s*$)/,del:x,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,punctuation:/^([\spunctuation])/};function M(e){return e.replace(/---/g,"—").replace(/--/g,"–").replace(/(^|[-\u2014/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…")}function O(e){let t,s,i="";const n=e.length;for(t=0;t<n;t++)s=e.charCodeAt(t),Math.random()>.5&&(s="x"+s.toString(16)),i+="&#"+s+";";return i}D._punctuation="!\"#$%&'()+\\-.,/:;<=>?@\\[\\]`^{|}~",D.punctuation=g(D.punctuation).replace(/punctuation/g,D._punctuation).getRegex(),D.blockSkip=/\[[^\]]*?\]\([^\)]*?\)|`[^`]*?`|<[^>]*?>/g,D.escapedEmSt=/\\\*|\\_/g,D._comment=g(I._comment).replace("(?:--\x3e|$)","--\x3e").getRegex(),D.emStrong.lDelim=g(D.emStrong.lDelim).replace(/punct/g,D._punctuation).getRegex(),D.emStrong.rDelimAst=g(D.emStrong.rDelimAst,"g").replace(/punct/g,D._punctuation).getRegex(),D.emStrong.rDelimUnd=g(D.emStrong.rDelimUnd,"g").replace(/punct/g,D._punctuation).getRegex(),D._escapes=/\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/g,D._scheme=/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/,D._email=/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/,D.autolink=g(D.autolink).replace("scheme",D._scheme).replace("email",D._email).getRegex(),D._attribute=/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/,D.tag=g(D.tag).replace("comment",D._comment).replace("attribute",D._attribute).getRegex(),D._label=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,D._href=/<(?:\\.|[^\n<>\\])+>|[^\s\x00-\x1f]*/,D._title=/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/,D.link=g(D.link).replace("label",D._label).replace("href",D._href).replace("title",D._title).getRegex(),D.reflink=g(D.reflink).replace("label",D._label).replace("ref",I._label).getRegex(),D.nolink=g(D.nolink).replace("ref",I._label).getRegex(),D.reflinkSearch=g(D.reflinkSearch,"g").replace("reflink",D.reflink).replace("nolink",D.nolink).getRegex(),D.normal=C({},D),D.pedantic=C({},D.normal,{strong:{start:/^__|\*\*/,middle:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,endAst:/\*\*(?!\*)/g,endUnd:/__(?!_)/g},em:{start:/^_|\*/,middle:/^()\*(?=\S)([\s\S]*?\S)\*(?!\*)|^_(?=\S)([\s\S]*?\S)_(?!_)/,endAst:/\*(?!\*)/g,endUnd:/_(?!_)/g},link:g(/^!?\[(label)\]\((.*?)\)/).replace("label",D._label).getRegex(),reflink:g(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",D._label).getRegex()}),D.gfm=C({},D.normal,{escape:g(D.escape).replace("])","~|])").getRegex(),_extended_email:/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/,url:/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,_backpedal:/(?:[^?!.,:;*_~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])([\s\S]*?[^\s~])\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/}),D.gfm.url=g(D.gfm.url,"i").replace("email",D.gfm._extended_email).getRegex(),D.breaks=C({},D.gfm,{br:g(D.br).replace("{2,}","*").getRegex(),text:g(D.gfm.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()});class P{constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||n,this.options.tokenizer=this.options.tokenizer||new j,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const t={block:I.normal,inline:D.normal};this.options.pedantic?(t.block=I.pedantic,t.inline=D.pedantic):this.options.gfm&&(t.block=I.gfm,this.options.breaks?t.inline=D.breaks:t.inline=D.gfm),this.tokenizer.rules=t}static get rules(){return{block:I,inline:D}}static lex(e,t){return new P(t).lex(e)}static lexInline(e,t){return new P(t).inlineTokens(e)}lex(e){let t;for(e=e.replace(/\r\n|\r/g,"\n"),this.blockTokens(e,this.tokens);t=this.inlineQueue.shift();)this.inlineTokens(t.src,t.tokens);return this.tokens}blockTokens(e,t=[]){let s,i,n,o;for(e=this.options.pedantic?e.replace(/\t/g,"    ").replace(/^ +$/gm,""):e.replace(/^( *)(\t+)/gm,((e,t,s)=>t+"    ".repeat(s.length)));e;)if(!(this.options.extensions&&this.options.extensions.block&&this.options.extensions.block.some((i=>!!(s=i.call({lexer:this},e,t))&&(e=e.substring(s.raw.length),t.push(s),!0)))))if(s=this.tokenizer.space(e))e=e.substring(s.raw.length),1===s.raw.length&&t.length>0?t[t.length-1].raw+="\n":t.push(s);else if(s=this.tokenizer.code(e))e=e.substring(s.raw.length),i=t[t.length-1],!i||"paragraph"!==i.type&&"text"!==i.type?t.push(s):(i.raw+="\n"+s.raw,i.text+="\n"+s.text,this.inlineQueue[this.inlineQueue.length-1].src=i.text);else if(s=this.tokenizer.fences(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.heading(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.hr(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.blockquote(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.list(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.html(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.def(e))e=e.substring(s.raw.length),i=t[t.length-1],!i||"paragraph"!==i.type&&"text"!==i.type?this.tokens.links[s.tag]||(this.tokens.links[s.tag]={href:s.href,title:s.title}):(i.raw+="\n"+s.raw,i.text+="\n"+s.raw,this.inlineQueue[this.inlineQueue.length-1].src=i.text);else if(s=this.tokenizer.table(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.lheading(e))e=e.substring(s.raw.length),t.push(s);else{if(n=e,this.options.extensions&&this.options.extensions.startBlock){let t=1/0;const s=e.slice(1);let i;this.options.extensions.startBlock.forEach((function(e){i=e.call({lexer:this},s),"number"==typeof i&&i>=0&&(t=Math.min(t,i))})),t<1/0&&t>=0&&(n=e.substring(0,t+1))}if(this.state.top&&(s=this.tokenizer.paragraph(n)))i=t[t.length-1],o&&"paragraph"===i.type?(i.raw+="\n"+s.raw,i.text+="\n"+s.text,this.inlineQueue.pop(),this.inlineQueue[this.inlineQueue.length-1].src=i.text):t.push(s),o=n.length!==e.length,e=e.substring(s.raw.length);else if(s=this.tokenizer.text(e))e=e.substring(s.raw.length),i=t[t.length-1],i&&"text"===i.type?(i.raw+="\n"+s.raw,i.text+="\n"+s.text,this.inlineQueue.pop(),this.inlineQueue[this.inlineQueue.length-1].src=i.text):t.push(s);else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return this.state.top=!0,t}inline(e,t){this.inlineQueue.push({src:e,tokens:t})}inlineTokens(e,t=[]){let s,i,n,o,a,r,c=e;if(this.tokens.links){const e=Object.keys(this.tokens.links);if(e.length>0)for(;null!=(o=this.tokenizer.rules.inline.reflinkSearch.exec(c));)e.includes(o[0].slice(o[0].lastIndexOf("[")+1,-1))&&(c=c.slice(0,o.index)+"["+A("a",o[0].length-2)+"]"+c.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;null!=(o=this.tokenizer.rules.inline.blockSkip.exec(c));)c=c.slice(0,o.index)+"["+A("a",o[0].length-2)+"]"+c.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);for(;null!=(o=this.tokenizer.rules.inline.escapedEmSt.exec(c));)c=c.slice(0,o.index)+"++"+c.slice(this.tokenizer.rules.inline.escapedEmSt.lastIndex);for(;e;)if(a||(r=""),a=!1,!(this.options.extensions&&this.options.extensions.inline&&this.options.extensions.inline.some((i=>!!(s=i.call({lexer:this},e,t))&&(e=e.substring(s.raw.length),t.push(s),!0)))))if(s=this.tokenizer.escape(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.tag(e))e=e.substring(s.raw.length),i=t[t.length-1],i&&"text"===s.type&&"text"===i.type?(i.raw+=s.raw,i.text+=s.text):t.push(s);else if(s=this.tokenizer.link(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.reflink(e,this.tokens.links))e=e.substring(s.raw.length),i=t[t.length-1],i&&"text"===s.type&&"text"===i.type?(i.raw+=s.raw,i.text+=s.text):t.push(s);else if(s=this.tokenizer.emStrong(e,c,r))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.codespan(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.br(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.del(e))e=e.substring(s.raw.length),t.push(s);else if(s=this.tokenizer.autolink(e,O))e=e.substring(s.raw.length),t.push(s);else if(this.state.inLink||!(s=this.tokenizer.url(e,O))){if(n=e,this.options.extensions&&this.options.extensions.startInline){let t=1/0;const s=e.slice(1);let i;this.options.extensions.startInline.forEach((function(e){i=e.call({lexer:this},s),"number"==typeof i&&i>=0&&(t=Math.min(t,i))})),t<1/0&&t>=0&&(n=e.substring(0,t+1))}if(s=this.tokenizer.inlineText(n,M))e=e.substring(s.raw.length),"_"!==s.raw.slice(-1)&&(r=s.raw.slice(-1)),a=!0,i=t[t.length-1],i&&"text"===i.type?(i.raw+=s.raw,i.text+=s.text):t.push(s);else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}else e=e.substring(s.raw.length),t.push(s);return t}}class R{constructor(e){this.options=e||n}code(e,t,s){const i=(t||"").match(/\S*/)[0];if(this.options.highlight){const t=this.options.highlight(e,i);null!=t&&t!==e&&(s=!0,e=t)}e=e.replace(/\n$/,"")+"\n";let n="";return n&&(n=` class="${this.options.langPrefix+h(i,!0)}"`),`<pre class="relative noevents"><code${n}>`+(s?e:h(e,!0))+'</code><button class="icon fa xs copy top-right display-hover" title="Copy" cmd="copy-code"></button></pre>\n'}blockquote(e){return`<blockquote>\n${e}</blockquote>\n`}html(e){return e}heading(e,t,s,i){if(this.options.headerIds){return`<h${t} id="${this.options.headerPrefix+i.slug(s)}">${e}</h${t}>\n`}return`<h${t}>${e}</h${t}>\n`}hr(){return this.options.xhtml?"<hr/>\n":"<hr>\n"}list(e,t,s){const i=t?"ol":"ul";return"<"+i+(t&&1!==s?' start="'+s+'"':"")+">\n"+e+"</"+i+">\n"}listitem(e){return`<li>${e}</li>\n`}checkbox(e){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox"'+(this.options.xhtml?" /":"")+"> "}paragraph(e,t){return t?`<p class="image">${e}</p>\n`:`<p>${e}</p>\n`}table(e,t){return t&&(t=`<tbody>${t}</tbody>`),"<table>\n<thead>\n"+e+"</thead>\n"+t+"</table>\n"}tablerow(e){return`<tr>\n${e}</tr>\n`}tablecell(e,t){const s=t.header?"th":"td";return(t.align?`<${s} align="${t.align}">`:`<${s}>`)+e+`</${s}>\n`}strong(e){return`<strong>${e}</strong>`}em(e){return`<em>${e}</em>`}codespan(e){return`<code>${e}</code>`}br(){return this.options.xhtml?"<br/>":"<br>"}del(e){return`<del>${e}</del>`}link(e,t,s){if(null===(e=y(this.options.sanitize,this.options.baseUrl,e)))return s;let i;return e.startsWith("#")?i='<a class="internal" link="'+e+'"':(i='<a href="'+h(e)+'"',this.options.externalLinks&&(i+=' target="_blank"')),t&&(i+=' title="'+t+'"'),i+=">"+s+"</a>",i}image(e,t,s){if(null===(e=y(this.options.sanitize,this.options.baseUrl,e)))return s;let i=`<img src="${e}" alt="${s}"`;return t&&(i+=` title="${t}"`),i+=this.options.xhtml?"/>":">",i}text(e){return e}}class ${strong(e){return e}em(e){return e}codespan(e){return e}del(e){return e}html(e){return e}text(e){return e}link(e,t,s){return""+s}image(e,t,s){return""+s}br(){return""}}class z{constructor(){this.seen={}}serialize(e){return e.toLowerCase().trim().replace(/<[!\/a-z].*?>/gi,"").replace(/[\u2000-\u206F\u2E00-\u2E7F\\'!"#$%&()*+,./:;<=>?@[\]^`{|}~]/g,"").replace(/\s/g,"-")}getNextSafeSlug(e,t){let s=e,i=0;if(this.seen.hasOwnProperty(s)){i=this.seen[e];do{i++,s=e+"-"+i}while(this.seen.hasOwnProperty(s))}return t||(this.seen[e]=i,this.seen[s]=0),s}slug(e,t={}){const s=this.serialize(e);return this.getNextSafeSlug(s,t.dryrun)}}class B{constructor(e){this.options=e||n,this.options.renderer=this.options.renderer||new R,this.renderer=this.options.renderer,this.renderer.options=this.options,this.textRenderer=new $,this.slugger=new z}static parse(e,t){return new B(t).parse(e)}static parseInline(e,t){return new B(t).parseInline(e)}parse(e,t=!0){let s,i,n,o,a,r,c,l,d,h,u,m,g,f,w,y,b,v,k,_="";const x=e.length;for(s=0;s<x;s++)if(h=e[s],this.options.extensions&&this.options.extensions.renderers&&this.options.extensions.renderers[h.type]&&(k=this.options.extensions.renderers[h.type].call({parser:this},h),!1!==k||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(h.type)))_+=k||"";else switch(h.type){case"space":continue;case"hr":_+=this.renderer.hr();continue;case"heading":_+=this.renderer.heading(this.parseInline(h.tokens),h.depth,p(this.parseInline(h.tokens,this.textRenderer)),this.slugger);continue;case"code":_+=this.renderer.code(h.text,h.lang,h.escaped);continue;case"table":for(l="",c="",o=h.header.length,i=0;i<o;i++)c+=this.renderer.tablecell(this.parseInline(h.header[i].tokens),{header:!0,align:h.align[i]});for(l+=this.renderer.tablerow(c),d="",o=h.rows.length,i=0;i<o;i++){for(r=h.rows[i],c="",a=r.length,n=0;n<a;n++)c+=this.renderer.tablecell(this.parseInline(r[n].tokens),{header:!1,align:h.align[n]});d+=this.renderer.tablerow(c)}_+=this.renderer.table(l,d);continue;case"blockquote":d=this.parse(h.tokens),_+=this.renderer.blockquote(d);continue;case"list":for(u=h.ordered,m=h.start,g=h.loose,o=h.items.length,d="",i=0;i<o;i++)w=h.items[i],y=w.checked,b=w.task,f="",w.task&&(v=this.renderer.checkbox(y),g?w.tokens.length>0&&"paragraph"===w.tokens[0].type?(w.tokens[0].text=v+" "+w.tokens[0].text,w.tokens[0].tokens&&w.tokens[0].tokens.length>0&&"text"===w.tokens[0].tokens[0].type&&(w.tokens[0].tokens[0].text=v+" "+w.tokens[0].tokens[0].text)):w.tokens.unshift({type:"text",text:v}):f+=v),f+=this.parse(w.tokens,g),d+=this.renderer.listitem(f,b,y);_+=this.renderer.list(d,u,m);continue;case"html":_+=this.renderer.html(h.text);continue;case"paragraph":{const e=h.tokens,t=1==e.length&&"image"==e[0].type;_+=this.renderer.paragraph(this.parseInline(e),t);continue}case"text":for(d=h.tokens?this.parseInline(h.tokens):h.text;s+1<x&&"text"===e[s+1].type;)h=e[++s],d+="\n"+(h.tokens?this.parseInline(h.tokens):h.text);_+=t?this.renderer.paragraph(d):d;continue;default:{const e='Token with "'+h.type+'" type was not found.';if(this.options.silent)return void console.error(e);throw new Error(e)}}return _}parseInline(e,t){t=t||this.renderer;let s,i,n,o="";const a=e.length;for(s=0;s<a;s++)if(i=e[s],this.options.extensions&&this.options.extensions.renderers&&this.options.extensions.renderers[i.type]&&(n=this.options.extensions.renderers[i.type].call({parser:this},i),!1!==n||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(i.type)))o+=n||"";else switch(i.type){case"escape":case"text":o+=t.text(i.text);break;case"html":o+=t.html(i.text);break;case"link":o+=t.link(i.href,i.title,this.parseInline(i.tokens,t));break;case"image":o+=t.image(i.href,i.title,i.text);break;case"strong":o+=t.strong(this.parseInline(i.tokens,t));break;case"em":o+=t.em(this.parseInline(i.tokens,t));break;case"codespan":o+=t.codespan(i.text);break;case"br":o+=t.br();break;case"del":o+=t.del(this.parseInline(i.tokens,t));break;default:{const e='Token with "'+i.type+'" type was not found.';if(this.options.silent)return void console.error(e);throw new Error(e)}}return o}}function N(e,t,s){if(null==e)throw new Error("marked(): input parameter is undefined or null");if("string"!=typeof e)throw new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected");if("function"==typeof t&&(s=t,t=null),T(t=C({},N.defaults,t||{})),s){const i=t.highlight;let n;try{n=P.lex(e,t)}catch(e){return s(e)}const o=function(e){let o;if(!e)try{t.walkTokens&&N.walkTokens(n,t.walkTokens),o=B.parse(n,t)}catch(t){e=t}return t.highlight=i,e?s(e):s(null,o)};if(!i||i.length<3)return o();if(delete t.highlight,!n.length)return o();let a=0;return N.walkTokens(n,(function(e){"code"===e.type&&(a++,setTimeout((()=>{i(e.text,e.lang,(function(t,s){if(t)return o(t);null!=s&&s!==e.text&&(e.text=s,e.escaped=!0),a--,0===a&&o()}))}),0))})),void(0===a&&o())}try{const s=P.lex(e,t);return t.walkTokens&&N.walkTokens(s,t.walkTokens),B.parse(s,t).replace(/(\$fa-[a-z0-9-]+)(;[a-z]+)?/g,((e,t,s)=>`<i class="fa ${t.slice(1)}" style="color:${s?s.slice(1):"inherit"}"></i>`))}catch(e){if(e.message+="\nPlease report this to https://github.com/markedjs/marked.",t.silent)return"<p>An error occurred:</p><pre>"+h(e.message+"",!0)+"</pre>";throw e}}N.options=N.setOptions=function(e){var t;return C(N.defaults,e),t=N.defaults,n=t,N},N.getDefaults=i,N.defaults=n,N.use=function(...e){const t=C({},...e),s=N.defaults.extensions||{renderers:{},childTokens:{}};let i;e.forEach((e=>{if(e.extensions&&(i=!0,e.extensions.forEach((e=>{if(!e.name)throw new Error("extension name required");if(e.renderer){const t=s.renderers?s.renderers[e.name]:null;s.renderers[e.name]=t?function(...s){let i=e.renderer.apply(this,s);return!1===i&&(i=t.apply(this,s)),i}:e.renderer}if(e.tokenizer){if(!e.level||"block"!==e.level&&"inline"!==e.level)throw new Error("extension level must be 'block' or 'inline'");s[e.level]?s[e.level].unshift(e.tokenizer):s[e.level]=[e.tokenizer],e.start&&("block"===e.level?s.startBlock?s.startBlock.push(e.start):s.startBlock=[e.start]:"inline"===e.level&&(s.startInline?s.startInline.push(e.start):s.startInline=[e.start]))}e.childTokens&&(s.childTokens[e.name]=e.childTokens)}))),e.renderer){const s=N.defaults.renderer||new R;for(const t in e.renderer){const i=s[t];s[t]=(...n)=>{let o=e.renderer[t].apply(s,n);return!1===o&&(o=i.apply(s,n)),o}}t.renderer=s}if(e.tokenizer){const s=N.defaults.tokenizer||new j;for(const t in e.tokenizer){const i=s[t];s[t]=(...n)=>{let o=e.tokenizer[t].apply(s,n);return!1===o&&(o=i.apply(s,n)),o}}t.tokenizer=s}if(e.walkTokens){const s=N.defaults.walkTokens;t.walkTokens=function(t){e.walkTokens.call(this,t),s&&s.call(this,t)}}i&&(t.extensions=s),N.setOptions(t)}))},N.walkTokens=function(e,t){for(const s of e)switch(t.call(N,s),s.type){case"table":for(const e of s.header)N.walkTokens(e.tokens,t);for(const e of s.rows)for(const s of e)N.walkTokens(s.tokens,t);break;case"list":N.walkTokens(s.items,t);break;default:N.defaults.extensions&&N.defaults.extensions.childTokens&&N.defaults.extensions.childTokens[s.type]?N.defaults.extensions.childTokens[s.type].forEach((function(e){N.walkTokens(s[e],t)})):s.tokens&&N.walkTokens(s.tokens,t)}},N.parseInline=function(e,t){if(null==e)throw new Error("marked.parseInline(): input parameter is undefined or null");if("string"!=typeof e)throw new Error("marked.parseInline(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected");T(t=C({},N.defaults,t||{}));try{const s=P.lexInline(e,t);return t.walkTokens&&N.walkTokens(s,t.walkTokens),B.parseInline(s,t)}catch(e){if(e.message+="\nPlease report this to https://github.com/markedjs/marked.",t.silent)return"<p>An error occurred:</p><pre>"+h(e.message+"",!0)+"</pre>";throw e}},N.Parser=B,N.parser=B.parse,N.Renderer=R,N.TextRenderer=$,N.Lexer=P,N.lexer=P.lex,N.Tokenizer=j,N.Slugger=z,N.parse=N;const F=N.options,q=N.setOptions,U=N.use,H=N.walkTokens,W=N.parseInline,V=N,X=B.parse,G=P.lex,Y=new RegExp(/@foreach\{\{(.*?)\}\}(\[(.*?)\])?((?:(?:((@if\{\{[^}]+\}\}(?:(?:((@if\{\{[^}]+\}\}(?:.)*?@endif)|(@foreach\{\{[^}]+\}\}(?:.)*?@endforeach)))*?|(?:.))*?@endif)|(@foreach\{\{[^}]+\}\}(?:(?:((@if\{\{[^}]+\}\}(?:.)*?@endif)|(@foreach\{\{[^}]+\}\}(?:.)*?@endforeach)))*?|(?:.))*?@endforeach)))*?|(?:.))*?)@endforeach/gs,"sg"),K=new RegExp(/@if\{\{(.*?)\}\}((?:(?:((@if\{\{[^}]+\}\}(?:(?:((@if\{\{[^}]+\}\}(?:.)*?@endif)|(@foreach\{\{[^}]+\}\}(?:.)*?@endforeach)))*?|(?:.))*?@endif)|(@foreach\{\{[^}]+\}\}(?:(?:((@if\{\{[^}]+\}\}(?:.)*?@endif)|(@foreach\{\{[^}]+\}\}(?:.)*?@endforeach)))*?|(?:.))*?@endforeach)))*?|(?:.))*?)@endif/gs,"sg"),Z=/\[\[(.*?)\]\](\{\{(.*?)\}\})?(\[\[(.*?)\]\])?/gs,J=/\{\{(.*)\}\}/;function Q(e,...t){return e.replace(Y,((e,s,i,n,o)=>{let a=s.match(/_([0-9])/);const r=(a?t[parseInt(a[1])]:s.eval(this))||[];if(!Array.isArray(r))return"";let c="";const l=[];if(i)for(const e of i.slice(1,-1).split(",")){let s=e.match(/_([0-9])/);if(s){let e=parseInt(s[1]);l.push(t[e])}else l.push(this[e])}let d=0;for(const e of r)c+=Q.bind(e)(o.trim(),d++,...l);return c})).replace(K,((e,s,i,n,o)=>{const[a,r]=i.splitLast("@else");return s.replace(/_([0-9])/g,((e,t)=>`_[${t}]`||"")).eval(this,...t)?Q.bind(this)(a.trim(),...t):r?Q.bind(this)(r.trim(),...t):""})).replace(Z,((e,s,i,n,o,a)=>{const r=n?n.replace(/_([0-9])/g,((e,t)=>`_[${t}]`||"")).eval(this,...t):{},[c,l,...d]=s.split(",").map((e=>e.trim()));let h=c.replacex(this);if(/^_[0-9]/.test(c)){const e=parseInt(c[1]);h=t[e]}else{const e=c.match(J);if(e&&/_[0-9]/.test(e[1])){const s=e[1][1]-"0";if(h=t[s],!h)return""}}if(!h)return"";let u=[];if(Array.isArray(h)&&(u=h.slice(1),h=h[0],!h))return"";for(let e=0;e<d.length;++e){const s=d[e];let i;i=s.match(/_([0-9])/),i?d[e]=t[parseInt(i[1])]:(i=s.match(/\{\{(.*?)\}\}/),i&&(d[e]=i[1].eval(this,...t)))}const[p,...m]=l?l.split(" "):["div"],[g,f,w]=te(h,r,...u,...d);let y="";if(a)for(const e of a.split(",")){const[s,i]=e.split("=");if(i){y+=` data-${s}="${i.eval(this,...t)}"`}else y+=` data-${s}="${this[s]}"`}const b=`${[...f,...m].join(" ")}`;return`<${p}${b?` class="${b}"`:""} ${`${Object.entries(w).map((([e,t])=>`${e}="${t.replacex(r)}"`)).join(" ")}`} ${y}>${Q.bind(r)(g,...u,...d)}</${p}>`})).replace(/_a-([^=]+)=\{\{(.*)\}\}/,((e,t,s)=>s.eval(this)?t:"")).replacex(this,...t).trim()}function ee(e,t,s="div",i=[],...n){const o=Q.bind(t)(e,...n).replaceAll(/>\s+</g,"><"),[a,...r]=s.split(" "),c=document.createElement(a);return c.classList.add(...i,...r),c.innerHTML=o,c}function te(e,t={},...s){const i=document.getElementById(e);i||console.error("Failed to load template",e);let n=i.innerHTML;n=n.replace(/(?=<!--)([\s\S]*?)-->/gs,"").replace(/[\n\t]/,"");let o=i.getAttribute("classes")||"";o&&(o=o.replacex(t,...s));const a=o?o.split(" ").filter((e=>e)):[],r={"&gt;":">","&lt;":"<","&amp;":"&"};for(const[e,t]of Object.entries(r))n=n.replaceAll(e,t);const c={};for(const e of i.attributes){let i=e.name;if(!["id","classes"].includes(i))if(i.startsWith("_a-")){i=i.slice(3);const s=e.value.replacex(t);s&&(c[i]=s)}else c[i]=e.value.replacex(t,...s)}return[n,a,c]}function se(e,t={},s="div",...i){const[n,o,a]=te(e,t,...i);let r;try{r=ee(n,t,s,o,...i);for(const[e,t]of Object.entries(a))r.setAttribute(e,t)}catch(s){throw console.groupCollapsed("Failed to render template",e),console.debug(t),console.debug(n),console.groupEnd(),s}return r}function ie(e,t,s,i,...n){const[o,a]=te(t,s);s=Array.isArray(s)?s:[s];for(const o of s){const o=ee(t,s,i,a,...n);e.appendChild(o)}}function ne(e,t){return Q.bind(t)(e)}const oe="highlight";function ae(e,t){t.parentNode.insertBefore(e,t.nextElementSibling)}function re(e,t){t.parentNode.insertBefore(e,t)}function ce(e,...t){const s=document.createElement(e);return function(e,...t){t.length>0&&e.classList.add(...t)}(s,...t),s}function le(e,t){const s={headerIds:!1,breaks:!0,externalLinks:!0};t&&Object.assign(s,t);const i=e.trim();return V(i,s)}function de(e){const t={":)":"🙂",":')":"😃",':")':"😀",":p":"😋",":'p":"😛",':"p':"😝",":P":"😛",":'P":"😛",':"P':"😝",":d":"😀",":'d":"😄",':"d':"😆",":D":"😄",":'D":"😅",':"D':"😂",":k":"😗",":'k":"😙",':"k':"😚",":s":"💯",":X":"💣",":t":"👍",":b":"🍺",":B":"🍻",":w":"✋",":(":"😧",":'(":"😥",':"(':"😭",":o":"😯",":'o":"😲",':"o':"😵",":8":"😎",";)":"😉"},s={family:"👪️",zzz:"💤",newspaper:"📰",books:"📚️",up:"👍️",usd:"💲",card:"💳️",money:"💰️",cash:"💸",tm:"™️",boom:"💥",eye:"👁️",eyes:"👀",glasses:"👓️",dizzy:"💫",santa:"🎅",bird:"🐦️",dragon:"🐉",fox:"🦊",horse:"🐎",linux:"🐧",mushroom:"🍄",octopus:"🐙",ox:"🐂",shark:"🦈",snake:"🐍",tiger:"🐅",whale:"🐋",sunflower:"🌻",tree:"🌳",ok:"🆗",wc:"🚾",wtf:"⁉",new:"🆕",free:"🆓",cool:"🆒",cancer:"♋️",gemini:"♊️",taurus:"♉️",libra:"♎️",hamburger:"🍔",honeypot:"🍯",pizza:"🍕",strawberry:"🍓",beer:"🍺",cheers:"🍻",cocktail:"🍸️",coffee:"☕️",drink:"🍹",wine:"🍷",bg:"🇧🇬",de:"🇩🇪",es:"🇪🇸",fr:"🇫🇷",gb:"🇬🇧",gr:"🇬🇷",us:"🇺🇸",congratulations:"㊗️",cannabis:'<i class="fa fa-cannabis w3-text-green"></i>',joint:'<i class="fa fa-joint"></i>',facebook:'<i class="fa fa-facebook w3-text-blue"></i>',feather:'<i class="fa fa-feather w3-text-indigo"></i>'};return e.replaceAll(/\:([A-z]+)\:/g,((e,t)=>s[t.toLowerCase()]||e)).replaceAll(/([:;]['"]?[)(pPdDksXtbBwo8])/g,((e,s)=>t[s]||e)).replaceAll(/(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])|(\p{Emoji_Presentation})/gu,(e=>`<i class="em">${e}</i>`))}window.dom={createFa:(...e)=>ce("i","fa",...e),createFaButton:function(e,...t){return ce("button","icon","fa","fa-fw",e,...t)},highlightElement:function(e,t=1800){e.classList.remove(oe),e.classList.add(oe)},isNode:function(e){return"object"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName},isElement:function(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName},isElementVisible:e=>e.getBoundingClientRect().height>0,removeChilds:function(e){for(;e.lastElementChild;)e.removeChild(e.lastElementChild)},removeElement:function(e){return e&&e.parentElement&&e.parentElement.removeChild(e),e},insertAfter:ae,insertBefore:re,insertTop:function(e,t){t.insertBefore(e,t.firstElementChild)},createElement:ce,createElementFromMarkdown:function(e,t=!0){const s=dom.createElement("span","md","compact","r2","nomargin","noevents","text-expand");s.setAttribute("expandable","");const i=le(e);return s.innerHTML=t?de(i):i,s},showElement:function(e,t=!0){t?e.classList.remove("hidden"):e.classList.add("hidden")},hideElement:function(e){e.classList.add("hidden")},toggleShow:function(e){return e.classList.toggle("hidden")},isHidden:function(e){return e.classList.contains("hidden")},moveTop:function(e,t,s){t&&(e=e.querySelector(`[${t}="${s}"]`));const i=e.parentElement;return i.insertBefore(e,i.firstElementChild),e},moveAfterTop:function(e){ae(e,e.parentElement.firstElementChild)},moveUp:function(e){re(e,e.previousElementSibling)},getParent:function(e,t=1){let s=e;for(let e=0;e<t;++e)s=s.parentElement;return s},findVisible:function e(t,s,i=0,n=s.length,o=Math.floor((i+n)/2)){if(i==n)return[];let a=s[o],r=a.getBoundingClientRect();if(r.top>=t.bottom)return e(t,s,i,o);if(r.bottom<=t.top)return e(t,s,o+1,n);const c=[a];for(let e=o-1;e>=0&&(a=s[e],r=a.getBoundingClientRect(),r.bottom>t.top);e--)c.unshift(a);for(let e=o+1;e<s.length&&(a=s[e],r=a.getBoundingClientRect(),r.top<t.bottom);++e)c.push(a);return c},isVisible:function(e,t){const s=e.getBoundingClientRect();return!(s.bottom<t.top||s.top>t.bottom)},getValues:function(e,t={}){const s=e.querySelectorAll("[role]");for(const e of s){let s;switch(e.tagName){case"IMG":s=e.src;break;case"A":s=e.href;break;case"TIME":if(e.dateTime){t.ts=new Date(e.dateTime).seconds();break}default:s=e.innerText}s&&(t[e.getAttribute("role")]=s)}return t},updateValues:function(e,t){let s;for(let[i,n]of Object.entries(t))if(s=e.querySelector(`[role="${i}"]`),s)if("status"==i)s.innerHTML=de(n);else if("IMG"===s.tagName)s.src=n;else s.innerText=n},loadScript:function(e){const t=document.createElement("script");return t.type="text/javascript",t.src=e,document.getElementsByTagName("head")[0].appendChild(t),new Promise(((e,s)=>{t.onload=e,t.onerror=s}))},getData:function(e,t="input"){const s={},i=e.querySelectorAll(t);for(const e of i)e.name&&(s[e.name]=e.value.trim());return s},updateElapsed:function(e,t=Date.now()){const s=e.querySelectorAll("time[data-time]");for(const e of s){const s=e.dataset.time;if(s){const i=new Date(1e3*parseInt(s));e.innerText=i.offsetFrom(t)}}},renderTemplate:se,renderTemplateHtml:ee,renderTemplateContainer:ie,template:s,facReplace:function(e,t){const s=e.className.split(" ");for(const t of s)if(/^fac-/.test(t)){e.classList.remove(t);break}e.classList.add(t)},showNextImage:function(e,t=!0){const s=e.querySelectorAll("img");if(!(s.length<2))for(let i=0;i<s.length;++i){const n=s[i];if(!n.classList.contains("hidden")){let o=i+(t?1:-1);o<0?o=s.length-1:o==s.length&&(o=0),dom.hideElement(n),dom.showElement(s[o]);const a=e.querySelector(".number");a&&(a.innerText=`${o+1} / ${s.length}`);break}}},openTab:function(e,t){const s="w3-border-red",i=e.getElementsByClassName("tablink");for(const e of i)e.dataset.id==t?e.classList.add(s):e.classList.remove(s);const n=e.querySelectorAll("div[data-tab]");for(const e of n)e.dataset.tab==t?dom.showElement(e):dom.hideElement(e)},markdown:le,markdowne:function(e,t){return e?de(le(e,t)):""},tomarkdown:function(e){const t=(new DOMParser).parseFromString(e.innerHTML,"text/html");let s="";for(const e of t.body.children)switch(e.nodeName){case"#text":s+=e.textContent;break;case"P":s+=e.innerText;break;case"H6":s+="#";case"H5":s+="#";case"H4":s+="#";case"H3":s+="#";case"H2":s+="#";case"H1":s+="# "+e.innerText}return s},renderEmojis:de,escapeTags:function(e){return e.replace(/(&nbsp;|<([^>]+)>)/gi,"")},escape:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},icon:function(e,...t){if(!e)return"";const s=t.pop(),i=s?` style="color:${s}"`:"";let[n,o]=/^f[0-9a-f]{3}/.test(e)?[` value="${String.fromCodePoint(parseInt(e,16))}"`,""]:["",` ${e}`];return t.length>0&&(o+=" "+t.join(" ")),`<i class="fa${o}"${n}${i}></i>`},color:function(e){return e?`color:${e}`:""},attr:(e,t)=>t?`${e}="${t}"`:"",length:e=>e?e.length():0,logoFromLink:e=>new URL(e).origin+"/favicon.ico",option(e,...t){let s="";const i=(e,t)=>`<option value="${e}" ${e==t?"selected":""}>${e.capitalizeFirstLetter()}</option>`;for(let n of t)if("function"==typeof n&&(n=n()),Array.isArray(n))for(let t of n)s+=i(t,e);else s+=i(n,e);return s},radio(e,...t){let s="",i=!0;const n=(t,s)=>{const n=`<input type="radio" name="${e}" value="${t}" ${i?"checked":""}><label class="radio">${t.capitalizeFirstLetter()}</label>`;return i=!1,n};for(let e of t)if("function"==typeof e&&(e=e()),Array.isArray(e))for(let t of e)s+=n(t);else s+=n(e);return s}};__webpack_require__(831),__webpack_require__(489);function he(e,t=1024){let s;if("number"==typeof e)s=e;else{s=(Array.isArray(e)?e:Object.values(e)).reduce(((e,t)=>e+t),0)}if(s<t)return s;const i=e=>e.replace(".0",""),n=t**2;return i(s<n?`${(s/t).toFixed(1)}K`:`${(s/n).toFixed(1)}M`)}Object.assign(window,{isPromise:function(e){return null!==e&&"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch},delayResolve:async function(e,t=1200){const s=new Promise(((e,s)=>{setTimeout(e,t)}));return await Promise.all([e,s]),e},sleep:function(e){return new Promise((t=>setTimeout(t,e)))},clamp:function(e,t,s){return e<=t?t:e>=s?s:e},unclamp:function(e,t,s=-t){return e>t||e<s?e:Math.sign(e)*t},size:he,time:function(e){const t=e?new Date(1e3*e):new Date,s=t.getHours(),i=t.getMinutes();return`${s>9?s:"0"+s}:${i>9?i:"0"+i}`},percent:function(e){return`${Math.floor(100*e)}%`},randInt:function(e,t){return Math.floor((t-e)*Math.random())+e},count:e=>he(e,1e3),indexName:function(e,t,s){return"number"==typeof t?e=s?`${s}[${t}].${e}`:`${e}[${t}]`:s&&(e=s+"."+e),e},dataset:function(e,t){return void 0!==t?`data-${e}="${t}"`:""},join:function(...e){let t=e.join("/").replace(/\/+/g,"/");return t.endsWith("/")?t.slice(0,-1):t}});__webpack_require__(976),__webpack_require__(910);const ue=["Blues","Classic Rock","Country","Dance","Disco","Funk","Grunge","Hip-Hop","Jazz","Metal","New Age","Oldies","Other","Pop","R&B","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death Metal","Pranks","Soundtrack","Euro-Techno","Ambient","Trip-Hop","Vocal","Jazz+Funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound Clip","Gospel","Noise","AlternRock","Bass","Soul","Punk","Space","Meditative","Instrumental Pop","Instrumental Rock","Ethnic","Gothic","Darkwave","Techno-Industrial","Electronic","Pop-Folk","Eurodance","Dream","Southern Rock","Comedy","Cult","Gangsta Rap","Top 40","Christian Rap","Pop / Funk","Jungle","Native American","Cabaret","New Wave","Psychedelic","Rave","Showtunes","Trailer","Lo-Fi","Tribal","Acid Punk","Acid Jazz","Polka","Retro","Musical","Rock & Roll","Hard Rock","Folk","Folk-Rock","National Folk","Swing","Fast  Fusion","Bebob","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic Rock","Progressive Rock","Psychedelic Rock","Symphonic Rock","Slow Rock","Big Band","Chorus","Easy Listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber Music","Sonata","Symphony","Booty Bass","Primus","Porn Groove","Satire","Slow Jam","Club","Tango","Samba","Folklore","Ballad","Power Ballad","Rhythmic Soul","Freestyle","Duet","Punk Rock","Drum Solo","A Cappella","Euro-House","Dance Hall","Goa","Drum & Bass","Club-House","Hardcore","Terror","Indie","BritPop","Negerpunk","Polsk Punk","Beat","Christian Gangsta Rap","Heavy Metal","Black Metal","Crossover","Contemporary Christian","Christian Rock","Merengue","Salsa","Thrash Metal","Anime","JPop","Synthpop","Rock/Pop"];function pe(e,t,s=0,i){let n=t||e.byteLength-s;const o="undefined"!=typeof Buffer;n<0&&(n+=e.byteLength);const a=[],r=s+n;for(let t=s;t<r;t++){const s=e.getUint8(t);if(0===s)break;a.push(s)}if(o)return Buffer.from(a).toString();const c=a.map((e=>String.fromCharCode(e))).join("");return i?c:decodeURIComponent(escape(c))}function me(e,t,s=0,i){let n=!1,o=t||e.byteLength-s;const a=[],r="undefined"!=typeof Buffer;if(o<0&&(o+=e.byteLength),s+1>e.byteLength)return"";if(i){65534===e.getUint16(s)&&(n=!0),s+=2,o-=2}const c=s+o;for(let t=s;t<c;t+=2){let s=e.getUint16(t,n);if(t<c-1&&0===s&&0===e.getUint16(t+1,n))break;s>=0&&s<=55295||s>=57344&&s<=65535?a.push(s):s>=65536&&s<=1114111&&(s-=65536,a.push(55296+((1047552&s)>>10)),a.push(56320+(1023&s)))}if(r){const e=Buffer.alloc(2*a.length);for(let t=0;t<a.length;t++){const s=a[t];n?e.writeUInt16LE(s,2*t):e.writeUInt16BE(s,2*t)}return e.toString()}return String.fromCharCode.apply(null,new Uint16Array(a))}function ge(e){let t=0,s=2130706432;for(;s;)t>>=1,t|=e&s,s>>=8;return t}function fe(e,t=0){return ge(e.getUint32(t))}function we(e,t=0,s){return s?e.getUint8(t)+(e.getUint8(t+1)<<8)+(e.getUint8(t+2)<<16):e.getUint8(t+2)+(e.getUint8(t+1)<<8)+(e.getUint8(t)<<16)}const ye=new Map([["TALB","album"],["TBPM","bpm"],["TCOM","composer"],["TCON","genre"],["TCOP","copyright"],["TDEN","encoding-time"],["TDLY","playlist-delay"],["TDOR","original-release-time"],["TDRC","recording-time"],["TDRL","release-time"],["TDTG","tagging-time"],["TENC","encoder"],["TEXT","writer"],["TFLT","file-type"],["TIPL","involved-people"],["TIT1","content-group"],["TIT2","title"],["TIT3","subtitle"],["TKEY","initial-key"],["TLAN","language"],["TLEN","length"],["TMCL","credits"],["TMED","media-type"],["TMOO","mood"],["TOAL","original-album"],["TOFN","original-filename"],["TOLY","original-writer"],["TOPE","original-artist"],["TOWN","owner"],["TPE1","artist"],["TPE2","band"],["TPE3","conductor"],["TPE4","remixer"],["TPOS","set-part"],["TPRO","produced-notice"],["TPUB","publisher"],["TRCK","track"],["TRSN","radio-name"],["TRSO","radio-owner"],["TSOA","album-sort"],["TSOP","performer-sort"],["TSOT","title-sort"],["TSRC","isrc"],["TSSE","encoder-settings"],["TSST","set-subtitle"],["TYER","year"],["TAL","album"],["TBP","bpm"],["TCM","composer"],["TCO","genre"],["TCR","copyright"],["TDY","playlist-delay"],["TEN","encoder"],["TFT","file-type"],["TKE","initial-key"],["TLA","language"],["TLE","length"],["TMT","media-type"],["TOA","original-artist"],["TOF","original-filename"],["TOL","original-writer"],["TOT","original-album"],["TP1","artist"],["TP2","band"],["TP3","conductor"],["TP4","remixer"],["TPA","set-part"],["TPB","publisher"],["TRC","isrc"],["TRK","track"],["TSS","encoder-settings"],["TT1","content-group"],["TT2","title"],["TT3","subtitle"],["TXT","writer"],["TYE","year"],["WCOM","url-commercial"],["WCOP","url-legal"],["WOAF","url-file"],["WOAR","url-artist"],["WOAS","url-source"],["WORS","url-radio"],["WPAY","url-payment"],["WPUB","url-publisher"],["WAF","url-file"],["WAR","url-artist"],["WAS","url-source"],["WCM","url-commercial"],["WCP","url-copyright"],["WPB","url-publisher"],["COMM","comments"],["APIC","image"],["PIC","image"],["PRIV","private"]]),be=["other","file-icon","icon","cover-front","cover-back","leaflet","media","artist-lead","artist","conductor","band","composer","writer","location","during-recording","during-performance","screen","fish","illustration","logo-band","logo-publisher"];function ve(e,t,s){s=s||0,t=t||4;const i={id:null,tag:null,value:null},n=new DataView(e);if(t<3)return function(e){const t={id:null,tag:null,value:null},s=new DataView(e),i={id:pe(s,3),type:pe(s,1),size:we(s,3)},n=ye.get(i.id);if(!n)return null;if(t.id=i.id,t.tag=n,"T"===i.type){let e=pe(s,-7,7);"TCO"===i.id&&parseInt(e)&&(e=ue[parseInt(e)]),t.value=e}else if("W"===i.type)t.value=pe(s,-7,7);else if("COM"===i.id){let e=pe(s,-10,10);-1!==e.indexOf("\0")&&(e=e.substr(e.indexOf("\0")+1)),t.value=e}else if("PIC"===i.id){const i={type:null,mime:"image/"+pe(s,3,7).toLowerCase(),description:null,data:null};i.type=be[s.getUint8(11)]||"other";const n=11;let o=0;for(let e=n;;e++)if(0===s.getUint8(e)){o=e-n;break}i.description=0===o?null:pe(s,o,n),i.data=e.slice(n+1),t.value=i}return t.tag?t:null}(e);const o={id:pe(n,4),type:pe(n,1),size:fe(n,4),flags:[n.getUint8(8),n.getUint8(9)]};if(0!==o.flags[1])return null;const a=ye.get(o.id);if(!a)return null;if(i.tag=a,i.id=o.id,"T"===o.type){const e=n.getUint8(10);let t=null;0===e||3===e?t=pe(n,-11,11):1===e?t=me(n,-11,11,!0):2===e&&(t=me(n,-11,11)),"TCON"===o.id&&null!==t&&parseInt(t)&&(t=ue[parseInt(t)]),i.value=t}else if("W"===o.type)i.value=pe(n,-10,10);else if("PRIV"===o.id){const t=10;let s=0;for(let e=0;;e++)if(0===n.getUint8(e)){s=e-t;break}i.value={identifier:0===s?null:pe(n,s,t),data:e.slice(s+t+1)}}else if("COMM"===o.id){const e=n.getUint8(10);let t=14;for(let s=t;;s++)if(1===e||2===e){if(0===n.getUint16(s)){t=s+2;break}s++}else if(0===n.getUint8(s)){t=s+1;break}0===e||3===e?i.value=pe(n,-1*t,t):1===e?i.value=me(n,-1*t,t,!0):2===e&&(i.value=me(n,-1*t,t))}else if("APIC"===o.id){const t=n.getUint8(10),s={type:null,mime:null,description:null,data:null};let o=11,a=0;for(let e=o;;e++)if(0===n.getUint8(e)){a=e-o;break}s.mime=pe(n,a,o),s.type=be[n.getUint8(o+a+1)]||"other",o+=a+2,a=0;for(let e=o;;e++)if(0===n.getUint8(e)){a=e-o;break}0!==a&&(0===t||3===t?s.description=pe(n,a,o):1===t?s.description=me(n,a,o,!0):2===t&&(s.description=me(n,a,o))),s.data=e.slice(o+1),i.value=s}return i.tag?i:null}class ke{constructor(){this.size=0}async close(){}async readBlob(e,t=0,s="application/octet-stream"){const i=await this.read(e,t);return new Blob([i],{type:s})}}class _e extends ke{constructor(e){super(),this._file=e}async open(){this.size=this._file.size}async read(e,t){const s=this._file.slice(t,t+e);return new Promise(((e,t)=>{const i=new FileReader;i.onload=()=>{e(i.result)},i.onerror=()=>{t(new Error("File read failed"))},i.readAsArrayBuffer(s)}))}}const xe="undefined"!=typeof window&&"File"in window&&"FileReader"in window&&"undefined"!=typeof ArrayBuffer;async function Ce(e){await e.open();const t=await async function(e){let t=null;const s=await e.read(128,e.size-128),i=new DataView(s);128===s.byteLength&&"TAG"===pe(i,3,void 0,!0)&&(t={kind:"v1",title:pe(i,30,3).trim()||null,album:pe(i,30,63).trim()||null,artist:pe(i,30,33).trim()||null,year:pe(i,4,93).trim()||null,genre:null,comment:null,track:null},0===i.getUint8(125)?(t.comment=pe(i,28,97),t.version=1.1,t.track=i.getUint8(126)):t.comment=pe(i,30,97),t.genre=ue[i.getUint8(127)]||null);const n=await e.read(14,0),o=new DataView(n);if(14===n.byteLength&&"ID3"===pe(o,3,void 0,!0)&&o.getUint8(3)<=4){let s=10,i=0;const n=[o.getUint8(3),o.getUint8(4)],a=o.getUint8(5);if(!(128&a)){t={kind:"v2",title:t?t.title:null,album:t?t.album:null,artist:t?t.artist:null,year:t?t.year:null,version:n,frames:[],images:[]},64&a&&(s+=fe(o,11)),i+=fe(o,6);const r=await e.read(i,s),c=new DataView(r);let l=0;for(;l<r.byteLength;){let e,s=!0;for(let e=0;e<3;e++){const t=c.getUint8(l+e);(t<65||t>90)&&(t<48||t>57)&&(s=!1)}if(!s)break;e=n[0]<3?r.slice(l,l+6+we(c,l+3)):3===n[0]?r.slice(l,l+10+c.getUint32(l+4)):r.slice(l,l+10+fe(c,l+4));const i=await ve(e,n[0],n[1]);if(i&&i.tag){const e=t;e.frames.push(i),"image"===i.tag?e.images.push(i.value):t[i.tag]=i.value}l+=e.byteLength}}}return t}(e);return await e.close(),t}const Ee=new Set(["c","cc","cpp","js","json","yml","yaml","py","sh","wsdl"]);function Se(e){let t;if(e instanceof File)t=e.name;else if(/^http(s)?:/.test(e)){t=new URL(e).pathname}else t=e;const s=t.lastIndexOf(".");if(-1==s){if(/^data/.test(t)){return[null,t.slice(5).split(";")[0].split("/")[1]]}return[t,""]}return[t.slice(0,s),t.slice(s+1).toLowerCase()]}function Te(e){return["jpg","jpeg","png","svg","gif"].includes(e.toLowerCase())}function Ae(e){return["mp3","flac","ogg"].includes(e)}function Le(e){return["mp4","mkv","webm"].includes(e)}function je(e){let[t,s]=e.split("/");if("application"===t){switch(s){case"x-bzip":case"gzip":s="zip";break;case"x-shellscript":case"x-yaml":case"json":s="text"}return s}return t}window.fileX={getExtension:e=>Se(e)[1],getName:e=>Se(e)[0],getFilename:Se,getType:je,getTypeFromExtension:function(e){return Ae(e)?"audio":Le(e)?"video":Te(e)?"image":Ee.has(e)?"text":void 0},getTypeFromFilename(e){return this.getTypeFromExtension(this.getExtension(e))},getMimeType:function(e){switch(e){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"svg":return"image/svg";case"gif":return"image/gif";case"bz2":return"application/x-bzip2";case"gz":return"application/gzip";case"zip":return"application/zip";case"json":return"application/json";case"mp3":return"audio/mpeg";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"webm":return"video/webm"}},getDuration:function(e){return(t=e,(t-(t%=60))/60+(9<t?":":":0")+t).split(".")[0];var t},getRating:function(e){return Math.floor((e.rating||0)/10).toString()},getDescriptionFromMeta:function(e){if(!e.meta){let t="";return e.artist&&(t+=e.artist),e.album&&(t&&(t+=" - "),t+=e.album),e.year&&(t+=` (${e.year})`),t=t.trim(),t||"Unknown"}let t="";const s=e.meta;return s.album&&(t=s.year?`${s.album} - ${s.year}`:s.album),t},getTitleFromMeta:function(e,t=!0){const s=e.title||e.name||e.filename||e.file.name;if(!e.meta)return fileX.getName(s);let i;const n=e.meta;if(n.title)i=n.artist&&t?`${n.title} - ${n.artist}`:n.title;else{if(!n.artist)return fileX.getName(s);i=n.artist}return i},isImage:Te,isAudio:Ae,isVideo:Le,isMedia:function(e){return Ae(e)||Le(e)},formatSize:function(e){if(e<1024)return`${e.toString()} B`;let t,s;return e<1048576?(s=e/1024,t="K"):(s=e/1048576,t="M"),s=s.toFixed(1),`${s.endsWith(".0")?s.slice(0,-2):s} ${t}`},readFile:function(e){return new Promise(((t,s)=>{const i=new FileReader;i.onerror=s,i.onload=()=>{const e=i.result;t(e)},i.readAsText(e)}))},getFileType(e){return e.type?je(e.type):this.getTypeFromFilename(e.name)},getMeta:async function(e){const t=e.name;let s,i={};const[n,o]=Se(t);if((s=n.match(/^\s*(\d{1,2})[\s-_.]*(.*)(\.\w+)?$/))&&(i={title:s[2],track:parseInt(s[1])}),"mp3"==o)try{const t=await function(e){if(!xe)throw new Error("Browser does not have support for the File API and/or ArrayBuffers");return Ce(new _e(e))}(e);if(console.log(t),t){const e=Object.fromEntries(Object.entries(t).filter((([e,t])=>null!=t)));if(e.track&&"string"==typeof e.track){const s=t.track.match(/^([0-9]{1,2}).*/);s&&(e.track=parseInt(s[1]))}Object.assign(i,e)}}catch(t){console.log("Failed to load meta info for mp3 file:",e.name)}return i}};function Ie(e){let t=e.length;for(;--t>=0;)e[t]=0}const De=256,Me=286,Oe=30,Pe=15,Re=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),$e=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),ze=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Be=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ne=new Array(576);Ie(Ne);const Fe=new Array(60);Ie(Fe);const qe=new Array(512);Ie(qe);const Ue=new Array(256);Ie(Ue);const He=new Array(29);Ie(He);const We=new Array(Oe);function Ve(e,t,s,i,n){this.static_tree=e,this.extra_bits=t,this.extra_base=s,this.elems=i,this.max_length=n,this.has_stree=e&&e.length}let Xe,Ge,Ye;function Ke(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}Ie(We);const Ze=e=>e<256?qe[e]:qe[256+(e>>>7)],Je=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},Qe=(e,t,s)=>{e.bi_valid>16-s?(e.bi_buf|=t<<e.bi_valid&65535,Je(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=s-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=s)},et=(e,t,s)=>{Qe(e,s[2*t],s[2*t+1])},tt=(e,t)=>{let s=0;do{s|=1&e,e>>>=1,s<<=1}while(--t>0);return s>>>1},st=(e,t,s)=>{const i=new Array(16);let n,o,a=0;for(n=1;n<=Pe;n++)i[n]=a=a+s[n-1]<<1;for(o=0;o<=t;o++){let t=e[2*o+1];0!==t&&(e[2*o]=tt(i[t]++,t))}},it=e=>{let t;for(t=0;t<Me;t++)e.dyn_ltree[2*t]=0;for(t=0;t<Oe;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0},nt=e=>{e.bi_valid>8?Je(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},ot=(e,t,s,i)=>{const n=2*t,o=2*s;return e[n]<e[o]||e[n]===e[o]&&i[t]<=i[s]},at=(e,t,s)=>{const i=e.heap[s];let n=s<<1;for(;n<=e.heap_len&&(n<e.heap_len&&ot(t,e.heap[n+1],e.heap[n],e.depth)&&n++,!ot(t,i,e.heap[n],e.depth));)e.heap[s]=e.heap[n],s=n,n<<=1;e.heap[s]=i},rt=(e,t,s)=>{let i,n,o,a,r=0;if(0!==e.last_lit)do{i=e.pending_buf[e.d_buf+2*r]<<8|e.pending_buf[e.d_buf+2*r+1],n=e.pending_buf[e.l_buf+r],r++,0===i?et(e,n,t):(o=Ue[n],et(e,o+De+1,t),a=Re[o],0!==a&&(n-=He[o],Qe(e,n,a)),i--,o=Ze(i),et(e,o,s),a=$e[o],0!==a&&(i-=We[o],Qe(e,i,a)))}while(r<e.last_lit);et(e,256,t)},ct=(e,t)=>{const s=t.dyn_tree,i=t.stat_desc.static_tree,n=t.stat_desc.has_stree,o=t.stat_desc.elems;let a,r,c,l=-1;for(e.heap_len=0,e.heap_max=573,a=0;a<o;a++)0!==s[2*a]?(e.heap[++e.heap_len]=l=a,e.depth[a]=0):s[2*a+1]=0;for(;e.heap_len<2;)c=e.heap[++e.heap_len]=l<2?++l:0,s[2*c]=1,e.depth[c]=0,e.opt_len--,n&&(e.static_len-=i[2*c+1]);for(t.max_code=l,a=e.heap_len>>1;a>=1;a--)at(e,s,a);c=o;do{a=e.heap[1],e.heap[1]=e.heap[e.heap_len--],at(e,s,1),r=e.heap[1],e.heap[--e.heap_max]=a,e.heap[--e.heap_max]=r,s[2*c]=s[2*a]+s[2*r],e.depth[c]=(e.depth[a]>=e.depth[r]?e.depth[a]:e.depth[r])+1,s[2*a+1]=s[2*r+1]=c,e.heap[1]=c++,at(e,s,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const s=t.dyn_tree,i=t.max_code,n=t.stat_desc.static_tree,o=t.stat_desc.has_stree,a=t.stat_desc.extra_bits,r=t.stat_desc.extra_base,c=t.stat_desc.max_length;let l,d,h,u,p,m,g=0;for(u=0;u<=Pe;u++)e.bl_count[u]=0;for(s[2*e.heap[e.heap_max]+1]=0,l=e.heap_max+1;l<573;l++)d=e.heap[l],u=s[2*s[2*d+1]+1]+1,u>c&&(u=c,g++),s[2*d+1]=u,d>i||(e.bl_count[u]++,p=0,d>=r&&(p=a[d-r]),m=s[2*d],e.opt_len+=m*(u+p),o&&(e.static_len+=m*(n[2*d+1]+p)));if(0!==g){do{for(u=c-1;0===e.bl_count[u];)u--;e.bl_count[u]--,e.bl_count[u+1]+=2,e.bl_count[c]--,g-=2}while(g>0);for(u=c;0!==u;u--)for(d=e.bl_count[u];0!==d;)h=e.heap[--l],h>i||(s[2*h+1]!==u&&(e.opt_len+=(u-s[2*h+1])*s[2*h],s[2*h+1]=u),d--)}})(e,t),st(s,l,e.bl_count)},lt=(e,t,s)=>{let i,n,o=-1,a=t[1],r=0,c=7,l=4;for(0===a&&(c=138,l=3),t[2*(s+1)+1]=65535,i=0;i<=s;i++)n=a,a=t[2*(i+1)+1],++r<c&&n===a||(r<l?e.bl_tree[2*n]+=r:0!==n?(n!==o&&e.bl_tree[2*n]++,e.bl_tree[32]++):r<=10?e.bl_tree[34]++:e.bl_tree[36]++,r=0,o=n,0===a?(c=138,l=3):n===a?(c=6,l=3):(c=7,l=4))},dt=(e,t,s)=>{let i,n,o=-1,a=t[1],r=0,c=7,l=4;for(0===a&&(c=138,l=3),i=0;i<=s;i++)if(n=a,a=t[2*(i+1)+1],!(++r<c&&n===a)){if(r<l)do{et(e,n,e.bl_tree)}while(0!=--r);else 0!==n?(n!==o&&(et(e,n,e.bl_tree),r--),et(e,16,e.bl_tree),Qe(e,r-3,2)):r<=10?(et(e,17,e.bl_tree),Qe(e,r-3,3)):(et(e,18,e.bl_tree),Qe(e,r-11,7));r=0,o=n,0===a?(c=138,l=3):n===a?(c=6,l=3):(c=7,l=4)}};let ht=!1;const ut=(e,t,s,i)=>{Qe(e,0+(i?1:0),3),((e,t,s,i)=>{nt(e),i&&(Je(e,s),Je(e,~s)),e.pending_buf.set(e.window.subarray(t,t+s),e.pending),e.pending+=s})(e,t,s,!0)};var pt=(e,t,s,i)=>{let n,o,a=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,s=4093624447;for(t=0;t<=31;t++,s>>>=1)if(1&s&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<De;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),ct(e,e.l_desc),ct(e,e.d_desc),a=(e=>{let t;for(lt(e,e.dyn_ltree,e.l_desc.max_code),lt(e,e.dyn_dtree,e.d_desc.max_code),ct(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*Be[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),n=e.opt_len+3+7>>>3,o=e.static_len+3+7>>>3,o<=n&&(n=o)):n=o=s+5,s+4<=n&&-1!==t?ut(e,t,s,i):4===e.strategy||o===n?(Qe(e,2+(i?1:0),3),rt(e,Ne,Fe)):(Qe(e,4+(i?1:0),3),((e,t,s,i)=>{let n;for(Qe(e,t-257,5),Qe(e,s-1,5),Qe(e,i-4,4),n=0;n<i;n++)Qe(e,e.bl_tree[2*Be[n]+1],3);dt(e,e.dyn_ltree,t-1),dt(e,e.dyn_dtree,s-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,a+1),rt(e,e.dyn_ltree,e.dyn_dtree)),it(e),i&&nt(e)},mt={_tr_init:e=>{ht||((()=>{let e,t,s,i,n;const o=new Array(16);for(s=0,i=0;i<28;i++)for(He[i]=s,e=0;e<1<<Re[i];e++)Ue[s++]=i;for(Ue[s-1]=i,n=0,i=0;i<16;i++)for(We[i]=n,e=0;e<1<<$e[i];e++)qe[n++]=i;for(n>>=7;i<Oe;i++)for(We[i]=n<<7,e=0;e<1<<$e[i]-7;e++)qe[256+n++]=i;for(t=0;t<=Pe;t++)o[t]=0;for(e=0;e<=143;)Ne[2*e+1]=8,e++,o[8]++;for(;e<=255;)Ne[2*e+1]=9,e++,o[9]++;for(;e<=279;)Ne[2*e+1]=7,e++,o[7]++;for(;e<=287;)Ne[2*e+1]=8,e++,o[8]++;for(st(Ne,287,o),e=0;e<Oe;e++)Fe[2*e+1]=5,Fe[2*e]=tt(e,5);Xe=new Ve(Ne,Re,257,Me,Pe),Ge=new Ve(Fe,$e,0,Oe,Pe),Ye=new Ve(new Array(0),ze,0,19,7)})(),ht=!0),e.l_desc=new Ke(e.dyn_ltree,Xe),e.d_desc=new Ke(e.dyn_dtree,Ge),e.bl_desc=new Ke(e.bl_tree,Ye),e.bi_buf=0,e.bi_valid=0,it(e)},_tr_stored_block:ut,_tr_flush_block:pt,_tr_tally:(e,t,s)=>(e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&s,e.last_lit++,0===t?e.dyn_ltree[2*s]++:(e.matches++,t--,e.dyn_ltree[2*(Ue[s]+De+1)]++,e.dyn_dtree[2*Ze(t)]++),e.last_lit===e.lit_bufsize-1),_tr_align:e=>{Qe(e,2,3),et(e,256,Ne),(e=>{16===e.bi_valid?(Je(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)}};var gt=(e,t,s,i)=>{let n=65535&e,o=e>>>16&65535,a=0;for(;0!==s;){a=s>2e3?2e3:s,s-=a;do{n=n+t[i++]|0,o=o+n|0}while(--a);n%=65521,o%=65521}return n|o<<16};const ft=new Uint32Array((()=>{let e,t=[];for(var s=0;s<256;s++){e=s;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[s]=e}return t})());var wt=(e,t,s,i)=>{const n=ft,o=i+s;e^=-1;for(let s=i;s<o;s++)e=e>>>8^n[255&(e^t[s])];return~e},yt={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},bt={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:vt,_tr_stored_block:kt,_tr_flush_block:_t,_tr_tally:xt,_tr_align:Ct}=mt,{Z_NO_FLUSH:Et,Z_PARTIAL_FLUSH:St,Z_FULL_FLUSH:Tt,Z_FINISH:At,Z_BLOCK:Lt,Z_OK:jt,Z_STREAM_END:It,Z_STREAM_ERROR:Dt,Z_DATA_ERROR:Mt,Z_BUF_ERROR:Ot,Z_DEFAULT_COMPRESSION:Pt,Z_FILTERED:Rt,Z_HUFFMAN_ONLY:$t,Z_RLE:zt,Z_FIXED:Bt,Z_DEFAULT_STRATEGY:Nt,Z_UNKNOWN:Ft,Z_DEFLATED:qt}=bt,Ut=258,Ht=262,Wt=103,Vt=113,Xt=666,Gt=(e,t)=>(e.msg=yt[t],t),Yt=e=>(e<<1)-(e>4?9:0),Kt=e=>{let t=e.length;for(;--t>=0;)e[t]=0};let Zt=(e,t,s)=>(t<<e.hash_shift^s)&e.hash_mask;const Jt=e=>{const t=e.state;let s=t.pending;s>e.avail_out&&(s=e.avail_out),0!==s&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+s),e.next_out),e.next_out+=s,t.pending_out+=s,e.total_out+=s,e.avail_out-=s,t.pending-=s,0===t.pending&&(t.pending_out=0))},Qt=(e,t)=>{_t(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Jt(e.strm)},es=(e,t)=>{e.pending_buf[e.pending++]=t},ts=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},ss=(e,t,s,i)=>{let n=e.avail_in;return n>i&&(n=i),0===n?0:(e.avail_in-=n,t.set(e.input.subarray(e.next_in,e.next_in+n),s),1===e.state.wrap?e.adler=gt(e.adler,t,n,s):2===e.state.wrap&&(e.adler=wt(e.adler,t,n,s)),e.next_in+=n,e.total_in+=n,n)},is=(e,t)=>{let s,i,n=e.max_chain_length,o=e.strstart,a=e.prev_length,r=e.nice_match;const c=e.strstart>e.w_size-Ht?e.strstart-(e.w_size-Ht):0,l=e.window,d=e.w_mask,h=e.prev,u=e.strstart+Ut;let p=l[o+a-1],m=l[o+a];e.prev_length>=e.good_match&&(n>>=2),r>e.lookahead&&(r=e.lookahead);do{if(s=t,l[s+a]===m&&l[s+a-1]===p&&l[s]===l[o]&&l[++s]===l[o+1]){o+=2,s++;do{}while(l[++o]===l[++s]&&l[++o]===l[++s]&&l[++o]===l[++s]&&l[++o]===l[++s]&&l[++o]===l[++s]&&l[++o]===l[++s]&&l[++o]===l[++s]&&l[++o]===l[++s]&&o<u);if(i=Ut-(u-o),o=u-Ut,i>a){if(e.match_start=t,a=i,i>=r)break;p=l[o+a-1],m=l[o+a]}}}while((t=h[t&d])>c&&0!=--n);return a<=e.lookahead?a:e.lookahead},ns=e=>{const t=e.w_size;let s,i,n,o,a;do{if(o=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-Ht)){e.window.set(e.window.subarray(t,t+t),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,i=e.hash_size,s=i;do{n=e.head[--s],e.head[s]=n>=t?n-t:0}while(--i);i=t,s=i;do{n=e.prev[--s],e.prev[s]=n>=t?n-t:0}while(--i);o+=t}if(0===e.strm.avail_in)break;if(i=ss(e.strm,e.window,e.strstart+e.lookahead,o),e.lookahead+=i,e.lookahead+e.insert>=3)for(a=e.strstart-e.insert,e.ins_h=e.window[a],e.ins_h=Zt(e,e.ins_h,e.window[a+1]);e.insert&&(e.ins_h=Zt(e,e.ins_h,e.window[a+3-1]),e.prev[a&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=a,a++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Ht&&0!==e.strm.avail_in)},os=(e,t)=>{let s,i;for(;;){if(e.lookahead<Ht){if(ns(e),e.lookahead<Ht&&t===Et)return 1;if(0===e.lookahead)break}if(s=0,e.lookahead>=3&&(e.ins_h=Zt(e,e.ins_h,e.window[e.strstart+3-1]),s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==s&&e.strstart-s<=e.w_size-Ht&&(e.match_length=is(e,s)),e.match_length>=3)if(i=xt(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=Zt(e,e.ins_h,e.window[e.strstart+3-1]),s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=Zt(e,e.ins_h,e.window[e.strstart+1]);else i=xt(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(Qt(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===At?(Qt(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Qt(e,!1),0===e.strm.avail_out)?1:2},as=(e,t)=>{let s,i,n;for(;;){if(e.lookahead<Ht){if(ns(e),e.lookahead<Ht&&t===Et)return 1;if(0===e.lookahead)break}if(s=0,e.lookahead>=3&&(e.ins_h=Zt(e,e.ins_h,e.window[e.strstart+3-1]),s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==s&&e.prev_length<e.max_lazy_match&&e.strstart-s<=e.w_size-Ht&&(e.match_length=is(e,s),e.match_length<=5&&(e.strategy===Rt||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){n=e.strstart+e.lookahead-3,i=xt(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=n&&(e.ins_h=Zt(e,e.ins_h,e.window[e.strstart+3-1]),s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,i&&(Qt(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(i=xt(e,0,e.window[e.strstart-1]),i&&Qt(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=xt(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===At?(Qt(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Qt(e,!1),0===e.strm.avail_out)?1:2};function rs(e,t,s,i,n){this.good_length=e,this.max_lazy=t,this.nice_length=s,this.max_chain=i,this.func=n}const cs=[new rs(0,0,0,0,((e,t)=>{let s=65535;for(s>e.pending_buf_size-5&&(s=e.pending_buf_size-5);;){if(e.lookahead<=1){if(ns(e),0===e.lookahead&&t===Et)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;const i=e.block_start+s;if((0===e.strstart||e.strstart>=i)&&(e.lookahead=e.strstart-i,e.strstart=i,Qt(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-Ht&&(Qt(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===At?(Qt(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(Qt(e,!1),e.strm.avail_out),1)})),new rs(4,4,8,4,os),new rs(4,5,16,8,os),new rs(4,6,32,32,os),new rs(4,4,16,16,as),new rs(8,16,32,32,as),new rs(8,16,128,128,as),new rs(8,32,128,256,as),new rs(32,128,258,1024,as),new rs(32,258,258,4096,as)];function ls(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=qt,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),Kt(this.dyn_ltree),Kt(this.dyn_dtree),Kt(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),Kt(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),Kt(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const ds=e=>{if(!e||!e.state)return Gt(e,Dt);e.total_in=e.total_out=0,e.data_type=Ft;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:Vt,e.adler=2===t.wrap?0:1,t.last_flush=Et,vt(t),jt},hs=e=>{const t=ds(e);var s;return t===jt&&((s=e.state).window_size=2*s.w_size,Kt(s.head),s.max_lazy_match=cs[s.level].max_lazy,s.good_match=cs[s.level].good_length,s.nice_match=cs[s.level].nice_length,s.max_chain_length=cs[s.level].max_chain,s.strstart=0,s.block_start=0,s.lookahead=0,s.insert=0,s.match_length=s.prev_length=2,s.match_available=0,s.ins_h=0),t},us=(e,t,s,i,n,o)=>{if(!e)return Dt;let a=1;if(t===Pt&&(t=6),i<0?(a=0,i=-i):i>15&&(a=2,i-=16),n<1||n>9||s!==qt||i<8||i>15||t<0||t>9||o<0||o>Bt)return Gt(e,Dt);8===i&&(i=9);const r=new ls;return e.state=r,r.strm=e,r.wrap=a,r.gzhead=null,r.w_bits=i,r.w_size=1<<r.w_bits,r.w_mask=r.w_size-1,r.hash_bits=n+7,r.hash_size=1<<r.hash_bits,r.hash_mask=r.hash_size-1,r.hash_shift=~~((r.hash_bits+3-1)/3),r.window=new Uint8Array(2*r.w_size),r.head=new Uint16Array(r.hash_size),r.prev=new Uint16Array(r.w_size),r.lit_bufsize=1<<n+6,r.pending_buf_size=4*r.lit_bufsize,r.pending_buf=new Uint8Array(r.pending_buf_size),r.d_buf=1*r.lit_bufsize,r.l_buf=3*r.lit_bufsize,r.level=t,r.strategy=o,r.method=s,hs(e)};var ps=(e,t)=>{let s,i;if(!e||!e.state||t>Lt||t<0)return e?Gt(e,Dt):Dt;const n=e.state;if(!e.output||!e.input&&0!==e.avail_in||n.status===Xt&&t!==At)return Gt(e,0===e.avail_out?Ot:Dt);n.strm=e;const o=n.last_flush;if(n.last_flush=t,42===n.status)if(2===n.wrap)e.adler=0,es(n,31),es(n,139),es(n,8),n.gzhead?(es(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),es(n,255&n.gzhead.time),es(n,n.gzhead.time>>8&255),es(n,n.gzhead.time>>16&255),es(n,n.gzhead.time>>24&255),es(n,9===n.level?2:n.strategy>=$t||n.level<2?4:0),es(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(es(n,255&n.gzhead.extra.length),es(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=wt(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69):(es(n,0),es(n,0),es(n,0),es(n,0),es(n,0),es(n,9===n.level?2:n.strategy>=$t||n.level<2?4:0),es(n,3),n.status=Vt);else{let t=qt+(n.w_bits-8<<4)<<8,s=-1;s=n.strategy>=$t||n.level<2?0:n.level<6?1:6===n.level?2:3,t|=s<<6,0!==n.strstart&&(t|=32),t+=31-t%31,n.status=Vt,ts(n,t),0!==n.strstart&&(ts(n,e.adler>>>16),ts(n,65535&e.adler)),e.adler=1}if(69===n.status)if(n.gzhead.extra){for(s=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>s&&(e.adler=wt(e.adler,n.pending_buf,n.pending-s,s)),Jt(e),s=n.pending,n.pending!==n.pending_buf_size));)es(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>s&&(e.adler=wt(e.adler,n.pending_buf,n.pending-s,s)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=73)}else n.status=73;if(73===n.status)if(n.gzhead.name){s=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>s&&(e.adler=wt(e.adler,n.pending_buf,n.pending-s,s)),Jt(e),s=n.pending,n.pending===n.pending_buf_size)){i=1;break}i=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,es(n,i)}while(0!==i);n.gzhead.hcrc&&n.pending>s&&(e.adler=wt(e.adler,n.pending_buf,n.pending-s,s)),0===i&&(n.gzindex=0,n.status=91)}else n.status=91;if(91===n.status)if(n.gzhead.comment){s=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>s&&(e.adler=wt(e.adler,n.pending_buf,n.pending-s,s)),Jt(e),s=n.pending,n.pending===n.pending_buf_size)){i=1;break}i=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,es(n,i)}while(0!==i);n.gzhead.hcrc&&n.pending>s&&(e.adler=wt(e.adler,n.pending_buf,n.pending-s,s)),0===i&&(n.status=Wt)}else n.status=Wt;if(n.status===Wt&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&Jt(e),n.pending+2<=n.pending_buf_size&&(es(n,255&e.adler),es(n,e.adler>>8&255),e.adler=0,n.status=Vt)):n.status=Vt),0!==n.pending){if(Jt(e),0===e.avail_out)return n.last_flush=-1,jt}else if(0===e.avail_in&&Yt(t)<=Yt(o)&&t!==At)return Gt(e,Ot);if(n.status===Xt&&0!==e.avail_in)return Gt(e,Ot);if(0!==e.avail_in||0!==n.lookahead||t!==Et&&n.status!==Xt){let s=n.strategy===$t?((e,t)=>{let s;for(;;){if(0===e.lookahead&&(ns(e),0===e.lookahead)){if(t===Et)return 1;break}if(e.match_length=0,s=xt(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,s&&(Qt(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===At?(Qt(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Qt(e,!1),0===e.strm.avail_out)?1:2})(n,t):n.strategy===zt?((e,t)=>{let s,i,n,o;const a=e.window;for(;;){if(e.lookahead<=Ut){if(ns(e),e.lookahead<=Ut&&t===Et)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(n=e.strstart-1,i=a[n],i===a[++n]&&i===a[++n]&&i===a[++n])){o=e.strstart+Ut;do{}while(i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&n<o);e.match_length=Ut-(o-n),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(s=xt(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(s=xt(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),s&&(Qt(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===At?(Qt(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Qt(e,!1),0===e.strm.avail_out)?1:2})(n,t):cs[n.level].func(n,t);if(3!==s&&4!==s||(n.status=Xt),1===s||3===s)return 0===e.avail_out&&(n.last_flush=-1),jt;if(2===s&&(t===St?Ct(n):t!==Lt&&(kt(n,0,0,!1),t===Tt&&(Kt(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),Jt(e),0===e.avail_out))return n.last_flush=-1,jt}return t!==At?jt:n.wrap<=0?It:(2===n.wrap?(es(n,255&e.adler),es(n,e.adler>>8&255),es(n,e.adler>>16&255),es(n,e.adler>>24&255),es(n,255&e.total_in),es(n,e.total_in>>8&255),es(n,e.total_in>>16&255),es(n,e.total_in>>24&255)):(ts(n,e.adler>>>16),ts(n,65535&e.adler)),Jt(e),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?jt:It)},ms={deflateInit:(e,t)=>us(e,t,qt,15,8,Nt),deflateInit2:us,deflateReset:hs,deflateResetKeep:ds,deflateSetHeader:(e,t)=>e&&e.state?2!==e.state.wrap?Dt:(e.state.gzhead=t,jt):Dt,deflate:ps,deflateEnd:e=>{if(!e||!e.state)return Dt;const t=e.state.status;return 42!==t&&69!==t&&73!==t&&91!==t&&t!==Wt&&t!==Vt&&t!==Xt?Gt(e,Dt):(e.state=null,t===Vt?Gt(e,Mt):jt)},deflateSetDictionary:(e,t)=>{let s=t.length;if(!e||!e.state)return Dt;const i=e.state,n=i.wrap;if(2===n||1===n&&42!==i.status||i.lookahead)return Dt;if(1===n&&(e.adler=gt(e.adler,t,s,0)),i.wrap=0,s>=i.w_size){0===n&&(Kt(i.head),i.strstart=0,i.block_start=0,i.insert=0);let e=new Uint8Array(i.w_size);e.set(t.subarray(s-i.w_size,s),0),t=e,s=i.w_size}const o=e.avail_in,a=e.next_in,r=e.input;for(e.avail_in=s,e.next_in=0,e.input=t,ns(i);i.lookahead>=3;){let e=i.strstart,t=i.lookahead-2;do{i.ins_h=Zt(i,i.ins_h,i.window[e+3-1]),i.prev[e&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=e,e++}while(--t);i.strstart=e,i.lookahead=2,ns(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=a,e.input=r,e.avail_in=o,i.wrap=n,jt},deflateInfo:"pako deflate (from Nodeca project)"};const gs=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var ws={assign:function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const s=t.shift();if(s){if("object"!=typeof s)throw new TypeError(s+"must be non-object");for(const t in s)gs(s,t)&&(e[t]=s[t])}}return e},flattenChunks:e=>{let t=0;for(let s=0,i=e.length;s<i;s++)t+=e[s].length;const s=new Uint8Array(t);for(let t=0,i=0,n=e.length;t<n;t++){let n=e[t];s.set(n,i),i+=n.length}return s}};let ys=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){ys=!1}const bs=new Uint8Array(256);for(let e=0;e<256;e++)bs[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;bs[254]=bs[254]=1;var vs={string2buf:e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,s,i,n,o,a=e.length,r=0;for(n=0;n<a;n++)s=e.charCodeAt(n),55296==(64512&s)&&n+1<a&&(i=e.charCodeAt(n+1),56320==(64512&i)&&(s=65536+(s-55296<<10)+(i-56320),n++)),r+=s<128?1:s<2048?2:s<65536?3:4;for(t=new Uint8Array(r),o=0,n=0;o<r;n++)s=e.charCodeAt(n),55296==(64512&s)&&n+1<a&&(i=e.charCodeAt(n+1),56320==(64512&i)&&(s=65536+(s-55296<<10)+(i-56320),n++)),s<128?t[o++]=s:s<2048?(t[o++]=192|s>>>6,t[o++]=128|63&s):s<65536?(t[o++]=224|s>>>12,t[o++]=128|s>>>6&63,t[o++]=128|63&s):(t[o++]=240|s>>>18,t[o++]=128|s>>>12&63,t[o++]=128|s>>>6&63,t[o++]=128|63&s);return t},buf2string:(e,t)=>{const s=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let i,n;const o=new Array(2*s);for(n=0,i=0;i<s;){let t=e[i++];if(t<128){o[n++]=t;continue}let a=bs[t];if(a>4)o[n++]=65533,i+=a-1;else{for(t&=2===a?31:3===a?15:7;a>1&&i<s;)t=t<<6|63&e[i++],a--;a>1?o[n++]=65533:t<65536?o[n++]=t:(t-=65536,o[n++]=55296|t>>10&1023,o[n++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&ys)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let s="";for(let i=0;i<t;i++)s+=String.fromCharCode(e[i]);return s})(o,n)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let s=t-1;for(;s>=0&&128==(192&e[s]);)s--;return s<0||0===s?t:s+bs[e[s]]>t?s:t}};var ks=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const _s=Object.prototype.toString,{Z_NO_FLUSH:xs,Z_SYNC_FLUSH:Cs,Z_FULL_FLUSH:Es,Z_FINISH:Ss,Z_OK:Ts,Z_STREAM_END:As,Z_DEFAULT_COMPRESSION:Ls,Z_DEFAULT_STRATEGY:js,Z_DEFLATED:Is}=bt;function Ds(e){this.options=ws.assign({level:Ls,method:Is,chunkSize:16384,windowBits:15,memLevel:8,strategy:js},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new ks,this.strm.avail_out=0;let s=ms.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(s!==Ts)throw new Error(yt[s]);if(t.header&&ms.deflateSetHeader(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?vs.string2buf(t.dictionary):"[object ArrayBuffer]"===_s.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,s=ms.deflateSetDictionary(this.strm,e),s!==Ts)throw new Error(yt[s]);this._dict_set=!0}}function Ms(e,t){const s=new Ds(t);if(s.push(e,!0),s.err)throw s.msg||yt[s.err];return s.result}Ds.prototype.push=function(e,t){const s=this.strm,i=this.options.chunkSize;let n,o;if(this.ended)return!1;for(o=t===~~t?t:!0===t?Ss:xs,"string"==typeof e?s.input=vs.string2buf(e):"[object ArrayBuffer]"===_s.call(e)?s.input=new Uint8Array(e):s.input=e,s.next_in=0,s.avail_in=s.input.length;;)if(0===s.avail_out&&(s.output=new Uint8Array(i),s.next_out=0,s.avail_out=i),(o===Cs||o===Es)&&s.avail_out<=6)this.onData(s.output.subarray(0,s.next_out)),s.avail_out=0;else{if(n=ms.deflate(s,o),n===As)return s.next_out>0&&this.onData(s.output.subarray(0,s.next_out)),n=ms.deflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===Ts;if(0!==s.avail_out){if(o>0&&s.next_out>0)this.onData(s.output.subarray(0,s.next_out)),s.avail_out=0;else if(0===s.avail_in)break}else this.onData(s.output)}return!0},Ds.prototype.onData=function(e){this.chunks.push(e)},Ds.prototype.onEnd=function(e){e===Ts&&(this.result=ws.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Os=function(e,t){return(t=t||{}).raw=!0,Ms(e,t)},Ps=function(e,t){return(t=t||{}).gzip=!0,Ms(e,t)},Rs={Deflate:Ds,deflate:Ms,deflateRaw:Os,gzip:Ps,constants:bt};var $s=function(e,t){let s,i,n,o,a,r,c,l,d,h,u,p,m,g,f,w,y,b,v,k,_,x,C,E;const S=e.state;s=e.next_in,C=e.input,i=s+(e.avail_in-5),n=e.next_out,E=e.output,o=n-(t-e.avail_out),a=n+(e.avail_out-257),r=S.dmax,c=S.wsize,l=S.whave,d=S.wnext,h=S.window,u=S.hold,p=S.bits,m=S.lencode,g=S.distcode,f=(1<<S.lenbits)-1,w=(1<<S.distbits)-1;e:do{p<15&&(u+=C[s++]<<p,p+=8,u+=C[s++]<<p,p+=8),y=m[u&f];t:for(;;){if(b=y>>>24,u>>>=b,p-=b,b=y>>>16&255,0===b)E[n++]=65535&y;else{if(!(16&b)){if(64&b){if(32&b){S.mode=12;break e}e.msg="invalid literal/length code",S.mode=30;break e}y=m[(65535&y)+(u&(1<<b)-1)];continue t}for(v=65535&y,b&=15,b&&(p<b&&(u+=C[s++]<<p,p+=8),v+=u&(1<<b)-1,u>>>=b,p-=b),p<15&&(u+=C[s++]<<p,p+=8,u+=C[s++]<<p,p+=8),y=g[u&w];;){if(b=y>>>24,u>>>=b,p-=b,b=y>>>16&255,16&b){if(k=65535&y,b&=15,p<b&&(u+=C[s++]<<p,p+=8,p<b&&(u+=C[s++]<<p,p+=8)),k+=u&(1<<b)-1,k>r){e.msg="invalid distance too far back",S.mode=30;break e}if(u>>>=b,p-=b,b=n-o,k>b){if(b=k-b,b>l&&S.sane){e.msg="invalid distance too far back",S.mode=30;break e}if(_=0,x=h,0===d){if(_+=c-b,b<v){v-=b;do{E[n++]=h[_++]}while(--b);_=n-k,x=E}}else if(d<b){if(_+=c+d-b,b-=d,b<v){v-=b;do{E[n++]=h[_++]}while(--b);if(_=0,d<v){b=d,v-=b;do{E[n++]=h[_++]}while(--b);_=n-k,x=E}}}else if(_+=d-b,b<v){v-=b;do{E[n++]=h[_++]}while(--b);_=n-k,x=E}for(;v>2;)E[n++]=x[_++],E[n++]=x[_++],E[n++]=x[_++],v-=3;v&&(E[n++]=x[_++],v>1&&(E[n++]=x[_++]))}else{_=n-k;do{E[n++]=E[_++],E[n++]=E[_++],E[n++]=E[_++],v-=3}while(v>2);v&&(E[n++]=E[_++],v>1&&(E[n++]=E[_++]))}break}if(64&b){e.msg="invalid distance code",S.mode=30;break e}y=g[(65535&y)+(u&(1<<b)-1)]}}break}}while(s<i&&n<a);v=p>>3,s-=v,p-=v<<3,u&=(1<<p)-1,e.next_in=s,e.next_out=n,e.avail_in=s<i?i-s+5:5-(s-i),e.avail_out=n<a?a-n+257:257-(n-a),S.hold=u,S.bits=p};const zs=15,Bs=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Ns=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Fs=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),qs=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Us=(e,t,s,i,n,o,a,r)=>{const c=r.bits;let l,d,h,u,p,m,g=0,f=0,w=0,y=0,b=0,v=0,k=0,_=0,x=0,C=0,E=null,S=0;const T=new Uint16Array(16),A=new Uint16Array(16);let L,j,I,D=null,M=0;for(g=0;g<=zs;g++)T[g]=0;for(f=0;f<i;f++)T[t[s+f]]++;for(b=c,y=zs;y>=1&&0===T[y];y--);if(b>y&&(b=y),0===y)return n[o++]=20971520,n[o++]=20971520,r.bits=1,0;for(w=1;w<y&&0===T[w];w++);for(b<w&&(b=w),_=1,g=1;g<=zs;g++)if(_<<=1,_-=T[g],_<0)return-1;if(_>0&&(0===e||1!==y))return-1;for(A[1]=0,g=1;g<zs;g++)A[g+1]=A[g]+T[g];for(f=0;f<i;f++)0!==t[s+f]&&(a[A[t[s+f]]++]=f);if(0===e?(E=D=a,m=19):1===e?(E=Bs,S-=257,D=Ns,M-=257,m=256):(E=Fs,D=qs,m=-1),C=0,f=0,g=w,p=o,v=b,k=0,h=-1,x=1<<b,u=x-1,1===e&&x>852||2===e&&x>592)return 1;for(;;){L=g-k,a[f]<m?(j=0,I=a[f]):a[f]>m?(j=D[M+a[f]],I=E[S+a[f]]):(j=96,I=0),l=1<<g-k,d=1<<v,w=d;do{d-=l,n[p+(C>>k)+d]=L<<24|j<<16|I}while(0!==d);for(l=1<<g-1;C&l;)l>>=1;if(0!==l?(C&=l-1,C+=l):C=0,f++,0==--T[g]){if(g===y)break;g=t[s+a[f]]}if(g>b&&(C&u)!==h){for(0===k&&(k=b),p+=w,v=g-k,_=1<<v;v+k<y&&(_-=T[v+k],!(_<=0));)v++,_<<=1;if(x+=1<<v,1===e&&x>852||2===e&&x>592)return 1;h=C&u,n[h]=b<<24|v<<16|p-o}}return 0!==C&&(n[p+C]=g-k<<24|64<<16),r.bits=b,0};const{Z_FINISH:Hs,Z_BLOCK:Ws,Z_TREES:Vs,Z_OK:Xs,Z_STREAM_END:Gs,Z_NEED_DICT:Ys,Z_STREAM_ERROR:Ks,Z_DATA_ERROR:Zs,Z_MEM_ERROR:Js,Z_BUF_ERROR:Qs,Z_DEFLATED:ei}=bt,ti=12,si=30,ii=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function ni(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const oi=e=>{if(!e||!e.state)return Ks;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,Xs},ai=e=>{if(!e||!e.state)return Ks;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,oi(e)},ri=(e,t)=>{let s;if(!e||!e.state)return Ks;const i=e.state;return t<0?(s=0,t=-t):(s=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Ks:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=s,i.wbits=t,ai(e))},ci=(e,t)=>{if(!e)return Ks;const s=new ni;e.state=s,s.window=null;const i=ri(e,t);return i!==Xs&&(e.state=null),i};let li,di,hi=!0;const ui=e=>{if(hi){li=new Int32Array(512),di=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Us(1,e.lens,0,288,li,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Us(2,e.lens,0,32,di,0,e.work,{bits:5}),hi=!1}e.lencode=li,e.lenbits=9,e.distcode=di,e.distbits=5},pi=(e,t,s,i)=>{let n;const o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(t.subarray(s-o.wsize,s),0),o.wnext=0,o.whave=o.wsize):(n=o.wsize-o.wnext,n>i&&(n=i),o.window.set(t.subarray(s-i,s-i+n),o.wnext),(i-=n)?(o.window.set(t.subarray(s-i,s),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=n,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=n))),0};var mi=(e,t)=>{let s,i,n,o,a,r,c,l,d,h,u,p,m,g,f,w,y,b,v,k,_,x,C=0;const E=new Uint8Array(4);let S,T;const A=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return Ks;s=e.state,s.mode===ti&&(s.mode=13),a=e.next_out,n=e.output,c=e.avail_out,o=e.next_in,i=e.input,r=e.avail_in,l=s.hold,d=s.bits,h=r,u=c,x=Xs;e:for(;;)switch(s.mode){case 1:if(0===s.wrap){s.mode=13;break}for(;d<16;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}if(2&s.wrap&&35615===l){s.check=0,E[0]=255&l,E[1]=l>>>8&255,s.check=wt(s.check,E,2,0),l=0,d=0,s.mode=2;break}if(s.flags=0,s.head&&(s.head.done=!1),!(1&s.wrap)||(((255&l)<<8)+(l>>8))%31){e.msg="incorrect header check",s.mode=si;break}if((15&l)!==ei){e.msg="unknown compression method",s.mode=si;break}if(l>>>=4,d-=4,_=8+(15&l),0===s.wbits)s.wbits=_;else if(_>s.wbits){e.msg="invalid window size",s.mode=si;break}s.dmax=1<<s.wbits,e.adler=s.check=1,s.mode=512&l?10:ti,l=0,d=0;break;case 2:for(;d<16;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}if(s.flags=l,(255&s.flags)!==ei){e.msg="unknown compression method",s.mode=si;break}if(57344&s.flags){e.msg="unknown header flags set",s.mode=si;break}s.head&&(s.head.text=l>>8&1),512&s.flags&&(E[0]=255&l,E[1]=l>>>8&255,s.check=wt(s.check,E,2,0)),l=0,d=0,s.mode=3;case 3:for(;d<32;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}s.head&&(s.head.time=l),512&s.flags&&(E[0]=255&l,E[1]=l>>>8&255,E[2]=l>>>16&255,E[3]=l>>>24&255,s.check=wt(s.check,E,4,0)),l=0,d=0,s.mode=4;case 4:for(;d<16;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}s.head&&(s.head.xflags=255&l,s.head.os=l>>8),512&s.flags&&(E[0]=255&l,E[1]=l>>>8&255,s.check=wt(s.check,E,2,0)),l=0,d=0,s.mode=5;case 5:if(1024&s.flags){for(;d<16;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}s.length=l,s.head&&(s.head.extra_len=l),512&s.flags&&(E[0]=255&l,E[1]=l>>>8&255,s.check=wt(s.check,E,2,0)),l=0,d=0}else s.head&&(s.head.extra=null);s.mode=6;case 6:if(1024&s.flags&&(p=s.length,p>r&&(p=r),p&&(s.head&&(_=s.head.extra_len-s.length,s.head.extra||(s.head.extra=new Uint8Array(s.head.extra_len)),s.head.extra.set(i.subarray(o,o+p),_)),512&s.flags&&(s.check=wt(s.check,i,p,o)),r-=p,o+=p,s.length-=p),s.length))break e;s.length=0,s.mode=7;case 7:if(2048&s.flags){if(0===r)break e;p=0;do{_=i[o+p++],s.head&&_&&s.length<65536&&(s.head.name+=String.fromCharCode(_))}while(_&&p<r);if(512&s.flags&&(s.check=wt(s.check,i,p,o)),r-=p,o+=p,_)break e}else s.head&&(s.head.name=null);s.length=0,s.mode=8;case 8:if(4096&s.flags){if(0===r)break e;p=0;do{_=i[o+p++],s.head&&_&&s.length<65536&&(s.head.comment+=String.fromCharCode(_))}while(_&&p<r);if(512&s.flags&&(s.check=wt(s.check,i,p,o)),r-=p,o+=p,_)break e}else s.head&&(s.head.comment=null);s.mode=9;case 9:if(512&s.flags){for(;d<16;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}if(l!==(65535&s.check)){e.msg="header crc mismatch",s.mode=si;break}l=0,d=0}s.head&&(s.head.hcrc=s.flags>>9&1,s.head.done=!0),e.adler=s.check=0,s.mode=ti;break;case 10:for(;d<32;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}e.adler=s.check=ii(l),l=0,d=0,s.mode=11;case 11:if(0===s.havedict)return e.next_out=a,e.avail_out=c,e.next_in=o,e.avail_in=r,s.hold=l,s.bits=d,Ys;e.adler=s.check=1,s.mode=ti;case ti:if(t===Ws||t===Vs)break e;case 13:if(s.last){l>>>=7&d,d-=7&d,s.mode=27;break}for(;d<3;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}switch(s.last=1&l,l>>>=1,d-=1,3&l){case 0:s.mode=14;break;case 1:if(ui(s),s.mode=20,t===Vs){l>>>=2,d-=2;break e}break;case 2:s.mode=17;break;case 3:e.msg="invalid block type",s.mode=si}l>>>=2,d-=2;break;case 14:for(l>>>=7&d,d-=7&d;d<32;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}if((65535&l)!=(l>>>16^65535)){e.msg="invalid stored block lengths",s.mode=si;break}if(s.length=65535&l,l=0,d=0,s.mode=15,t===Vs)break e;case 15:s.mode=16;case 16:if(p=s.length,p){if(p>r&&(p=r),p>c&&(p=c),0===p)break e;n.set(i.subarray(o,o+p),a),r-=p,o+=p,c-=p,a+=p,s.length-=p;break}s.mode=ti;break;case 17:for(;d<14;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}if(s.nlen=257+(31&l),l>>>=5,d-=5,s.ndist=1+(31&l),l>>>=5,d-=5,s.ncode=4+(15&l),l>>>=4,d-=4,s.nlen>286||s.ndist>30){e.msg="too many length or distance symbols",s.mode=si;break}s.have=0,s.mode=18;case 18:for(;s.have<s.ncode;){for(;d<3;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}s.lens[A[s.have++]]=7&l,l>>>=3,d-=3}for(;s.have<19;)s.lens[A[s.have++]]=0;if(s.lencode=s.lendyn,s.lenbits=7,S={bits:s.lenbits},x=Us(0,s.lens,0,19,s.lencode,0,s.work,S),s.lenbits=S.bits,x){e.msg="invalid code lengths set",s.mode=si;break}s.have=0,s.mode=19;case 19:for(;s.have<s.nlen+s.ndist;){for(;C=s.lencode[l&(1<<s.lenbits)-1],f=C>>>24,w=C>>>16&255,y=65535&C,!(f<=d);){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}if(y<16)l>>>=f,d-=f,s.lens[s.have++]=y;else{if(16===y){for(T=f+2;d<T;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}if(l>>>=f,d-=f,0===s.have){e.msg="invalid bit length repeat",s.mode=si;break}_=s.lens[s.have-1],p=3+(3&l),l>>>=2,d-=2}else if(17===y){for(T=f+3;d<T;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}l>>>=f,d-=f,_=0,p=3+(7&l),l>>>=3,d-=3}else{for(T=f+7;d<T;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}l>>>=f,d-=f,_=0,p=11+(127&l),l>>>=7,d-=7}if(s.have+p>s.nlen+s.ndist){e.msg="invalid bit length repeat",s.mode=si;break}for(;p--;)s.lens[s.have++]=_}}if(s.mode===si)break;if(0===s.lens[256]){e.msg="invalid code -- missing end-of-block",s.mode=si;break}if(s.lenbits=9,S={bits:s.lenbits},x=Us(1,s.lens,0,s.nlen,s.lencode,0,s.work,S),s.lenbits=S.bits,x){e.msg="invalid literal/lengths set",s.mode=si;break}if(s.distbits=6,s.distcode=s.distdyn,S={bits:s.distbits},x=Us(2,s.lens,s.nlen,s.ndist,s.distcode,0,s.work,S),s.distbits=S.bits,x){e.msg="invalid distances set",s.mode=si;break}if(s.mode=20,t===Vs)break e;case 20:s.mode=21;case 21:if(r>=6&&c>=258){e.next_out=a,e.avail_out=c,e.next_in=o,e.avail_in=r,s.hold=l,s.bits=d,$s(e,u),a=e.next_out,n=e.output,c=e.avail_out,o=e.next_in,i=e.input,r=e.avail_in,l=s.hold,d=s.bits,s.mode===ti&&(s.back=-1);break}for(s.back=0;C=s.lencode[l&(1<<s.lenbits)-1],f=C>>>24,w=C>>>16&255,y=65535&C,!(f<=d);){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}if(w&&!(240&w)){for(b=f,v=w,k=y;C=s.lencode[k+((l&(1<<b+v)-1)>>b)],f=C>>>24,w=C>>>16&255,y=65535&C,!(b+f<=d);){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}l>>>=b,d-=b,s.back+=b}if(l>>>=f,d-=f,s.back+=f,s.length=y,0===w){s.mode=26;break}if(32&w){s.back=-1,s.mode=ti;break}if(64&w){e.msg="invalid literal/length code",s.mode=si;break}s.extra=15&w,s.mode=22;case 22:if(s.extra){for(T=s.extra;d<T;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}s.length+=l&(1<<s.extra)-1,l>>>=s.extra,d-=s.extra,s.back+=s.extra}s.was=s.length,s.mode=23;case 23:for(;C=s.distcode[l&(1<<s.distbits)-1],f=C>>>24,w=C>>>16&255,y=65535&C,!(f<=d);){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}if(!(240&w)){for(b=f,v=w,k=y;C=s.distcode[k+((l&(1<<b+v)-1)>>b)],f=C>>>24,w=C>>>16&255,y=65535&C,!(b+f<=d);){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}l>>>=b,d-=b,s.back+=b}if(l>>>=f,d-=f,s.back+=f,64&w){e.msg="invalid distance code",s.mode=si;break}s.offset=y,s.extra=15&w,s.mode=24;case 24:if(s.extra){for(T=s.extra;d<T;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}s.offset+=l&(1<<s.extra)-1,l>>>=s.extra,d-=s.extra,s.back+=s.extra}if(s.offset>s.dmax){e.msg="invalid distance too far back",s.mode=si;break}s.mode=25;case 25:if(0===c)break e;if(p=u-c,s.offset>p){if(p=s.offset-p,p>s.whave&&s.sane){e.msg="invalid distance too far back",s.mode=si;break}p>s.wnext?(p-=s.wnext,m=s.wsize-p):m=s.wnext-p,p>s.length&&(p=s.length),g=s.window}else g=n,m=a-s.offset,p=s.length;p>c&&(p=c),c-=p,s.length-=p;do{n[a++]=g[m++]}while(--p);0===s.length&&(s.mode=21);break;case 26:if(0===c)break e;n[a++]=s.length,c--,s.mode=21;break;case 27:if(s.wrap){for(;d<32;){if(0===r)break e;r--,l|=i[o++]<<d,d+=8}if(u-=c,e.total_out+=u,s.total+=u,u&&(e.adler=s.check=s.flags?wt(s.check,n,u,a-u):gt(s.check,n,u,a-u)),u=c,(s.flags?l:ii(l))!==s.check){e.msg="incorrect data check",s.mode=si;break}l=0,d=0}s.mode=28;case 28:if(s.wrap&&s.flags){for(;d<32;){if(0===r)break e;r--,l+=i[o++]<<d,d+=8}if(l!==(4294967295&s.total)){e.msg="incorrect length check",s.mode=si;break}l=0,d=0}s.mode=29;case 29:x=Gs;break e;case si:x=Zs;break e;case 31:return Js;default:return Ks}return e.next_out=a,e.avail_out=c,e.next_in=o,e.avail_in=r,s.hold=l,s.bits=d,(s.wsize||u!==e.avail_out&&s.mode<si&&(s.mode<27||t!==Hs))&&pi(e,e.output,e.next_out,u-e.avail_out),h-=e.avail_in,u-=e.avail_out,e.total_in+=h,e.total_out+=u,s.total+=u,s.wrap&&u&&(e.adler=s.check=s.flags?wt(s.check,n,u,e.next_out-u):gt(s.check,n,u,e.next_out-u)),e.data_type=s.bits+(s.last?64:0)+(s.mode===ti?128:0)+(20===s.mode||15===s.mode?256:0),(0===h&&0===u||t===Hs)&&x===Xs&&(x=Qs),x},gi={inflateReset:ai,inflateReset2:ri,inflateResetKeep:oi,inflateInit:e=>ci(e,15),inflateInit2:ci,inflate:mi,inflateEnd:e=>{if(!e||!e.state)return Ks;let t=e.state;return t.window&&(t.window=null),e.state=null,Xs},inflateGetHeader:(e,t)=>{if(!e||!e.state)return Ks;const s=e.state;return 2&s.wrap?(s.head=t,t.done=!1,Xs):Ks},inflateSetDictionary:(e,t)=>{const s=t.length;let i,n,o;return e&&e.state?(i=e.state,0!==i.wrap&&11!==i.mode?Ks:11===i.mode&&(n=1,n=gt(n,t,s,0),n!==i.check)?Zs:(o=pi(e,t,s,s),o?(i.mode=31,Js):(i.havedict=1,Xs))):Ks},inflateInfo:"pako inflate (from Nodeca project)"};var fi=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const wi=Object.prototype.toString,{Z_NO_FLUSH:yi,Z_FINISH:bi,Z_OK:vi,Z_STREAM_END:ki,Z_NEED_DICT:_i,Z_STREAM_ERROR:xi,Z_DATA_ERROR:Ci,Z_MEM_ERROR:Ei}=bt;function Si(e){this.options=ws.assign({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&(15&t.windowBits||(t.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new ks,this.strm.avail_out=0;let s=gi.inflateInit2(this.strm,t.windowBits);if(s!==vi)throw new Error(yt[s]);if(this.header=new fi,gi.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=vs.string2buf(t.dictionary):"[object ArrayBuffer]"===wi.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(s=gi.inflateSetDictionary(this.strm,t.dictionary),s!==vi)))throw new Error(yt[s])}function Ti(e,t){const s=new Si(t);if(s.push(e),s.err)throw s.msg||yt[s.err];return s.result}Si.prototype.push=function(e,t){const s=this.strm,i=this.options.chunkSize,n=this.options.dictionary;let o,a,r;if(this.ended)return!1;for(a=t===~~t?t:!0===t?bi:yi,"[object ArrayBuffer]"===wi.call(e)?s.input=new Uint8Array(e):s.input=e,s.next_in=0,s.avail_in=s.input.length;;){for(0===s.avail_out&&(s.output=new Uint8Array(i),s.next_out=0,s.avail_out=i),o=gi.inflate(s,a),o===_i&&n&&(o=gi.inflateSetDictionary(s,n),o===vi?o=gi.inflate(s,a):o===Ci&&(o=_i));s.avail_in>0&&o===ki&&s.state.wrap>0&&0!==e[s.next_in];)gi.inflateReset(s),o=gi.inflate(s,a);switch(o){case xi:case Ci:case _i:case Ei:return this.onEnd(o),this.ended=!0,!1}if(r=s.avail_out,s.next_out&&(0===s.avail_out||o===ki))if("string"===this.options.to){let e=vs.utf8border(s.output,s.next_out),t=s.next_out-e,n=vs.buf2string(s.output,e);s.next_out=t,s.avail_out=i-t,t&&s.output.set(s.output.subarray(e,e+t),0),this.onData(n)}else this.onData(s.output.length===s.next_out?s.output:s.output.subarray(0,s.next_out));if(o!==vi||0!==r){if(o===ki)return o=gi.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(0===s.avail_in)break}}return!0},Si.prototype.onData=function(e){this.chunks.push(e)},Si.prototype.onEnd=function(e){e===vi&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=ws.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Ai=function(e,t){return(t=t||{}).raw=!0,Ti(e,t)},Li={Inflate:Si,inflate:Ti,inflateRaw:Ai,ungzip:Ti,constants:bt};const{Deflate:ji,deflate:Ii,deflateRaw:Di,gzip:Mi}=Rs,{Inflate:Oi,inflate:Pi,inflateRaw:Ri,ungzip:$i}=Li;const zi={Deflate:ji,deflate:Ii,deflateRaw:Di,gzip:Mi,Inflate:Oi,inflate:Pi,inflateRaw:Ri,ungzip:$i,constants:bt};Object.assign(window,{unzip:(e,t={to:"string"})=>zi.inflate(e,t),zip(e){let t=e;return"string"==typeof e&&(t=new TextEncoder("utf-8").encode(e)),zi.deflate(t)}});__webpack_require__(830);var Bi={maxCacheSize:100,maxCacheTime:864e5,warnIfItemPurgedBeforeTime:5e3,opLimit:200,scanLimit:50};function Ni(){return Ni=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Ni.apply(this,arguments)}var Fi=Object.create,qi=Object.assign,Ui=Object.prototype.hasOwnProperty,Hi=Date.now,Wi=function(e){return Math.max(e,0)||0},Vi=function(e){return qi(e,{maxCacheSize:Wi(e.maxCacheSize),maxCacheTime:Wi(e.maxCacheTime),opLimit:Wi(e.opLimit)}),e},Xi=function(e){return!!e&&!!e.limitedCacheMetaVersion},Gi=function(e){if(!Xi(e))throw new Error("Limited-cache metadata is missing: please check your usage");2!==e.limitedCacheMetaVersion&&(console.warn("Limited-cache metadata is from an incompatible version (1). It must be reset."),e.limitedCacheMetaVersion=2,rn(e))},Yi=function(e,t){return Gi(e),Vi(qi(e.options,t))},Ki=function(e){if(Xi(e)){var t=e;return Gi(t),t}var s=Vi(Ni({},Bi,e));return rn({limitedCacheMetaVersion:2,options:s})},Zi=function(e,t){var s=e.options.maxCacheTime,i=e.keyInfo[t];if(!i)return 0;var n=i[0];return i[1]||n+(s||31536e6)},Ji=function(e,t,s){return Zi(e,t)<s},Qi=function(e){Gi(e);var t=e.cache,s=e.keyList,i=e.keyInfo,n=Hi(),o=s.reduce((function(s,o){var a=s[0],r=s[1],c=s[2];return Ji(e,o,n)||(a[o]=t[o],r.push(o),c[o]=i[o]),s}),[{},[],Fi(null)]),a=o[0],r=o[1],c=o[2];return qi(e,{cache:a,keyList:r,keyInfo:c,opsLeft:e.options.opLimit})},en=function(e,t,s){var i=e.cache,n=e.keyList,o=e.keyInfo,a=t,r=n[t],c=n.length;do{i[r]=o[r]=void 0,r=n[++a]}while(a<c&&Ji(e,r,s));n.splice(t,a-t)},tn=function(e,t){Gi(e);var s=e.cache;if(Ui.call(s,t)&&void 0!==s[t]){if(!Ji(e,t,Hi()))return!0;s[t]=void 0}return!1},sn=function(e,t){if(Gi(e),tn(e,t))return e.cache[t]},nn=function(e){return Gi(e),Qi(e),e.cache},on=function(e,t,s){Gi(e);var i,n=e.options.maxCacheSize,o=e.keyList,a=e.keyInfo,r=Hi(),c=!a[t];e.cache[t]!==s&&(e.cache=Ni({},e.cache,((i={})[t]=s,i)));return a[t]=[r,0],c&&(o.push(t),e.opsLeft--,e.opsLeft<=0&&Qi(e),n&&e.keyList.length>n&&function(e,t){var s=e.options,i=s.scanLimit,n=(s.warnIfItemPurgedBeforeTime,e.cache,e.keyList),o=(e.keyInfo,0),a=Zi(e,n[0]);if(a>t)for(var r=0,c=Math.min(n.length,i);r<c;){var l=n[r],d=Zi(e,l);if(d<t){o=r,a=0;break}d<a&&(o=r,a=d),r+=1}en(e,o,t)}(e,r)),Ji(e,o[0],r)&&en(e,0,r),e},an=function(e,t){Gi(e);var s=e.cache,i=e.keyInfo;if(i[t]){var n;if(void 0!==s[t])e.cache=Ni({},s,((n={})[t]=void 0,n));i[t]=void 0}return e},rn=function(e){return Gi(e),qi(e,{cache:{},keyList:[],keyInfo:Fi(null),opsLeft:e.options.opLimit})},cn=function(e,t){return e.bind(null,t)},ln=(__webpack_require__(753),/Mac/.test(navigator.platform)),dn={toggleBold:vn,toggleItalic:kn,drawLink:Mn,toggleHeadingSmaller:En,toggleHeadingBigger:Sn,drawImage:On,toggleBlockquote:Cn,toggleOrderedList:In,toggleUnorderedList:jn,toggleCodeBlock:xn,togglePreview:Nn,toggleStrikethrough:_n,toggleHeading1:Tn,toggleHeading2:An,toggleHeading3:Ln,cleanBlock:Dn,drawTable:Pn,drawHorizontalRule:Rn,undo:$n,redo:zn,toggleSideBySide:Bn,toggleFullScreen:bn},hn={toggleBold:"Cmd-B",toggleItalic:"Cmd-I",drawLink:"Cmd-K",toggleHeadingSmaller:"Cmd-H",toggleHeadingBigger:"Shift-Cmd-H",cleanBlock:"Cmd-E",drawImage:"Cmd-Alt-I",toggleBlockquote:"Cmd-'",toggleOrderedList:"Cmd-Alt-L",toggleUnorderedList:"Cmd-L",toggleCodeBlock:"Cmd-Alt-C",togglePreview:"Cmd-P",toggleSideBySide:"F9",toggleFullScreen:"F11"},un=function(e){for(var t in dn)if(dn[t]===e)return t;return null},pn=function(){var e,t=!1;return e=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0),t};function mn(e){return e=ln?e.replace("Ctrl","Cmd"):e.replace("Cmd","Ctrl")}function gn(e,t,s){e=e||{};var i=document.createElement("a");return t=null==t||t,e.title&&t&&(i.title=function(e,t,s){var i,n=e;t&&s[i=un(t)]&&(n+=" ("+mn(s[i])+")");return n}(e.title,e.action,s),ln&&(i.title=i.title.replace("Ctrl","⌘"),i.title=i.title.replace("Alt","⌥"))),i.tabIndex=-1,i.className=e.className,i}function fn(){var e=document.createElement("i");return e.className="separator",e.innerHTML="|",e}function wn(e,t){t=t||e.getCursor("start");var s=e.getTokenAt(t);if(!s.type)return{};for(var i,n,o=s.type.split(" "),a={},r=0;r<o.length;r++)"strong"===(i=o[r])?a.bold=!0:"variable-2"===i?(n=e.getLine(t.line),/^\s*\d+\.\s/.test(n)?a["ordered-list"]=!0:a["unordered-list"]=!0):"atom"===i?a.quote=!0:"em"===i?a.italic=!0:"quote"===i?a.quote=!0:"strikethrough"===i?a.strikethrough=!0:"comment"===i?a.code=!0:"link"===i?a.link=!0:"tag"===i?a.image=!0:i.match(/^header(\-[1-6])?$/)&&(a[i.replace("header","heading")]=!0);return a}var yn="";function bn(e){var t=e.codemirror;t.setOption("fullScreen",!t.getOption("fullScreen")),t.getOption("fullScreen")?(yn=document.body.style.overflow,document.body.style.overflow="hidden"):document.body.style.overflow=yn;var s=t.getWrapperElement();/fullscreen/.test(s.previousSibling.className)?s.previousSibling.className=s.previousSibling.className.replace(/\s*fullscreen\b/,""):s.previousSibling.className+=" fullscreen";var i=e.toolbarElements.fullscreen;/active/.test(i.className)?i.className=i.className.replace(/\s*active\s*/g,""):i.className+=" active";var n=t.getWrapperElement().nextSibling;/editor-preview-active-side/.test(n.className)&&Bn(e)}function vn(e){Hn(e,"bold",e.options.blockStyles.bold)}function kn(e){Hn(e,"italic",e.options.blockStyles.italic)}function _n(e){Hn(e,"strikethrough","~~")}function xn(e){var t=e.options.blockStyles.code;function s(e){if("object"!=typeof e)throw"fencing_line() takes a 'line' object (not a line number, or line text).  Got: "+typeof e+": "+e;return e.styles&&e.styles[2]&&-1!==e.styles[2].indexOf("formatting-code-block")}function i(e){return e.state.base.base||e.state.base}function n(e,t,n,o,a){n=n||e.getLineHandle(t),o=o||e.getTokenAt({line:t,ch:1}),a=a||!!n.text&&e.getTokenAt({line:t,ch:n.text.length-1});var r=o.type?o.type.split(" "):[];return a&&i(a).indentedCode?"indented":-1!==r.indexOf("comment")&&(i(o).fencedChars||i(a).fencedChars||s(n)?"fenced":"single")}var o,a,r,c=e.codemirror,l=c.getCursor("start"),d=c.getCursor("end"),h=c.getTokenAt({line:l.line,ch:l.ch||1}),u=c.getLineHandle(l.line),p=n(c,l.line,u,h);if("single"===p){var m=u.text.slice(0,l.ch).replace("`",""),g=u.text.slice(l.ch).replace("`","");c.replaceRange(m+g,{line:l.line,ch:0},{line:l.line,ch:99999999999999}),l.ch--,l!==d&&d.ch--,c.setSelection(l,d),c.focus()}else if("fenced"===p)if(l.line!==d.line||l.ch!==d.ch){for(o=l.line;o>=0&&!s(u=c.getLineHandle(o));o--);var f,w,y,b,v=i(c.getTokenAt({line:o,ch:1})).fencedChars;s(c.getLineHandle(l.line))?(f="",w=l.line):s(c.getLineHandle(l.line-1))?(f="",w=l.line-1):(f=v+"\n",w=l.line),s(c.getLineHandle(d.line))?(y="",b=d.line,0===d.ch&&(b+=1)):0!==d.ch&&s(c.getLineHandle(d.line+1))?(y="",b=d.line+1):(y=v+"\n",b=d.line+1),0===d.ch&&(b-=1),c.operation((function(){c.replaceRange(y,{line:b,ch:0},{line:b+(y?0:1),ch:0}),c.replaceRange(f,{line:w,ch:0},{line:w+(f?0:1),ch:0})})),c.setSelection({line:w+(f?1:0),ch:0},{line:b+(f?1:-1),ch:0}),c.focus()}else{var k=l.line;if(s(c.getLineHandle(l.line))&&("fenced"===n(c,l.line+1)?(o=l.line,k=l.line+1):(a=l.line,k=l.line-1)),void 0===o)for(o=k;o>=0&&!s(u=c.getLineHandle(o));o--);if(void 0===a)for(r=c.lineCount(),a=k;a<r&&!s(u=c.getLineHandle(a));a++);c.operation((function(){c.replaceRange("",{line:o,ch:0},{line:o+1,ch:0}),c.replaceRange("",{line:a-1,ch:0},{line:a,ch:0})})),c.focus()}else if("indented"===p){if(l.line!==d.line||l.ch!==d.ch)o=l.line,a=d.line,0===d.ch&&a--;else{for(o=l.line;o>=0;o--)if(!(u=c.getLineHandle(o)).text.match(/^\s*$/)&&"indented"!==n(c,o,u)){o+=1;break}for(r=c.lineCount(),a=l.line;a<r;a++)if(!(u=c.getLineHandle(a)).text.match(/^\s*$/)&&"indented"!==n(c,a,u)){a-=1;break}}var _=c.getLineHandle(a+1),x=_&&c.getTokenAt({line:a+1,ch:_.text.length-1});x&&i(x).indentedCode&&c.replaceRange("\n",{line:a+1,ch:0});for(var C=o;C<=a;C++)c.indentLine(C,"subtract");c.focus()}else{var E=l.line===d.line&&l.ch===d.ch&&0===l.ch,S=l.line!==d.line;E||S?function(e,t,s,i){var n=t.line+1,o=s.line+1,a=t.line!==s.line,r=i+"\n",c="\n"+i;a&&o++,a&&0===s.ch&&(c=i+"\n",o--),Fn(e,!1,[r,c]),e.setSelection({line:n,ch:0},{line:o,ch:0})}(c,l,d,t):Fn(c,!1,["`","`"])}}function Cn(e){Un(e.codemirror,"quote")}function En(e){qn(e.codemirror,"smaller")}function Sn(e){qn(e.codemirror,"bigger")}function Tn(e){qn(e.codemirror,void 0,1)}function An(e){qn(e.codemirror,void 0,2)}function Ln(e){qn(e.codemirror,void 0,3)}function jn(e){Un(e.codemirror,"unordered-list")}function In(e){Un(e.codemirror,"ordered-list")}function Dn(e){!function(e){if(/editor-preview-active/.test(e.getWrapperElement().lastChild.className))return;for(var t,s=e.getCursor("start"),i=e.getCursor("end"),n=s.line;n<=i.line;n++)t=(t=e.getLine(n)).replace(/^[ ]*([# ]+|\*|\-|[> ]+|[0-9]+(.|\)))[ ]*/,""),e.replaceRange(t,{line:n,ch:0},{line:n,ch:99999999999999})}(e.codemirror)}function Mn(e){var t=e.codemirror,s=wn(t),i=e.options,n="http://";if(i.promptURLs&&!(n=prompt(i.promptTexts.link)))return!1;Fn(t,s.link,i.insertTexts.link,n)}function On(e){var t=e.codemirror,s=wn(t),i=e.options,n="http://";if(i.promptURLs&&!(n=prompt(i.promptTexts.image)))return!1;Fn(t,s.image,i.insertTexts.image,n)}function Pn(e){var t=e.codemirror,s=wn(t),i=e.options;Fn(t,s.table,i.insertTexts.table)}function Rn(e){var t=e.codemirror,s=wn(t),i=e.options;Fn(t,s.image,i.insertTexts.horizontalRule)}function $n(e){var t=e.codemirror;t.undo(),t.focus()}function zn(e){var t=e.codemirror;t.redo(),t.focus()}function Bn(e){var t=e.codemirror,s=t.getWrapperElement(),i=s.nextSibling,n=e.toolbarElements["side-by-side"],o=!1;/editor-preview-active-side/.test(i.className)?(i.className=i.className.replace(/\s*editor-preview-active-side\s*/g,""),n.className=n.className.replace(/\s*active\s*/g,""),s.className=s.className.replace(/\s*CodeMirror-sided\s*/g," ")):(setTimeout((function(){t.getOption("fullScreen")||bn(e),i.className+=" editor-preview-active-side"}),1),n.className+=" active",s.className+=" CodeMirror-sided",o=!0);var a=s.lastChild;if(/editor-preview-active/.test(a.className)){a.className=a.className.replace(/\s*editor-preview-active\s*/g,"");var r=e.toolbarElements.preview,c=s.previousSibling;r.className=r.className.replace(/\s*active\s*/g,""),c.className=c.className.replace(/\s*disabled-for-preview*/g,"")}t.sideBySideRenderingFunction||(t.sideBySideRenderingFunction=function(){i.innerHTML=e.options.previewRender(e.value(),i)}),o?(i.innerHTML=e.options.previewRender(e.value(),i),t.on("update",t.sideBySideRenderingFunction)):t.off("update",t.sideBySideRenderingFunction),t.refresh()}function Nn(e){var t=e.codemirror,s=t.getWrapperElement(),i=s.previousSibling,n=!!e.options.toolbar&&e.toolbarElements.preview,o=s.lastChild;o&&/editor-preview/.test(o.className)||((o=document.createElement("div")).className="editor-preview",s.appendChild(o)),/editor-preview-active/.test(o.className)?(o.className=o.className.replace(/\s*editor-preview-active\s*/g,""),n&&(n.className=n.className.replace(/\s*active\s*/g,""),i.className=i.className.replace(/\s*disabled-for-preview*/g,""))):(setTimeout((function(){o.className+=" editor-preview-active"}),1),n&&(n.className+=" active",i.className+=" disabled-for-preview")),o.innerHTML=e.options.previewRender(e.value(),o);var a=t.getWrapperElement().nextSibling;/editor-preview-active-side/.test(a.className)&&Bn(e)}function Fn(e,t,s,i){if(!/editor-preview-active/.test(e.getWrapperElement().lastChild.className)){var n,o=s[0],a=s[1],r=e.getCursor("start"),c=e.getCursor("end");i&&(a=a.replace("#url#",i)),t?(o=(n=e.getLine(r.line)).slice(0,r.ch),a=n.slice(r.ch),e.replaceRange(o+a,{line:r.line,ch:0})):(n=e.getSelection(),e.replaceSelection(o+n+a),r.ch+=o.length,r!==c&&(c.ch+=o.length)),e.setSelection(r,c),e.focus()}}function qn(e,t,s){if(!/editor-preview-active/.test(e.getWrapperElement().lastChild.className)){for(var i=e.getCursor("start"),n=e.getCursor("end"),o=i.line;o<=n.line;o++)!function(i){var n=e.getLine(i),o=n.search(/[^#]/);n=void 0!==t?o<=0?"bigger"==t?"###### "+n:"# "+n:6==o&&"smaller"==t?n.substr(7):1==o&&"bigger"==t?n.substr(2):"bigger"==t?n.substr(1):"#"+n:1==s?o<=0?"# "+n:o==s?n.substr(o+1):"# "+n.substr(o+1):2==s?o<=0?"## "+n:o==s?n.substr(o+1):"## "+n.substr(o+1):o<=0?"### "+n:o==s?n.substr(o+1):"### "+n.substr(o+1),e.replaceRange(n,{line:i,ch:0},{line:i,ch:99999999999999})}(o);e.focus()}}function Un(e,t){if(!/editor-preview-active/.test(e.getWrapperElement().lastChild.className)){for(var s=wn(e),i=e.getCursor("start"),n=e.getCursor("end"),o={quote:/^(\s*)\>\s+/,"unordered-list":/^(\s*)(\*|\-|\+)\s+/,"ordered-list":/^(\s*)\d+\.\s+/},a={quote:"> ","unordered-list":"* ","ordered-list":"1. "},r=i.line;r<=n.line;r++)!function(i){var n=e.getLine(i);n=s[t]?n.replace(o[t],"$1"):a[t]+n,e.replaceRange(n,{line:i,ch:0},{line:i,ch:99999999999999})}(r);e.focus()}}function Hn(e,t,s,i){if(!/editor-preview-active/.test(e.codemirror.getWrapperElement().lastChild.className)){i=void 0===i?s:i;var n,o=e.codemirror,a=wn(o),r=s,c=i,l=o.getCursor("start"),d=o.getCursor("end");a[t]?(r=(n=o.getLine(l.line)).slice(0,l.ch),c=n.slice(l.ch),"bold"==t?(r=r.replace(/(\*\*|__)(?![\s\S]*(\*\*|__))/,""),c=c.replace(/(\*\*|__)/,"")):"italic"==t?(r=r.replace(/(\*|_)(?![\s\S]*(\*|_))/,""),c=c.replace(/(\*|_)/,"")):"strikethrough"==t&&(r=r.replace(/(\*\*|~~)(?![\s\S]*(\*\*|~~))/,""),c=c.replace(/(\*\*|~~)/,"")),o.replaceRange(r+c,{line:l.line,ch:0},{line:l.line,ch:99999999999999}),"bold"==t||"strikethrough"==t?(l.ch-=2,l!==d&&(d.ch-=2)):"italic"==t&&(l.ch-=1,l!==d&&(d.ch-=1))):(n=o.getSelection(),"bold"==t?n=(n=n.split("**").join("")).split("__").join(""):"italic"==t?n=(n=n.split("*").join("")).split("_").join(""):"strikethrough"==t&&(n=n.split("~~").join("")),o.replaceSelection(r+n+c),l.ch+=s.length,d.ch=l.ch+n.length),o.setSelection(l,d),o.focus()}}function Wn(e,t){for(var s in t)t.hasOwnProperty(s)&&(t[s]instanceof Array?e[s]=t[s].concat(e[s]instanceof Array?e[s]:[]):null!==t[s]&&"object"==typeof t[s]&&t[s].constructor===Object?e[s]=Wn(e[s]||{},t[s]):e[s]=t[s]);return e}function Vn(e){for(var t=1;t<arguments.length;t++)e=Wn(e,arguments[t]);return e}function Xn(e){var t=e.match(/[a-zA-Z0-9_\u0392-\u03c9\u0410-\u04F9]+|[\u4E00-\u9FFF\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\uac00-\ud7af]+/g),s=0;if(null===t)return s;for(var i=0;i<t.length;i++)t[i].charCodeAt(0)>=19968?s+=t[i].length:s+=1;return s}var Gn={bold:{name:"bold",action:vn,className:"fa fa-bold",title:"Bold",default:!0},italic:{name:"italic",action:kn,className:"fa fa-italic",title:"Italic",default:!0},strikethrough:{name:"strikethrough",action:_n,className:"fa fa-strikethrough",title:"Strikethrough"},heading:{name:"heading",action:En,className:"fa fa-header",title:"Heading",default:!0},"heading-smaller":{name:"heading-smaller",action:En,className:"fa fa-header fa-header-x fa-header-smaller",title:"Smaller Heading"},"heading-bigger":{name:"heading-bigger",action:Sn,className:"fa fa-header fa-header-x fa-header-bigger",title:"Bigger Heading"},"heading-1":{name:"heading-1",action:Tn,className:"fa fa-header fa-header-x fa-header-1",title:"Big Heading"},"heading-2":{name:"heading-2",action:An,className:"fa fa-header fa-header-x fa-header-2",title:"Medium Heading"},"heading-3":{name:"heading-3",action:Ln,className:"fa fa-header fa-header-x fa-header-3",title:"Small Heading"},"separator-1":{name:"separator-1"},code:{name:"code",action:xn,className:"fa fa-code",title:"Code",default:!0},quote:{name:"quote",action:Cn,className:"fa fa-quote-left",title:"Quote",default:!0},"unordered-list":{name:"unordered-list",action:jn,className:"fa fa-list-ul",title:"Generic List",default:!0},"ordered-list":{name:"ordered-list",action:In,className:"fa fa-list-ol",title:"Numbered List",default:!0},"clean-block":{name:"clean-block",action:Dn,className:"fa fa-eraser fa-clean-block",title:"Clean block"},link:{name:"link",action:Mn,className:"fa fa-link",title:"Create Link",default:!0},image:{name:"image",action:On,className:"fa fa-picture-o",title:"Insert Image",default:!1},table:{name:"table",action:Pn,className:"fa fa-table",title:"Insert Table"},"horizontal-rule":{name:"horizontal-rule",action:Rn,className:"fa fa-minus",title:"Insert Horizontal Line"},"separator-3":{name:"separator-3"},preview:{name:"preview",action:Nn,className:"fa fa-eye no-disable",title:"Toggle Preview",default:!0},"side-by-side":{name:"side-by-side",action:Bn,className:"fa fa-columns no-disable no-mobile",title:"Toggle Side by Side",default:!1},fullscreen:{name:"fullscreen",action:bn,className:"fa fa-arrows-alt no-disable no-mobile",title:"Toggle Fullscreen",default:!1},"separator-4":{name:"separator-4"},guide:{name:"guide",action:"https://simplemde.com/markdown-guide",className:"fa fa-question-circle",title:"Markdown Guide",default:!1},"separator-5":{name:"separator-5"},undo:{name:"undo",action:$n,className:"fa fa-undo no-disable",title:"Undo"},redo:{name:"redo",action:zn,className:"fa fa-repeat no-disable",title:"Redo"}},Yn={link:["[","](#url#)"],image:["![](","#url#)"],table:["","\n\n| Column 1 | Column 2 | Column 3 |\n| -------- | -------- | -------- |\n| Text     | Text     | Text     |\n\n"],horizontalRule:["","\n\n-----\n\n"]},Kn={link:"URL for the link:",image:"URL of the image:"},Zn={bold:"**",code:"```",italic:"*"};function Jn(e){(e=e||{}).parent=this;var t=!0;if(!1===e.autoDownloadFontAwesome&&(t=!1),!0!==e.autoDownloadFontAwesome)for(var s=document.styleSheets,i=0;i<s.length;i++)s[i].href&&s[i].href.indexOf("//maxcdn.bootstrapcdn.com/font-awesome/")>-1&&(t=!1);if(t){var n=document.createElement("link");n.rel="stylesheet",n.href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css",document.getElementsByTagName("head")[0].appendChild(n)}if(e.element)this.element=e.element;else if(null===e.element)return void console.log("SimpleMDE: Error. No element was found.");if(void 0===e.toolbar)for(var o in e.toolbar=[],Gn)Gn.hasOwnProperty(o)&&(-1!=o.indexOf("separator-")&&e.toolbar.push("|"),(!0===Gn[o].default||e.showIcons&&e.showIcons.constructor===Array&&-1!=e.showIcons.indexOf(o))&&e.toolbar.push(o));e.hasOwnProperty("status")||(e.status=["autosave","lines","words","cursor"]),e.previewRender||(e.previewRender=function(e){return this.parent.markdown(e)}),e.parsingConfig=Vn({highlightFormatting:!0},e.parsingConfig||{}),e.insertTexts=Vn({},Yn,e.insertTexts||{}),e.promptTexts=Kn,e.blockStyles=Vn({},Zn,e.blockStyles||{}),e.shortcuts=Vn({},hn,e.shortcuts||{}),null!=e.autosave&&null!=e.autosave.unique_id&&""!=e.autosave.unique_id&&(e.autosave.uniqueId=e.autosave.unique_id),this.options=e,this.render(),!e.initialValue||this.options.autosave&&!0===this.options.autosave.foundSavedValue||this.value(e.initialValue)}function Qn(){if("object"!=typeof localStorage)return!1;try{localStorage.setItem("smde_localStorage",1),localStorage.removeItem("smde_localStorage")}catch(e){return!1}return!0}Jn.prototype.markdown=function(e){if(t){var s={headerIds:!1};return this.options&&this.options.renderingConfig&&!1===this.options.renderingConfig.singleLineBreaks?s.breaks=!1:s.breaks=!0,this.options&&this.options.renderingConfig&&!0===this.options.renderingConfig.codeSyntaxHighlighting&&window.hljs&&(s.highlight=function(e){return window.hljs.highlightAuto(e).value}),q(s),N(e)}},Jn.prototype.render=function(e){if(e||(e=this.element||document.getElementsByTagName("textarea")[0]),!this._rendered||this._rendered!==e){this.element=e;var t,s,i=this.options,n=this,o={};for(var a in i.shortcuts)null!==i.shortcuts[a]&&null!==dn[a]&&function(e){o[mn(i.shortcuts[e])]=function(){dn[e](n)}}(a);if(o.Enter="newlineAndIndentContinueMarkdownList",o.Tab="tabAndIndentMarkdownList",o["Shift-Tab"]="shiftTabAndUnindentMarkdownList",o.Esc=function(e){e.getOption("fullScreen")&&bn(n)},document.addEventListener("keydown",(function(e){27==(e=e||window.event).keyCode&&n.codemirror.getOption("fullScreen")&&bn(n)}),!1),!1!==i.spellChecker?(t="spell-checker",(s=i.parsingConfig).name="gfm",s.gitHubSpice=!1):((t=i.parsingConfig).name="gfm",t.gitHubSpice=!1),this.codemirror=CodeMirror.fromTextArea(e,{mode:t,backdrop:s,theme:"paper",tabSize:null!=i.tabSize?i.tabSize:2,indentUnit:null!=i.tabSize?i.tabSize:2,indentWithTabs:!1!==i.indentWithTabs,lineNumbers:!1,autofocus:!0===i.autofocus,extraKeys:o,lineWrapping:!1!==i.lineWrapping,allowDropFileTypes:["text/plain"],placeholder:i.placeholder||e.getAttribute("placeholder")||"",styleSelectedText:null==i.styleSelectedText||i.styleSelectedText}),!0===i.forceSync){var r=this.codemirror;r.on("change",(function(){r.save()}))}this.gui={},!1!==i.toolbar&&(this.gui.toolbar=this.createToolbar()),!1!==i.status&&(this.gui.statusbar=this.createStatusbar()),null!=i.autosave&&!0===i.autosave.enabled&&this.autosave(),this.gui.sideBySide=this.createSideBySide(),this._rendered=this.element;var c=this.codemirror;setTimeout(function(){c.refresh()}.bind(c),0)}},Jn.prototype.autosave=function(){if(Qn()){var e=this;if(null==this.options.autosave.uniqueId||""==this.options.autosave.uniqueId)return void console.log("SimpleMDE: You must set a uniqueId to use the autosave feature");null!=e.element.form&&null!=e.element.form&&e.element.form.addEventListener("submit",(function(){localStorage.removeItem("smde_"+e.options.autosave.uniqueId)})),!0!==this.options.autosave.loaded&&("string"==typeof localStorage.getItem("smde_"+this.options.autosave.uniqueId)&&""!=localStorage.getItem("smde_"+this.options.autosave.uniqueId)&&(this.codemirror.setValue(localStorage.getItem("smde_"+this.options.autosave.uniqueId)),this.options.autosave.foundSavedValue=!0),this.options.autosave.loaded=!0),localStorage.setItem("smde_"+this.options.autosave.uniqueId,e.value());var t=document.getElementById("autosaved");if(null!=t&&null!=t&&""!=t){var s=new Date,i=s.getHours(),n=s.getMinutes(),o="am",a=i;a>=12&&(a=i-12,o="pm"),0==a&&(a=12),n=n<10?"0"+n:n,t.innerHTML="Autosaved: "+a+":"+n+" "+o}this.autosaveTimeoutId=setTimeout((function(){e.autosave()}),this.options.autosave.delay||1e4)}else console.log("SimpleMDE: localStorage not available, cannot autosave")},Jn.prototype.clearAutosavedValue=function(){if(Qn()){if(null==this.options.autosave||null==this.options.autosave.uniqueId||""==this.options.autosave.uniqueId)return void console.log("SimpleMDE: You must set a uniqueId to clear the autosave value");localStorage.removeItem("smde_"+this.options.autosave.uniqueId)}else console.log("SimpleMDE: localStorage not available, cannot autosave")},Jn.prototype.createSideBySide=function(){var e=this.codemirror,t=e.getWrapperElement(),s=t.nextSibling;s&&/editor-preview-side/.test(s.className)||((s=document.createElement("div")).className="editor-preview-side",t.parentNode.insertBefore(s,t.nextSibling));var i=!1,n=!1;return e.on("scroll",(function(e){if(i)i=!1;else{n=!0;var t=e.getScrollInfo().height-e.getScrollInfo().clientHeight,o=parseFloat(e.getScrollInfo().top)/t,a=(s.scrollHeight-s.clientHeight)*o;s.scrollTop=a}})),s.onscroll=function(){if(n)n=!1;else{i=!0;var t=s.scrollHeight-s.clientHeight,o=parseFloat(s.scrollTop)/t,a=(e.getScrollInfo().height-e.getScrollInfo().clientHeight)*o;e.scrollTo(0,a)}},s},Jn.prototype.createToolbar=function(e){if((e=e||this.options.toolbar)&&0!==e.length){var t;for(t=0;t<e.length;t++)null!=Gn[e[t]]&&(e[t]=Gn[e[t]]);var s=document.createElement("div");s.className="editor-toolbar";var i=this,n={};for(i.toolbar=e,t=0;t<e.length;t++)if(("guide"!=e[t].name||!1!==i.options.toolbarGuideIcon)&&!(i.options.hideIcons&&-1!=i.options.hideIcons.indexOf(e[t].name)||("fullscreen"==e[t].name||"side-by-side"==e[t].name)&&pn())){if("|"===e[t]){for(var o=!1,a=t+1;a<e.length;a++)"|"===e[a]||i.options.hideIcons&&-1!=i.options.hideIcons.indexOf(e[a].name)||(o=!0);if(!o)continue}!function(e){var t;t="|"===e?fn():gn(e,i.options.toolbarTips,i.options.shortcuts),e.action&&("function"==typeof e.action?t.onclick=function(t){t.preventDefault(),e.action(i)}:"string"==typeof e.action&&(t.href=e.action,t.target="_blank")),n[e.name||e]=t,s.appendChild(t)}(e[t])}i.toolbarElements=n;var r=this.codemirror;r.on("cursorActivity",(function(){var e=wn(r);for(var t in n)!function(t){var s=n[t];e[t]?s.className+=" active":"fullscreen"!=t&&"side-by-side"!=t&&(s.className=s.className.replace(/\s*active\s*/g,""))}(t)}));var c=r.getWrapperElement();return c.parentNode.insertBefore(s,c),s}},Jn.prototype.createStatusbar=function(e){e=e||this.options.status;var t=this.options,s=this.codemirror;if(e&&0!==e.length){var i,n,o,a=[];for(i=0;i<e.length;i++)if(n=void 0,o=void 0,"object"==typeof e[i])a.push({className:e[i].className,defaultValue:e[i].defaultValue,onUpdate:e[i].onUpdate});else{var r=e[i];"words"===r?(o=function(e){e.innerHTML=Xn(s.getValue())},n=function(e){e.innerHTML=Xn(s.getValue())}):"lines"===r?(o=function(e){e.innerHTML=s.lineCount()},n=function(e){e.innerHTML=s.lineCount()}):"cursor"===r?(o=function(e){e.innerHTML="0:0"},n=function(e){var t=s.getCursor();e.innerHTML=t.line+":"+t.ch}):"autosave"===r&&(o=function(e){null!=t.autosave&&!0===t.autosave.enabled&&e.setAttribute("id","autosaved")}),a.push({className:r,defaultValue:o,onUpdate:n})}var c=document.createElement("div");for(c.className="editor-statusbar",i=0;i<a.length;i++){var l=a[i],d=document.createElement("span");d.className=l.className,"function"==typeof l.defaultValue&&l.defaultValue(d),"function"==typeof l.onUpdate&&this.codemirror.on("update",function(e,t){return function(){t.onUpdate(e)}}(d,l)),c.appendChild(d)}var h=this.codemirror.getWrapperElement();return h.parentNode.insertBefore(c,h.nextSibling),c}},Jn.prototype.value=function(e){return void 0===e?this.codemirror.getValue():(this.codemirror.getDoc().setValue(e),this)},Jn.toggleBold=vn,Jn.toggleItalic=kn,Jn.toggleStrikethrough=_n,Jn.toggleBlockquote=Cn,Jn.toggleHeadingSmaller=En,Jn.toggleHeadingBigger=Sn,Jn.toggleHeading1=Tn,Jn.toggleHeading2=An,Jn.toggleHeading3=Ln,Jn.toggleCodeBlock=xn,Jn.toggleUnorderedList=jn,Jn.toggleOrderedList=In,Jn.cleanBlock=Dn,Jn.drawLink=Mn,Jn.drawImage=On,Jn.drawTable=Pn,Jn.drawHorizontalRule=Rn,Jn.undo=$n,Jn.redo=zn,Jn.togglePreview=Nn,Jn.toggleSideBySide=Bn,Jn.toggleFullScreen=bn,Jn.prototype.toggleBold=function(){vn(this)},Jn.prototype.toggleItalic=function(){kn(this)},Jn.prototype.toggleStrikethrough=function(){_n(this)},Jn.prototype.toggleBlockquote=function(){Cn(this)},Jn.prototype.toggleHeadingSmaller=function(){En(this)},Jn.prototype.toggleHeadingBigger=function(){Sn(this)},Jn.prototype.toggleHeading1=function(){Tn(this)},Jn.prototype.toggleHeading2=function(){An(this)},Jn.prototype.toggleHeading3=function(){Ln(this)},Jn.prototype.toggleCodeBlock=function(){xn(this)},Jn.prototype.toggleUnorderedList=function(){jn(this)},Jn.prototype.toggleOrderedList=function(){In(this)},Jn.prototype.cleanBlock=function(){Dn(this)},Jn.prototype.drawLink=function(){Mn(this)},Jn.prototype.drawImage=function(){On(this)},Jn.prototype.drawTable=function(){Pn(this)},Jn.prototype.drawHorizontalRule=function(){Rn(this)},Jn.prototype.undo=function(){$n(this)},Jn.prototype.redo=function(){zn(this)},Jn.prototype.togglePreview=function(){Nn(this)},Jn.prototype.toggleSideBySide=function(){Bn(this)},Jn.prototype.toggleFullScreen=function(){bn(this)},Jn.prototype.isPreviewActive=function(){var e=this.codemirror.getWrapperElement().lastChild;return/editor-preview-active/.test(e.className)},Jn.prototype.isSideBySideActive=function(){var e=this.codemirror.getWrapperElement().nextSibling;return/editor-preview-active-side/.test(e.className)},Jn.prototype.isFullscreenActive=function(){return this.codemirror.getOption("fullScreen")},Jn.prototype.getState=function(){return wn(this.codemirror)},Jn.prototype.toTextArea=function(){var e=this.codemirror,t=e.getWrapperElement();t.parentNode&&(this.gui.toolbar&&t.parentNode.removeChild(this.gui.toolbar),this.gui.statusbar&&t.parentNode.removeChild(this.gui.statusbar),this.gui.sideBySide&&t.parentNode.removeChild(this.gui.sideBySide));var s=e.getTextArea();return e.toTextArea(),this.autosaveTimeoutId&&(clearTimeout(this.autosaveTimeoutId),this.autosaveTimeoutId=void 0,this.clearAutosavedValue()),s};const eo=to({label:"UTILS"});function to(e={}){const t=[`color: ${e.color||"#fff"}`,`background-color: ${e.bgcolor||"#87CEEB"}`,"padding: 2px 4px","border-radius: 2px"].join(";"),s=e.label||"",i=window.console;return{log(...n){so(i.log,!!e.time,s,t,...n)},error(...n){so(i.error,!!e.time,s,t,...n)},debug(...n){so(i.debug,!!e.time,s,t,...n)}}}function so(e,t,s,i,...n){if(t){e(`${(new Date).toLocaleTimeString()} %c${s}`,i,...n)}else e(`%c${s}`,i,...n)}Jn.wrap=function(e){return new Jn({element:e,spellChecker:!1,autoDownloadFontAwesome:!1})};const io="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz";Object.assign(window,{download:function(e,t,s){var i=document.createElement("a"),n=new Blob([e],{type:t}),o=URL.createObjectURL(n);i.setAttribute("href",o),i.setAttribute("download",s),i.click()},loadImage:async function(e,t=200,s=t){eo.debug("Load image begin ...");const{url:i,width:n,height:o}=await function(e,t=200,s=t){return new Promise(((i,n)=>{const o=dom.createElement("img","obj"),a=fileX.getExtension(e),r=fileX.getMimeType(a);"string"==typeof e||e instanceof Blob||(o.file=e);const c=new FileReader;var l;c.onload=(l=o,e=>{l.onload=()=>{var e=dom.createElement("canvas","photo"),n=e.getContext("2d");let o=l.width,a=l.height;o>a?o>t&&(a*=t/o,o=t):a>s&&(o*=s/a,a=s),e.width=o,e.height=a,n.drawImage(l,0,0,o,a),i({url:e.toDataURL(r),width:o,height:a})},l.src=e.target.result}),c.readAsDataURL(e)}))}(e,t,s),a=new Image;return a.src=i,a.width=n,a.height=o,eo.debug("Load image DONE!!!"),a},loadImageUrl:function(e,t=200,s=t){const i=dom.createElement("img","obj"),n=fileX.getExtension(e),o=fileX.getMimeType(n);return"string"==typeof e||e instanceof Blob||(i.file=e),new Promise(((n,a)=>{i.onerror=a,i.onload=()=>{var e=dom.createElement("canvas","photo"),a=e.getContext("2d");let r=i.width,c=i.height;r>c?r>t&&(c*=t/r,r=t):c>s&&(r*=s/c,c=s),e.width=r,e.height=c,a.drawImage(i,0,0,r,c),URL.revokeObjectURL(i.src),n({url:e.toDataURL(o),width:r,height:c})};const r=new FileReader;r.onerror=a,r.onload=()=>i.src=r.result,r.readAsDataURL(e)}))},loadVideoThumb:function(e,t=640,s=t){return eo.log("LOADING VIDEO"),new Promise(((i,n)=>{var o=dom.createElement("canvas","video"),a=o.getContext("2d");const r=URL.createObjectURL(e),c=dom.createElement("video");c.autoplay=!0,c.src=r,c.createTime=5,c.muted=!0;let l,d,h=!1;c.onloadedmetadata=e=>{eo.log("VIDEO metadata loaded",c.videoWidth,"x",c.height),eo.log(e),l=c.videoWidth,d=c.videoHeight,l>d?l>t&&(d*=t/l,l=t):d>s&&(l*=s/d,d=s),o.width=l,o.height=d},c.oncanplay=()=>{eo.log("VIDEO can play",c.width,"x",c.height),h||(c.currentTime=10,h=!0)},c.onseeked=()=>{a.drawImage(c,0,0,l,d);const e=new Image;e.src=o.toDataURL("image/jpeg"),e.width=l,e.height=d,c.pause(),i(e)},c.onerror=()=>n("Unable to load video")}))},parseMagnetURI:function(e){const t=e.match(/magnet:\?xt=urn:[a-z0-9]+:([a-z0-9]{40})(.+)/),s=t[1],i=t[2].slice(1).split("&"),n={uri:e,hash:s};for(const[e,t]of i.map((e=>e.split("=")))){const s=decodeURIComponent(t);n[e]?Array.isArray(n[e])?n[e].push(s):n[e]=[n[e],s]:n[e]=s}return n},generatePushID:function(e,t=Date.seconds()){for(var s="string"==typeof e?e.hashCode():e,i=1e3*t+s%1e3,n=(s^i)>>>0,o=new Array(8),a=7;a>=0;a--)o[a]=io.charAt(i%64),i=Math.floor(i/64);var r=o.join(""),c=io.slice(a=n%64)+io.slice(0,a);for(a=7;a>=0;a--)o[a]=c.charAt(n%64),n=Math.floor(n/64);return r+=o.join("")},createConsole:to,CacheMap:function(e){var t=Ki(e);return{get:cn(sn,t),getAll:cn(nn,t),has:cn(tn,t),set:function(e,s){return on(t,e,s),s},remove:function(e){return an(t,e),!0},reset:cn(rn,t),getCacheMeta:function(){return t},getOptions:function(){return t.options},setOptions:cn(Yi,t),doMaintenance:cn(Qi,t),values(){return Object.values(this.getAll())}}},MDE:Jn,le:(e,t)=>e<t,leq:(e,t)=>e<=t,gt:(e,t)=>e>t,gte:(e,t)=>e>=t});const no={append(e,t=!1){t?this.area.insertBefore(e,this.area.firstElementChild):this.area.appendChild(e)},appendTemplate(e,t,s="div",...i){const n=dom.renderTemplate(e,t,s,[...i]);return this.append(n),n},removeContent(){dom.removeChilds(this.area)},querySelector(e){return this.area.querySelector(e)},querySelectorAll(e){return this.area.querySelectorAll(e)},getLastElement(){return this.area.lastElementChild},getFirstElement(){return this.area.firstElementChild},moveTop(e,t=!1){t?dom.moveAfterTop(e):dom.moveTop(e)},insertTop(e){dom.insertTop(e,this.area)},addStyle(...e){this.area.classList.add(...e)},removeStyle(...e){this.area.classList.remove(...e)},removeSelf(){dom.removeElement(this.area)},getViewport(){return this.area.getBoundingClientRect()},showSelf(e){const t=e?this.area.parentElement:this.area;dom.showElement(t)},hideSelf(e){const t=e?this.area.parentElement:this.area;dom.hideElement(t)},childCount(){return this.area.childElementCount}};class oo{#r;#c;#l;get area(){return this.#c}get viewport(){return this.#r.getBoundingClientRect()}set bottom(e){this.alignBottom=e,this.posY=1}get sliderMaxY(){return this.height-this.sliderHeight}get sliderPosY(){return this.sliderMaxY*this.posY}get containerElement(){return this.#r}get parentElement(){return this.#r.parentElement}get firstElement(){return this.#r.firstElement}get Y(){return this.posY}set Y(e){this.posY=e,this.#d(),this.#h()}get offsetY(){return Math.floor(this.posY*this.totalHeight)}set offsetY(e){if(this.totalHeight>0){const t=Math.abs(e/this.totalHeight);this.Y=t<=1?t:1}}constructor(e){this.height=e.getBoundingClientRect().height,this.scroller=e.querySelector("div.v-scroller"),this.slider=this.scroller.querySelector("div.slider"),this.#c=e.querySelector("div.content");const t=this.area.getBoundingClientRect();this.totalHeight=t.height,this.#l=t.width,this.posY=0,this.alignBottom=!1,this.scrolling=!1,this.#c.hasAttribute("bottom")&&(this.bottom=!0),this.#r=e,this.#u(),this.resizeObserver=new ResizeObserver((t=>{const s=Math.floor(e.getBoundingClientRect().height);s>0&&(this.height=s,this.#p())})),this.resizeAreaObserver=new ResizeObserver((()=>{const e=this.#c.getBoundingClientRect(),t=Math.ceil(e.height);if(Math.abs(this.#l-e.width)>20){this.#l=e.width;const t=this.area.querySelectorAll(".marquee-container > .marquee");for(const e of t){const t=e.clientWidth,s=e.parentElement.clientWidth;let i=s/100*1.2;t>s?i+=t/s:i-=s/t,i=Math.floor(i),i<4&&(i=4),e.style.animationDuration=`${i}s`}}if(t>0){const e=this.alignBottom?this.totalHeight-this.offsetY:this.offsetY,s=this.totalHeight;this.totalHeight=t,this.#u(),this.offsetY=this.alignBottom?t-e:e,this.onHeightChange(s,t,this.height)}}))}registerEvents(){this.resizeObserver.observe(this.#r),this.resizeAreaObserver.observe(this.area),this.#r.addEventListener("wheel",this,{passive:!0}),this.#r.addEventListener("keyup",this),this.registerSliderEvents()}unregisterEvents(){this.resizeObserver.unobserve(this.#r),this.resizeAreaObserver.unobserve(this.area),this.#r.removeEventListener("wheel",this),this.#r.removeEventListener("keyup",this),this.unregisterSliderEvents()}registerSliderEvents(){this.slider.addEventListener("mouseup",this),this.slider.addEventListener("mousedown",this),this.slider.addEventListener("mouseleave",this),this.slider.addEventListener("mousemove",this)}unregisterSliderEvents(){this.slider.removeEventListener("mouseup",this),this.slider.removeEventListener("mousedown",this),this.slider.removeEventListener("mouseleave",this),this.slider.removeEventListener("mousemove",this)}handleEvent(e){switch(e.type){case"wheel":if(this.totalHeight>this.height){if(this.posY<=0&&e.deltaY<0)return;if(this.posY>=1&&e.deltaY>0)return;const t=e.deltaY;let s=this.posY+t/this.totalHeight;s>1?s=1:s<0&&(s=0),this.posY=s,this.#m()}return!0;case"keyup":if(this.totalHeight>this.height){const t=this.height/this.totalHeight;33==e.keyCode?this.posY>0&&(this.posY-=t,this.posY<0&&(this.posY=0),this.#m()):34==e.keyCode&&this.posY<1&&(this.posY+=t,this.posY>1&&(this.posY=1),this.#m())}return!0;case"mousedown":e.stopPropagation(),this.scrolling=!0,this.sliderY=e.offsetY;break;case"mouseup":e.stopPropagation(),this.scrolling=!1;break;case"mousemove":if(this.scrolling){e.stopPropagation();const t=e.offsetY-this.sliderY,s=this.sliderPosY;if(s<=0){if(t<=0)return;this.posY=t/this.sliderMaxY}else this.posY*=(s+t)/s;this.posY>1?this.posY=1:this.posY<0&&(this.posY=0),this.#m()}break;case"mouseleave":this.scrolling=!1,e.stopPropagation()}return!1}setFocus(){this.#r.focus()}scrollTo(e){const t=e.getBoundingClientRect().top;if(t<=10)return void(this.Y=0);const s=this.totalHeight;s>0&&(console.log("###",t,s),this.Y=t/s)}scrollBottom(){this.posY=1,this.#m(),this.alignBottom&&this.totalHeight<this.height&&(this.area.style.top=this.height-this.totalHeight+"px")}onScrollY(){}onHeightChange(){}#m(){this.#d(),this.#h();const e=Math.floor(this.posY*this.totalHeight);this.onScrollY(e,this.totalHeight)}#u(){this.#p(),this.#h()}#p(){if(0!=this.totalHeight)if(this.totalHeight<=this.height)this.scroller.style.display="none";else{this.scroller.style.display="block",this.scroller.style.height=`${this.height}px`;const e=this.height/this.totalHeight;let t=this.height*e;t<20&&(t=20),this.slider.style.height=`${t}px`,this.sliderHeight=t,this.#d()}else this.scroller.style.display="none"}#d(){const e=Math.floor((this.height-this.sliderHeight)*this.posY);this.slider.style.top=`${e}px`}#h(){if(this.totalHeight<=this.height)return void(this.alignBottom?this.area.style.top=this.height-this.totalHeight+"px":this.area.style.top="0px");const e=this.totalHeight-this.height,t=Math.ceil(this.posY*e);this.area.style.top=-t+"px"}static createContent(e){const t=dom.createElement("div","slider"),s=dom.createElement("div","v-scroller");s.appendChild(t);const i=dom.createElement("div","shadow"),n=dom.createElement("div","content");n.setAttribute("tabindex","0");const o=dom.createElement("div","area");o.appendChild(i),o.appendChild(n),e.appendChild(s),e.appendChild(o),e.classList.add("scrollable")}static create(e){return oo.createContent(e),new oo(e)}static createElement(e){const t=dom.renderTemplate("scrollable");return e&&e.appendChild(t),t}static createMixin(e){return{area:e,...no}}}Object.assign(oo.prototype,no);const ao="hidden";class ro{constructor(e){let t="string"==typeof e?document.getElementById(e):e;"TEMPLATE"==t.tagName&&(t=dom.renderTemplate(t.id)),this.container=t}set id(e){this.container.dataset.id=e}get id(){return this.container.dataset.id||this.container.id}get headerElement(){return this.container.querySelector(":scope > .header")}get editorElement(){return this.container.querySelector(".editor")}get active(){return!this.container.classList.contains(ao)}get viewport(){return this.container.getBoundingClientRect()}set mode(e){e?this.container.setAttribute("mode",e):this.container.removeAttribute("mode")}onAction(){}onCommand(){}onEditorAction(){}onInput(){}onChange(){}onFilter(){}onKeyPress(){}onClick(){}onLinkClick(){}onElementClick(){}onResize(){}loadAutocomplete(){}static createHeader(e){const t=dom.createElement("div","header");return e.appendChild(t),t}static createEditor(e){const t=dom.createElement("div","editor");return e.appendChild(t),t}}const co={hide(){this.container.classList.add(ao)},show(){this.container.classList.remove(ao)},getElementByClass(e){return this.container.querySelector(`:scope > .${e}`)},getButton(e){return this.container.querySelector(`button[name="${e}"]`)},showLoading(){const e=dom.createElement("div","loader");return this.container.appendChild(e),e},query(e){return this.container.querySelector(e)},appendChild(e,t=!1){t&&this.container.firstElementChild?dom.insertBefore(e,this.container.firstElementChild):this.container.appendChild(e)},removeChilds(){dom.removeChilds(this.container)},clearContent(){this.container.innerHTML=""},removeSelf(){dom.removeElement(this.container)},updateTimes(e=Date.now()){dom.updateElapsed(this.container,e)},addStyle(...e){this.container.classList.add(...e)},toggleLoading(){return this.container.classList.toggle("loading3")},addTemplate(e,t,s="div",...i){const n=dom.renderTemplate(e,t,s,...i);return this.container.appendChild(n),n},queryElement(e){return this.container.querySelector(e)},querySelector(e){return this.container.querySelector(e)},querySelectorAll(e){return this.container.querySelectorAll(e)}};Object.assign(ro.prototype,co);class lo extends ro{get sashElement(){return this.container.querySelector("div.v-sash")}get sidebarElement(){return this.container.querySelector("div.sidebar")}get meta(){return{}}static createMixin(e){return{container:e,...co}}}class ho{constructor(){this.pages=new Map,this.current=null}get currentPage(){return this.pages.get(this.current)}}const uo={addPage(e,t){let s=t;if("string"==typeof t){const i=document.getElementById(t);return s=new lo(i),s.hide(),void this.pages.set(e,s)}return t.hide(),this.pages.set(e,t),s},switchTo(e){if(this.current==e)return this.pages.get(e);if(this.current){this.pages.get(this.current).hide()}const t=this.pages.get(e);return t&&(t.show(),this.current=e),t},getPage(e){return this.pages.get(e)},getCurrentPage(){return this.pages.get(this.current)},remove(e){let t;"string"==typeof e?(t=e,e=this.pages.get(t)):t=e.id;const s=e.container;dom.removeElement(s),this.pages.delete(t)}};Object.assign(ho.prototype,uo);const po=Object.assign({addItem(e,t=!1){const s=e.create();return e.render(s),this.append(s),t&&this.area.insertBefore(s,this.area.firstElementChild),s},addItemTemplate(e,t,s=!1,...i){const n=this.elementTag||"div";let o=[];i.length>0&&Array.isArray(i[0])&&(o=i.shift());const a=dom.renderTemplate(e,t,n,...o);if(a.classList.add("item"),!a.dataset.id&&t.id&&(a.dataset.id=t.id),i.length>0&&a.classList.add(...i),this.append(a),s){let e=this.area.firstElementChild;if("li"===n)e&&"LH"==e.tagName&&(e=e.nextElementSibling);this.area.insertBefore(a,e)}return a},addGroup(e={},t=!1){return mo.createGroup(this.area,e,t)},addContent(e={}){const t=Object.assign({template:"list-group-content",item:"list-base-item",hide:!1,empty:!1,draggable:!1,visible:-1>>>0},e),s=dom.renderTemplate(t.template,t);return t.name&&s.setAttribute("name",t.name),t.id&&(s.dataset.id=t.id),top?this.area.insertBefore(s,this.area.firstElementChild):this.area.appendChild(s),go(s,t)},wrapGroup(e,t){const s="string"==typeof e?this.area.querySelector(`[group="${e}"]`):e;return mo.wrapGroup(s,t)},open(e){if(!e)return;const t=this.getElement(e);t&&!t.hasAttribute("selected")&&(this.clearSelection(),t.setAttribute("selected",""))},clearSelection(){mo.clearSelection(this.area)},getSelected(){return this.querySelector(".item[selected]")},selectItem(e){const t=this.getSelected();if(t){if(t.dataset.id==e)return;t.removeAttribute("selected")}const s=this.getElement(e);return s&&s.setAttribute("selected",""),s},delete(e){const t=this.getElement(e);return t&&t.parentElement.removeChild(t),t},getElement(e){return this.area.querySelector(`.item[data-id="${e}"]`)},getElements(e){const t=e?`.item[data-id="${e}"]`:".item[data-id]";return Array.from(this.querySelectorAll(t))},getLastElement(){return this.area.lastElementChild},getElementBy(e,t){return this.area.querySelector(`.item[data-${e}="${t}"]`)},getElementsBy(e,t){return this.area.querySelectorAll(`.item[data-${e}="${t}"]`)},getElementByClass(e){return this.area.querySelector(`.item.${e}`)},getElementIds(){return this.getElements().map((e=>e.dataset.id))},getItem(e){return this.area.querySelector(`:scope > .item[data-id="${e}"]`)},getItems(e,t,s=":scope > .item"){return e&&(s+=t?`[data-${e}="${t}"]`:`[data-${e}]`),this.area.querySelectorAll(s)},queryItems(e){const t=`:scope > .item ${e}`;return this.area.querySelectorAll(t)},registerClickHandlers(){this.area.onclick=e=>{const t=e.target;if(!mo.handleClick(t,this)&&"BUTTON"===t.tagName){let e,s=t.closest(".item[data-id]");if(s)e=s.dataset.id;else{let s,i=t.closest(".group");s=i?i.querySelector("[group]"):t.closest("[group]"),s&&(e=s.getAttribute("group"))}this.onAction(t.name,e,t)}}},filter(e,t=".item"){if(!e||""==e){const e=this.querySelectorAll(".item[data-name].filter");for(const t of e)t.classList.remove("filter");return}const s=new RegExp(e,"i"),i=this.getItems("name",null,t);for(const e of i){const t=e.dataset.name;s.test(t)?e.classList.remove("filter"):e.classList.add("filter")}},filterDelay(e,t,s=[".name"]){const i=()=>{const e=this.getItems();for(const t of e)dom.showElement(t)};console.debug("Filter:",e),this._filter=e.toLowerCase(),e.length<3?i():(this._filterTimeout&&clearTimeout(this._filterTimeout),this._filterTimeout=setTimeout((async()=>{if(this._filter.length<3)i();else{this.toggleLoading(),t.disabled=!0,await sleep(800),t.disabled=!1,t.focus(),this.toggleLoading();const e=this.getItems();for(const t of e){let e=!1;for(const i of s){if(-1!=t.querySelector(i).innerText.toLowerCase().search(this._filter)){e=!0;break}}e?dom.showElement(t):dom.hideElement(t)}}delete this._filter,delete this._filterTimeout}),1e3))},sort(e){const t=this.getItems(),s=[].slice.call(t).sort(e);for(const e of s)this.area.appendChild(e)},clear(){const e=this.getElements();for(const t of e)dom.removeElement(t)},toggleLoading(){return this.area.classList.toggle("loading3")},async loadGroups(){const e=this.area.querySelectorAll("[group][ds]");for(const t of e)await mo.loadGroup(t)}},no);class mo extends oo{set hover(e){e?this.containerElement.removeAttribute("nohover"):this.containerElement.setAttribute("nohover","")}scrollToItem(e){const t=this.getElement(e);t&&(this.scrollTo(t),dom.highlightElement(t))}static create(e){const t=mo.createElement(e);return new mo(t)}static createElement(e){const t=oo.createElement(e);return t.classList.add("list2"),t.tabIndex=0,t}static createItemElement(e){const t=document.createElement("div");return t.classList.add("item",...e.template.split(" ")),e.id&&(t.dataset.id=e.id),e.draggable&&(t.draggable=!0,t.addEventListener("dragstart",(t=>e.setDraggableData(t.dataTransfer)))),t}static clearSelection(e){const t=e.querySelectorAll(".item[selected]");for(const e of t)e.removeAttribute("selected")}static createMixin(e,t="div"){return{area:e,elementTag:t,...po}}static createPageMixin(e,t="div"){return{container:e,area:e,elementTag:t,...co,...po}}static createGroup(e,t,s=!1){const i=Object.assign({template:"list-group",item:"list-base-item",badge:!1,collapse:!0,hide:!1,empty:!1,draggable:!1,visible:-1>>>0},t);let n,o;if(i.template?(n=dom.renderTemplate(i.template,i),o=n.querySelector(".content")):(n=dom.createElement("div","list"),o=n),i.classes&&n.classList.add(...Array.isArray(i.classes)?i.classes:i.classes.split(" ")),i.badge&&n.classList.add("badge"),i.name&&n.setAttribute("name",i.name),i.id&&(n.dataset.id=i.id),s?e.insertBefore(n,e.firstElementChild):e.appendChild(n),i.help){const e=dom.renderTemplate(i.help);o.classList.add("help"),o.appendChild(e)}return go(o,i)}static wrapGroup(e,t){const s=mo.createMixin(e),i=t||e.getAttribute("template")||"list-base-item",n=parseInt(e.getAttribute("visible")||5);return e.dataset.count||(e.dataset.count=n),s.add=function(t,s=!1,...n){const o=this.addItemTemplate(i,t,s,...n);if(this.childCount()>parseInt(e.dataset.count))if(s);else{dom.hideElement(o);const t=e.closest(".group");if(t){const e=t.querySelector('[name="_more"]');e&&dom.showElement(e)}}return o},s.get=function(e){return this.getItem(e)},s.load=async function(e){const t=await e.ls();for(const e of t)this.add(e)},s.push=function(...e){for(const t of e)this.add(t)},s}static async loadGroup(e){const t=mo.wrapGroup(e),s=app.ds(e.getAttribute("ds"));let i,n,o;t.toggleLoading(),i=await delayResolve(s.load(t),1200),t.toggleLoading(),o=e.closest(".group"),o&&(n=o.querySelector('[name="_more"]'),n&&(i?dom.showElement(n):dom.hideElement(n)))}static handleClick(e,t){if("BUTTON"==e.tagName)switch(e.name){case"_less":{const t=e.parentElement.nextElementSibling,s=parseInt(t.getAttribute("visible")),i=fo(t).reverse(),n=i.length-s>=s?s:i.length-s;for(let e=0;e<n;++e)dom.hideElement(i[e]);t.classList.add("more"),i.length-n<=s&&t.parentElement.classList.remove("less")}return!0;case"_up":{const t=e.closest(".group");if(t){let e;for(;e=t.previousElementSibling,e&&e.classList.contains("group")&&(dom.moveUp(t),!dom.isElementVisible(e)););}}return!0;case"rm":{const t=e.closest(".item");if(t){const e=t.closest("[group]");if(e){const t=e.querySelector(":scope > .item.hidden");t&&dom.showElement(t);e.closest(".group")}dom.removeElement(t)}}}else if("A"==e.tagName)switch(e.name){case"_more":{const t=e.closest(".group");if(t){const s=t.querySelector("[group]");if(s){const t=parseInt(s.getAttribute("visible")||5),i=parseInt(s.dataset.count||t);s.dataset.count=i+t;const n=fo(s,!1).slice(0,t);for(const e of n)dom.showElement(e);n.length<t&&(dom.hideElement(e),s.hasAttribute("ds")&&mo.loadGroup(s))}const i=t.querySelector('[name="_less"]');i&&dom.showElement(i)}}return!0;case"_less":{const t=e.closest(".group");if(t){const s=t.querySelector("[group]");if(s){const t=parseInt(s.getAttribute("visible")||5),i=parseInt(s.dataset.count||t),n=i-t;s.dataset.count=n;const o=fo(s),a=t-(i-o.length);for(const e of o.reverse().slice(0,a))dom.hideElement(e);n==t&&dom.hideElement(e)}const i=t.querySelector('[name="_more"]');i&&dom.showElement(i)}}return!0}else{if(e.hasAttribute("grouphdr"))return e.parentElement.classList.toggle("collapsed"),!0;if(e.hasAttribute("group")&&e.classList.contains("more")){const t=parseInt(e.getAttribute("visible")),s=e.querySelectorAll(":scope > .item.hidden"),i=Math.min(s.length,t);for(let e=0;e<i;++e)dom.showElement(s[e]);s.length<=t&&e.classList.remove("more");return e.parentElement.classList.add("less"),!0}}if(t){if(e.classList.contains("item")){const s=e.dataset.id;t.onClick(s,e)}}}}Object.assign(mo.prototype,po);function go(e,t){return t.hide&&e.classList.add("hidable"),t.empty&&e.classList.add("show-empty"),t.count&&e.classList.add("count"),t.hideFirst&&e.classList.add("hide-first"),t.cmd&&e.setAttribute("cmd",t.cmd),t.ds&&e.setAttribute("ds",t.ds),t.item&&e.setAttribute("template",t.item),{count:0,...mo.createMixin(e),addTemplate(s,i,n=!1,o=[],...a){let r=!1;if(t.visible){const s=t.visible;r=!n,this.count>s?e.classList.add("more"):this.count<s&&(r=!1)}++this.count;const c=this.addItemTemplate(s,i,n,o,...a);return t.draggable&&(c.draggable=!0),r&&dom.hideElement(c),c},add(...e){return this.addTemplate(t.item,...e)},get(e){return this.getItem(e)},async load(e,t){const s=await e.ls();t&&s.sort(t);for(const e of s)this.add(e)},push(...e){for(const t of e)this.add(t)}}}function fo(e,t=!0){const s=t?":not(.hidden)":".hidden";return Array.from(e.querySelectorAll(":scope > .item"+s))}class wo extends lo{get scrollableElement(){return this.query(".editor .scrollable")}get scrollableContent(){return this.query(".editor .scrollable > .area > .content")}set bottom(e){this.area.setAttribute("bottom","")}get height(){return this.scrollableElement.getBoundingClientRect().height}constructor(e,t={}){let s;s=e?"string"==typeof e?document.getElementById(e):e:dom.renderTemplate("editor-base",t,"div","editor-header-grid","editor-scrollable"),s.querySelector("div.header")||wo.createHeader(s);let i=s.querySelector("div.editor");i||(i=wo.createEditor(s));let n=i.querySelector(".scrollable");n||(n=oo.createElement(i)),super(s),this.area=n.querySelector(".content")}onScrollY(){}onResize(){}registerEvents(){}}Object.assign(wo.prototype,no);class yo extends wo{constructor(e){super(e);this.scrollableElement.classList.add("list2")}}Object.assign(yo.prototype,po);class bo extends yo{onFilter(e){1!=e.length&&this.filter(e)}}class vo extends bo{pages=new Map;get currentPage(){return this.pages.get(this.current)}}Object.assign(vo.prototype,uo),window.UX={Scrollable:oo,ScrollableMixin:no,List:mo,ListMixin:po,ListItem:class{constructor(e){this.info=e}get template(){return"column"}get id(){return this.info.id}get draggable(){return!1}create(){return mo.createItemElement(this)}render(){}},Page:lo,PageController:ho,PageControllerMixin:uo,ScrollablePage:wo,ListPage:bo,ListPageController:vo};class ko{#g=!1;get name(){return"app"}get version(){return 1}get isSetup(){return this.#g}async init(){if(!window.indexedDB)throw console.log("Your browser doesn't support IndexedDB"),new Error("IndexDB is not supported");this.db=await this.#f(),this.isSetup&&this.setup()}setup(){}ls(e,t=!1,s=0,i=100){return this.#w(Co(e),t,s,i)}tail(e,t=0,s=50){return this.#w(Co(e),!0,t,s)}lsByIndex(e,t,s,i=!1,n=30,o=0){return this.#y(Co(e),t,s,o,n,i)}lsByRating(e,t,s){return this.#b(Co(e),"rating",t,s,!0)}lsByRange(e,t,s,i,n=!1,o=50){return this.#v(Co(e),t,s,i,n,o)}count(e){return this.#k(Co(e))}put(e,t){return ko.put(this.db,Co(e),t)}update(e,...t){return this.#m(Co(e),...t)}updateByIndex(e,...t){return this.#_(Co(e),...t)}push(e,...t){return this.#x(Co(e),...t)}get(e,t){return this.#C(Co(e),t)}rm(e,t){return this.#E(Co(e),t)}rmByIndex(e,t,s){return this.#S(Co(e),t,s)}pushValue(e,t,s,i){return this.#T(Co(e),t,s,i)}pushValueByIndex(e,t,s,i,n){return this.#A(Co(e),t,s,i,n)}deleteValue(e,...t){return this.#L(Co(e),...t)}deleteValueByIndex(e,...t){return this.#j(Co(e),...t)}add(e,t){return this.#I(Co(e),t)}getById(e){return this.#C(kContact,e)}getByEmail(e){return this.#D(kContact,"email",e)}getByIndex(e,t,s){return this.#D(e,t,s)}#f(){const e=this.name,t=this.version;return new Promise(((s,i)=>{const n=indexedDB.open(e,t);n.onerror=e=>{console.error(`Database error: ${e.target.errorCode}`),i(e.target.errorCode)},n.onsuccess=e=>{const t=e.target.result;s(t)},n.onupgradeneeded=e=>{const t=e.target.result,s=e.target.transaction,i=e.oldVersion;this.onUpgrade(t,s,i),0==i&&(this.#g=!0)}}))}#y(e,t,s,i=0,n=50,o=!1){return new Promise(((a,r)=>{const c=this.db.transaction(e,"readonly").objectStore(e),l=s?IDBKeyRange.only(s):IDBKeyRange.lowerBound(0),d=c.index(t).openCursor(l,o?"prev":"next");let h=0==i,u=0;const p=[];d.onsuccess=e=>{const t=e.target.result;if(t)if(h){const e=t.value;p.push(e),u++,u<n?t.continue():a(p)}else h=!0,t.advance(i);else a(p)},d.onerror=e=>{r(e)}}))}addOne(e,t){return new Promise(((s,i)=>{let n=this.db.transaction(e,"readwrite").objectStore(e).add(t);n.onsuccess=s,n.onerror=i}))}#E(e,t){return new Promise(((s,i)=>{const n=this.db.transaction(e,"readwrite").objectStore(e);let o=t?n.delete(t):n.clear();o.onsuccess=function(e){s()},o.onerror=function(e){console.log(e.target.errorCode),i(e.target.errorCode)}}))}#S(e,t,s){return new Promise(((i,n)=>{const o=this.db.transaction(e,"readwrite").objectStore(e).index(t).openCursor(s);o.onerror=i,o.onsuccess=e=>{const t=e.target.result;if(!t)return void i();t.delete();t.continue()}}))}#I(e,t){const s=this.db.transaction(e,"readwrite").objectStore(e);Array.isArray(t)||(t=[t]),console.log("IndexDB: adding new entries =>",e,"\n",t.map((e=>e.id)));const i=[];for(const e of t)i.push(new Promise(((t,i)=>{let n=s.add(e);n.onsuccess=function(e){t()},n.onerror=i})));return Promise.all(i)}#m(e,t,s,i={}){return new Promise(((n,o)=>{const a=this.db.transaction(e,"readwrite").objectStore(e),r=a.openCursor(IDBKeyRange.only(t));r.onsuccess=e=>{const r=e.target.result;let c;if(r){const e=Object.assign(r.value,s);Object.deleteUndefined(e),c=r.update(e)}else{const e={id:t,...i,...s};c=a.add(e)}c.onsuccess=function(e){n()},c.onerror=o},r.onerror=o}))}#_(e,t,s,i,n={}){return new Promise(((o,a)=>{const r=this.db.transaction(e,"readwrite").objectStore(e),c=r.index(t).openCursor(s);c.onsuccess=e=>{const t=e.target.result;let s;if(t){const e=Object.assign(t.value,i);Object.deleteUndefined(e),s=t.update(e)}else{const e={...n,...i};s=r.add(e)}s.onsuccess=function(e){o()},s.onerror=a},c.onerror=a}))}#T(e,t,s,i){return new Promise(((n,o)=>{const a=this.db.transaction(e,"readwrite").objectStore(e).openCursor(IDBKeyRange.only(t));_o(s,i,a,n,o)}))}#A(e,t,s,i,n){return new Promise(((o,a)=>{const r=this.db.transaction(e,"readwrite").objectStore(e).index(t).openCursor(s);_o(i,n,r,o,a)}))}#L(e,t,s,i){return new Promise(((n,o)=>{const a=this.db.transaction(e,"readwrite").objectStore(e).openCursor(IDBKeyRange.only(t));xo(s,i,a,n,o)}))}#j(e,t,s,i,n){return new Promise(((o,a)=>{const r=this.db.transaction(e,"readwrite").objectStore(e).index(t).openCursor(s);xo(i,n,r,o,a)}))}#x(e,t,s,i){return new Promise(((n,o)=>{const a=this.db.transaction(e,"readwrite").objectStore(e).openCursor(IDBKeyRange.only(t));a.onsuccess=e=>{const t=e.target.result;let a;if(!t)return o("Appending to non-existing record");const r=t.value;r[s]?r[s].push(i):r[s]=[i],r.ts&&(r.ts=Date.seconds()),a=t.update(r),a.onsuccess=function(e){console.log(e),n()},a.onerror=function(e){console.log(e.target.errorCode),o(e.target.errorCode)}},a.onerror=o}))}#C(e,t){return new Promise(((s,i)=>{let n=this.db.transaction(e,"readonly").objectStore(e).get(t);n.onsuccess=i=>{i.target.result?s(i.target.result):(console.log(`IndexDB: ${t} not found in ${e}`),s(null))},n.onerror=i}))}#D(e,t,s){return new Promise(((i,n)=>{let o=this.db.transaction(e,"readonly").objectStore(e).index(t).get(s);o.onsuccess=e=>{i(o.result)},o.onerror=n}))}#w(e,t,s,i){return new Promise(((s,n)=>{const o=this.db.transaction(e,"readonly").objectStore(e),a=[],r=o.openCursor(null,t?"prev":"next");let c=0;r.onsuccess=e=>{let t=e.target.result;if(t){let e=t.value;a.push(e),++c<i?t.continue():s(a)}else s(a)},r.onerror=n}))}#b(e,t,s=0,i=50,n=!1){return new Promise(((o,a)=>{const r=this.db.transaction(e,"readonly").objectStore(e),c=IDBKeyRange.lowerBound(0),l=r.index(t).openCursor(c,n?"prev":"next");let d=0==s,h=0;const u=[];l.onsuccess=e=>{const t=e.target.result;if(t)if(d){const e=t.value;u.push(e),h++,h<i?t.continue():o(u)}else d=!0,t.advance(s);else o(u)},l.onerror=a}))}#v(e,t,s,i,n=!1,o=50){return new Promise(((a,r)=>{const c=this.db.transaction(e,"readonly").objectStore(e);let l;l=s?i?IDBKeyRange.bound(s,i,!1,!0):IDBKeyRange.lowerBound(s):IDBKeyRange.upperBound(i,!0);const d=c.index(t).openCursor(l,n?"prev":"next"),h=[];let u=0;d.onsuccess=e=>{let t=e.target.result;if(t){let e=t.value;h.push(e),++u<o?t.continue():a(h)}else a(h)},d.onerror=r}))}#k(e){return new Promise(((t,s)=>{const i=this.db.transaction(e,"readonly").objectStore(e).count();i.onsuccess=e=>{const s=e.target.result;t(s)},i.onerror=s}))}#M(e){return new Promise(((t,s)=>{const i=this.db.transaction(e,"readonly").objectStore(e).clear();i.onsuccess=()=>t(),i.onerror=s}))}delete(e,t,s,i){return new Promise(((n,o)=>{const a=this.db.transaction(e,"readwrite").objectStore(e);let r,c;if(t){r=s==i?IDBKeyRange.only(s):s?i?IDBKeyRange.bound(s,i,!1,!0):IDBKeyRange.lowerBound(s):IDBKeyRange.upperBound(i,!0);c=a.index(t).openCursor(r)}else c=a.openCursor();c.onsuccess=e=>{let t=e.target.result;t?(t.delete(),t.continue()):n()},c.onerror=o}))}static put(e,t,s){const i=e.transaction(t,"readwrite").objectStore(t);Array.isArray(s)||(s=[s]);const n=[];for(const e of s)n.push(new Promise(((t,s)=>{let n=i.put(e);n.onsuccess=function(e){t()},n.onerror=s})));return Promise.all(n)}}function _o(e,t,s,i,n){s.onsuccess=s=>{const o=s.target.result;let a;if(o){const s=o.value;s[e]||(s[e]=[]),Array.isArray(t)?s[e].push(...t):s[e].push(t),a=o.update(s),a.onsuccess=i,a.onerror=n}else i()},s.onerror=n}function xo(e,t,s,i,n){s.onsuccess=s=>{const o=s.target.result;let a;if(o){const s=o.value,r=s[e];Array.isArray(r)&&t?s[e]=r.filter((e=>e!=t)):delete s[e],a=o.update(s),a.onsuccess=function(e){i()},a.onerror=n}else i()},s.onerror=n}function Co(e){return"article"===e?"news":e}function Eo(e,t,s=!1,i="id"){const n={keyPath:i,autoIncrement:s};e.createObjectStore(t,n)}function So(e,t,s,i=!1,n=t){s.objectStore(e).createIndex(n,t,{unique:i})}const To=86400,Ao="contact",Lo="channel",jo="history",Io="room",Do="recent",Mo="post",Oo="comment",Po="games2",Ro="audio",$o="file",zo="chat",Bo="cache",No=new TextDecoder("utf-8");class Fo extends ko{get version(){return 6}async init(){await super.init(),await this.updateHistory()}setup(){return app.setupDatabase(this)}onUpgrade(e,t,s){switch(s){case 0:Eo(e,"settings"),Eo(e,Ao),Eo(e,Lo),Eo(e,Mo),Eo(e,Oo),Eo(e,jo,!0),Eo(e,Io),Eo(e,Ro),Eo(e,"playlist"),Eo(e,"torrent"),Eo(e,Do,!1,"_id"),Eo(e,"game"),Eo(e,"offline",!0),Eo(e,$o),Eo(e,"scraper"),Eo(e,"domain"),Eo(e,"news"),Eo(e,"task"),Eo(e,zo,!0),Eo(e,"games"),Eo(e,Bo),Eo(e,"pin"),Eo(e,"radio"),So(Ao,"email",t,!0),So(Lo,"ts",t),So(Lo,"remote",t),So(Mo,"ts",t),So(Mo,"channel",t),So(Oo,["channel","gid"],t,!1,"topic"),So(Oo,["user","ts"],t,!1,"latest"),So(jo,"uid",t),So(Ro,"rating",t),So(Ro,"type",t),So($o,"type",t),So(zo,"uid",t),So(zo,"ts",t),So("games","user",t),So("games",["id","user"],t,!0,"gid"),So(Bo,["id","type"],t,!0,"uid"),So(Do,["_type","ts"],t,!1,"latest"),So("pin","type",t);case 1:So(Ao,"ts",t);case 2:Eo(e,"update");case 3:Eo(e,Po),So(Po,"type",t),So(Po,"user",t);case 4:So(Po,["type","ts"],t,!1,"recent");case 5:So(Io,"uid",t)}}addHistory(e){return this.addOne(zo,e)}async getHistory(e,t=Date.seconds()){const s=[e,0],i=[e,t];let n=await this.lsByRange(zo,"user",s,i,!0,10),o=n.length;const a=10==n.length,r=[];for(const e of n.slice().reverse()){if(!e.data)break;--o,r.push(...Wo(e))}return r.reverse(),n.splice(o,n.length-o,...r),[n,a]}async getHistoryOld(e,t=-1){if(-1==t){const s=await this.lsByIndex(zo,"uid",e,!1,1e4);if(s.length>0)return[s,!0];t=0}const[s]=await this.lsByIndex(jo,"uid",e,!0,1,t);if(!s)return null;const i=[],n=new TextDecoder("utf-8");let o=unzip(s.data,null);for(;o.length>0;){const e=new DataView(o.buffer),t=e.getUint16(0)+s.ts,a=!!e.getUint8(2);o=o.slice(3);let r=0;for(;r<o.length&&0!=o[r];++r);const c=o.slice(0,r),l={ts:t,own:a},d=n.decode(c).replace(/^\[\[([A-z0-9]+)\]\] /,((e,t)=>(l.user=t,"")));l.msg=d,i.push(l),o=o.slice(r+1)}return[i,!1]}async updateHistory(){const e=[Date.seconds(To),1],t=await this.lsByRange(zo,"latest",[0,1],e,!1,1e4);if(0==t.length)return;const s=t[0].ts,i=new Map;let n,o=0,a=0;for(const e of t)e.ts>=a&&(o=Ho(t[0].ts),a=o+To,n=[],i.set(o,n)),n.push(e);for(const[e,t]of i.entries()){const s=new Map;for(const i of t){const t=i.uid;delete i.uid,i.ts-=e;let n=s.get(t);n||(n=[],s.set(t,n));const o=qo(i);n.push(o)}for(const[t,i]of s.entries()){const s=Uo(i),n=zip(s);await this.put(zo,{uid:t,ts:e,data:n})}}return console.log("History recent entries",i),this.delete(zo,"ts",s,e)}clearHistory(e){return this.delete(jo,"uid",e,e)}}function qo({msg:e,info:t,type:s,ts:i,own:n,user:o}){s&&(e=n?`**Share ${s}:** ${t.name}`:`${s}://${t.id}`),o&&(e=`[[${o}]] `+e);const a=new TextEncoder("utf-8").encode(e),r=3+a.length+1;console.log("Encoding message:",e,a.length);const c=new ArrayBuffer(r),l=new DataView(c);l.setUint16(0,i),l.setUint8(2,n);const d=new Uint8Array(c);return d.set(a,3),d.set(0,r-1),c}function Uo(e){const t=e.reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(t);return e.reduce(((e,t)=>(s.set(new Uint8Array(t),e),e+t.byteLength)),0),s.buffer}function Ho(e){return Math.floor(e/To)*To}function Wo(e){let t=unzip(e.data,null);const s=[];for(;t.length>0;){const i=new DataView(t.buffer),n=i.getUint16(0)+e.ts,o=!!i.getUint8(2);t=t.slice(3);let a=0;for(;a<t.length&&0!=t[a];++a);const r=t.slice(0,a),c={ts:n,own:o,uid:e.uid,text:No.decode(r).replace(/^\[\[([A-z0-9]+)\]\] /,((e,t)=>(c.user=t,"")))};s.push(c),t=t.slice(a+1)}return s}Fo.addTable=Eo,Fo.addIndex=So;class Vo{#O;#P="stopped";#R="player";#$=[];#z=[];#B;#N;#F;#q=0;#U=0;#H=!1;get queueCount(){return this.#$.length}get recent(){return this.#z.reverse()}get videoElement(){return this.#O}get isPlaying(){return"playing"==this.#P}get current(){return this.#B}constructor(){const e=function(){const e=dom.createElement("video");return e.controls=!0,e.disablePictureInPicture=!0,e.disableRemotePlayback=!0,e.setAttribute("controlslist","nodownload"),e}();e.onplaying=()=>this.#W(),e.onended=()=>this.#V(),e.onpause=()=>this.#X(),e.onloadedmetadata=e=>{console.log("METADATA loaded",e)},this.#O=e}registerEvents(){app.on("call",(e=>this.#G(e.detail))),app.on("hangup",(e=>this.#Y(e.detail)))}pause(){console.log("PLAYER: pausing track"),this.#K(),this.#P="paused",this.#F&&(clearInterval(this.#F),this.#F=null)}resume(){console.log("PLAYER: resuming track"),this.#O.play()}playYoutube(e){const t=e.dataset.id;if(console.debug("Player: loading yt =>",t),this.#N){this.#N.stopVideo();const e=document.getElementById("player"),t=e.previousElementSibling;dom.showElement(t),dom.removeElement(e)}dom.hideElement(e);const s=dom.createElement("div");s.id="player",dom.insertAfter(s,e),this.#N=new YT.Player("player",{videoId:t,events:{onReady:function(e){console.debug("YT on ready"),e.target.playVideo()}}})}onYoutubeStateChange(){console.debug("YT player state change")}onYoutubeError(e){console.error("YT player on error",e)}playFile(e,t=!1){if(e=Number(e),!t||!(this.#$.length>0||"stopped"!=this.#P))return this.#Z(e);this.#$.includes(e)||(this.#$.push(e),app.emit("trackqueued",e))}playNext(){if(0==this.#$.length)return;const e=this.#$.shift();return this.#Z(e)}clear(){this.#z=[]}remove(e){const t=this.#$.indexOf(e);-1!=t&&this.#$.splice(t,1)}playRadio(e,t){console.debug("Play radio request:",e,t),this.#J(e,t)}#J(e,t){if(this.#H)switch(t){case"play":this.#O.src;0,this.resume();break;case"pause":this.pause()}else this.pause(),this.#H=!0,this.#O.src="http://127.0.0.1:8000/test",this.resume()}async#Z(e){let t;this.#q=0,this.#z.length>50&&this.#z.shift();const s=this.#z.findIndex((t=>t.id==e));-1!=s?(t=this.#z[s],this.#z.splice(s,1)):t=await app.db.get("audio",e),t.rating++,await app.db.update("audio",e,{rating:t.rating}),this.#B=t,this.#z.push(t);const i=this.#O.src;i&&!i.startsWith("http")&&URL.revokeObjectURL(i);const n=URL.createObjectURL(t.file);this.#O.src=n,this.#O.play()}#G(){if("playing"===this.#P)this.#K()}#Y(){if("playing"===this.#P)this.#Q()}#K(){this.#O.pause()}#Q(){this.#O.play()}#ee(e){}async#W(){if(console.log("Player: on playing, radio:",this.#H),this.#P="playing",this.#H)return;this.#U=Math.round(this.#O.duration),this.#te();let e=!0;this.#B.meta?this.#B.meta.duration?e=!1:this.#B.meta.duration=this.#U:this.#B.meta={duration:this.#U},e&&await app.db.update("audio",this.#B.id,{meta:this.#B.meta});const{id:t,rating:s,file:i,type:n}=this.#B,o={id:t,rating:s,file:i,type:n,duration:this.#U},a=this.#B.meta;a&&(o.meta=a,o.title=fileX.getTitleFromMeta(o),o.desc=fileX.getDescriptionFromMeta(o)),app.addRecent("player",o),app.emit("trackchange",o)}#X(){console.log("Player: on paused"),this.#se(),app.emit("trackpause")}#V(){console.log("Player: on end"),this.#$.length>0?this.playNext():(this.#se(),this.#P="stopped",app.emit("trackstop"))}#ie(){}#te(){this.#F||(this.#F=setInterval((()=>app.emit("trackprogress",{sec:++this.#q,total:this.#U})),1e3))}#se(){this.#F&&(clearInterval(this.#F),this.#F=null)}}const Xo="base16-dark";async function Go(){if(!window.CodeMirror)return __webpack_require__(650)("../dist/codemirror.js")}function Yo(e){const t={js:"javascript",md:{name:"markdown",highlightFormatting:!0},html:"htmlmixed",css:"css"}[e];if(!t)throw new Error("Unsupported code editor mode:",e);return t}function Ko(e={mode:"js"}){return Object.assign({keyMap:"vim",lineNumbers:!0,autoRefresh:!0,lineWrapping:!0,scrollbarStyle:"overlay",foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],extraKeys:{"Ctrl-Space":"autocomplete"},autoCloseTags:!0,matchBrackets:!0,autoCloseBrackets:!0},e)}const Zo=class{static createTextArea(e){const t=document.createElement("textarea");return e.appendChild(t),CodeMirror.fromTextArea(t,{mode:"javascript",keyMap:"vim",lineNumbers:!0,autoRefresh:!0,lineWrapping:!0,scrollbarStyle:"overlay",foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"]})}static async create(e,t="js",s=!1){const i=Yo(t);await Go();const n=Ko({mode:i});return s&&(n.theme=Xo),console.log("Creating CodeMirror editor",n),CodeMirror(e,n)}static async bind(e,t="js",s=!1){const i=Yo(t);await Go();const n=Ko({mode:i,height:"auto",viewportMargin:1/0});return s&&(n.theme=Xo),console.log("Binding CodeMirror editor",n),CodeMirror.fromTextArea(e,n)}};function Jo(e,t){var s;function i(e){if(!e)return!1;!function(e){for(var t=0;t<e.length;t++)e[t].classList.remove("autocomplete-active")}(e),s>=e.length&&(s=0),s<0&&(s=e.length-1);e[s].classList.add("autocomplete-active")}function n(t){for(var s=document.getElementsByClassName("autocomplete-items"),i=0;i<s.length;i++)t!=s[i]&&t!=e&&s[i].parentNode.removeChild(s[i])}console.log("Autocompleteenabled for:",e.name),e.addEventListener("input",(function(i){console.log("Autocomplete input: input");var o,a,r,c=this.value;if(n(),delete this.dataset.id,!c)return!1;s=-1;const l=[];for(const e of t)(r="string"==typeof e?e:e.name).substr(0,c.length).toUpperCase()==c.toUpperCase()&&l.push(e);if(0==l.length)return;(o=dom.createElement("div","autocomplete-items")).setAttribute("id",this.id+"autocomplete-list"),console.log("Setting width: ",this.getBoundingClientRect().width),o.style.maxWidth=`${this.getBoundingClientRect().width}px`;const d=oo.create(o);this.parentNode.appendChild(o);for(const t of l){a=dom.createElement("div","item");const s="object"==typeof t;let i="";s?(t.photo?i+=`<img src="${t.photo}" class="photo">`:t.icon,i+=`<i class="${t.icon}"></i>`,r=t.name):r=t,i+="<strong>"+r.substr(0,c.length)+"</strong>",i+=r.substr(c.length),s&&t.id?i+=`<input type="hidden" value="${r}" data-id="${t.id}">`:i+="<input type='hidden' value='"+r+"'>",a.innerHTML=i,a.addEventListener("click",(function(t){const s=this.getElementsByTagName("input")[0];e.value=s.value,s.dataset.id&&(e.dataset.id=s.dataset.id),n()})),d.append(a)}d.registerEvents()})),e.addEventListener("keydown",(function(e){console.log("KeyDown",this.id);var t=document.getElementById(this.id+"autocomplete-list");t&&(t=t.getElementsByClassName("item")),40==e.keyCode?(s++,i(t)):38==e.keyCode?(s--,i(t)):13==e.keyCode&&(e.preventDefault(),s>-1&&t&&t[s].click())})),document.addEventListener("click",(function(e){n(e.target)}))}function Qo(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))}function ea(e,t,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(e):i?i.value:t.get(e)}function ta(e,t,s,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,s):n?n.value=s:t.set(e,s),s}async function sa(e,t={}){const{local:s=!1,version:i="latest",cdnUrl:n,...o}=t,a=function(e,t,s){let i=`https://cdn.jsdelivr.net/npm/emojibase-data@${t}/${e}`;return"function"==typeof s?i=s(e,t):"string"==typeof s&&(i=`${s}/${e}`),i}(e,i,n),r=s?localStorage:sessionStorage,c=`emojibase/${i}/${e}`,l=r.getItem(c);if(l)return Promise.resolve(JSON.parse(l));const d=await fetch(a,{credentials:"omit",mode:"cors",redirect:"error",...o});if(!d.ok)throw new Error("Failed to load Emojibase dataset.");const h=await d.json();try{r.setItem(c,JSON.stringify(h))}catch{}return h}const ia={discord:"joypixels",slack:"iamcal"};async function na(e,t,s){var i;return sa(`${e}/shortcodes/${null!==(i=ia[t])&&void 0!==i?i:t}.json`,s)}function oa(e,t){if(0===t.length)return e;const s=new Set(e.shortcodes);return t.forEach((t=>{const i=t[e.hexcode];Array.isArray(i)?i.forEach((e=>s.add(e))):i&&s.add(i)})),e.shortcodes=[...s],e.skins&&e.skins.forEach((e=>{oa(e,t)})),e}async function aa(e,t={}){const{compact:s=!1,flat:i=!1,shortcodes:n=[],...o}=t,a=await sa(`${e}/${s?"compact":"data"}.json`,o);let r=[];return n.length>0&&(r=await Promise.all(n.map((t=>{let s;if(t.includes("/")){const[e,i]=t.split("/");s=na(e,i,o)}else s=na(e,t,o);return s.catch((()=>({})))})))),i?function(e,t=[]){const s=[];return e.forEach((e=>{if(e.skins){const{skins:i,...n}=e;s.push(oa(n,t)),i.forEach((e=>{const i={...e};n.tags&&(i.tags=[...n.tags]),s.push(oa(i,t))}))}else s.push(oa(e,t))})),s}(a,r):function(e,t){return 0===t.length||e.forEach((e=>{oa(e,t)})),e}(a,r)}async function ra(e,t){return sa(`${e}/messages.json`,t)}function ca(e,t){const s=e.target.closest("[data-emoji]");if(s){const e=t.find((e=>e.emoji===s.dataset.emoji));if(e)return e}return null}function la(e){var t;const s=null===(t=window.matchMedia)||void 0===t?void 0:t.call(window,"(prefers-reduced-motion: reduce)");return e.animate&&!(null==s?void 0:s.matches)}function da(e,t){return e.toLowerCase().includes(t.toLowerCase())}function ha(e,t,s,i){return la(i)&&e.animate?e.animate(t,s).finished:Promise.resolve()}function ua(e){var t;const s=document.createElement("template");return s.innerHTML=e,null===(t=s.content)||void 0===t?void 0:t.firstElementChild}function pa(e){return Qo(this,void 0,void 0,(function*(){try{return(yield fetch(e,{method:"HEAD"})).headers.get("etag")}catch(e){return null}}))}function ma(e,t,s){return Qo(this,void 0,void 0,(function*(){const i=s||t(e);return yield i.open(),i}))}function ga(e,t,s){return Qo(this,void 0,void 0,(function*(){const i=yield ma(e,t,s),[n,o]=yield function(e){const{emojisUrl:t,messagesUrl:s}=function(e,t){const s="/ui/lib/picmo";return{emojisUrl:`${s}/data.json`,messagesUrl:`${s}/messages.json`}}();try{return Promise.all([pa(t),pa(s)])}catch(e){return Promise.all([null,null])}}();if(yield i.isPopulated())n&&o&&(yield function(e,t,s){return Qo(this,void 0,void 0,(function*(){let i;try{i=yield e.getEtags()}catch(e){i={}}const{storedEmojisEtag:n,storedMessagesEtag:o}=i;if(s!==o||t!==n){const[i,n]=yield Promise.all([ra(e.locale),aa(e.locale)]);yield e.populate({groups:i.groups,emojis:n,emojisEtag:t,messagesEtag:s})}}))}(i,n,o));else{const[t,s]=yield Promise.all([ra(e),aa(e)]);yield i.populate({groups:t.groups,emojis:s,emojisEtag:n,messagesEtag:o})}return i}))}function fa(e,t,s,i,n){return Qo(this,void 0,void 0,(function*(){const o=yield ma(e,t,n),a=yield function(e){return Qo(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e),s=yield crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join("")}))}(i);return(yield o.isPopulated())&&!(yield function(e,t){return Qo(this,void 0,void 0,(function*(){const s=yield e.getHash();return t!==s}))}(o,a))||(yield o.populate({groups:s.groups,emojis:i,hash:a})),o}))}function wa(e,t,s,i,n){return Qo(this,void 0,void 0,(function*(){return s&&i?fa(e,t,s,i,n):ga(e,t,n)}))}var ya,ba,va,ka;class _a{constructor(){ya.add(this),ba.set(this,new Map)}on(e,t,s){ea(this,ya,"m",ka).call(this,e,t,s)}once(e,t,s){ea(this,ya,"m",ka).call(this,e,t,s,!0)}off(e,t){const s=ea(this,ya,"m",va).call(this,e);ea(this,ba,"f").set(e,s.filter((e=>e.handler!==t)))}emit(e,...t){ea(this,ya,"m",va).call(this,e).forEach((s=>{s.handler.apply(s.context,t),s.once&&this.off(e,s.handler)}))}removeAll(){ea(this,ba,"f").clear()}}ba=new WeakMap,ya=new WeakSet,va=function(e){return ea(this,ba,"f").has(e)||ea(this,ba,"f").set(e,[]),ea(this,ba,"f").get(e)},ka=function(e,t,s,i=!1){ea(this,ya,"m",va).call(this,e).push({context:s,handler:t,once:i})};class xa extends _a{}class Ca extends _a{}class Ea{constructor({template:e,classes:t,parent:s}){this.isDestroyed=!1,this.appEvents={},this.uiEvents=[],this.uiElements={},this.ui={},this.template=e,this.classes=t,this.parent=s,this.keyBindingHandler=this.keyBindingHandler.bind(this)}initialize(){this.bindAppEvents()}setCustomEmojis(e){this.customEmojis=e}setEvents(e){this.events=e}setPickerId(e){this.pickerId=e}emit(e,...t){this.events.emit(e,...t)}setI18n(e){this.i18n=e}setRenderer(e){this.renderer=e}setEmojiData(e){this.emojiDataPromise=e,e.then((e=>{this.emojiData=e}))}updateEmojiData(e){this.emojiData=e,this.emojiDataPromise=Promise.resolve(e)}setOptions(e){this.options=e}renderSync(e={}){return this.el=this.template.renderSync(Object.assign({classes:this.classes,i18n:this.i18n,pickerId:this.pickerId},e)),this.postRender(),this.el}render(e={}){return Qo(this,void 0,void 0,(function*(){return yield this.emojiDataPromise,this.el=yield this.template.renderAsync(Object.assign({classes:this.classes,i18n:this.i18n,pickerId:this.pickerId},e)),this.postRender(),this.el}))}postRender(){this.bindUIElements(),this.bindKeyBindings(),this.bindUIEvents(),this.scheduleShowAnimation()}bindAppEvents(){Object.keys(this.appEvents).forEach((e=>{this.events.on(e,this.appEvents[e],this)})),this.events.on("data:ready",this.updateEmojiData,this)}unbindAppEvents(){Object.keys(this.appEvents).forEach((e=>{this.events.off(e,this.appEvents[e])})),this.events.off("data:ready",this.updateEmojiData)}keyBindingHandler(e){const t=this.keyBindings[e.key];t&&t.call(this,e)}bindKeyBindings(){this.keyBindings&&this.el.addEventListener("keydown",this.keyBindingHandler)}unbindKeyBindings(){this.keyBindings&&this.el.removeEventListener("keydown",this.keyBindingHandler)}bindUIElements(){this.ui=Object.keys(this.uiElements).reduce(((e,t)=>Object.assign(Object.assign({},e),{[t]:this.el.querySelector(this.uiElements[t])})),{})}bindUIEvents(){this.uiEvents.forEach((e=>{e.handler=e.handler.bind(this);(e.target?this.ui[e.target]:this.el).addEventListener(e.event,e.handler,e.options)}))}unbindUIEvents(){this.uiEvents.forEach((e=>{(e.target?this.ui[e.target]:this.el).removeEventListener(e.event,e.handler)}))}destroy(){this.unbindAppEvents(),this.unbindUIEvents(),this.unbindKeyBindings(),this.el.remove(),this.isDestroyed=!0}scheduleShowAnimation(){if(this.parent){const e=new MutationObserver((t=>{const[s]=t;"childList"===s.type&&s.addedNodes[0]===this.el&&(la(this.options)&&this.animateShow&&this.animateShow(),e.disconnect)}));e.observe(this.parent,{childList:!0})}}static childEvent(e,t,s,i={}){return{target:e,event:t,handler:s,options:i}}static uiEvent(e,t,s={}){return{event:e,handler:t,options:s}}static byClass(e){return`.${e}`}}var Sa={emojiCategory:"EmojiCategory_emojiCategory__7G3mq",categoryName:"EmojiCategory_categoryName__zHcOq",noRecents:"EmojiCategory_noRecents__Pk1Ys",recentEmojis:"EmojiCategory_recentEmojis__CybhN"};class Ta extends Ea{constructor({template:e,category:t,showVariants:s,lazyLoader:i}){super({template:e,classes:Sa}),this.baseUIElements={categoryName:Ea.byClass(Sa.categoryName)},this.category=t,this.showVariants=s,this.lazyLoader=i}setActive(e,t,s){this.emojiContainer.setActive(e,t,s)}}var Aa={icon:"icons_icon__YUQ3S","icon-small":"icons_icon-small__fEcU6","icon-medium":"icons_icon-medium__e5lKJ","icon-large":"icons_icon-large__t5mwg","icon-2x":"icons_icon-2x__on8is","icon-3x":"icons_icon-3x__RBDYg","icon-4x":"icons_icon-4x__UjvXP","icon-5x":"icons_icon-5x__zRG9K","icon-8x":"icons_icon-8x__PsCPS","icon-10x":"icons_icon-10x__WLjku"};const La={clock:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M256 512C114.6 512 0 397.4 0 256C0 114.6 114.6 0 256 0C397.4 0 512 114.6 512 256C512 397.4 397.4 512 256 512zM232 256C232 264 236 271.5 242.7 275.1L338.7 339.1C349.7 347.3 364.6 344.3 371.1 333.3C379.3 322.3 376.3 307.4 365.3 300L280 243.2V120C280 106.7 269.3 96 255.1 96C242.7 96 231.1 106.7 231.1 120L232 256z"/></svg>',flag:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M64 496C64 504.8 56.75 512 48 512h-32C7.25 512 0 504.8 0 496V32c0-17.75 14.25-32 32-32s32 14.25 32 32V496zM476.3 0c-6.365 0-13.01 1.35-19.34 4.233c-45.69 20.86-79.56 27.94-107.8 27.94c-59.96 0-94.81-31.86-163.9-31.87C160.9 .3055 131.6 4.867 96 15.75v350.5c32-9.984 59.87-14.1 84.85-14.1c73.63 0 124.9 31.78 198.6 31.78c31.91 0 68.02-5.971 111.1-23.09C504.1 355.9 512 344.4 512 332.1V30.73C512 11.1 495.3 0 476.3 0z"/></svg>',frown:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M0 256C0 114.6 114.6 0 256 0C397.4 0 512 114.6 512 256C512 397.4 397.4 512 256 512C114.6 512 0 397.4 0 256zM176.4 240C194 240 208.4 225.7 208.4 208C208.4 190.3 194 176 176.4 176C158.7 176 144.4 190.3 144.4 208C144.4 225.7 158.7 240 176.4 240zM336.4 176C318.7 176 304.4 190.3 304.4 208C304.4 225.7 318.7 240 336.4 240C354 240 368.4 225.7 368.4 208C368.4 190.3 354 176 336.4 176zM259.9 369.4C288.8 369.4 316.2 375.2 340.6 385.5C352.9 390.7 366.7 381.3 361.4 369.1C344.8 330.9 305.6 303.1 259.9 303.1C214.3 303.1 175.1 330.8 158.4 369.1C153.1 381.3 166.1 390.6 179.3 385.4C203.7 375.1 231 369.4 259.9 369.4L259.9 369.4z"/></svg>',gamepad:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M448 64H192C85.96 64 0 149.1 0 256s85.96 192 192 192h256c106 0 192-85.96 192-192S554 64 448 64zM247.1 280h-32v32c0 13.2-10.78 24-23.98 24c-13.2 0-24.02-10.8-24.02-24v-32L136 279.1C122.8 279.1 111.1 269.2 111.1 256c0-13.2 10.85-24.01 24.05-24.01L167.1 232v-32c0-13.2 10.82-24 24.02-24c13.2 0 23.98 10.8 23.98 24v32h32c13.2 0 24.02 10.8 24.02 24C271.1 269.2 261.2 280 247.1 280zM431.1 344c-22.12 0-39.1-17.87-39.1-39.1s17.87-40 39.1-40s39.1 17.88 39.1 40S454.1 344 431.1 344zM495.1 248c-22.12 0-39.1-17.87-39.1-39.1s17.87-40 39.1-40c22.12 0 39.1 17.88 39.1 40S518.1 248 495.1 248z"/></svg>',lightbulb:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438 0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1h-160L112.1 454.3zM191.4 .0132C89.44 .3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8c16.53 18.84 42.34 58.23 52.22 91.45c.0313 .25 .0938 .5166 .125 .7823h160.2c.0313-.2656 .0938-.5166 .125-.7823c9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1C368 78.61 288.9-.2837 191.4 .0132zM192 96.01c-44.13 0-80 35.89-80 79.1C112 184.8 104.8 192 96 192S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1c8.844 0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg>',mug:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M512 32H120c-13.25 0-24 10.75-24 24L96.01 288c0 53 43 96 96 96h192C437 384 480 341 480 288h32c70.63 0 128-57.38 128-128S582.6 32 512 32zM512 224h-32V96h32c35.25 0 64 28.75 64 64S547.3 224 512 224zM560 416h-544C7.164 416 0 423.2 0 432C0 458.5 21.49 480 48 480h480c26.51 0 48-21.49 48-48C576 423.2 568.8 416 560 416z"/></svg>',plane:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M482.3 192C516.5 192 576 221 576 256C576 292 516.5 320 482.3 320H365.7L265.2 495.9C259.5 505.8 248.9 512 237.4 512H181.2C170.6 512 162.9 501.8 165.8 491.6L214.9 320H112L68.8 377.6C65.78 381.6 61.04 384 56 384H14.03C6.284 384 0 377.7 0 369.1C0 368.7 .1818 367.4 .5398 366.1L32 256L.5398 145.9C.1818 144.6 0 143.3 0 142C0 134.3 6.284 128 14.03 128H56C61.04 128 65.78 130.4 68.8 134.4L112 192H214.9L165.8 20.4C162.9 10.17 170.6 0 181.2 0H237.4C248.9 0 259.5 6.153 265.2 16.12L365.7 192H482.3z"/></svg>',robot:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M9.375 233.4C3.375 239.4 0 247.5 0 256v128c0 8.5 3.375 16.62 9.375 22.62S23.5 416 32 416h32V224H32C23.5 224 15.38 227.4 9.375 233.4zM464 96H352V32c0-17.62-14.38-32-32-32S288 14.38 288 32v64H176C131.8 96 96 131.8 96 176V448c0 35.38 28.62 64 64 64h320c35.38 0 64-28.62 64-64V176C544 131.8 508.3 96 464 96zM256 416H192v-32h64V416zM224 296C201.9 296 184 278.1 184 256S201.9 216 224 216S264 233.9 264 256S246.1 296 224 296zM352 416H288v-32h64V416zM448 416h-64v-32h64V416zM416 296c-22.12 0-40-17.88-40-40S393.9 216 416 216S456 233.9 456 256S438.1 296 416 296zM630.6 233.4C624.6 227.4 616.5 224 608 224h-32v192h32c8.5 0 16.62-3.375 22.62-9.375S640 392.5 640 384V256C640 247.5 636.6 239.4 630.6 233.4z"/></svg>',sad:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n  <defs>\n    <radialGradient gradientUnits="userSpaceOnUse" cy="10%" id="gradient-0">\n      <stop offset="0" style="stop-color: hsl(50, 100%, 50%);"/>\n      <stop offset="1" style="stop-color: hsl(50, 100%, 60%);"/>\n    </radialGradient>\n  </defs>\n  \x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e\n  <ellipse style="stroke: rgb(0, 0, 0); fill: rgba(0, 0, 0, 0.59);" cx="172.586" cy="207.006" rx="39.974" ry="39.974"/>\n  <ellipse style="stroke: rgb(0, 0, 0); fill: rgba(0, 0, 0, 0.59);" cx="334.523" cy="207.481" rx="39.974" ry="39.974"/>\n  <ellipse style="stroke: rgb(0, 0, 0); fill: rgba(0, 0, 0, 0.59);" cx="313.325" cy="356.208" rx="91.497" ry="59.893"/>\n  <path style="fill: rgb(85, 167, 255);" d="M 159.427 274.06 L 102.158 363.286 L 124.366 417.011 L 160.476 423.338 L 196.937 414.736 L 218.502 375.214"></path>\n  <path style="fill: url(#gradient-0);" d="M256 0C397.4 0 512 114.6 512 256C512 397.4 397.4 512 256 512C114.6 512 0 397.4 0 256C0 114.6 114.6 0 256 0zM256 352C290.9 352 323.2 367.8 348.3 394.9C354.3 401.4 364.4 401.7 370.9 395.7C377.4 389.7 377.7 379.6 371.7 373.1C341.6 340.5 301 320 256 320C247.2 320 240 327.2 240 336C240 344.8 247.2 352 256 352H256zM208 369C208 349 179.6 308.6 166.4 291.3C163.2 286.9 156.8 286.9 153.6 291.3C140.6 308.6 112 349 112 369C112 395 133.5 416 160 416C186.5 416 208 395 208 369H208zM303.6 208C303.6 225.7 317.1 240 335.6 240C353.3 240 367.6 225.7 367.6 208C367.6 190.3 353.3 176 335.6 176C317.1 176 303.6 190.3 303.6 208zM207.6 208C207.6 190.3 193.3 176 175.6 176C157.1 176 143.6 190.3 143.6 208C143.6 225.7 157.1 240 175.6 240C193.3 240 207.6 225.7 207.6 208z" />\n</svg>',search:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M500.3 443.7l-119.7-119.7c27.22-40.41 40.65-90.9 33.46-144.7C401.8 87.79 326.8 13.32 235.2 1.723C99.01-15.51-15.51 99.01 1.724 235.2c11.6 91.64 86.08 166.7 177.6 178.9c53.8 7.189 104.3-6.236 144.7-33.46l119.7 119.7c15.62 15.62 40.95 15.62 56.57 0C515.9 484.7 515.9 459.3 500.3 443.7zM79.1 208c0-70.58 57.42-128 128-128s128 57.42 128 128c0 70.58-57.42 128-128 128S79.1 278.6 79.1 208z"/></svg>',smiley:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M0 256C0 114.6 114.6 0 256 0C397.4 0 512 114.6 512 256C512 397.4 397.4 512 256 512C114.6 512 0 397.4 0 256zM256.3 331.8C208.9 331.8 164.1 324.9 124.5 312.8C112.2 309 100.2 319.7 105.2 331.5C130.1 390.6 188.4 432 256.3 432C324.2 432 382.4 390.6 407.4 331.5C412.4 319.7 400.4 309 388.1 312.8C348.4 324.9 303.7 331.8 256.3 331.8H256.3zM176.4 176C158.7 176 144.4 190.3 144.4 208C144.4 225.7 158.7 240 176.4 240C194 240 208.4 225.7 208.4 208C208.4 190.3 194 176 176.4 176zM336.4 240C354 240 368.4 225.7 368.4 208C368.4 190.3 354 176 336.4 176C318.7 176 304.4 190.3 304.4 208C304.4 225.7 318.7 240 336.4 240z"/></svg>',symbols:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M500.3 7.251C507.7 13.33 512 22.41 512 31.1V175.1C512 202.5 483.3 223.1 447.1 223.1C412.7 223.1 383.1 202.5 383.1 175.1C383.1 149.5 412.7 127.1 447.1 127.1V71.03L351.1 90.23V207.1C351.1 234.5 323.3 255.1 287.1 255.1C252.7 255.1 223.1 234.5 223.1 207.1C223.1 181.5 252.7 159.1 287.1 159.1V63.1C287.1 48.74 298.8 35.61 313.7 32.62L473.7 .6198C483.1-1.261 492.9 1.173 500.3 7.251H500.3zM74.66 303.1L86.5 286.2C92.43 277.3 102.4 271.1 113.1 271.1H174.9C185.6 271.1 195.6 277.3 201.5 286.2L213.3 303.1H239.1C266.5 303.1 287.1 325.5 287.1 351.1V463.1C287.1 490.5 266.5 511.1 239.1 511.1H47.1C21.49 511.1-.0019 490.5-.0019 463.1V351.1C-.0019 325.5 21.49 303.1 47.1 303.1H74.66zM143.1 359.1C117.5 359.1 95.1 381.5 95.1 407.1C95.1 434.5 117.5 455.1 143.1 455.1C170.5 455.1 191.1 434.5 191.1 407.1C191.1 381.5 170.5 359.1 143.1 359.1zM440.3 367.1H496C502.7 367.1 508.6 372.1 510.1 378.4C513.3 384.6 511.6 391.7 506.5 396L378.5 508C372.9 512.1 364.6 513.3 358.6 508.9C352.6 504.6 350.3 496.6 353.3 489.7L391.7 399.1H336C329.3 399.1 323.4 395.9 321 389.6C318.7 383.4 320.4 376.3 325.5 371.1L453.5 259.1C459.1 255 467.4 254.7 473.4 259.1C479.4 263.4 481.6 271.4 478.7 278.3L440.3 367.1zM116.7 219.1L19.85 119.2C-8.112 90.26-6.614 42.31 24.85 15.34C51.82-8.137 93.26-3.642 118.2 21.83L128.2 32.32L137.7 21.83C162.7-3.642 203.6-8.137 231.6 15.34C262.6 42.31 264.1 90.26 236.1 119.2L139.7 219.1C133.2 225.6 122.7 225.6 116.7 219.1H116.7z"/></svg>',tree:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M413.8 447.1L256 448l0 31.99C256 497.7 241.8 512 224.1 512c-17.67 0-32.1-14.32-32.1-31.99l0-31.99l-158.9-.0099c-28.5 0-43.69-34.49-24.69-56.4l68.98-79.59H62.22c-25.41 0-39.15-29.8-22.67-49.13l60.41-70.85H89.21c-21.28 0-32.87-22.5-19.28-37.31l134.8-146.5c10.4-11.3 28.22-11.3 38.62-.0033l134.9 146.5c13.62 14.81 2.001 37.31-19.28 37.31h-10.77l60.35 70.86c16.46 19.34 2.716 49.12-22.68 49.12h-15.2l68.98 79.59C458.7 413.7 443.1 447.1 413.8 447.1z"/></svg>',users:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M224 256c70.7 0 128-57.31 128-128S294.7 0 224 0C153.3 0 96 57.31 96 128S153.3 256 224 256zM274.7 304H173.3c-95.73 0-173.3 77.6-173.3 173.3C0 496.5 15.52 512 34.66 512H413.3C432.5 512 448 496.5 448 477.3C448 381.6 370.4 304 274.7 304zM479.1 320h-73.85C451.2 357.7 480 414.1 480 477.3C480 490.1 476.2 501.9 470 512h138C625.7 512 640 497.6 640 479.1C640 391.6 568.4 320 479.1 320zM432 256C493.9 256 544 205.9 544 144S493.9 32 432 32c-25.11 0-48.04 8.555-66.72 22.51C376.8 76.63 384 101.4 384 128c0 35.52-11.93 68.14-31.59 94.71C372.7 243.2 400.8 256 432 256z"/></svg>',warning:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n  <defs>\n    <radialGradient id="radial" cy="85%">\n      <stop offset="20%" stop-color="var(--color-secondary)" />\n      <stop offset="100%" stop-color="var(--color-primary)" />\n    </radialGradient>\n  </defs>\n  \x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e\n  <path fill="url(\'#radial\')" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z" />\n</svg>',xmark:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>'},ja={recents:"clock","smileys-emotion":"smiley","people-body":"users","animals-nature":"tree","food-drink":"mug",activities:"gamepad","travel-places":"plane",objects:"lightbulb",symbols:"symbols",flags:"flag",custom:"robot"};function Ia(e,t){if(!(e in La))return console.warn(`Unknown icon: "${e}"`),document.createElement("div");const s=function(e,t){const s=ua(t);return s.dataset.icon=e,s.classList.add(Aa.icon),s}(e,La[e]);return t&&s.classList.add(Aa[`icon-${t}`]),s}var Da,Ma,Oa,Pa,Ra,$a;const za="sync";class Ba{constructor(e,t={}){Da.add(this),Ma.set(this,void 0),Oa.set(this,void 0),ta(this,Ma,e,"f"),ta(this,Oa,t.mode||za,"f")}renderSync(e={}){const t=ua(ea(this,Ma,"f").call(this,e));return ea(this,Da,"m",$a).call(this,t,e),ea(this,Da,"m",Ra).call(this,t),ea(this,Da,"m",Pa).call(this,t,e),t}renderAsync(e={}){return Qo(this,void 0,void 0,(function*(){const t=ua(ea(this,Ma,"f").call(this,e));return ea(this,Da,"m",$a).call(this,t,e),ea(this,Da,"m",Ra).call(this,t),yield ea(this,Da,"m",Pa).call(this,t,e),t}))}render(e){return"sync"===ea(this,Oa,"f")?this.renderSync(e):this.renderAsync(e)}}Ma=new WeakMap,Oa=new WeakMap,Da=new WeakSet,Pa=function(e,t){return Qo(this,void 0,void 0,(function*(){const s=e.querySelectorAll("[data-view]"),i=[];for(const e of s){const s=t[e.dataset.view];s?"sync"!==e.dataset.render?i.push(s.render().then((t=>(e.replaceWith(t),t)))):e.replaceWith(s.renderSync()):e.remove()}return Promise.all(i)}))},Ra=function(e){e.querySelectorAll("i[data-icon]").forEach((e=>{const{icon:t,size:s}=e.dataset;e.replaceWith(Ia(t,s))}))},$a=function(e,t){return e.querySelectorAll("[data-placeholder]").forEach((e=>{const s=e.dataset.placeholder;if(s&&t[s]){const i=t[s];e.replaceWith(...[i].flat())}else console.warn(`Missing placeholder element for key "${s}"`)})),e};var Na=new Ba((({classes:e,emoji:t})=>`\n  <button\n    class="${e.emoji}"\n    title="${t.label}"\n    data-emoji="${t.emoji}"\n    tabindex="-1">\n    <div data-placeholder="emojiContent"></div>\n  </button>\n`)),Fa={emoji:"Emoji_emoji__iKc1G"};class qa extends Ea{constructor({emoji:e,lazyLoader:t,category:s}){super({template:Na,classes:Fa}),this.emoji=e,this.lazyLoader=t,this.category=s}initialize(){this.uiEvents=[Ea.uiEvent("focus",this.handleFocus)],super.initialize()}handleFocus(){this.category&&this.events.emit("focus:change",this.category)}activateFocus(e){this.el.tabIndex=0,e&&this.el.focus()}deactivateFocus(){this.el.tabIndex=-1}renderSync(){return super.renderSync({emoji:this.emoji,emojiContent:this.renderer.doRender(this.emoji,this.lazyLoader)})}}class Ua{constructor(e,t,s=0,i=0,n=!1){this.events=new _a,this.keyHandlers={ArrowLeft:this.focusPrevious.bind(this),ArrowRight:this.focusNext.bind(this),ArrowUp:this.focusUp.bind(this),ArrowDown:this.focusDown.bind(this)},this.rowCount=Math.ceil(t/e),this.columnCount=e,this.focusedRow=s,this.focusedColumn=i,this.emojiCount=t,this.wrap=n,this.handleKeyDown=this.handleKeyDown.bind(this)}destroy(){this.events.removeAll()}on(e,t){this.events.on(e,t)}handleKeyDown(e){e.key in this.keyHandlers&&(e.preventDefault(),this.keyHandlers[e.key]())}setCell(e,t,s=!0){const i=this.getIndex();this.focusedRow=e,void 0!==t&&(this.focusedColumn=Math.min(this.columnCount,t)),(this.focusedRow>=this.rowCount||this.getIndex()>=this.emojiCount)&&(this.focusedRow=this.rowCount-1,this.focusedColumn=this.emojiCount%this.columnCount-1),this.events.emit("focus:change",{from:i,to:this.getIndex(),performFocus:s})}setFocusedIndex(e,t=!0){const s=Math.floor(e/this.columnCount),i=e%this.columnCount;this.setCell(s,i,t)}focusNext(){this.focusedColumn<this.columnCount-1&&this.getIndex()<this.emojiCount-1?this.setCell(this.focusedRow,this.focusedColumn+1):this.focusedRow<this.rowCount-1?this.setCell(this.focusedRow+1,0):this.wrap?this.setCell(0,0):this.events.emit("focus:overflow",0)}focusPrevious(){this.focusedColumn>0?this.setCell(this.focusedRow,this.focusedColumn-1):this.focusedRow>0?this.setCell(this.focusedRow-1,this.columnCount-1):this.wrap?this.setCell(this.rowCount-1,this.columnCount-1):this.events.emit("focus:underflow",this.columnCount-1)}focusUp(){this.focusedRow>0?this.setCell(this.focusedRow-1,this.focusedColumn):this.events.emit("focus:underflow",this.focusedColumn)}focusDown(){this.focusedRow<this.rowCount-1?this.setCell(this.focusedRow+1,this.focusedColumn):this.events.emit("focus:overflow",this.focusedColumn)}focusToIndex(e){this.setCell(Math.floor(e/this.columnCount),e%this.columnCount)}getIndex(){return this.focusedRow*this.columnCount+this.focusedColumn}getCell(){return{row:this.focusedRow,column:this.focusedColumn}}getRowCount(){return this.rowCount}}var Ha=new Ba((({classes:e})=>`\n  <div class="${e.emojiContainer}">\n    <div data-placeholder="emojis"></div>\n  </div>\n`)),Wa={emojiContainer:"EmojiContainer_emojiContainer__4SPb5"};class Va extends Ea{constructor({emojis:e,showVariants:t,preview:s=!0,lazyLoader:i,category:n,fullHeight:o=!1}){super({template:Ha,classes:Wa}),this.fullHeight=!1,this.showVariants=t,this.lazyLoader=i,this.preview=s,this.emojis=e,this.category=n,this.fullHeight=o,this.setFocus=this.setFocus.bind(this),this.triggerNextCategory=this.triggerNextCategory.bind(this),this.triggerPreviousCategory=this.triggerPreviousCategory.bind(this)}initialize(){this.grid=new Ua(this.options.emojisPerRow,this.emojiCount,0,0,!this.category),this.grid.on("focus:change",this.setFocus),this.grid.on("focus:overflow",this.triggerNextCategory),this.grid.on("focus:underflow",this.triggerPreviousCategory),this.uiEvents=[Ea.uiEvent("click",this.selectEmoji),Ea.uiEvent("keydown",this.grid.handleKeyDown)],this.preview&&this.uiEvents.push(Ea.uiEvent("mouseover",this.showPreview),Ea.uiEvent("mouseout",this.hidePreview),Ea.uiEvent("focus",this.showPreview,{capture:!0}),Ea.uiEvent("blur",this.hidePreview,{capture:!0})),super.initialize()}setFocusedView(e,t){if(e)if("string"==typeof e){const t=this.emojis.findIndex((t=>t.emoji===e));this.grid.setFocusedIndex(t,!1),setTimeout((()=>{var e,s,i,n;const o=this.emojiViews[t].el;o.scrollIntoView();const a=null===(e=o.parentElement)||void 0===e?void 0:e.previousElementSibling;(null===(i=null===(s=o.parentElement)||void 0===s?void 0:s.parentElement)||void 0===i?void 0:i.parentElement).scrollTop-=null!==(n=null==a?void 0:a.offsetHeight)&&void 0!==n?n:0}))}else"first"===e.row||0===e.row?this.grid.setCell(0,e.offset,t):"last"===e.row&&this.grid.setCell(this.grid.getRowCount()-1,e.offset,t)}setActive(e,t,s){var i;e?this.setFocusedView(t,s):null===(i=this.emojiViews[this.grid.getIndex()])||void 0===i||i.deactivateFocus()}renderSync(){return this.emojiViews=this.emojis.map((e=>this.viewFactory.create(qa,{emoji:e,category:this.category,lazyLoader:this.lazyLoader,renderer:this.renderer}))),this.emojiElements=this.emojiViews.map((e=>e.renderSync())),super.renderSync({emojis:this.emojiElements,i18n:this.i18n})}destroy(){super.destroy(),this.emojiViews.forEach((e=>e.destroy())),this.grid.destroy()}triggerPreviousCategory(e){this.events.emit("category:previous",e)}triggerNextCategory(e){this.category&&this.events.emit("category:next",e)}setFocus({from:e,to:t,performFocus:s}){var i,n;null===(i=this.emojiViews[e])||void 0===i||i.deactivateFocus(),null===(n=this.emojiViews[t])||void 0===n||n.activateFocus(s)}selectEmoji(e){const t=ca(e,this.emojis);t&&this.events.emit("emoji:select",{emoji:t,showVariants:this.showVariants})}showPreview(e){const t=e.target.closest("button"),s=null==t?void 0:t.firstElementChild,i=ca(e,this.emojis);i&&this.events.emit("preview:show",i,null==s?void 0:s.cloneNode(!0))}hidePreview(e){ca(e,this.emojis)&&this.events.emit("preview:hide")}get emojiCount(){return this.emojis.length}}var Xa=new Ba((({classes:e,category:t,pickerId:s,icon:i,i18n:n})=>`\n  <section class="${e.emojiCategory}" role="tabpanel" aria-labelledby="${s}-category-${t.key}">\n    <h3 data-category="${t.key}" class="${e.categoryName}">\n      <i data-icon="${i}"></i>\n      ${n.get(`categories.${t.key}`,t.message||t.key)}\n    </h3>\n    <div data-view="emojis" data-render="sync"></div>\n  </section>\n`));class Ga extends Ta{constructor({category:e,showVariants:t,lazyLoader:s,emojiVersion:i}){super({category:e,showVariants:t,lazyLoader:s,template:Xa}),this.showVariants=t,this.lazyLoader=s,this.emojiVersion=i}initialize(){this.uiElements=Object.assign({},this.baseUIElements),super.initialize()}render(){const e=Object.create(null,{render:{get:()=>super.render}});return Qo(this,void 0,void 0,(function*(){yield this.emojiDataPromise;const t=yield this.emojiData.getEmojis(this.category,this.emojiVersion);return this.emojiContainer=this.viewFactory.create(Va,{emojis:t,showVariants:this.showVariants,lazyLoader:this.lazyLoader,category:this.category.key}),e.render.call(this,{category:this.category,emojis:this.emojiContainer,emojiCount:t.length,icon:ja[this.category.key]})}))}}class Ya extends Va{constructor({category:e,emojis:t,preview:s=!0,lazyLoader:i}){super({category:e,emojis:t,showVariants:!1,preview:s,lazyLoader:i})}addOrUpdate(e){return Qo(this,void 0,void 0,(function*(){const t=this.el.querySelector(`[data-emoji="${e.emoji}"]`);t&&(this.el.removeChild(t),this.emojis=this.emojis.filter((t=>t!==e)));const s=this.viewFactory.create(qa,{emoji:e});if(this.el.insertBefore(s.renderSync(),this.el.firstChild),this.emojis=[e,...this.emojis.filter((t=>t!==e))],this.emojis.length>this.options.maxRecents){this.emojis=this.emojis.slice(0,this.options.maxRecents);const e=this.el.childElementCount-this.options.maxRecents;for(let t=0;t<e;t++)this.el.lastElementChild&&this.el.removeChild(this.el.lastElementChild)}}))}}const Ka="PicMo:recents";function Za(e){var t;try{return JSON.parse(null!==(t=localStorage.getItem(Ka))&&void 0!==t?t:"[]").slice(0,e)}catch(e){return[]}}var Ja=new Ba((({emojiCount:e,classes:t,category:s,pickerId:i,icon:n,i18n:o})=>`\n  <section class="${t.emojiCategory}" role="tabpanel" aria-labelledby="${i}-category-${s.key}">\n  <h3 data-category="${s.key}" class="${t.categoryName}">\n    <i data-icon="${n}"></i>\n    ${o.get(`categories.${s.key}`,s.message||s.key)}\n  </h3>\n  <div data-empty="${0===e}" class="${t.recentEmojis}">\n    <div data-view="emojis" data-render="sync"></div>\n  </div>\n  <div class="${t.noRecents}">\n    ${o.get("recents.none")}\n  </div>\n</section>\n`),{mode:"async"});var Qa=new Ba((({classes:e,category:t,pickerId:s,icon:i,i18n:n})=>`\n  <section class="${e.emojiCategory}" role="tabpanel" aria-labelledby="${s}-category-${t.key}">\n    <h3 data-category="${t.key}" class="${e.categoryName}">\n      <i data-icon="${i}"></i>\n      ${n.get(`categories.${t.key}`,t.message||t.key)}\n    </h3>\n    <div data-view="emojis" data-render="sync"></div>\n  </section>\n`));class er{constructor(){this.elements=new Map}lazyLoad(e,t){return this.elements.set(e,t),e}observe(e){if(window.IntersectionObserver){const t=new IntersectionObserver((e=>{e.filter((e=>e.intersectionRatio>0)).map((e=>e.target)).forEach((e=>{const s=this.elements.get(e);null==s||s(),t.unobserve(e)}))}),{root:e});this.elements.forEach(((e,s)=>{t.observe(s)}))}else this.elements.forEach((e=>{e()}))}}var tr={emojis:"EmojiArea_emojis__L4mMq"};const sr=new Ba((({classes:e})=>`\n  <div class="${e.emojis}">\n    <div data-placeholder="emojis"></div>\n  </div>\n`),{mode:"async"}),ir={recents:class extends Ta{constructor({category:e,lazyLoader:t}){super({category:e,showVariants:!1,lazyLoader:t,template:Ja})}initialize(){this.uiElements=Object.assign(Object.assign({},this.baseUIElements),{recents:Ea.byClass(Sa.recentEmojis)}),this.appEvents={"recent:add":this.addRecent},super.initialize()}addRecent(e){return Qo(this,void 0,void 0,(function*(){yield this.emojiContainer.addOrUpdate(e),this.ui.recents.dataset.empty="false"}))}render(){const e=Object.create(null,{render:{get:()=>super.render}});return Qo(this,void 0,void 0,(function*(){const t=Za(this.options.maxRecents);return this.emojiContainer=this.viewFactory.create(Ya,{emojis:t,showVariants:!1,lazyLoader:this.lazyLoader,category:this.category.key}),yield e.render.call(this,{category:this.category,emojis:this.emojiContainer,emojiCount:t.length,icon:ja[this.category.key]}),this.el}))}},custom:class extends Ta{constructor({category:e,lazyLoader:t}){super({template:Qa,showVariants:!1,lazyLoader:t,category:e})}initialize(){this.uiElements=Object.assign({},this.baseUIElements),super.initialize()}render(){const e=Object.create(null,{render:{get:()=>super.render}});return Qo(this,void 0,void 0,(function*(){return this.emojiContainer=this.viewFactory.create(Va,{emojis:this.customEmojis,showVariants:this.showVariants,lazyLoader:this.lazyLoader,category:this.category.key}),e.render.call(this,{category:this.category,emojis:this.emojiContainer,emojiCount:this.customEmojis.length,icon:ja[this.category.key]})}))}}};class nr extends Ea{constructor({categoryTabs:e,categories:t,emojiVersion:s}){super({template:sr,classes:tr}),this.selectedCategory=0,this.scrollListenerState="active",this.lazyLoader=new er,this.categoryTabs=e,this.categories=t,this.emojiVersion=s,this.handleScroll=function(e,t){let s=null;return()=>{s||(s=window.setTimeout((()=>{e(),s=null}),t))}}(this.handleScroll.bind(this),100)}initialize(){this.appEvents={"category:select":this.handleCategorySelect,"category:previous":this.focusPreviousCategory,"category:next":this.focusNextCategory,"focus:change":this.updateFocusedCategory},this.uiElements={emojis:Ea.byClass(tr.emojis)},this.uiEvents=[Ea.uiEvent("scroll",this.handleScroll)],super.initialize()}get focusableEmoji(){return this.el.querySelector('[tabindex="0"]')}render(){const e=Object.create(null,{render:{get:()=>super.render}});return Qo(this,void 0,void 0,(function*(){this.emojiCategories=this.categories.map(this.createCategory,this);const t={};return this.categories.forEach(((e,s)=>{t[`emojis-${e.key}`]=this.emojiCategories[s]})),yield e.render.call(this,{emojis:yield Promise.all(this.emojiCategories.map((e=>e.render())))}),this.lazyLoader.observe(this.el),window.ResizeObserver&&(this.observer=new ResizeObserver((()=>{const e=this.el.scrollHeight-this.scrollHeight;0===this.el.scrollTop-this.scrollTop&&e>0&&(this.el.scrollTop+=e),this.scrollHeight=this.el.scrollHeight,this.scrollTop=this.el.scrollTop})),this.emojiCategories.forEach((e=>{this.observer.observe(e.el)}))),this.el}))}destroy(){super.destroy(),this.emojiCategories.forEach((e=>{var t;null===(t=this.observer)||void 0===t||t.unobserve(e.el),e.destroy()}))}handleCategorySelect(e,t){this.selectCategory(e,t)}createCategory(e){const t=function(e){return ir[e.key]||Ga}(e);return this.viewFactory.create(t,{category:e,showVariants:!0,lazyLoader:this.lazyLoader,emojiVersion:this.emojiVersion})}determineInitialCategory(){var e;return this.options.initialCategory&&this.categories.find((e=>e.key===this.options.initialCategory))?this.options.initialCategory:null===(e=this.categories.find((e=>"recents"!==e.key)))||void 0===e?void 0:e.key}determineFocusTarget(e){const t=this.emojiCategories.find((t=>t.category.key===e));return this.options.initialEmoji&&(null==t?void 0:t.el.querySelector(`[data-emoji="${this.options.initialEmoji}"]`))?this.options.initialEmoji:"button"}reset(){this.events.emit("preview:hide");const e=this.determineInitialCategory();e&&(this.selectCategory(e,{focus:this.determineFocusTarget(e),performFocus:!0,scroll:"jump"}),this.selectedCategory=this.getCategoryIndex(e))}getCategoryIndex(e){return this.categories.findIndex((t=>t.key===e))}focusPreviousCategory(e){this.selectedCategory>0&&this.focusCategory(this.selectedCategory-1,{row:"last",offset:null!=e?e:this.options.emojisPerRow})}focusNextCategory(e){this.selectedCategory<this.categories.length-1&&this.focusCategory(this.selectedCategory+1,{row:"first",offset:null!=e?e:0})}focusCategory(e,t){this.selectCategory(e,{focus:t,performFocus:!0})}selectCategory(e,t={}){var s;return Qo(this,void 0,void 0,(function*(){this.scrollListenerState="suspend";const{focus:i,performFocus:n,scroll:o}=Object.assign({performFocus:!1},t);this.emojiCategories[this.selectedCategory].setActive(!1);const a=this.selectedCategory="number"==typeof e?e:this.getCategoryIndex(e);null===(s=this.categoryTabs)||void 0===s||s.setActiveTab(this.selectedCategory,n,"button"===i);const r=this.emojiCategories[a].el.offsetTop;this.emojiCategories[a].setActive(!0,function(e){return e&&"button"!==e?e:{row:"first",offset:0}}(i),"button"!==i&&n),o&&(this.el.scrollTop=r),this.scrollListenerState="resume"}))}updateFocusedCategory(e){var t;this.categories[this.selectedCategory].key!==e&&(this.scrollListenerState="suspend",this.selectedCategory=this.getCategoryIndex(e),null===(t=this.categoryTabs)||void 0===t||t.setActiveTab(this.selectedCategory,!1),this.scrollListenerState="resume")}handleScroll(){if("suspend"===this.scrollListenerState||!this.categoryTabs)return;if("resume"===this.scrollListenerState)return void(this.scrollListenerState="active");const e=this.el.scrollTop,t=this.el.scrollHeight-this.el.offsetHeight,s=this.emojiCategories.findIndex(((t,s)=>{var i;return e<(null===(i=this.emojiCategories[s+1])||void 0===i?void 0:i.el.offsetTop)}));0===e?this.categoryTabs.setActiveTab(0,!1):Math.floor(e)===Math.floor(t)||s<0?this.categoryTabs.setActiveTab(this.categories.length-1,!1):this.categoryTabs.setActiveTab(s,!1)}}var or=new Ba((({classList:e,classes:t,icon:s,message:i})=>`\n<div class="${e}" role="alert">\n  <div class="${t.icon}"><i data-size="10x" data-icon="${s}"></i></div>\n  <h3 class="${t.title}">${i}</h3>\n</div>\n`)),ar={error:"ErrorMessage_error__7I7y1",icon:"ErrorMessage_icon__4---V","appear-grow":"ErrorMessage_appear-grow__oBenJ",title:"ErrorMessage_title__shDDT",appear:"ErrorMessage_appear__kry-R"};class rr extends Ea{constructor({message:e,icon:t="warning",template:s=or,className:i}){super({template:s,classes:ar}),this.message=e,this.icon=t,this.className=i}renderSync(){const e=[ar.error,this.className].join(" ").trim();return super.renderSync({message:this.message,icon:this.icon,classList:e})}}var cr="DataError_dataError__jyJ0H",lr=new Ba((({classList:e,classes:t,icon:s,i18n:i,message:n})=>`\n  <div class="${e}">\n    <div class="${t.icon}"><i data-size="10x" data-icon="${s}"></i></div>\n    <h3 class="${t.title}">${n}</h3>\n    <button>${i.get("retry")}</button>\n  </div>\n`));class dr extends rr{constructor({message:e}){super({message:e,template:lr,className:cr})}initialize(){this.uiElements={retryButton:"button"},this.uiEvents=[Ea.childEvent("retryButton","click",this.onRetry)],super.initialize()}onRetry(){return Qo(this,void 0,void 0,(function*(){this.emojiData?yield this.emojiData.delete():yield this.options.dataStore.deleteDatabase(this.options.locale),this.events.emit("reinitialize");const e=yield wa(this.options.locale,this.options.dataStore,this.options.messages,this.options.emojiData,this.emojiData);this.viewFactory.setEmojiData(e),this.events.emit("data:ready",e)}))}}var hr={preview:"Preview_preview__HcFH6",previewEmoji:"Preview_previewEmoji__vjUki",previewName:"Preview_previewName__C79nL",tagList:"Preview_tagList__DielP",tag:"Preview_tag__aUSTM"};const ur=new Ba((({classes:e,tag:t})=>`\n  <li class="${e.tag}">${t}</li>\n`)),pr=new Ba((({classes:e})=>`\n  <div class="${e.preview}">\n    <div class="${e.previewEmoji}"></div>\n    <div class="${e.previewName}"></div>\n    <ul class="${e.tagList}"></ul>\n  </div>\n`));class mr extends Ea{constructor(){super({template:pr,classes:hr})}initialize(){this.uiElements={emoji:Ea.byClass(hr.previewEmoji),name:Ea.byClass(hr.previewName),tagList:Ea.byClass(hr.tagList)},this.appEvents={"preview:show":this.showPreview,"preview:hide":this.hidePreview},super.initialize()}showPreview(e,t){if(this.ui.emoji.replaceChildren(t),this.ui.name.textContent=e.label,e.tags){this.ui.tagList.style.display="flex";const t=e.tags.map((e=>ur.renderSync({tag:e,classes:hr})));this.ui.tagList.replaceChildren(...t)}}hidePreview(){this.ui.emoji.replaceChildren(),this.ui.name.textContent="",this.ui.tagList.replaceChildren()}}var gr={searchContainer:"Search_searchContainer__aJW7V",searchField:"Search_searchField__tENKn",clearButton:"Search_clearButton__oFTEY",searchAccessory:"Search_searchAccessory__0rdYO",clearSearchButton:"Search_clearSearchButton__AoDtB",notFound:"Search_notFound__rOdr1"};const fr=new Ba((({classes:e,i18n:t})=>`\n  <button title="${t.get("search.clear")}" class="${e.clearSearchButton}">\n    <i data-icon="xmark"></i>\n  </button>\n`)),wr=new Ba((({classes:e,i18n:t})=>`\n<div class="${e.searchContainer}">\n  <input class="${e.searchField}" placeholder="${t.get("search")}">\n  <span class="${e.searchAccessory}"></span>\n</div>\n`),{mode:"async"});class yr extends Ea{constructor({categories:e,emojiVersion:t}){super({template:wr,classes:gr}),this.categories=e.filter((e=>"recents"!==e.key)),this.emojiVersion=t,this.search=function(e,t){let s=null;return(...i)=>{s&&window.clearTimeout(s),s=window.setTimeout((()=>{e(...i),s=null}),t)}}(this.search.bind(this),100)}initialize(){this.uiElements={searchField:Ea.byClass(gr.searchField),searchAccessory:Ea.byClass(gr.searchAccessory)},this.uiEvents=[Ea.childEvent("searchField","keydown",this.onKeyDown),Ea.childEvent("searchField","input",this.onSearchInput)],super.initialize()}render(){const e=Object.create(null,{render:{get:()=>super.render}});return Qo(this,void 0,void 0,(function*(){return yield e.render.call(this),this.searchIcon=Ia("search"),this.notFoundMessage=this.viewFactory.create(rr,{message:this.i18n.get("search.notFound"),className:gr.notFound,icon:"sad"}),this.notFoundMessage.renderSync(),this.errorMessage=this.viewFactory.create(rr,{message:this.i18n.get("search.error")}),this.errorMessage.renderSync(),this.clearSearchButton=fr.render({classes:gr,i18n:this.i18n}),this.clearSearchButton.addEventListener("click",(e=>this.onClearSearch(e))),this.searchField=this.ui.searchField,this.showSearchIcon(),this.el}))}showSearchIcon(){this.showSearchAccessory(this.searchIcon)}showClearSearchButton(){this.showSearchAccessory(this.clearSearchButton)}showSearchAccessory(e){this.ui.searchAccessory.replaceChildren(e)}clear(){this.searchField.value="",this.showSearchIcon()}focus(){this.searchField.focus()}onClearSearch(e){var t;e.stopPropagation(),this.searchField.value="",null===(t=this.resultsContainer)||void 0===t||t.destroy(),this.resultsContainer=null,this.showSearchIcon(),this.events.emit("content:show"),this.searchField.focus()}handleResultsKeydown(e){this.resultsContainer&&"Escape"===e.key&&this.onClearSearch(e)}onKeyDown(e){var t;"Escape"===e.key&&this.searchField.value?this.onClearSearch(e):"Enter"!==e.key&&"ArrowDown"!==e.key||!this.resultsContainer||(e.preventDefault(),null===(t=this.resultsContainer.el.querySelector('[tabindex="0"]'))||void 0===t||t.focus())}onSearchInput(e){this.searchField.value?(this.showClearSearchButton(),this.search()):this.onClearSearch(e)}search(){var e;return Qo(this,void 0,void 0,(function*(){if(this.searchField.value)try{const t=yield this.emojiData.searchEmojis(this.searchField.value,this.customEmojis,this.emojiVersion,this.categories);if(this.events.emit("preview:hide"),t.length){const s=new er;this.resultsContainer=this.viewFactory.create(Va,{emojis:t,fullHeight:!0,showVariants:!0,lazyLoader:s}),this.resultsContainer.renderSync(),(null===(e=this.resultsContainer)||void 0===e?void 0:e.el)&&(s.observe(this.resultsContainer.el),this.resultsContainer.setActive(!0,{row:0,offset:0},!1),this.resultsContainer.el.addEventListener("keydown",(e=>this.handleResultsKeydown(e))),this.events.emit("content:show",this.resultsContainer))}else this.events.emit("content:show",this.notFoundMessage)}catch(e){this.events.emit("content:show",this.errorMessage)}}))}}class br{constructor(){this.handleKeyDown=this.handleKeyDown.bind(this)}activate(e){this.rootElement=e,this.rootElement.addEventListener("keydown",this.handleKeyDown)}deactivate(){var e;null===(e=this.rootElement)||void 0===e||e.removeEventListener("keydown",this.handleKeyDown)}get focusableElements(){return this.rootElement.querySelectorAll('input, [tabindex="0"]')}get lastFocusableElement(){return this.focusableElements[this.focusableElements.length-1]}get firstFocusableElement(){return this.focusableElements[0]}checkFocus(e,t,s){e.target===t&&(s.focus(),e.preventDefault())}handleKeyDown(e){"Tab"===e.key&&this.checkFocus(e,e.shiftKey?this.firstFocusableElement:this.lastFocusableElement,e.shiftKey?this.lastFocusableElement:this.firstFocusableElement)}}var vr=new Ba((({classes:e})=>`\n  <div class="${e.variantOverlay}">\n    <div class="${e.variantPopup}">\n      <div data-view="emojis" data-render="sync"></div>\n    </div>\n  </div>\n`)),kr={variantOverlay:"VariantPopup_variantOverlay__gGwue",variantPopup:"VariantPopup_variantPopup__c2pHF"};const _r={easing:"ease-in-out",duration:250,fill:"both"},xr={opacity:[0,1]},Cr={opacity:[0,1],transform:["scale3d(0.8, 0.8, 0.8)","scale3d(1, 1, 1)"]};class Er extends Ea{constructor({emoji:e,parent:t}){super({template:vr,classes:kr,parent:t}),this.focusedEmojiIndex=0,this.focusTrap=new br,this.animateShow=()=>Promise.all([ha(this.el,xr,_r,this.options),ha(this.ui.popup,Cr,_r,this.options)]),this.emoji=e}initialize(){this.uiElements={popup:Ea.byClass(kr.variantPopup)},this.uiEvents=[Ea.uiEvent("click",this.handleClick),Ea.uiEvent("keydown",this.handleKeydown)],super.initialize()}animateHide(){const e=Object.assign(Object.assign({},_r),{direction:"reverse"});return Promise.all([ha(this.el,xr,e,this.options),ha(this.ui.popup,Cr,e,this.options)])}hide(){return Qo(this,void 0,void 0,(function*(){yield this.animateHide(),this.events.emit("variantPopup:hide")}))}handleKeydown(e){"Escape"===e.key&&(this.hide(),e.stopPropagation())}handleClick(e){this.ui.popup.contains(e.target)||this.hide()}getEmoji(e){return this.renderedEmojis[e]}setFocusedEmoji(e){this.getEmoji(this.focusedEmojiIndex).tabIndex=-1,this.focusedEmojiIndex=e;const t=this.getEmoji(this.focusedEmojiIndex);t.tabIndex=0,t.focus()}destroy(){this.emojiContainer.destroy(),this.focusTrap.deactivate(),super.destroy()}renderSync(){const e=[Object.assign(Object.assign({},this.emoji),{skins:null}),...(this.emoji.skins||[]).map((e=>Object.assign(Object.assign({},e),{label:this.emoji.label,tags:this.emoji.tags})))];return this.emojiContainer=this.viewFactory.create(Va,{emojis:e,preview:!1}),super.renderSync({emojis:this.emojiContainer}),e.length<this.options.emojisPerRow&&this.el.style.setProperty("--emojis-per-row",e.length.toString()),this.el}activate(){this.emojiContainer.setActive(!0,{row:0,offset:0},!0),this.focusTrap.activate(this.el)}}var Sr=new Ba((({classes:e,i18n:t,category:s,pickerId:i,icon:n})=>`\n<li class="${e.categoryTab}">\n  <button\n    aria-selected="false"\n    role="tab"\n    class="${e.categoryButton}"\n    tabindex="-1"\n    title="${t.get(`categories.${s.key}`,s.message||s.key)}"\n    type="button"\n    data-category="${s.key}"\n    id="${i}-category-${s.key}"\n  >\n    <i data-icon="${n}"></i>\n</li>\n`)),Tr={categoryButtons:"CategoryTabs_categoryButtons__dJVp-",categoryButton:"CategoryTabs_categoryButton__AsR9b",categoryTab:"CategoryTabs_categoryTab__fAgQT",categoryTabActive:"CategoryTabs_categoryTabActive__691be"};class Ar extends Ea{constructor({category:e,icon:t}){super({template:Sr,classes:Tr}),this.isActive=!1,this.category=e,this.icon=t}initialize(){this.uiElements={button:Ea.byClass(Tr.categoryButton)},this.uiEvents=[Ea.childEvent("button","click",this.selectCategory)],super.initialize()}renderSync(){return super.renderSync({category:this.category,icon:this.icon}),this.ui.button.ariaSelected="false",this.el}setActive(e,t=!0,s=!1){this.el.classList.toggle(Tr.categoryTabActive,e),t&&this.setFocused(e,s),this.isActive=e}setFocused(e,t=!1){this.ui.button.ariaSelected=e.toString(),e?(this.ui.button.tabIndex=0,this.ui.button.focus(),t&&this.events.emit("category:select",this.category.key,{scroll:"animate",focus:"button",performFocus:!1})):this.ui.button.tabIndex=-1}selectCategory(){this.isActive||this.events.emit("category:select",this.category.key,{scroll:"animate",focus:"button",performFocus:!0})}}var Lr=new Ba((({classes:e})=>`\n  <ul role="tablist" class="${e.categoryButtons}">\n    <div data-placeholder="tabs"></div>\n  </ul>\n`));class jr extends Ea{constructor({categories:e}){super({template:Lr,classes:Tr}),this.activeCategoryIndex=0,this.categories=e}initialize(){this.keyBindings={ArrowLeft:this.stepSelectedTab(-1),ArrowRight:this.stepSelectedTab(1)},super.initialize()}renderSync(){return this.tabViews=this.categories.map((e=>this.viewFactory.create(Ar,{category:e,icon:ja[e.key]}))),super.renderSync({tabs:this.tabViews.map((e=>e.renderSync()))}),this.currentTabView.setActive(!0),this.el}get currentCategory(){return this.categories[this.activeCategoryIndex]}get currentTabView(){return this.tabViews[this.activeCategoryIndex]}setActiveTab(e,t=!0,s=!0){if(e===this.activeCategoryIndex)return;const i=this.currentTabView,n=this.tabViews[e];i.setActive(!1,t),n.setActive(!0,t,s),this.activeCategoryIndex=e}getTargetCategory(e){return e<0?this.categories.length-1:e>=this.categories.length?0:e}stepSelectedTab(e){return()=>{const t=this.activeCategoryIndex+e;this.setActiveTab(this.getTargetCategory(t))}}}const Ir=[{version:15,emoji:String.fromCodePoint(129768)},{version:14,emoji:String.fromCodePoint(128733)},{version:13,emoji:String.fromCodePoint(129729)},{version:12,emoji:String.fromCodePoint(129449)},{version:11,emoji:String.fromCodePoint(129463)},{version:5,emoji:String.fromCodePoint(129322)},{version:4,emoji:String.fromCodePoint(9877)},{version:3,emoji:String.fromCodePoint(129314)},{version:2,emoji:String.fromCodePoint(128488)},{version:1,emoji:String.fromCodePoint(128512)}];function Dr(){var e;const t=Ir.find((e=>function(e){const t=document.createElement("canvas").getContext("2d");if(t)return t.textBaseline="top",t.font="32px Arial",t.fillText(e,0,0),0!==t.getImageData(16,16,1,1).data[0]}(e.emoji)));return null!==(e=null==t?void 0:t.version)&&void 0!==e?e:1}function Mr(e,t){return Array.from({length:e},(()=>t)).join("")}function Or(e){const{emojiCount:t,classes:s,theme:i,className:n}=e;return`\n    <div class="${s.skeleton} ${s.picker} ${i} ${n}">\n      ${(({showHeader:t,classes:s})=>t?`\n    <header class="${s.header}">\n      ${(({showSearch:e,classes:t})=>e?`\n    <div class="${t.searchSkeleton}">\n      <div class="${t.searchInput} ${t.placeholder}"></div>\n    </div>\n  `:"")(e)}\n      ${(({showCategoryTabs:e,classes:t})=>e?`\n    <div class="${t.categoryTabsSkeleton}">\n      ${Mr(10,`<div class="${t.placeholder} ${t.categoryTab}"></div>`)}\n    </div>\n  `:"")(e)}\n    </header>\n  `:"")(e)}\n      <div class="${s.contentSkeleton}">\n        <div class="${s.placeholder} ${s.categoryName}"></div>\n        <div class="${s.emojiGrid}">\n          ${Mr(t,`<div class="${s.placeholder} ${s.emoji}"></div>`)}\n        </div>\n      </div>\n      ${(({showPreview:e,classes:t})=>e?`\n    <div class="${t.previewSkeleton}">\n      <div class="${t.placeholder} ${t.previewEmoji}"></div>\n      <div class="${t.placeholder} ${t.previewName}"></div>\n      <ul class="${t.tagList}">\n        ${Mr(3,`<li class="${t.placeholder} ${t.tag}"></li>`)}\n      </ul>\n    </div>\n  `:"")(e)}\n    </div>\n  `}var Pr=new Ba((e=>e.isLoaded?function(e){const{classes:t,theme:s,className:i=""}=e;return`\n    <div class="${t.picker} ${s} ${i}">\n      ${function({showHeader:e,classes:t}){return e?`\n    <header class="${t.header}">\n      <div data-view="search"></div>\n      <div data-view="categoryTabs" data-render="sync"></div>\n    </header>\n  `:""}(e)}\n      <div class="${t.content}">\n        <div data-view="emojiArea"></div>\n      </div>\n      <div data-view="preview"></div>\n    </div>\n  `}(e):Or(e))),Rr={picker:"EmojiPicker_picker__19Vln",skeleton:"EmojiPicker_skeleton__M1a2g",placeholder:"EmojiPicker_placeholder__YDJn-",shine:"EmojiPicker_shine__s-vEs",searchSkeleton:"EmojiPicker_searchSkeleton__gNgdU",searchInput:"EmojiPicker_searchInput__tpaBs",categoryTabsSkeleton:"EmojiPicker_categoryTabsSkeleton__2dISl",categoryTab:"EmojiPicker_categoryTab__mmSVF",contentSkeleton:"EmojiPicker_contentSkeleton__UWfQu",categoryName:"EmojiPicker_categoryName__d2-Ed",emojiGrid:"EmojiPicker_emojiGrid__WnoCI",emoji:"EmojiPicker_emoji__jaN-w",previewSkeleton:"EmojiPicker_previewSkeleton__Bjqkm",previewEmoji:"EmojiPicker_previewEmoji__uOLbA",previewName:"EmojiPicker_previewName__QJ47d",tagList:"EmojiPicker_tagList__tc6nv",tag:"EmojiPicker_tag__gAU6B",overlay:"EmojiPicker_overlay__kDT99",content:"EmojiPicker_content__xT6Kl",fullHeight:"EmojiPicker_fullHeight__7kz2H",pluginContainer:"EmojiPicker_pluginContainer__Gz3yT",header:"EmojiPicker_header__eDZPD"};const $r={emojisPerRow:"--emojis-per-row",visibleRows:"--row-count",emojiSize:"--emoji-size"};class zr extends Ea{constructor(){super({template:Pr,classes:Rr}),this.pickerReady=!1,this.externalEvents=new Ca}initialize(){this.uiElements={pickerContent:Ea.byClass(Rr.content),header:Ea.byClass(Rr.header)},this.uiEvents=[Ea.uiEvent("keydown",this.handleKeyDown)],this.appEvents={error:this.onError,reinitialize:this.reinitialize,"data:ready":this.onDataReady,"content:show":this.showContent,"variantPopup:hide":this.hideVariantPopup,"emoji:select":this.selectEmoji},super.initialize()}destroy(){var e,t;super.destroy(),null===(e=this.search)||void 0===e||e.destroy(),this.emojiArea.destroy(),null===(t=this.categoryTabs)||void 0===t||t.destroy(),this.events.removeAll(),this.externalEvents.removeAll()}addEventListener(e,t){this.externalEvents.on(e,t)}removeEventListener(e,t){this.externalEvents.off(e,t)}initializePickerView(){this.pickerReady&&(this.showContent(),this.emojiArea.reset())}handleKeyDown(e){const t=e.ctrlKey||e.metaKey;"s"===e.key&&t&&this.search&&(e.preventDefault(),this.search.focus())}buildChildViews(){return this.options.showPreview&&(this.preview=this.viewFactory.create(mr)),this.options.showSearch&&(this.search=this.viewFactory.create(yr,{categories:this.categories,emojiVersion:this.emojiVersion})),this.options.showCategoryTabs&&(this.categoryTabs=this.viewFactory.create(jr,{categories:this.categories})),this.currentView=this.emojiArea=this.viewFactory.create(nr,{categoryTabs:this.categoryTabs,categories:this.categories,emojiVersion:this.emojiVersion}),[this.preview,this.search,this.emojiArea,this.categoryTabs]}setStyleProperties(){this.options.showSearch||this.el.style.setProperty("--search-height-full","0px"),this.options.showCategoryTabs||(this.el.style.setProperty("--category-tabs-height","0px"),this.el.style.setProperty("--category-tabs-offset","0px")),this.options.showPreview||this.el.style.setProperty("--emoji-preview-height-full","0px"),Object.keys($r).forEach((e=>{this.options[e]&&this.el.style.setProperty($r[e],this.options[e].toString())}))}reinitialize(){this.renderSync()}onError(e){const t=this.viewFactory.create(dr,{message:this.i18n.get("error.load")}),s=this.el.offsetHeight||375;throw this.el.style.height=`${s}px`,this.el.replaceChildren(t.renderSync()),e}onDataReady(e){const t=Object.create(null,{render:{get:()=>super.render}});return Qo(this,void 0,void 0,(function*(){const s=this.el;try{e?this.emojiData=e:yield this.emojiDataPromise,"auto"===this.options.emojiVersion?this.emojiVersion=Dr()||parseFloat("14.0"):this.emojiVersion=this.options.emojiVersion,this.categories=yield this.emojiData.getCategories(this.options);const[i,n,o,a]=this.buildChildViews();yield t.render.call(this,{isLoaded:!0,search:n,categoryTabs:a,emojiArea:o,preview:i,showHeader:Boolean(this.search||this.categoryTabs),theme:this.options.theme,className:this.options.className}),this.el.style.setProperty("--category-count",this.categories.length.toString()),this.pickerReady=!0,s.replaceWith(this.el),this.setStyleProperties(),this.initializePickerView(),this.setInitialFocus(),this.externalEvents.emit("data:ready")}catch(e){this.events.emit("error",e)}}))}renderSync(){if(super.renderSync({isLoaded:!1,theme:this.options.theme,showSearch:this.options.showSearch,showPreview:this.options.showPreview,showCategoryTabs:this.options.showCategoryTabs,showHeader:this.options.showSearch||this.options.showCategoryTabs,emojiCount:this.options.emojisPerRow*this.options.visibleRows}),!this.options.rootElement)throw new Error("Picker must be given a root element via the rootElement option");return this.options.rootElement.replaceChildren(this.el),this.setStyleProperties(),this.pickerReady&&this.initializePickerView(),this.el}setInitialFocus(){this.pickerReady&&(this.search&&this.options.autoFocusSearch?this.search.focus():this.emojiArea.focusableEmoji.focus())}reset(){this.pickerReady&&(this.emojiArea.reset(),this.showContent(this.emojiArea)),this.search&&this.search.clear()}showContent(e=this.emojiArea){var t,s;e!==this.currentView&&(this.currentView!==this.emojiArea&&(null===(t=this.currentView)||void 0===t||t.destroy()),this.ui.pickerContent.classList.toggle(Rr.fullHeight,e!==this.emojiArea),this.ui.pickerContent.replaceChildren(e.el),this.currentView=e,e===this.emojiArea?(this.emojiArea.reset(),this.categoryTabs&&this.ui.header.appendChild(this.categoryTabs.el)):null===(s=this.categoryTabs)||void 0===s||s.el.remove())}hideVariantPopup(){var e;null===(e=this.variantPopup)||void 0===e||e.destroy()}isPickerClick(e){var t,s;const i=e.target,n=this.el.contains(i),o=null===(s=null===(t=this.variantPopup)||void 0===t?void 0:t.el)||void 0===s?void 0:s.contains(i);return n||o}selectEmoji({emoji:e}){var t,s;return Qo(this,void 0,void 0,(function*(){(null===(t=e.skins)||void 0===t?void 0:t.length)&&this.options.showVariants&&!this.isVariantPopupOpen?this.showVariantPopup(e):(yield null===(s=this.variantPopup)||void 0===s?void 0:s.animateHide(),this.events.emit("variantPopup:hide"),yield this.emitEmoji(e))}))}get isVariantPopupOpen(){return this.variantPopup&&!this.variantPopup.isDestroyed}showVariantPopup(e){return Qo(this,void 0,void 0,(function*(){const t=document.activeElement;this.events.once("variantPopup:hide",(()=>{null==t||t.focus()})),this.variantPopup=this.viewFactory.create(Er,{emoji:e,parent:this.el}),this.el.appendChild(this.variantPopup.renderSync()),this.variantPopup.activate()}))}emitEmoji(e){return Qo(this,void 0,void 0,(function*(){this.externalEvents.emit("emoji:select",yield this.renderer.doEmit(e)),function(e,t){const s=[e,...Za(t).filter((t=>t.hexcode!==e.hexcode))].slice(0,t);try{localStorage.setItem(Ka,JSON.stringify(s))}catch(e){}}(e,this.options.maxRecents),this.events.emit("recent:add",e)}))}}class Br{constructor({events:e,i18n:t,renderer:s,emojiData:i,options:n,customEmojis:o=[],pickerId:a}){this.events=e,this.i18n=t,this.renderer=s,this.emojiData=i,this.options=n,this.customEmojis=o,this.pickerId=a}setEmojiData(e){this.emojiData=Promise.resolve(e)}create(e,...t){const s=new e(...t);return s.setPickerId(this.pickerId),s.setEvents(this.events),s.setI18n(this.i18n),s.setRenderer(this.renderer),s.setEmojiData(this.emojiData),s.setOptions(this.options),s.setCustomEmojis(this.customEmojis),s.viewFactory=this,s.initialize(),s}}var Nr;class Fr{constructor(e={}){Nr.set(this,void 0),ta(this,Nr,new Map(Object.entries(e)),"f")}get(e,t=e){return ea(this,Nr,"f").get(e)||t}}Nr=new WeakMap;var qr={imagePlaceholder:"common_imagePlaceholder__FRWLu",placeholder:"common_placeholder__qe-fo",shine:"common_shine__tUVG2"};const Ur=new Ba((({classes:e})=>`\n  <div class="${e.placeholder} ${e.imagePlaceholder}"></div>\n`));class Hr extends Ea{constructor({classNames:e}={}){super({template:Ur,classes:qr}),this.classNames=e}load(e){const t=document.createElement("img");this.classNames&&(t.className=this.classNames),t.addEventListener("load",(()=>{this.el.replaceWith(t)}),{once:!0}),Promise.resolve(e).then((e=>t.src=e))}renderSync(){if(super.renderSync(),this.classNames){this.classNames.split(" ").forEach((e=>this.el.classList.add(e)))}return this.el}}var Wr={customEmoji:"custom_customEmoji__Kspg6"};class Vr{renderElement(e){return{content:e}}renderImage(e="",t){const s=new Hr({classNames:e});s.renderSync();return{content:s,resolver:()=>(s.load(t()),s.el)}}doRender(e,t,s){if(e.custom)return this.renderCustom(e,t,s);const{content:i,resolver:n}=this.render(e,s),o=i instanceof HTMLElement?i:i.el;return t&&n?t.lazyLoad(o,n):(n&&n(),o)}doEmit(e){return e.custom?this.emitCustom(e):this.emit(e)}emitCustom({url:e,label:t,emoji:s,data:i}){return{url:e,label:t,emoji:s,data:i}}renderCustom(e,t,s=""){const i=[Wr.customEmoji,s].join(" ").trim(),{content:n,resolver:o}=this.renderImage(i,(()=>e.url)),a=n instanceof HTMLElement?n:n.el;return o&&o(),a}}const Xr=new Ba((({emoji:e})=>`<span>${e}</span>`));const{autoTheme:Gr,lightTheme:Yr,darkTheme:Kr}={lightTheme:"themes_lightTheme__mMNem",darkTheme:"themes_darkTheme__qgrZP",autoTheme:"themes_autoTheme__tik-v"};const Zr=[(e,t)=>("1F91D"===e.hexcode&&t<14&&(e.skins=[]),e),(e,t)=>(e.skins&&(e.skins=e.skins.filter((e=>!e.version||e.version<=t))),e)];function Jr(e,t){return e.filter((e=>null!==function(e,t){return Zr.some((s=>null===s(e,t)))?null:e}(e,t)))}function Qr(e){var t;return{emoji:e.emoji,label:e.label,tags:e.tags,skins:null===(t=e.skins)||void 0===t?void 0:t.map((e=>Qr(e))),order:e.order,custom:!1,hexcode:e.hexcode,version:e.version}}function ec(e,t,s){var i;return!(s&&!s.some((t=>t.order===e.group)))&&(da(e.label,t)||(null===(i=e.tags)||void 0===i?void 0:i.some((e=>da(e,t)))))}class tc{constructor(e="en"){this.locale=e}}const sc="PicMo";function ic(e){return new nc(e)}ic.deleteDatabase=e=>new Promise(((t,s)=>{const i=indexedDB.deleteDatabase(`${sc}-${e}`);i.addEventListener("success",t),i.addEventListener("error",s)}));class nc extends tc{open(){return Qo(this,void 0,void 0,(function*(){const e=indexedDB.open(`${sc}-${this.locale}`);return new Promise(((t,s)=>{e.addEventListener("success",(e=>{var s;this.db=null===(s=e.target)||void 0===s?void 0:s.result,t()})),e.addEventListener("error",s),e.addEventListener("upgradeneeded",(e=>Qo(this,void 0,void 0,(function*(){var t;this.db=null===(t=e.target)||void 0===t?void 0:t.result,this.db.createObjectStore("category",{keyPath:"order"});const s=this.db.createObjectStore("emoji",{keyPath:"emoji"});s.createIndex("category","group"),s.createIndex("version","version"),this.db.createObjectStore("meta")}))))}))}))}delete(){return Qo(this,void 0,void 0,(function*(){this.close();const e=indexedDB.deleteDatabase(`${sc}-${this.locale}`);yield this.waitForRequest(e)}))}close(){this.db.close()}getEmojiCount(){return Qo(this,void 0,void 0,(function*(){const e=this.db.transaction("emoji","readonly").objectStore("emoji");return(yield this.waitForRequest(e.count())).target.result}))}getEtags(){return Qo(this,void 0,void 0,(function*(){const e=this.db.transaction("meta","readonly").objectStore("meta"),[t,s]=yield Promise.all([this.waitForRequest(e.get("emojisEtag")),this.waitForRequest(e.get("messagesEtag"))]);return{storedEmojisEtag:t.target.result,storedMessagesEtag:s.target.result}}))}setMeta(e){return Qo(this,void 0,void 0,(function*(){const t=this.db.transaction("meta","readwrite"),s=t.objectStore("meta");return new Promise((i=>{t.oncomplete=i;Object.keys(e).filter(Boolean).forEach((t=>{s.put(e[t],t)}))}))}))}getHash(){return Qo(this,void 0,void 0,(function*(){const e=this.db.transaction("meta","readonly").objectStore("meta");return(yield this.waitForRequest(e.get("hash"))).target.result}))}isPopulated(){return Qo(this,void 0,void 0,(function*(){const e=this.db.transaction("category","readonly").objectStore("category");return(yield this.waitForRequest(e.count())).target.result>0}))}populate({groups:e,emojis:t,emojisEtag:s,messagesEtag:i,hash:n}){return Qo(this,void 0,void 0,(function*(){yield this.removeAllObjects("category","emoji");const o=[this.addObjects("category",e),this.addObjects("emoji",t),this.setMeta({emojisEtag:s,messagesEtag:i,hash:n})];yield Promise.all(o)}))}getCategories(e){var t;return Qo(this,void 0,void 0,(function*(){const s=this.db.transaction("category","readonly").objectStore("category");let i=(yield this.waitForRequest(s.getAll())).target.result.filter((e=>"component"!==e.key));if(e.showRecents&&i.unshift({key:"recents",order:-1}),(null===(t=e.custom)||void 0===t?void 0:t.length)&&i.push({key:"custom",order:10}),e.categories){const t=e.categories;i=i.filter((e=>t.includes(e.key))),i.sort(((e,s)=>t.indexOf(e.key)-t.indexOf(s.key)))}else i.sort(((e,t)=>e.order-t.order));return i}))}getEmojis(e,t){return Qo(this,void 0,void 0,(function*(){const s=this.db.transaction("emoji","readonly").objectStore("emoji").index("category");return Jr((yield this.waitForRequest(s.getAll(e.order))).target.result.filter((e=>e.version<=t)).sort(((e,t)=>null!=e.order&&null!=t.order?e.order-t.order:0)).map(Qr),t)}))}searchEmojis(e,t,s,i){return Qo(this,void 0,void 0,(function*(){const n=[];return new Promise(((o,a)=>{const r=this.db.transaction("emoji","readonly").objectStore("emoji").openCursor();r.addEventListener("success",(a=>{var r;const c=null===(r=a.target)||void 0===r?void 0:r.result;if(!c)return o([...Jr(n,s),...t.filter((t=>ec(t,e)))]);const l=c.value;ec(l,e,i)&&l.version<=s&&n.push(Qr(l)),c.continue()})),r.addEventListener("error",(e=>{a(e)}))}))}))}waitForRequest(e){return Qo(this,void 0,void 0,(function*(){return new Promise(((t,s)=>{e.onsuccess=t,e.onerror=s}))}))}withTransaction(e,t="readwrite",s){return new Promise(((i,n)=>{const o=this.db.transaction(e,t);o.oncomplete=i,o.onerror=n,s(o)}))}removeAllObjects(...e){return Qo(this,void 0,void 0,(function*(){const t=this.db.transaction(e,"readwrite"),s=e.map((e=>t.objectStore(e)));yield Promise.all(s.map((e=>this.waitForRequest(e.clear()))))}))}addObjects(e,t){return Qo(this,void 0,void 0,(function*(){return this.withTransaction(e,"readwrite",(s=>{const i=s.objectStore(e);t.forEach((e=>{i.add(e)}))}))}))}}const oc={renderer:new class extends Vr{render(e){return this.renderElement(Xr.renderSync({emoji:e.emoji}))}emit({emoji:e,hexcode:t,label:s}){return{emoji:e,hexcode:t,label:s}}},dataStore:ic,theme:Yr,animate:!0,showSearch:!0,showCategoryTabs:!0,showVariants:!0,showRecents:!0,showPreview:!0,emojisPerRow:8,visibleRows:6,emojiVersion:"auto",maxRecents:50,i18n:{"categories.activities":"Activities","categories.animals-nature":"Animals & Nature","categories.custom":"Custom","categories.flags":"Flags","categories.food-drink":"Food & Drink","categories.objects":"Objects","categories.people-body":"People & Body","categories.recents":"Recently Used","categories.smileys-emotion":"Smileys & Emotion","categories.symbols":"Symbols","categories.travel-places":"Travel & Places","error.load":"Failed to load emojis","recents.clear":"Clear recent emojis","recents.none":"You haven't selected any emojis yet.",retry:"Try again","search.clear":"Clear search","search.error":"Failed to search emojis","search.notFound":"No results found",search:"Search emojis..."},locale:"en",custom:[]};function ac(e={}){return Object.assign(Object.assign({},oc),e)}let rc=0;function cc(e){const t=ac(e),s=((null==t?void 0:t.custom)||[]).map((e=>Object.assign(Object.assign({},e),{custom:!0,tags:["custom",...e.tags||[]]}))),i=new xa,n=function(e){return wa(e.locale,e.dataStore,e.messages,e.emojiData)}(t),o=new Fr(t.i18n);n.then((e=>{i.emit("data:ready",e)})).catch((e=>{i.emit("error",e)}));const a=new Br({events:i,i18n:o,customEmojis:s,renderer:t.renderer,options:t,emojiData:n,pickerId:`picmo-${Date.now()}-${rc++}`}).create(zr);return a.renderSync(),a}const lc="undefined"!=typeof window&&void 0!==window.document,dc=lc?window:{},hc=!(!lc||!dc.document.documentElement)&&"ontouchstart"in dc.document.documentElement,uc=!!lc&&"PointerEvent"in dc,pc="cropper",mc="all",gc="crop",fc="move",wc="zoom",yc="e",bc="w",vc="s",kc="n",_c="ne",xc="nw",Cc="se",Ec="sw",Sc=`${pc}-crop`,Tc=`${pc}-disabled`,Ac=`${pc}-hidden`,Lc=`${pc}-hide`,jc=`${pc}-invisible`,Ic=`${pc}-modal`,Dc=`${pc}-move`,Mc=`${pc}Action`,Oc=`${pc}Preview`,Pc="crop",Rc="move",$c="none",zc="crop",Bc="cropend",Nc="cropmove",Fc="cropstart",qc="dblclick",Uc=uc?"pointerdown":hc?"touchstart":"mousedown",Hc=uc?"pointermove":hc?"touchmove":"mousemove",Wc=uc?"pointerup pointercancel":hc?"touchend touchcancel":"mouseup",Vc="ready",Xc="resize",Gc="wheel",Yc="zoom",Kc="image/jpeg",Zc=/^e|w|s|n|se|sw|ne|nw|all|crop|move|zoom$/,Jc=/^data:/,Qc=/^data:image\/jpeg;base64,/,el=/^img|canvas$/i,tl={viewMode:0,dragMode:Pc,initialAspectRatio:NaN,aspectRatio:NaN,data:null,preview:"",responsive:!0,restore:!0,checkCrossOrigin:!0,checkOrientation:!0,modal:!0,guides:!0,center:!0,highlight:!0,background:!0,autoCrop:!0,autoCropArea:.8,movable:!0,rotatable:!0,scalable:!0,zoomable:!0,zoomOnTouch:!0,zoomOnWheel:!0,wheelZoomRatio:.1,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!0,minCanvasWidth:0,minCanvasHeight:0,minCropBoxWidth:0,minCropBoxHeight:0,minContainerWidth:200,minContainerHeight:100,ready:null,cropstart:null,cropmove:null,cropend:null,crop:null,zoom:null},sl=Number.isNaN||dc.isNaN;function il(e){return"number"==typeof e&&!sl(e)}const nl=e=>e>0&&e<1/0;function ol(e){return void 0===e}function al(e){return"object"==typeof e&&null!==e}const{hasOwnProperty:rl}=Object.prototype;function cl(e){if(!al(e))return!1;try{const{constructor:t}=e,{prototype:s}=t;return t&&s&&rl.call(s,"isPrototypeOf")}catch(e){return!1}}function ll(e){return"function"==typeof e}const{slice:dl}=Array.prototype;function hl(e){return Array.from?Array.from(e):dl.call(e)}function ul(e,t){return e&&ll(t)&&(Array.isArray(e)||il(e.length)?hl(e).forEach(((s,i)=>{t.call(e,s,i,e)})):al(e)&&Object.keys(e).forEach((s=>{t.call(e,e[s],s,e)}))),e}const pl=Object.assign||function(e,...t){return al(e)&&t.length>0&&t.forEach((t=>{al(t)&&Object.keys(t).forEach((s=>{e[s]=t[s]}))})),e},ml=/\.\d*(?:0|9){12}\d*$/;function gl(e,t=1e11){return ml.test(e)?Math.round(e*t)/t:e}const fl=/^width|height|left|top|marginLeft|marginTop$/;function wl(e,t){const{style:s}=e;ul(t,((e,t)=>{fl.test(t)&&il(e)&&(e=`${e}px`),s[t]=e}))}function yl(e,t){if(!t)return;if(il(e.length))return void ul(e,(e=>{yl(e,t)}));if(e.classList)return void e.classList.add(t);const s=e.className.trim();s?s.indexOf(t)<0&&(e.className=`${s} ${t}`):e.className=t}function bl(e,t){t&&(il(e.length)?ul(e,(e=>{bl(e,t)})):e.classList?e.classList.remove(t):e.className.indexOf(t)>=0&&(e.className=e.className.replace(t,"")))}function vl(e,t,s){t&&(il(e.length)?ul(e,(e=>{vl(e,t,s)})):s?yl(e,t):bl(e,t))}const kl=/([a-z\d])([A-Z])/g;function _l(e){return e.replace(kl,"$1-$2").toLowerCase()}function xl(e,t){return al(e[t])?e[t]:e.dataset?e.dataset[t]:e.getAttribute(`data-${_l(t)}`)}function Cl(e,t,s){al(s)?e[t]=s:e.dataset?e.dataset[t]=s:e.setAttribute(`data-${_l(t)}`,s)}const El=/\s\s*/,Sl=(()=>{let e=!1;if(lc){let t=!1;const s=()=>{},i=Object.defineProperty({},"once",{get:()=>(e=!0,t),set(e){t=e}});dc.addEventListener("test",s,i),dc.removeEventListener("test",s,i)}return e})();function Tl(e,t,s,i={}){let n=s;t.trim().split(El).forEach((t=>{if(!Sl){const{listeners:i}=e;i&&i[t]&&i[t][s]&&(n=i[t][s],delete i[t][s],0===Object.keys(i[t]).length&&delete i[t],0===Object.keys(i).length&&delete e.listeners)}e.removeEventListener(t,n,i)}))}function Al(e,t,s,i={}){let n=s;t.trim().split(El).forEach((t=>{if(i.once&&!Sl){const{listeners:o={}}=e;n=(...a)=>{delete o[t][s],e.removeEventListener(t,n,i),s.apply(e,a)},o[t]||(o[t]={}),o[t][s]&&e.removeEventListener(t,o[t][s],i),o[t][s]=n,e.listeners=o}e.addEventListener(t,n,i)}))}function Ll(e,t,s){let i;return ll(Event)&&ll(CustomEvent)?i=new CustomEvent(t,{detail:s,bubbles:!0,cancelable:!0}):(i=document.createEvent("CustomEvent"),i.initCustomEvent(t,!0,!0,s)),e.dispatchEvent(i)}function jl(e){const t=e.getBoundingClientRect();return{left:t.left+(window.pageXOffset-document.documentElement.clientLeft),top:t.top+(window.pageYOffset-document.documentElement.clientTop)}}const{location:Il}=dc,Dl=/^(\w+:)\/\/([^:/?#]*):?(\d*)/i;function Ml(e){const t=e.match(Dl);return null!==t&&(t[1]!==Il.protocol||t[2]!==Il.hostname||t[3]!==Il.port)}function Ol(e){const t=`timestamp=${(new Date).getTime()}`;return e+(-1===e.indexOf("?")?"?":"&")+t}function Pl({rotate:e,scaleX:t,scaleY:s,translateX:i,translateY:n}){const o=[];il(i)&&0!==i&&o.push(`translateX(${i}px)`),il(n)&&0!==n&&o.push(`translateY(${n}px)`),il(e)&&0!==e&&o.push(`rotate(${e}deg)`),il(t)&&1!==t&&o.push(`scaleX(${t})`),il(s)&&1!==s&&o.push(`scaleY(${s})`);const a=o.length?o.join(" "):"none";return{WebkitTransform:a,msTransform:a,transform:a}}function Rl({pageX:e,pageY:t},s){const i={endX:e,endY:t};return s?i:{startX:e,startY:t,...i}}function $l({aspectRatio:e,height:t,width:s},i="contain"){const n=nl(s),o=nl(t);if(n&&o){const n=t*e;"contain"===i&&n>s||"cover"===i&&n<s?t=s/e:s=t*e}else n?t=s/e:o&&(s=t*e);return{width:s,height:t}}const{fromCharCode:zl}=String;const Bl=/^data:.*,/;function Nl(e){const t=new DataView(e);let s;try{let e,i,n;if(255===t.getUint8(0)&&216===t.getUint8(1)){const e=t.byteLength;let s=2;for(;s+1<e;){if(255===t.getUint8(s)&&225===t.getUint8(s+1)){i=s;break}s+=1}}if(i){const s=i+10;if("Exif"===function(e,t,s){let i="";s+=t;for(let n=t;n<s;n+=1)i+=zl(e.getUint8(n));return i}(t,i+4,4)){const i=t.getUint16(s);if(e=18761===i,(e||19789===i)&&42===t.getUint16(s+2,e)){const i=t.getUint32(s+4,e);i>=8&&(n=s+i)}}}if(n){const i=t.getUint16(n,e);let o,a;for(a=0;a<i;a+=1)if(o=n+12*a+2,274===t.getUint16(o,e)){o+=8,s=t.getUint16(o,e),t.setUint16(o,1,e);break}}}catch(e){s=1}return s}const Fl={render(){this.initContainer(),this.initCanvas(),this.initCropBox(),this.renderCanvas(),this.cropped&&this.renderCropBox()},initContainer(){const{element:e,options:t,container:s,cropper:i}=this,n=Number(t.minContainerWidth),o=Number(t.minContainerHeight);yl(i,Ac),bl(e,Ac);const a={width:Math.max(s.offsetWidth,n>=0?n:200),height:Math.max(s.offsetHeight,o>=0?o:100)};this.containerData=a,wl(i,{width:a.width,height:a.height}),yl(e,Ac),bl(i,Ac)},initCanvas(){const{containerData:e,imageData:t}=this,{viewMode:s}=this.options,i=Math.abs(t.rotate)%180==90,n=i?t.naturalHeight:t.naturalWidth,o=i?t.naturalWidth:t.naturalHeight,a=n/o;let r=e.width,c=e.height;e.height*a>e.width?3===s?r=e.height*a:c=e.width/a:3===s?c=e.width/a:r=e.height*a;const l={aspectRatio:a,naturalWidth:n,naturalHeight:o,width:r,height:c};this.canvasData=l,this.limited=1===s||2===s,this.limitCanvas(!0,!0),l.width=Math.min(Math.max(l.width,l.minWidth),l.maxWidth),l.height=Math.min(Math.max(l.height,l.minHeight),l.maxHeight),l.left=(e.width-l.width)/2,l.top=(e.height-l.height)/2,l.oldLeft=l.left,l.oldTop=l.top,this.initialCanvasData=pl({},l)},limitCanvas(e,t){const{options:s,containerData:i,canvasData:n,cropBoxData:o}=this,{viewMode:a}=s,{aspectRatio:r}=n,c=this.cropped&&o;if(e){let e=Number(s.minCanvasWidth)||0,t=Number(s.minCanvasHeight)||0;a>1?(e=Math.max(e,i.width),t=Math.max(t,i.height),3===a&&(t*r>e?e=t*r:t=e/r)):a>0&&(e?e=Math.max(e,c?o.width:0):t?t=Math.max(t,c?o.height:0):c&&(e=o.width,t=o.height,t*r>e?e=t*r:t=e/r)),({width:e,height:t}=$l({aspectRatio:r,width:e,height:t})),n.minWidth=e,n.minHeight=t,n.maxWidth=1/0,n.maxHeight=1/0}if(t)if(a>(c?0:1)){const e=i.width-n.width,t=i.height-n.height;n.minLeft=Math.min(0,e),n.minTop=Math.min(0,t),n.maxLeft=Math.max(0,e),n.maxTop=Math.max(0,t),c&&this.limited&&(n.minLeft=Math.min(o.left,o.left+(o.width-n.width)),n.minTop=Math.min(o.top,o.top+(o.height-n.height)),n.maxLeft=o.left,n.maxTop=o.top,2===a&&(n.width>=i.width&&(n.minLeft=Math.min(0,e),n.maxLeft=Math.max(0,e)),n.height>=i.height&&(n.minTop=Math.min(0,t),n.maxTop=Math.max(0,t))))}else n.minLeft=-n.width,n.minTop=-n.height,n.maxLeft=i.width,n.maxTop=i.height},renderCanvas(e,t){const{canvasData:s,imageData:i}=this;if(t){const{width:e,height:t}=function({width:e,height:t,degree:s}){if(90==(s=Math.abs(s)%180))return{width:t,height:e};const i=s%90*Math.PI/180,n=Math.sin(i),o=Math.cos(i),a=e*o+t*n,r=e*n+t*o;return s>90?{width:r,height:a}:{width:a,height:r}}({width:i.naturalWidth*Math.abs(i.scaleX||1),height:i.naturalHeight*Math.abs(i.scaleY||1),degree:i.rotate||0}),n=s.width*(e/s.naturalWidth),o=s.height*(t/s.naturalHeight);s.left-=(n-s.width)/2,s.top-=(o-s.height)/2,s.width=n,s.height=o,s.aspectRatio=e/t,s.naturalWidth=e,s.naturalHeight=t,this.limitCanvas(!0,!1)}(s.width>s.maxWidth||s.width<s.minWidth)&&(s.left=s.oldLeft),(s.height>s.maxHeight||s.height<s.minHeight)&&(s.top=s.oldTop),s.width=Math.min(Math.max(s.width,s.minWidth),s.maxWidth),s.height=Math.min(Math.max(s.height,s.minHeight),s.maxHeight),this.limitCanvas(!1,!0),s.left=Math.min(Math.max(s.left,s.minLeft),s.maxLeft),s.top=Math.min(Math.max(s.top,s.minTop),s.maxTop),s.oldLeft=s.left,s.oldTop=s.top,wl(this.canvas,pl({width:s.width,height:s.height},Pl({translateX:s.left,translateY:s.top}))),this.renderImage(e),this.cropped&&this.limited&&this.limitCropBox(!0,!0)},renderImage(e){const{canvasData:t,imageData:s}=this,i=s.naturalWidth*(t.width/t.naturalWidth),n=s.naturalHeight*(t.height/t.naturalHeight);pl(s,{width:i,height:n,left:(t.width-i)/2,top:(t.height-n)/2}),wl(this.image,pl({width:s.width,height:s.height},Pl(pl({translateX:s.left,translateY:s.top},s)))),e&&this.output()},initCropBox(){const{options:e,canvasData:t}=this,s=e.aspectRatio||e.initialAspectRatio,i=Number(e.autoCropArea)||.8,n={width:t.width,height:t.height};s&&(t.height*s>t.width?n.height=n.width/s:n.width=n.height*s),this.cropBoxData=n,this.limitCropBox(!0,!0),n.width=Math.min(Math.max(n.width,n.minWidth),n.maxWidth),n.height=Math.min(Math.max(n.height,n.minHeight),n.maxHeight),n.width=Math.max(n.minWidth,n.width*i),n.height=Math.max(n.minHeight,n.height*i),n.left=t.left+(t.width-n.width)/2,n.top=t.top+(t.height-n.height)/2,n.oldLeft=n.left,n.oldTop=n.top,this.initialCropBoxData=pl({},n)},limitCropBox(e,t){const{options:s,containerData:i,canvasData:n,cropBoxData:o,limited:a}=this,{aspectRatio:r}=s;if(e){let e=Number(s.minCropBoxWidth)||0,t=Number(s.minCropBoxHeight)||0,c=a?Math.min(i.width,n.width,n.width+n.left,i.width-n.left):i.width,l=a?Math.min(i.height,n.height,n.height+n.top,i.height-n.top):i.height;e=Math.min(e,i.width),t=Math.min(t,i.height),r&&(e&&t?t*r>e?t=e/r:e=t*r:e?t=e/r:t&&(e=t*r),l*r>c?l=c/r:c=l*r),o.minWidth=Math.min(e,c),o.minHeight=Math.min(t,l),o.maxWidth=c,o.maxHeight=l}t&&(a?(o.minLeft=Math.max(0,n.left),o.minTop=Math.max(0,n.top),o.maxLeft=Math.min(i.width,n.left+n.width)-o.width,o.maxTop=Math.min(i.height,n.top+n.height)-o.height):(o.minLeft=0,o.minTop=0,o.maxLeft=i.width-o.width,o.maxTop=i.height-o.height))},renderCropBox(){const{options:e,containerData:t,cropBoxData:s}=this;(s.width>s.maxWidth||s.width<s.minWidth)&&(s.left=s.oldLeft),(s.height>s.maxHeight||s.height<s.minHeight)&&(s.top=s.oldTop),s.width=Math.min(Math.max(s.width,s.minWidth),s.maxWidth),s.height=Math.min(Math.max(s.height,s.minHeight),s.maxHeight),this.limitCropBox(!1,!0),s.left=Math.min(Math.max(s.left,s.minLeft),s.maxLeft),s.top=Math.min(Math.max(s.top,s.minTop),s.maxTop),s.oldLeft=s.left,s.oldTop=s.top,e.movable&&e.cropBoxMovable&&Cl(this.face,Mc,s.width>=t.width&&s.height>=t.height?fc:mc),wl(this.cropBox,pl({width:s.width,height:s.height},Pl({translateX:s.left,translateY:s.top}))),this.cropped&&this.limited&&this.limitCanvas(!0,!0),this.disabled||this.output()},output(){this.preview(),Ll(this.element,zc,this.getData())}},ql={initPreview(){const{element:e,crossOrigin:t}=this,{preview:s}=this.options,i=t?this.crossOriginUrl:this.url,n=e.alt||"The image to preview",o=document.createElement("img");if(t&&(o.crossOrigin=t),o.src=i,o.alt=n,this.viewBox.appendChild(o),this.viewBoxImage=o,!s)return;let a=s;"string"==typeof s?a=e.ownerDocument.querySelectorAll(s):s.querySelector&&(a=[s]),this.previews=a,ul(a,(e=>{const s=document.createElement("img");Cl(e,Oc,{width:e.offsetWidth,height:e.offsetHeight,html:e.innerHTML}),t&&(s.crossOrigin=t),s.src=i,s.alt=n,s.style.cssText='display:block;width:100%;height:auto;min-width:0!important;min-height:0!important;max-width:none!important;max-height:none!important;image-orientation:0deg!important;"',e.innerHTML="",e.appendChild(s)}))},resetPreview(){ul(this.previews,(e=>{const t=xl(e,Oc);wl(e,{width:t.width,height:t.height}),e.innerHTML=t.html,function(e,t){if(al(e[t]))try{delete e[t]}catch(s){e[t]=void 0}else if(e.dataset)try{delete e.dataset[t]}catch(s){e.dataset[t]=void 0}else e.removeAttribute(`data-${_l(t)}`)}(e,Oc)}))},preview(){const{imageData:e,canvasData:t,cropBoxData:s}=this,{width:i,height:n}=s,{width:o,height:a}=e,r=s.left-t.left-e.left,c=s.top-t.top-e.top;this.cropped&&!this.disabled&&(wl(this.viewBoxImage,pl({width:o,height:a},Pl(pl({translateX:-r,translateY:-c},e)))),ul(this.previews,(t=>{const s=xl(t,Oc),l=s.width,d=s.height;let h=l,u=d,p=1;i&&(p=l/i,u=n*p),n&&u>d&&(p=d/n,h=i*p,u=d),wl(t,{width:h,height:u}),wl(t.getElementsByTagName("img")[0],pl({width:o*p,height:a*p},Pl(pl({translateX:-r*p,translateY:-c*p},e))))})))}},Ul={bind(){const{element:e,options:t,cropper:s}=this;ll(t.cropstart)&&Al(e,Fc,t.cropstart),ll(t.cropmove)&&Al(e,Nc,t.cropmove),ll(t.cropend)&&Al(e,Bc,t.cropend),ll(t.crop)&&Al(e,zc,t.crop),ll(t.zoom)&&Al(e,Yc,t.zoom),Al(s,Uc,this.onCropStart=this.cropStart.bind(this)),t.zoomable&&t.zoomOnWheel&&Al(s,Gc,this.onWheel=this.wheel.bind(this),{passive:!1,capture:!0}),t.toggleDragModeOnDblclick&&Al(s,qc,this.onDblclick=this.dblclick.bind(this)),Al(e.ownerDocument,Hc,this.onCropMove=this.cropMove.bind(this)),Al(e.ownerDocument,Wc,this.onCropEnd=this.cropEnd.bind(this)),t.responsive&&Al(window,Xc,this.onResize=this.resize.bind(this))},unbind(){const{element:e,options:t,cropper:s}=this;ll(t.cropstart)&&Tl(e,Fc,t.cropstart),ll(t.cropmove)&&Tl(e,Nc,t.cropmove),ll(t.cropend)&&Tl(e,Bc,t.cropend),ll(t.crop)&&Tl(e,zc,t.crop),ll(t.zoom)&&Tl(e,Yc,t.zoom),Tl(s,Uc,this.onCropStart),t.zoomable&&t.zoomOnWheel&&Tl(s,Gc,this.onWheel,{passive:!1,capture:!0}),t.toggleDragModeOnDblclick&&Tl(s,qc,this.onDblclick),Tl(e.ownerDocument,Hc,this.onCropMove),Tl(e.ownerDocument,Wc,this.onCropEnd),t.responsive&&Tl(window,Xc,this.onResize)}},Hl={resize(){if(this.disabled)return;const{options:e,container:t,containerData:s}=this,i=t.offsetWidth/s.width,n=t.offsetHeight/s.height,o=Math.abs(i-1)>Math.abs(n-1)?i:n;if(1!==o){let t,s;e.restore&&(t=this.getCanvasData(),s=this.getCropBoxData()),this.render(),e.restore&&(this.setCanvasData(ul(t,((e,s)=>{t[s]=e*o}))),this.setCropBoxData(ul(s,((e,t)=>{s[t]=e*o}))))}},dblclick(){var e,t;this.disabled||this.options.dragMode===$c||this.setDragMode((e=this.dragBox,t=Sc,(e.classList?e.classList.contains(t):e.className.indexOf(t)>-1)?Rc:Pc))},wheel(e){const t=Number(this.options.wheelZoomRatio)||.1;let s=1;this.disabled||(e.preventDefault(),this.wheeling||(this.wheeling=!0,setTimeout((()=>{this.wheeling=!1}),50),e.deltaY?s=e.deltaY>0?1:-1:e.wheelDelta?s=-e.wheelDelta/120:e.detail&&(s=e.detail>0?1:-1),this.zoom(-s*t,e)))},cropStart(e){const{buttons:t,button:s}=e;if(this.disabled||("mousedown"===e.type||"pointerdown"===e.type&&"mouse"===e.pointerType)&&(il(t)&&1!==t||il(s)&&0!==s||e.ctrlKey))return;const{options:i,pointers:n}=this;let o;e.changedTouches?ul(e.changedTouches,(e=>{n[e.identifier]=Rl(e)})):n[e.pointerId||0]=Rl(e),o=Object.keys(n).length>1&&i.zoomable&&i.zoomOnTouch?wc:xl(e.target,Mc),Zc.test(o)&&!1!==Ll(this.element,Fc,{originalEvent:e,action:o})&&(e.preventDefault(),this.action=o,this.cropping=!1,o===gc&&(this.cropping=!0,yl(this.dragBox,Ic)))},cropMove(e){const{action:t}=this;if(this.disabled||!t)return;const{pointers:s}=this;e.preventDefault(),!1!==Ll(this.element,Nc,{originalEvent:e,action:t})&&(e.changedTouches?ul(e.changedTouches,(e=>{pl(s[e.identifier]||{},Rl(e,!0))})):pl(s[e.pointerId||0]||{},Rl(e,!0)),this.change(e))},cropEnd(e){if(this.disabled)return;const{action:t,pointers:s}=this;e.changedTouches?ul(e.changedTouches,(e=>{delete s[e.identifier]})):delete s[e.pointerId||0],t&&(e.preventDefault(),Object.keys(s).length||(this.action=""),this.cropping&&(this.cropping=!1,vl(this.dragBox,Ic,this.cropped&&this.options.modal)),Ll(this.element,Bc,{originalEvent:e,action:t}))}},Wl={change(e){const{options:t,canvasData:s,containerData:i,cropBoxData:n,pointers:o}=this;let{action:a}=this,{aspectRatio:r}=t,{left:c,top:l,width:d,height:h}=n;const u=c+d,p=l+h;let m,g=0,f=0,w=i.width,y=i.height,b=!0;!r&&e.shiftKey&&(r=d&&h?d/h:1),this.limited&&(({minLeft:g,minTop:f}=n),w=g+Math.min(i.width,s.width,s.left+s.width),y=f+Math.min(i.height,s.height,s.top+s.height));const v=o[Object.keys(o)[0]],k={x:v.endX-v.startX,y:v.endY-v.startY},_=e=>{switch(e){case yc:u+k.x>w&&(k.x=w-u);break;case bc:c+k.x<g&&(k.x=g-c);break;case kc:l+k.y<f&&(k.y=f-l);break;case vc:p+k.y>y&&(k.y=y-p)}};switch(a){case mc:c+=k.x,l+=k.y;break;case yc:if(k.x>=0&&(u>=w||r&&(l<=f||p>=y))){b=!1;break}_(yc),d+=k.x,d<0&&(a=bc,d=-d,c-=d),r&&(h=d/r,l+=(n.height-h)/2);break;case kc:if(k.y<=0&&(l<=f||r&&(c<=g||u>=w))){b=!1;break}_(kc),h-=k.y,l+=k.y,h<0&&(a=vc,h=-h,l-=h),r&&(d=h*r,c+=(n.width-d)/2);break;case bc:if(k.x<=0&&(c<=g||r&&(l<=f||p>=y))){b=!1;break}_(bc),d-=k.x,c+=k.x,d<0&&(a=yc,d=-d,c-=d),r&&(h=d/r,l+=(n.height-h)/2);break;case vc:if(k.y>=0&&(p>=y||r&&(c<=g||u>=w))){b=!1;break}_(vc),h+=k.y,h<0&&(a=kc,h=-h,l-=h),r&&(d=h*r,c+=(n.width-d)/2);break;case _c:if(r){if(k.y<=0&&(l<=f||u>=w)){b=!1;break}_(kc),h-=k.y,l+=k.y,d=h*r}else _(kc),_(yc),k.x>=0?u<w?d+=k.x:k.y<=0&&l<=f&&(b=!1):d+=k.x,k.y<=0?l>f&&(h-=k.y,l+=k.y):(h-=k.y,l+=k.y);d<0&&h<0?(a=Ec,h=-h,d=-d,l-=h,c-=d):d<0?(a=xc,d=-d,c-=d):h<0&&(a=Cc,h=-h,l-=h);break;case xc:if(r){if(k.y<=0&&(l<=f||c<=g)){b=!1;break}_(kc),h-=k.y,l+=k.y,d=h*r,c+=n.width-d}else _(kc),_(bc),k.x<=0?c>g?(d-=k.x,c+=k.x):k.y<=0&&l<=f&&(b=!1):(d-=k.x,c+=k.x),k.y<=0?l>f&&(h-=k.y,l+=k.y):(h-=k.y,l+=k.y);d<0&&h<0?(a=Cc,h=-h,d=-d,l-=h,c-=d):d<0?(a=_c,d=-d,c-=d):h<0&&(a=Ec,h=-h,l-=h);break;case Ec:if(r){if(k.x<=0&&(c<=g||p>=y)){b=!1;break}_(bc),d-=k.x,c+=k.x,h=d/r}else _(vc),_(bc),k.x<=0?c>g?(d-=k.x,c+=k.x):k.y>=0&&p>=y&&(b=!1):(d-=k.x,c+=k.x),k.y>=0?p<y&&(h+=k.y):h+=k.y;d<0&&h<0?(a=_c,h=-h,d=-d,l-=h,c-=d):d<0?(a=Cc,d=-d,c-=d):h<0&&(a=xc,h=-h,l-=h);break;case Cc:if(r){if(k.x>=0&&(u>=w||p>=y)){b=!1;break}_(yc),d+=k.x,h=d/r}else _(vc),_(yc),k.x>=0?u<w?d+=k.x:k.y>=0&&p>=y&&(b=!1):d+=k.x,k.y>=0?p<y&&(h+=k.y):h+=k.y;d<0&&h<0?(a=xc,h=-h,d=-d,l-=h,c-=d):d<0?(a=Ec,d=-d,c-=d):h<0&&(a=_c,h=-h,l-=h);break;case fc:this.move(k.x,k.y),b=!1;break;case wc:this.zoom(function(e){const t={...e};let s=0;return ul(e,((e,i)=>{delete t[i],ul(t,(t=>{const i=Math.abs(e.startX-t.startX),n=Math.abs(e.startY-t.startY),o=Math.abs(e.endX-t.endX),a=Math.abs(e.endY-t.endY),r=Math.sqrt(i*i+n*n),c=(Math.sqrt(o*o+a*a)-r)/r;Math.abs(c)>Math.abs(s)&&(s=c)}))})),s}(o),e),b=!1;break;case gc:if(!k.x||!k.y){b=!1;break}m=jl(this.cropper),c=v.startX-m.left,l=v.startY-m.top,d=n.minWidth,h=n.minHeight,k.x>0?a=k.y>0?Cc:_c:k.x<0&&(c-=d,a=k.y>0?Ec:xc),k.y<0&&(l-=h),this.cropped||(bl(this.cropBox,Ac),this.cropped=!0,this.limited&&this.limitCropBox(!0,!0))}b&&(n.width=d,n.height=h,n.left=c,n.top=l,this.action=a,this.renderCropBox()),ul(o,(e=>{e.startX=e.endX,e.startY=e.endY}))}},Vl={crop(){return!this.ready||this.cropped||this.disabled||(this.cropped=!0,this.limitCropBox(!0,!0),this.options.modal&&yl(this.dragBox,Ic),bl(this.cropBox,Ac),this.setCropBoxData(this.initialCropBoxData)),this},reset(){return this.ready&&!this.disabled&&(this.imageData=pl({},this.initialImageData),this.canvasData=pl({},this.initialCanvasData),this.cropBoxData=pl({},this.initialCropBoxData),this.renderCanvas(),this.cropped&&this.renderCropBox()),this},clear(){return this.cropped&&!this.disabled&&(pl(this.cropBoxData,{left:0,top:0,width:0,height:0}),this.cropped=!1,this.renderCropBox(),this.limitCanvas(!0,!0),this.renderCanvas(),bl(this.dragBox,Ic),yl(this.cropBox,Ac)),this},replace(e,t=!1){return!this.disabled&&e&&(this.isImg&&(this.element.src=e),t?(this.url=e,this.image.src=e,this.ready&&(this.viewBoxImage.src=e,ul(this.previews,(t=>{t.getElementsByTagName("img")[0].src=e})))):(this.isImg&&(this.replaced=!0),this.options.data=null,this.uncreate(),this.load(e))),this},enable(){return this.ready&&this.disabled&&(this.disabled=!1,bl(this.cropper,Tc)),this},disable(){return this.ready&&!this.disabled&&(this.disabled=!0,yl(this.cropper,Tc)),this},destroy(){const{element:e}=this;return e[pc]?(e[pc]=void 0,this.isImg&&this.replaced&&(e.src=this.originalUrl),this.uncreate(),this):this},move(e,t=e){const{left:s,top:i}=this.canvasData;return this.moveTo(ol(e)?e:s+Number(e),ol(t)?t:i+Number(t))},moveTo(e,t=e){const{canvasData:s}=this;let i=!1;return e=Number(e),t=Number(t),this.ready&&!this.disabled&&this.options.movable&&(il(e)&&(s.left=e,i=!0),il(t)&&(s.top=t,i=!0),i&&this.renderCanvas(!0)),this},zoom(e,t){const{canvasData:s}=this;return e=(e=Number(e))<0?1/(1-e):1+e,this.zoomTo(s.width*e/s.naturalWidth,null,t)},zoomTo(e,t,s){const{options:i,canvasData:n}=this,{width:o,height:a,naturalWidth:r,naturalHeight:c}=n;if((e=Number(e))>=0&&this.ready&&!this.disabled&&i.zoomable){const i=r*e,l=c*e;if(!1===Ll(this.element,Yc,{ratio:e,oldRatio:o/r,originalEvent:s}))return this;if(s){const{pointers:e}=this,t=jl(this.cropper),r=e&&Object.keys(e).length?function(e){let t=0,s=0,i=0;return ul(e,(({startX:e,startY:n})=>{t+=e,s+=n,i+=1})),t/=i,s/=i,{pageX:t,pageY:s}}(e):{pageX:s.pageX,pageY:s.pageY};n.left-=(i-o)*((r.pageX-t.left-n.left)/o),n.top-=(l-a)*((r.pageY-t.top-n.top)/a)}else cl(t)&&il(t.x)&&il(t.y)?(n.left-=(i-o)*((t.x-n.left)/o),n.top-=(l-a)*((t.y-n.top)/a)):(n.left-=(i-o)/2,n.top-=(l-a)/2);n.width=i,n.height=l,this.renderCanvas(!0)}return this},rotate(e){return this.rotateTo((this.imageData.rotate||0)+Number(e))},rotateTo(e){return il(e=Number(e))&&this.ready&&!this.disabled&&this.options.rotatable&&(this.imageData.rotate=e%360,this.renderCanvas(!0,!0)),this},scaleX(e){const{scaleY:t}=this.imageData;return this.scale(e,il(t)?t:1)},scaleY(e){const{scaleX:t}=this.imageData;return this.scale(il(t)?t:1,e)},scale(e,t=e){const{imageData:s}=this;let i=!1;return e=Number(e),t=Number(t),this.ready&&!this.disabled&&this.options.scalable&&(il(e)&&(s.scaleX=e,i=!0),il(t)&&(s.scaleY=t,i=!0),i&&this.renderCanvas(!0,!0)),this},getData(e=!1){const{options:t,imageData:s,canvasData:i,cropBoxData:n}=this;let o;if(this.ready&&this.cropped){o={x:n.left-i.left,y:n.top-i.top,width:n.width,height:n.height};const t=s.width/s.naturalWidth;if(ul(o,((e,s)=>{o[s]=e/t})),e){const e=Math.round(o.y+o.height),t=Math.round(o.x+o.width);o.x=Math.round(o.x),o.y=Math.round(o.y),o.width=t-o.x,o.height=e-o.y}}else o={x:0,y:0,width:0,height:0};return t.rotatable&&(o.rotate=s.rotate||0),t.scalable&&(o.scaleX=s.scaleX||1,o.scaleY=s.scaleY||1),o},setData(e){const{options:t,imageData:s,canvasData:i}=this,n={};if(this.ready&&!this.disabled&&cl(e)){let o=!1;t.rotatable&&il(e.rotate)&&e.rotate!==s.rotate&&(s.rotate=e.rotate,o=!0),t.scalable&&(il(e.scaleX)&&e.scaleX!==s.scaleX&&(s.scaleX=e.scaleX,o=!0),il(e.scaleY)&&e.scaleY!==s.scaleY&&(s.scaleY=e.scaleY,o=!0)),o&&this.renderCanvas(!0,!0);const a=s.width/s.naturalWidth;il(e.x)&&(n.left=e.x*a+i.left),il(e.y)&&(n.top=e.y*a+i.top),il(e.width)&&(n.width=e.width*a),il(e.height)&&(n.height=e.height*a),this.setCropBoxData(n)}return this},getContainerData(){return this.ready?pl({},this.containerData):{}},getImageData(){return this.sized?pl({},this.imageData):{}},getCanvasData(){const{canvasData:e}=this,t={};return this.ready&&ul(["left","top","width","height","naturalWidth","naturalHeight"],(s=>{t[s]=e[s]})),t},setCanvasData(e){const{canvasData:t}=this,{aspectRatio:s}=t;return this.ready&&!this.disabled&&cl(e)&&(il(e.left)&&(t.left=e.left),il(e.top)&&(t.top=e.top),il(e.width)?(t.width=e.width,t.height=e.width/s):il(e.height)&&(t.height=e.height,t.width=e.height*s),this.renderCanvas(!0)),this},getCropBoxData(){const{cropBoxData:e}=this;let t;return this.ready&&this.cropped&&(t={left:e.left,top:e.top,width:e.width,height:e.height}),t||{}},setCropBoxData(e){const{cropBoxData:t}=this,{aspectRatio:s}=this.options;let i,n;return this.ready&&this.cropped&&!this.disabled&&cl(e)&&(il(e.left)&&(t.left=e.left),il(e.top)&&(t.top=e.top),il(e.width)&&e.width!==t.width&&(i=!0,t.width=e.width),il(e.height)&&e.height!==t.height&&(n=!0,t.height=e.height),s&&(i?t.height=t.width/s:n&&(t.width=t.height*s)),this.renderCropBox()),this},getCroppedCanvas(e={}){if(!this.ready||!window.HTMLCanvasElement)return null;const{canvasData:t}=this,s=function(e,{aspectRatio:t,naturalWidth:s,naturalHeight:i,rotate:n=0,scaleX:o=1,scaleY:a=1},{aspectRatio:r,naturalWidth:c,naturalHeight:l},{fillColor:d="transparent",imageSmoothingEnabled:h=!0,imageSmoothingQuality:u="low",maxWidth:p=1/0,maxHeight:m=1/0,minWidth:g=0,minHeight:f=0}){const w=document.createElement("canvas"),y=w.getContext("2d"),b=$l({aspectRatio:r,width:p,height:m}),v=$l({aspectRatio:r,width:g,height:f},"cover"),k=Math.min(b.width,Math.max(v.width,c)),_=Math.min(b.height,Math.max(v.height,l)),x=$l({aspectRatio:t,width:p,height:m}),C=$l({aspectRatio:t,width:g,height:f},"cover"),E=Math.min(x.width,Math.max(C.width,s)),S=Math.min(x.height,Math.max(C.height,i)),T=[-E/2,-S/2,E,S];return w.width=gl(k),w.height=gl(_),y.fillStyle=d,y.fillRect(0,0,k,_),y.save(),y.translate(k/2,_/2),y.rotate(n*Math.PI/180),y.scale(o,a),y.imageSmoothingEnabled=h,y.imageSmoothingQuality=u,y.drawImage(e,...T.map((e=>Math.floor(gl(e))))),y.restore(),w}(this.image,this.imageData,t,e);if(!this.cropped)return s;let{x:i,y:n,width:o,height:a}=this.getData();const r=s.width/Math.floor(t.naturalWidth);1!==r&&(i*=r,n*=r,o*=r,a*=r);const c=o/a,l=$l({aspectRatio:c,width:e.maxWidth||1/0,height:e.maxHeight||1/0}),d=$l({aspectRatio:c,width:e.minWidth||0,height:e.minHeight||0},"cover");let{width:h,height:u}=$l({aspectRatio:c,width:e.width||(1!==r?s.width:o),height:e.height||(1!==r?s.height:a)});h=Math.min(l.width,Math.max(d.width,h)),u=Math.min(l.height,Math.max(d.height,u));const p=document.createElement("canvas"),m=p.getContext("2d");p.width=gl(h),p.height=gl(u),m.fillStyle=e.fillColor||"transparent",m.fillRect(0,0,h,u);const{imageSmoothingEnabled:g=!0,imageSmoothingQuality:f}=e;m.imageSmoothingEnabled=g,f&&(m.imageSmoothingQuality=f);const w=s.width,y=s.height;let b,v,k,_,x,C,E=i,S=n;E<=-o||E>w?(E=0,b=0,k=0,x=0):E<=0?(k=-E,E=0,b=Math.min(w,o+E),x=b):E<=w&&(k=0,b=Math.min(o,w-E),x=b),b<=0||S<=-a||S>y?(S=0,v=0,_=0,C=0):S<=0?(_=-S,S=0,v=Math.min(y,a+S),C=v):S<=y&&(_=0,v=Math.min(a,y-S),C=v);const T=[E,S,b,v];if(x>0&&C>0){const e=h/o;T.push(k*e,_*e,x*e,C*e)}return m.drawImage(s,...T.map((e=>Math.floor(gl(e))))),p},setAspectRatio(e){const{options:t}=this;return this.disabled||ol(e)||(t.aspectRatio=Math.max(0,e)||NaN,this.ready&&(this.initCropBox(),this.cropped&&this.renderCropBox())),this},setDragMode(e){const{options:t,dragBox:s,face:i}=this;if(this.ready&&!this.disabled){const n=e===Pc,o=t.movable&&e===Rc;e=n||o?e:$c,t.dragMode=e,Cl(s,Mc,e),vl(s,Sc,n),vl(s,Dc,o),t.cropBoxMovable||(Cl(i,Mc,e),vl(i,Sc,n),vl(i,Dc,o))}return this}},Xl=dc.Cropper;class Gl{constructor(e,t={}){if(!e||!el.test(e.tagName))throw new Error("The first argument is required and must be an <img> or <canvas> element.");this.element=e,this.options=pl({},tl,cl(t)&&t),this.cropped=!1,this.disabled=!1,this.pointers={},this.ready=!1,this.reloading=!1,this.replaced=!1,this.sized=!1,this.sizing=!1,this.init()}init(){const{element:e}=this,t=e.tagName.toLowerCase();let s;if(!e[pc]){if(e[pc]=this,"img"===t){if(this.isImg=!0,s=e.getAttribute("src")||"",this.originalUrl=s,!s)return;s=e.src}else"canvas"===t&&window.HTMLCanvasElement&&(s=e.toDataURL());this.load(s)}}load(e){if(!e)return;this.url=e,this.imageData={};const{element:t,options:s}=this;if(s.rotatable||s.scalable||(s.checkOrientation=!1),!s.checkOrientation||!window.ArrayBuffer)return void this.clone();if(Jc.test(e))return void(Qc.test(e)?this.read(function(e){const t=e.replace(Bl,""),s=atob(t),i=new ArrayBuffer(s.length),n=new Uint8Array(i);return ul(n,((e,t)=>{n[t]=s.charCodeAt(t)})),i}(e)):this.clone());const i=new XMLHttpRequest,n=this.clone.bind(this);this.reloading=!0,this.xhr=i,i.onabort=n,i.onerror=n,i.ontimeout=n,i.onprogress=()=>{i.getResponseHeader("content-type")!==Kc&&i.abort()},i.onload=()=>{this.read(i.response)},i.onloadend=()=>{this.reloading=!1,this.xhr=null},s.checkCrossOrigin&&Ml(e)&&t.crossOrigin&&(e=Ol(e)),i.open("GET",e,!0),i.responseType="arraybuffer",i.withCredentials="use-credentials"===t.crossOrigin,i.send()}read(e){const{options:t,imageData:s}=this,i=Nl(e);let n=0,o=1,a=1;i>1&&(this.url=function(e,t){const s=[];let i=new Uint8Array(e);for(;i.length>0;)s.push(zl.apply(null,hl(i.subarray(0,8192)))),i=i.subarray(8192);return`data:${t};base64,${btoa(s.join(""))}`}(e,Kc),({rotate:n,scaleX:o,scaleY:a}=function(e){let t=0,s=1,i=1;switch(e){case 2:s=-1;break;case 3:t=-180;break;case 4:i=-1;break;case 5:t=90,i=-1;break;case 6:t=90;break;case 7:t=90,s=-1;break;case 8:t=-90}return{rotate:t,scaleX:s,scaleY:i}}(i))),t.rotatable&&(s.rotate=n),t.scalable&&(s.scaleX=o,s.scaleY=a),this.clone()}clone(){const{element:e,url:t}=this;let{crossOrigin:s}=e,i=t;this.options.checkCrossOrigin&&Ml(t)&&(s||(s="anonymous"),i=Ol(t)),this.crossOrigin=s,this.crossOriginUrl=i;const n=document.createElement("img");s&&(n.crossOrigin=s),n.src=i||t,n.alt=e.alt||"The image to crop",this.image=n,n.onload=this.start.bind(this),n.onerror=this.stop.bind(this),yl(n,Lc),e.parentNode.insertBefore(n,e.nextSibling)}start(){const{image:e}=this;e.onload=null,e.onerror=null,this.sizing=!0;const t=dc.navigator&&/(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(dc.navigator.userAgent),s=(e,t)=>{pl(this.imageData,{naturalWidth:e,naturalHeight:t,aspectRatio:e/t}),this.initialImageData=pl({},this.imageData),this.sizing=!1,this.sized=!0,this.build()};if(e.naturalWidth&&!t)return void s(e.naturalWidth,e.naturalHeight);const i=document.createElement("img"),n=document.body||document.documentElement;this.sizingImage=i,i.onload=()=>{s(i.width,i.height),t||n.removeChild(i)},i.src=e.src,t||(i.style.cssText="left:0;max-height:none!important;max-width:none!important;min-height:0!important;min-width:0!important;opacity:0;position:absolute;top:0;z-index:-1;",n.appendChild(i))}stop(){const{image:e}=this;e.onload=null,e.onerror=null,e.parentNode.removeChild(e),this.image=null}build(){if(!this.sized||this.ready)return;const{element:e,options:t,image:s}=this,i=e.parentNode,n=document.createElement("div");n.innerHTML='<div class="cropper-container" touch-action="none"><div class="cropper-wrap-box"><div class="cropper-canvas"></div></div><div class="cropper-drag-box"></div><div class="cropper-crop-box"><span class="cropper-view-box"></span><span class="cropper-dashed dashed-h"></span><span class="cropper-dashed dashed-v"></span><span class="cropper-center"></span><span class="cropper-face"></span><span class="cropper-line line-e" data-cropper-action="e"></span><span class="cropper-line line-n" data-cropper-action="n"></span><span class="cropper-line line-w" data-cropper-action="w"></span><span class="cropper-line line-s" data-cropper-action="s"></span><span class="cropper-point point-e" data-cropper-action="e"></span><span class="cropper-point point-n" data-cropper-action="n"></span><span class="cropper-point point-w" data-cropper-action="w"></span><span class="cropper-point point-s" data-cropper-action="s"></span><span class="cropper-point point-ne" data-cropper-action="ne"></span><span class="cropper-point point-nw" data-cropper-action="nw"></span><span class="cropper-point point-sw" data-cropper-action="sw"></span><span class="cropper-point point-se" data-cropper-action="se"></span></div></div>';const o=n.querySelector(`.${pc}-container`),a=o.querySelector(`.${pc}-canvas`),r=o.querySelector(`.${pc}-drag-box`),c=o.querySelector(`.${pc}-crop-box`),l=c.querySelector(`.${pc}-face`);this.container=i,this.cropper=o,this.canvas=a,this.dragBox=r,this.cropBox=c,this.viewBox=o.querySelector(`.${pc}-view-box`),this.face=l,a.appendChild(s),yl(e,Ac),i.insertBefore(o,e.nextSibling),this.isImg||bl(s,Lc),this.initPreview(),this.bind(),t.initialAspectRatio=Math.max(0,t.initialAspectRatio)||NaN,t.aspectRatio=Math.max(0,t.aspectRatio)||NaN,t.viewMode=Math.max(0,Math.min(3,Math.round(t.viewMode)))||0,yl(c,Ac),t.guides||yl(c.getElementsByClassName(`${pc}-dashed`),Ac),t.center||yl(c.getElementsByClassName(`${pc}-center`),Ac),t.background&&yl(o,`${pc}-bg`),t.highlight||yl(l,jc),t.cropBoxMovable&&(yl(l,Dc),Cl(l,Mc,mc)),t.cropBoxResizable||(yl(c.getElementsByClassName(`${pc}-line`),Ac),yl(c.getElementsByClassName(`${pc}-point`),Ac)),this.render(),this.ready=!0,this.setDragMode(t.dragMode),t.autoCrop&&this.crop(),this.setData(t.data),ll(t.ready)&&Al(e,Vc,t.ready,{once:!0}),Ll(e,Vc)}unbuild(){this.ready&&(this.ready=!1,this.unbind(),this.resetPreview(),this.cropper.parentNode.removeChild(this.cropper),bl(this.element,Ac))}uncreate(){this.ready?(this.unbuild(),this.ready=!1,this.cropped=!1):this.sizing?(this.sizingImage.onload=null,this.sizing=!1,this.sized=!1):this.reloading?(this.xhr.onabort=null,this.xhr.abort()):this.image&&this.stop()}static noConflict(){return window.Cropper=Xl,Gl}static setDefaults(e){pl(tl,cl(e)&&e)}}pl(Gl.prototype,Fl,ql,Ul,Hl,Wl,Vl);const Yl=Gl,Kl=["edit","preview","test"];class Zl{#r;#ne=!0;#oe;#ae={};#re;#ce;#le;#de=[];#he;get area(){return this.#r.area}constructor(e){e.area.classList.add("settings","container-col","m5"),this.#r=e,this.area.oninput=e=>this.#ue(e.target),this.area.onchange=e=>this.#ue(e.target)}load(t,s={}){console.log("Settings load items",t,s),this.#pe();const i=new Map,n=new Set;for(let o of t){if("string"==typeof o&&"opponent"===o)o={type:"autocomplete",name:"opponent",title:"Opponent",placeholder:"Select an opponent",value:e=>e.dataset.id,ds:"contact"};if(Kl.includes(o.type))continue;const t=o.name.toLowerCase();if("custom"==o.type){const i=new o.Instance;this.#ae[t]=i;const n=i.render(s);isPromise(n)?n.then((e=>this.#r.append(e))):this.#r.append(e)}else{let e=!0;o.name in s&&(o.val=s[o.name]);let a=o.type;"json"==a&&(a="text");const r=this.#r.addItemTemplate(`settings-${a}-field`,o);switch(i.set(t.toLowerCase(),o),(o.required&&!o.val||o.check&&o.val&&!o.check(o.val))&&n.add(t),o.type){case"autocomplete":{const e=r.querySelector("input");if(Array.isArray(o.options))Jo(e,o.options);else if("function"==typeof o.options){const t=o.options();isPromise(t)?t.then((t=>Jo(e,t))):Jo(e,t)}}break;case"radio":{const e=r.querySelectorAll("input");if(o.val){for(const t of e)if(t.value==o.val){t.checked=!0;break}}else e[0].checked=!0}break;case"region":case"option":if(o.val){const e=r.querySelector(`select > option[value="${o.val}"]`);e&&(e.selected=!0)}break;case"optiontab":if(o.val){const e=r.querySelector(`select > option[value="${o.val}"]`);e&&(e.selected=!0);const t={};for(const{name:e,fields:s}of o.options)if(s)for(const e of s)t[e.name]=e;const s=r.querySelectorAll("[data-tab] input");for(const e of s){const s=t[e.name];s&&s.val&&(e.value=s.val)}const i=r.querySelectorAll("[data-tab] select");for(const e of i){const s=t[e.name];if(s&&s.val){const t=e.querySelector(`option[value="${s.val}"]`);t&&(t.selected=!0)}}const n=r.querySelector(`[data-tab="${o.val}"]`);n&&dom.moveAfterTop(n)}break;case"text":{const e=r.querySelector("textarea");if(o.val&&(e.value=o.val),o.md){e.setAttribute("md","");const t=new MDE({element:e,spellChecker:!1,autoDownloadFontAwesome:!1});this.#re=t}}break;case"json":{const e=r.querySelector("textarea");e.setAttribute("type","json"),o.val&&(e.value=JSON.stringify(o.val))}break;case"list":if(o.val&&Array.isArray(o.val)){const e=r.querySelector("ul");for(const t of o.val){const s=dom.renderTemplate(o.template,t);e.appendChild(s)}}break;case"faicon":{const e=cc({rootElement:r.querySelector(".picker"),theme:"dark"});this.#de.push(e)}break;default:if(!e){r.querySelector("input").setAttribute("readonly","")}}}}this.#ce=i,this.#le=n,this.#ne=0==n.size,this.onvalidchange(this.#ne)}getData(){const e={},t=this.#me();for(const s of t)if(""!=s.name)switch(s.tagName){case"INPUT":if(s.dataset.id)e[s.name]=s.dataset.id;else switch(s.type){case"checkbox":e[s.name]=!!s.checked;break;case"radio":s.checked&&(e[s.name]=s.value);break;case"number":e[s.name]=Number(s.value);break;default:e[s.name]=s.value}break;case"TEXTAREA":if(s.hasAttribute("md")){e[s.name]=this.#re.value();break}if("json"==s.getAttribute("type")){e[s.name]=JSON.parse(s.value);break}default:e[s.name]=s.value}const s=this.#ge();for(const t of s){const s=Array.from(t.querySelectorAll("li[data-id]")).map((e=>e.dataset.id));e[t.getAttribute("name")]=s}if(this.#oe)for(const[t,s]of Object.entries(this.#oe))e[t]=s.getValue();for(const[t,s]of Object.entries(this.#ae))e[t]=s.getValue();return this.#he&&(e.photo=function(e){const t=e.getCroppedCanvas(),s=function(e){var t=document.createElement("canvas"),s=t.getContext("2d"),i=e.width,n=e.height;return t.width=i,t.height=n,s.imageSmoothingEnabled=!0,s.drawImage(e,0,0,i,n),s.globalCompositeOperation="destination-in",s.beginPath(),s.arc(i/2,n/2,Math.min(i,n)/2,0,2*Math.PI,!0),s.fill(),t}(t).toDataURL("image/png");return s}(this.#he)),e}onvalidchange(e){console.log("Setting valid change",e)}async onFileDrop(e){const t=this.#r.querySelector(".dropzone");if(t){dom.removeChilds(t),t.classList.add("active");for(const s of e){this.#he=await Jl(s,t);break}}}#me(e=!0){const t=e?"input,select,textarea:not([data-mode])":"input,select,textarea";return this.area.querySelectorAll(t)}#fe(){return this.area.querySelectorAll("textarea[data-mode]")}#ge(){return this.area.querySelectorAll("ul[name]")}#pe(){if(this.#ae={},this.#he&&(this.#he.destroy(),this.#he=null),this.#re&&(this.#re.toTextArea(),this.#re=null),this.#oe){for(const e of Object.values(this.#oe))e.toTextArea();this.#oe=void 0}for(const e of this.#de)e.destroy();this.#de=[],this.#r.removeContent()}#ue(e){if(!(""!=e.name&&("TEXTAREA"==e.tagName||"INPUT"==e.tagName&&!["checkbox","radio","color"].includes(e.type))))return;const t=this.#ce,s=this.#le,i="INPUT"==e.tagName&&"checkbox"==e.type?!!e.checked:e.value,n=e.name,{check:o}=t.get(n);o&&!o(i)?(s.add(n),e.classList.add("error")):(s.delete(n),e.classList.remove("error")),0==s.size?(this.#ne||this.onvalidchange(!0),this.#ne=!0):(this.#ne&&this.onvalidchange(!1),this.#ne=!1)}}async function Jl(e,t,s="default"){const i=await loadImage(e,600);console.debug("PHOTO loaded",e.name),t.appendChild(i);const n=new Yl(i,{aspectRatio:1,viewMode:1,ready:function(){}});return n.name=s,n}Object.assign(Zl.prototype,UX.ListMixin);const Ql={string:(e={})=>(ed(e),Object.assign({type:"string",value:e=>e.value,valid:e=>!0},e)),time:(e={})=>(ed(e),Object.assign({type:"time",value:e=>e.value,valid:e=>!0},e)),integer:(e={})=>(ed(e),Object.assign({type:"number",value:e=>Number(e.value),valid:e=>!0},e)),option:(e={})=>(ed(e),Object.assign({type:"option",value:e=>e.value.toLowerCase()},e)),variant:(e={})=>(ed(e),Object.assign({type:"variant",value:e=>e.value.toLowerCase(),valid:e=>!0},e)),text:(e={})=>(ed(e),Object.assign({type:"text",value:e=>e.value,valid:e=>!0},e)),radio:(e={})=>(ed(e),Object.assign({type:"radio",value:e=>e.value.toLowerCase(),valid:e=>!0},e)),list:(e={})=>(ed(e),Object.assign({type:"list"},e)),content:(e={})=>(ed(e),Object.assign({type:"content"},e)),required(e){const t={...e};return t.required=!0,t},name:{type:"string",name:"name",title:"Name",value:e=>e.value,check:e=>e.length>2,noedit:!0},firstname:{type:"string",name:"firstname",value:e=>e.value,check:e=>e.length>2},lastname:{type:"string",name:"lastname",value:e=>e.value,check:e=>e.length>=2},desc:{type:"text",name:"desc",title:"Description",value:e=>e.value,valid:e=>!0},email:{type:"string",name:"email",title:"Email",value:e=>e.value,check:validate.email},ns:{type:"string",name:"ns",title:"Namespace",value:e=>e.value,check:e=>e.length>3},domain:{type:"string",name:"domain",title:"Domain",value:e=>e.value,check:validate.domain},url:{type:"string",name:"url",title:"Url",value:e=>e.value,check:validate.url},role:{type:"option",name:"role",title:"Role",options:["User","Site admin","Admin"],value:e=>e.value.toLowerCase().replace(/ /g,""),valid:e=>!0},access:{type:"option",name:"access",title:"Access",options:["Public","Private"],value:e=>e.value.toLowerCase(),valid:e=>!0},perm:{type:"option",name:"perm",title:"Permission",options:["Full","Read only"],value:e=>e.value.toLowerCase().replace(/ /g,""),valid:e=>!0},channel:{type:"option",name:"channel",title:"Channel",options:()=>app.contacts.getChannels(),value:e=>Number(e.value),valid:e=>!0},comp:{type:"option",name:"comp",title:"Component",options:()=>app.contacts.getComponents(),value:e=>Number(e.value),valid:e=>!0},timeout:{type:"number",name:"timeout",title:"Timeout",value:e=>Number(e.value),valid:e=>!0},tls:{type:"boolean",name:"tls",title:"Tls",value:e=>e.checked,valid:e=>!0},category:{type:"option",name:"category",title:"Category",options:["News","Social","Sport","Education","Fun"],value:e=>e.value.toLowerCase(),valid:e=>!0},region:{type:"region",name:"region",title:"Region",options:["EU","Bulgaria"],value:e=>e.value.toLowerCase(),valid:e=>!0},tag:{type:"string",name:"tag",title:"Tag",value:e=>e.value.toLowerCase(),valid:e=>e.length>2}};function ed(e){e.title||(e.title=e.name.capitalizeFirstLetter(),e.name=e.name.toLowerCase())}function td(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))}class sd extends _a{}var nd="top",od="bottom",ad="right",rd="left",cd="auto",ld=[nd,od,ad,rd],dd="start",hd="end",ud="clippingParents",pd="viewport",md="popper",gd="reference",fd=ld.reduce((function(e,t){return e.concat([t+"-"+dd,t+"-"+hd])}),[]),wd=[].concat(ld,[cd]).reduce((function(e,t){return e.concat([t,t+"-"+dd,t+"-"+hd])}),[]),yd=["beforeRead","read","afterRead","beforeMain","main","afterMain","beforeWrite","write","afterWrite"];function bd(e){return e?(e.nodeName||"").toLowerCase():null}function vd(e){if(null==e)return window;if("[object Window]"!==e.toString()){var t=e.ownerDocument;return t&&t.defaultView||window}return e}function kd(e){return e instanceof vd(e).Element||e instanceof Element}function _d(e){return e instanceof vd(e).HTMLElement||e instanceof HTMLElement}function xd(e){return"undefined"!=typeof ShadowRoot&&(e instanceof vd(e).ShadowRoot||e instanceof ShadowRoot)}var Cd={name:"applyStyles",enabled:!0,phase:"write",fn:function(e){var t=e.state;Object.keys(t.elements).forEach((function(e){var s=t.styles[e]||{},i=t.attributes[e]||{},n=t.elements[e];_d(n)&&bd(n)&&(Object.assign(n.style,s),Object.keys(i).forEach((function(e){var t=i[e];!1===t?n.removeAttribute(e):n.setAttribute(e,!0===t?"":t)})))}))},effect:function(e){var t=e.state,s={popper:{position:t.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(t.elements.popper.style,s.popper),t.styles=s,t.elements.arrow&&Object.assign(t.elements.arrow.style,s.arrow),function(){Object.keys(t.elements).forEach((function(e){var i=t.elements[e],n=t.attributes[e]||{},o=Object.keys(t.styles.hasOwnProperty(e)?t.styles[e]:s[e]).reduce((function(e,t){return e[t]="",e}),{});_d(i)&&bd(i)&&(Object.assign(i.style,o),Object.keys(n).forEach((function(e){i.removeAttribute(e)})))}))}},requires:["computeStyles"]};function Ed(e){return e.split("-")[0]}var Sd=Math.max,Td=Math.min,Ad=Math.round;function Ld(e,t){void 0===t&&(t=!1);var s=e.getBoundingClientRect(),i=1,n=1;if(_d(e)&&t){var o=e.offsetHeight,a=e.offsetWidth;a>0&&(i=Ad(s.width)/a||1),o>0&&(n=Ad(s.height)/o||1)}return{width:s.width/i,height:s.height/n,top:s.top/n,right:s.right/i,bottom:s.bottom/n,left:s.left/i,x:s.left/i,y:s.top/n}}function jd(e){var t=Ld(e),s=e.offsetWidth,i=e.offsetHeight;return Math.abs(t.width-s)<=1&&(s=t.width),Math.abs(t.height-i)<=1&&(i=t.height),{x:e.offsetLeft,y:e.offsetTop,width:s,height:i}}function Id(e,t){var s=t.getRootNode&&t.getRootNode();if(e.contains(t))return!0;if(s&&xd(s)){var i=t;do{if(i&&e.isSameNode(i))return!0;i=i.parentNode||i.host}while(i)}return!1}function Dd(e){return vd(e).getComputedStyle(e)}function Md(e){return["table","td","th"].indexOf(bd(e))>=0}function Od(e){return((kd(e)?e.ownerDocument:e.document)||window.document).documentElement}function Pd(e){return"html"===bd(e)?e:e.assignedSlot||e.parentNode||(xd(e)?e.host:null)||Od(e)}function Rd(e){return _d(e)&&"fixed"!==Dd(e).position?e.offsetParent:null}function $d(e){for(var t=vd(e),s=Rd(e);s&&Md(s)&&"static"===Dd(s).position;)s=Rd(s);return s&&("html"===bd(s)||"body"===bd(s)&&"static"===Dd(s).position)?t:s||function(e){var t=-1!==navigator.userAgent.toLowerCase().indexOf("firefox");if(-1!==navigator.userAgent.indexOf("Trident")&&_d(e)&&"fixed"===Dd(e).position)return null;var s=Pd(e);for(xd(s)&&(s=s.host);_d(s)&&["html","body"].indexOf(bd(s))<0;){var i=Dd(s);if("none"!==i.transform||"none"!==i.perspective||"paint"===i.contain||-1!==["transform","perspective"].indexOf(i.willChange)||t&&"filter"===i.willChange||t&&i.filter&&"none"!==i.filter)return s;s=s.parentNode}return null}(e)||t}function zd(e){return["top","bottom"].indexOf(e)>=0?"x":"y"}function Bd(e,t,s){return Sd(e,Td(t,s))}function Nd(e){return Object.assign({},{top:0,right:0,bottom:0,left:0},e)}function Fd(e,t){return t.reduce((function(t,s){return t[s]=e,t}),{})}var qd={name:"arrow",enabled:!0,phase:"main",fn:function(e){var t,s=e.state,i=e.name,n=e.options,o=s.elements.arrow,a=s.modifiersData.popperOffsets,r=Ed(s.placement),c=zd(r),l=[rd,ad].indexOf(r)>=0?"height":"width";if(o&&a){var d=function(e,t){return Nd("number"!=typeof(e="function"==typeof e?e(Object.assign({},t.rects,{placement:t.placement})):e)?e:Fd(e,ld))}(n.padding,s),h=jd(o),u="y"===c?nd:rd,p="y"===c?od:ad,m=s.rects.reference[l]+s.rects.reference[c]-a[c]-s.rects.popper[l],g=a[c]-s.rects.reference[c],f=$d(o),w=f?"y"===c?f.clientHeight||0:f.clientWidth||0:0,y=m/2-g/2,b=d[u],v=w-h[l]-d[p],k=w/2-h[l]/2+y,_=Bd(b,k,v),x=c;s.modifiersData[i]=((t={})[x]=_,t.centerOffset=_-k,t)}},effect:function(e){var t=e.state,s=e.options.element,i=void 0===s?"[data-popper-arrow]":s;null!=i&&("string"!=typeof i||(i=t.elements.popper.querySelector(i)))&&Id(t.elements.popper,i)&&(t.elements.arrow=i)},requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function Ud(e){return e.split("-")[1]}var Hd={top:"auto",right:"auto",bottom:"auto",left:"auto"};function Wd(e){var t,s=e.popper,i=e.popperRect,n=e.placement,o=e.variation,a=e.offsets,r=e.position,c=e.gpuAcceleration,l=e.adaptive,d=e.roundOffsets,h=e.isFixed,u=a.x,p=void 0===u?0:u,m=a.y,g=void 0===m?0:m,f="function"==typeof d?d({x:p,y:g}):{x:p,y:g};p=f.x,g=f.y;var w=a.hasOwnProperty("x"),y=a.hasOwnProperty("y"),b=rd,v=nd,k=window;if(l){var _=$d(s),x="clientHeight",C="clientWidth";if(_===vd(s)&&"static"!==Dd(_=Od(s)).position&&"absolute"===r&&(x="scrollHeight",C="scrollWidth"),n===nd||(n===rd||n===ad)&&o===hd)v=od,g-=(h&&_===k&&k.visualViewport?k.visualViewport.height:_[x])-i.height,g*=c?1:-1;if(n===rd||(n===nd||n===od)&&o===hd)b=ad,p-=(h&&_===k&&k.visualViewport?k.visualViewport.width:_[C])-i.width,p*=c?1:-1}var E,S=Object.assign({position:r},l&&Hd),T=!0===d?function(e){var t=e.x,s=e.y,i=window.devicePixelRatio||1;return{x:Ad(t*i)/i||0,y:Ad(s*i)/i||0}}({x:p,y:g}):{x:p,y:g};return p=T.x,g=T.y,c?Object.assign({},S,((E={})[v]=y?"0":"",E[b]=w?"0":"",E.transform=(k.devicePixelRatio||1)<=1?"translate("+p+"px, "+g+"px)":"translate3d("+p+"px, "+g+"px, 0)",E)):Object.assign({},S,((t={})[v]=y?g+"px":"",t[b]=w?p+"px":"",t.transform="",t))}var Vd={name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:function(e){var t=e.state,s=e.options,i=s.gpuAcceleration,n=void 0===i||i,o=s.adaptive,a=void 0===o||o,r=s.roundOffsets,c=void 0===r||r,l={placement:Ed(t.placement),variation:Ud(t.placement),popper:t.elements.popper,popperRect:t.rects.popper,gpuAcceleration:n,isFixed:"fixed"===t.options.strategy};null!=t.modifiersData.popperOffsets&&(t.styles.popper=Object.assign({},t.styles.popper,Wd(Object.assign({},l,{offsets:t.modifiersData.popperOffsets,position:t.options.strategy,adaptive:a,roundOffsets:c})))),null!=t.modifiersData.arrow&&(t.styles.arrow=Object.assign({},t.styles.arrow,Wd(Object.assign({},l,{offsets:t.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:c})))),t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-placement":t.placement})},data:{}},Xd={passive:!0};var Gd={name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:function(e){var t=e.state,s=e.instance,i=e.options,n=i.scroll,o=void 0===n||n,a=i.resize,r=void 0===a||a,c=vd(t.elements.popper),l=[].concat(t.scrollParents.reference,t.scrollParents.popper);return o&&l.forEach((function(e){e.addEventListener("scroll",s.update,Xd)})),r&&c.addEventListener("resize",s.update,Xd),function(){o&&l.forEach((function(e){e.removeEventListener("scroll",s.update,Xd)})),r&&c.removeEventListener("resize",s.update,Xd)}},data:{}},Yd={left:"right",right:"left",bottom:"top",top:"bottom"};function Kd(e){return e.replace(/left|right|bottom|top/g,(function(e){return Yd[e]}))}var Zd={start:"end",end:"start"};function Jd(e){return e.replace(/start|end/g,(function(e){return Zd[e]}))}function Qd(e){var t=vd(e);return{scrollLeft:t.pageXOffset,scrollTop:t.pageYOffset}}function eh(e){return Ld(Od(e)).left+Qd(e).scrollLeft}function th(e){var t=Dd(e),s=t.overflow,i=t.overflowX,n=t.overflowY;return/auto|scroll|overlay|hidden/.test(s+n+i)}function sh(e){return["html","body","#document"].indexOf(bd(e))>=0?e.ownerDocument.body:_d(e)&&th(e)?e:sh(Pd(e))}function ih(e,t){var s;void 0===t&&(t=[]);var i=sh(e),n=i===(null==(s=e.ownerDocument)?void 0:s.body),o=vd(i),a=n?[o].concat(o.visualViewport||[],th(i)?i:[]):i,r=t.concat(a);return n?r:r.concat(ih(Pd(a)))}function nh(e){return Object.assign({},e,{left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height})}function oh(e,t){return t===pd?nh(function(e){var t=vd(e),s=Od(e),i=t.visualViewport,n=s.clientWidth,o=s.clientHeight,a=0,r=0;return i&&(n=i.width,o=i.height,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(a=i.offsetLeft,r=i.offsetTop)),{width:n,height:o,x:a+eh(e),y:r}}(e)):kd(t)?function(e){var t=Ld(e);return t.top=t.top+e.clientTop,t.left=t.left+e.clientLeft,t.bottom=t.top+e.clientHeight,t.right=t.left+e.clientWidth,t.width=e.clientWidth,t.height=e.clientHeight,t.x=t.left,t.y=t.top,t}(t):nh(function(e){var t,s=Od(e),i=Qd(e),n=null==(t=e.ownerDocument)?void 0:t.body,o=Sd(s.scrollWidth,s.clientWidth,n?n.scrollWidth:0,n?n.clientWidth:0),a=Sd(s.scrollHeight,s.clientHeight,n?n.scrollHeight:0,n?n.clientHeight:0),r=-i.scrollLeft+eh(e),c=-i.scrollTop;return"rtl"===Dd(n||s).direction&&(r+=Sd(s.clientWidth,n?n.clientWidth:0)-o),{width:o,height:a,x:r,y:c}}(Od(e)))}function ah(e,t,s){var i="clippingParents"===t?function(e){var t=ih(Pd(e)),s=["absolute","fixed"].indexOf(Dd(e).position)>=0&&_d(e)?$d(e):e;return kd(s)?t.filter((function(e){return kd(e)&&Id(e,s)&&"body"!==bd(e)})):[]}(e):[].concat(t),n=[].concat(i,[s]),o=n[0],a=n.reduce((function(t,s){var i=oh(e,s);return t.top=Sd(i.top,t.top),t.right=Td(i.right,t.right),t.bottom=Td(i.bottom,t.bottom),t.left=Sd(i.left,t.left),t}),oh(e,o));return a.width=a.right-a.left,a.height=a.bottom-a.top,a.x=a.left,a.y=a.top,a}function rh(e){var t,s=e.reference,i=e.element,n=e.placement,o=n?Ed(n):null,a=n?Ud(n):null,r=s.x+s.width/2-i.width/2,c=s.y+s.height/2-i.height/2;switch(o){case nd:t={x:r,y:s.y-i.height};break;case od:t={x:r,y:s.y+s.height};break;case ad:t={x:s.x+s.width,y:c};break;case rd:t={x:s.x-i.width,y:c};break;default:t={x:s.x,y:s.y}}var l=o?zd(o):null;if(null!=l){var d="y"===l?"height":"width";switch(a){case dd:t[l]=t[l]-(s[d]/2-i[d]/2);break;case hd:t[l]=t[l]+(s[d]/2-i[d]/2)}}return t}function ch(e,t){void 0===t&&(t={});var s=t,i=s.placement,n=void 0===i?e.placement:i,o=s.boundary,a=void 0===o?ud:o,r=s.rootBoundary,c=void 0===r?pd:r,l=s.elementContext,d=void 0===l?md:l,h=s.altBoundary,u=void 0!==h&&h,p=s.padding,m=void 0===p?0:p,g=Nd("number"!=typeof m?m:Fd(m,ld)),f=d===md?gd:md,w=e.rects.popper,y=e.elements[u?f:d],b=ah(kd(y)?y:y.contextElement||Od(e.elements.popper),a,c),v=Ld(e.elements.reference),k=rh({reference:v,element:w,strategy:"absolute",placement:n}),_=nh(Object.assign({},w,k)),x=d===md?_:v,C={top:b.top-x.top+g.top,bottom:x.bottom-b.bottom+g.bottom,left:b.left-x.left+g.left,right:x.right-b.right+g.right},E=e.modifiersData.offset;if(d===md&&E){var S=E[n];Object.keys(C).forEach((function(e){var t=[ad,od].indexOf(e)>=0?1:-1,s=[nd,od].indexOf(e)>=0?"y":"x";C[e]+=S[s]*t}))}return C}function lh(e,t){void 0===t&&(t={});var s=t,i=s.placement,n=s.boundary,o=s.rootBoundary,a=s.padding,r=s.flipVariations,c=s.allowedAutoPlacements,l=void 0===c?wd:c,d=Ud(i),h=d?r?fd:fd.filter((function(e){return Ud(e)===d})):ld,u=h.filter((function(e){return l.indexOf(e)>=0}));0===u.length&&(u=h);var p=u.reduce((function(t,s){return t[s]=ch(e,{placement:s,boundary:n,rootBoundary:o,padding:a})[Ed(s)],t}),{});return Object.keys(p).sort((function(e,t){return p[e]-p[t]}))}var dh={name:"flip",enabled:!0,phase:"main",fn:function(e){var t=e.state,s=e.options,i=e.name;if(!t.modifiersData[i]._skip){for(var n=s.mainAxis,o=void 0===n||n,a=s.altAxis,r=void 0===a||a,c=s.fallbackPlacements,l=s.padding,d=s.boundary,h=s.rootBoundary,u=s.altBoundary,p=s.flipVariations,m=void 0===p||p,g=s.allowedAutoPlacements,f=t.options.placement,w=Ed(f),y=c||(w===f||!m?[Kd(f)]:function(e){if(Ed(e)===cd)return[];var t=Kd(e);return[Jd(e),t,Jd(t)]}(f)),b=[f].concat(y).reduce((function(e,s){return e.concat(Ed(s)===cd?lh(t,{placement:s,boundary:d,rootBoundary:h,padding:l,flipVariations:m,allowedAutoPlacements:g}):s)}),[]),v=t.rects.reference,k=t.rects.popper,_=new Map,x=!0,C=b[0],E=0;E<b.length;E++){var S=b[E],T=Ed(S),A=Ud(S)===dd,L=[nd,od].indexOf(T)>=0,j=L?"width":"height",I=ch(t,{placement:S,boundary:d,rootBoundary:h,altBoundary:u,padding:l}),D=L?A?ad:rd:A?od:nd;v[j]>k[j]&&(D=Kd(D));var M=Kd(D),O=[];if(o&&O.push(I[T]<=0),r&&O.push(I[D]<=0,I[M]<=0),O.every((function(e){return e}))){C=S,x=!1;break}_.set(S,O)}if(x)for(var P=function(e){var t=b.find((function(t){var s=_.get(t);if(s)return s.slice(0,e).every((function(e){return e}))}));if(t)return C=t,"break"},R=m?3:1;R>0;R--){if("break"===P(R))break}t.placement!==C&&(t.modifiersData[i]._skip=!0,t.placement=C,t.reset=!0)}},requiresIfExists:["offset"],data:{_skip:!1}};function hh(e,t,s){return void 0===s&&(s={x:0,y:0}),{top:e.top-t.height-s.y,right:e.right-t.width+s.x,bottom:e.bottom-t.height+s.y,left:e.left-t.width-s.x}}function uh(e){return[nd,ad,od,rd].some((function(t){return e[t]>=0}))}var ph={name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:function(e){var t=e.state,s=e.options,i=e.name,n=s.offset,o=void 0===n?[0,0]:n,a=wd.reduce((function(e,s){return e[s]=function(e,t,s){var i=Ed(e),n=[rd,nd].indexOf(i)>=0?-1:1,o="function"==typeof s?s(Object.assign({},t,{placement:e})):s,a=o[0],r=o[1];return a=a||0,r=(r||0)*n,[rd,ad].indexOf(i)>=0?{x:r,y:a}:{x:a,y:r}}(s,t.rects,o),e}),{}),r=a[t.placement],c=r.x,l=r.y;null!=t.modifiersData.popperOffsets&&(t.modifiersData.popperOffsets.x+=c,t.modifiersData.popperOffsets.y+=l),t.modifiersData[i]=a}};var mh={name:"preventOverflow",enabled:!0,phase:"main",fn:function(e){var t=e.state,s=e.options,i=e.name,n=s.mainAxis,o=void 0===n||n,a=s.altAxis,r=void 0!==a&&a,c=s.boundary,l=s.rootBoundary,d=s.altBoundary,h=s.padding,u=s.tether,p=void 0===u||u,m=s.tetherOffset,g=void 0===m?0:m,f=ch(t,{boundary:c,rootBoundary:l,padding:h,altBoundary:d}),w=Ed(t.placement),y=Ud(t.placement),b=!y,v=zd(w),k="x"===v?"y":"x",_=t.modifiersData.popperOffsets,x=t.rects.reference,C=t.rects.popper,E="function"==typeof g?g(Object.assign({},t.rects,{placement:t.placement})):g,S="number"==typeof E?{mainAxis:E,altAxis:E}:Object.assign({mainAxis:0,altAxis:0},E),T=t.modifiersData.offset?t.modifiersData.offset[t.placement]:null,A={x:0,y:0};if(_){if(o){var L,j="y"===v?nd:rd,I="y"===v?od:ad,D="y"===v?"height":"width",M=_[v],O=M+f[j],P=M-f[I],R=p?-C[D]/2:0,$=y===dd?x[D]:C[D],z=y===dd?-C[D]:-x[D],B=t.elements.arrow,N=p&&B?jd(B):{width:0,height:0},F=t.modifiersData["arrow#persistent"]?t.modifiersData["arrow#persistent"].padding:{top:0,right:0,bottom:0,left:0},q=F[j],U=F[I],H=Bd(0,x[D],N[D]),W=b?x[D]/2-R-H-q-S.mainAxis:$-H-q-S.mainAxis,V=b?-x[D]/2+R+H+U+S.mainAxis:z+H+U+S.mainAxis,X=t.elements.arrow&&$d(t.elements.arrow),G=X?"y"===v?X.clientTop||0:X.clientLeft||0:0,Y=null!=(L=null==T?void 0:T[v])?L:0,K=M+V-Y,Z=Bd(p?Td(O,M+W-Y-G):O,M,p?Sd(P,K):P);_[v]=Z,A[v]=Z-M}if(r){var J,Q="x"===v?nd:rd,ee="x"===v?od:ad,te=_[k],se="y"===k?"height":"width",ie=te+f[Q],ne=te-f[ee],oe=-1!==[nd,rd].indexOf(w),ae=null!=(J=null==T?void 0:T[k])?J:0,re=oe?ie:te-x[se]-C[se]-ae+S.altAxis,ce=oe?te+x[se]+C[se]-ae-S.altAxis:ne,le=p&&oe?function(e,t,s){var i=Bd(e,t,s);return i>s?s:i}(re,te,ce):Bd(p?re:ie,te,p?ce:ne);_[k]=le,A[k]=le-te}t.modifiersData[i]=A}},requiresIfExists:["offset"]};function gh(e,t,s){void 0===s&&(s=!1);var i,n,o=_d(t),a=_d(t)&&function(e){var t=e.getBoundingClientRect(),s=Ad(t.width)/e.offsetWidth||1,i=Ad(t.height)/e.offsetHeight||1;return 1!==s||1!==i}(t),r=Od(t),c=Ld(e,a),l={scrollLeft:0,scrollTop:0},d={x:0,y:0};return(o||!o&&!s)&&(("body"!==bd(t)||th(r))&&(l=(i=t)!==vd(i)&&_d(i)?{scrollLeft:(n=i).scrollLeft,scrollTop:n.scrollTop}:Qd(i)),_d(t)?((d=Ld(t,!0)).x+=t.clientLeft,d.y+=t.clientTop):r&&(d.x=eh(r))),{x:c.left+l.scrollLeft-d.x,y:c.top+l.scrollTop-d.y,width:c.width,height:c.height}}function fh(e){var t=new Map,s=new Set,i=[];function n(e){s.add(e.name),[].concat(e.requires||[],e.requiresIfExists||[]).forEach((function(e){if(!s.has(e)){var i=t.get(e);i&&n(i)}})),i.push(e)}return e.forEach((function(e){t.set(e.name,e)})),e.forEach((function(e){s.has(e.name)||n(e)})),i}var wh={placement:"bottom",modifiers:[],strategy:"absolute"};function yh(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return!t.some((function(e){return!(e&&"function"==typeof e.getBoundingClientRect)}))}function bh(e){void 0===e&&(e={});var t=e,s=t.defaultModifiers,i=void 0===s?[]:s,n=t.defaultOptions,o=void 0===n?wh:n;return function(e,t,s){void 0===s&&(s=o);var n,a,r={placement:"bottom",orderedModifiers:[],options:Object.assign({},wh,o),modifiersData:{},elements:{reference:e,popper:t},attributes:{},styles:{}},c=[],l=!1,d={state:r,setOptions:function(s){var n="function"==typeof s?s(r.options):s;h(),r.options=Object.assign({},o,r.options,n),r.scrollParents={reference:kd(e)?ih(e):e.contextElement?ih(e.contextElement):[],popper:ih(t)};var a,l,u=function(e){var t=fh(e);return yd.reduce((function(e,s){return e.concat(t.filter((function(e){return e.phase===s})))}),[])}((a=[].concat(i,r.options.modifiers),l=a.reduce((function(e,t){var s=e[t.name];return e[t.name]=s?Object.assign({},s,t,{options:Object.assign({},s.options,t.options),data:Object.assign({},s.data,t.data)}):t,e}),{}),Object.keys(l).map((function(e){return l[e]}))));return r.orderedModifiers=u.filter((function(e){return e.enabled})),r.orderedModifiers.forEach((function(e){var t=e.name,s=e.options,i=void 0===s?{}:s,n=e.effect;if("function"==typeof n){var o=n({state:r,name:t,instance:d,options:i}),a=function(){};c.push(o||a)}})),d.update()},forceUpdate:function(){if(!l){var e=r.elements,t=e.reference,s=e.popper;if(yh(t,s)){r.rects={reference:gh(t,$d(s),"fixed"===r.options.strategy),popper:jd(s)},r.reset=!1,r.placement=r.options.placement,r.orderedModifiers.forEach((function(e){return r.modifiersData[e.name]=Object.assign({},e.data)}));for(var i=0;i<r.orderedModifiers.length;i++)if(!0!==r.reset){var n=r.orderedModifiers[i],o=n.fn,a=n.options,c=void 0===a?{}:a,h=n.name;"function"==typeof o&&(r=o({state:r,options:c,name:h,instance:d})||r)}else r.reset=!1,i=-1}}},update:(n=function(){return new Promise((function(e){d.forceUpdate(),e(r)}))},function(){return a||(a=new Promise((function(e){Promise.resolve().then((function(){a=void 0,e(n())}))}))),a}),destroy:function(){h(),l=!0}};if(!yh(e,t))return d;function h(){c.forEach((function(e){return e()})),c=[]}return d.setOptions(s).then((function(e){!l&&s.onFirstUpdate&&s.onFirstUpdate(e)})),d}}var vh=bh({defaultModifiers:[Gd,{name:"popperOffsets",enabled:!0,phase:"read",fn:function(e){var t=e.state,s=e.name;t.modifiersData[s]=rh({reference:t.rects.reference,element:t.rects.popper,strategy:"absolute",placement:t.placement})},data:{}},Vd,Cd,ph,dh,mh,qd,{name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:function(e){var t=e.state,s=e.name,i=t.rects.reference,n=t.rects.popper,o=t.modifiersData.preventOverflow,a=ch(t,{elementContext:"reference"}),r=ch(t,{altBoundary:!0}),c=hh(a,i),l=hh(r,n,o),d=uh(c),h=uh(l);t.modifiersData[s]={referenceClippingOffsets:c,popperEscapeOffsets:l,isReferenceHidden:d,hasPopperEscaped:h},t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-reference-hidden":d,"data-popper-escaped":h})}}]});function kh(e,t,s){if(!s)throw new Error("Must provide a positioning option");return"string"==typeof s?function(e,t,s){if(!t)throw new Error("Reference element is required for relative positioning");const i=vh(t,e,{placement:s,modifiers:[{name:"offset",options:{offset:[0,5]}}]});return()=>i.destroy()}(e,t,s):function(e,t){return e.style.position="fixed",Object.entries(t).forEach((([t,s])=>{e.style[t]=s})),()=>{}}(e,s)}const _h={hideOnClickOutside:!0,hideOnEmojiSelect:!0,hideOnEscape:!0,position:"auto",showCloseButton:!0};var xh="popupPicker_popupContainer__-DboI",Ch="popupPicker_closeButton__j1nuQ";class Eh{constructor(e,t){this.isOpen=!1,this.externalEvents=new sd,this.options=Object.assign(Object.assign({},function(e={}){return Object.assign(Object.assign(Object.assign({},_h),{rootElement:document.body}),e)}(t)),ac(e)),this.popupEl=document.createElement("div"),this.popupEl.classList.add(xh),this.popupEl.classList.add(this.options.theme),t.className&&this.popupEl.classList.add(t.className),this.options.showCloseButton&&(this.closeButton=document.createElement("button"),this.closeButton.classList.add(Ch),this.closeButton.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">\x3c!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --\x3e<path d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>',this.popupEl.appendChild(this.closeButton));const s=document.createElement("div");this.popupEl.appendChild(s),this.picker=cc(Object.assign(Object.assign({},this.options),{rootElement:s})),this.focusTrap=new br,this.picker.addEventListener("data:ready",(()=>{this.focusTrap.activate(this.picker.el),this.picker.setInitialFocus()})),this.options.hideOnEmojiSelect&&this.picker.addEventListener("emoji:select",(()=>{this.close()})),this.options.hideOnClickOutside&&(this.onDocumentClick=this.onDocumentClick.bind(this),document.addEventListener("click",this.onDocumentClick)),this.options.hideOnEscape&&(this.handleKeydown=this.handleKeydown.bind(this),this.popupEl.addEventListener("keydown",this.handleKeydown))}addEventListener(e,t){this.externalEvents.on(e,t),this.picker.addEventListener(e,t)}removeEventListener(e,t){this.externalEvents.off(e,t),this.picker.removeEventListener(e,t)}handleKeydown(e){"Escape"===e.key&&this.close()}destroy(){return td(this,void 0,void 0,(function*(){this.isOpen&&(yield this.close()),document.removeEventListener("click",this.onDocumentClick),this.picker.destroy(),this.externalEvents.removeAll()}))}toggle(){return this.isOpen?this.close():this.open()}open(){return td(this,void 0,void 0,(function*(){this.isOpen||(yield this.initiateOpenStateChange(!0),this.options.rootElement.appendChild(this.popupEl),this.setPosition(),this.picker.reset(),yield this.animatePopup(!0),yield this.animateCloseButton(!0),this.picker.setInitialFocus(),this.externalEvents.emit("picker:open"))}))}close(){var e,t;return td(this,void 0,void 0,(function*(){this.isOpen&&(yield this.initiateOpenStateChange(!1),yield this.animateCloseButton(!1),yield this.animatePopup(!1),this.popupEl.remove(),this.picker.reset(),null===(e=this.positionCleanup)||void 0===e||e.call(this),this.focusTrap.deactivate(),null===(t=this.options.triggerElement)||void 0===t||t.focus(),this.externalEvents.emit("picker:close"))}))}getRunningAnimations(){return this.picker.el.getAnimations().filter((e=>"running"===e.playState))}setPosition(){var e;null===(e=this.positionCleanup)||void 0===e||e.call(this),this.positionCleanup=kh(this.popupEl,this.options.referenceElement,this.options.position)}awaitPendingAnimations(){return Promise.all(this.getRunningAnimations().map((e=>e.finished)))}onDocumentClick(e){var t;const s=e.target,i=null===(t=this.options.triggerElement)||void 0===t?void 0:t.contains(s);!this.isOpen||this.picker.isPickerClick(e)||i||this.close()}animatePopup(e){return ha(this.picker.el,{opacity:[0,1],transform:["scale(0.9)","scale(1)"]},{duration:150,id:e?"show-picker":"hide-picker",easing:"ease-in-out",direction:e?"normal":"reverse",fill:"both"},this.options)}animateCloseButton(e){if(this.closeButton)return ha(this.closeButton,{opacity:[0,1]},{duration:25,id:e?"show-close":"hide-close",easing:"ease-in-out",direction:e?"normal":"reverse",fill:"both"},this.options)}initiateOpenStateChange(e){return td(this,void 0,void 0,(function*(){this.isOpen=e,yield this.awaitPendingAnimations()}))}}const Sh=10,Th='[role="icon"]';class Ah{#we;constructor(e){this.#we=e}set title(e){this.#we.querySelector(".title").innerText=e}set desc(e){this.#we.querySelector(".ns").innerText=e}set icon(e){const t=this.#we.querySelector(Th),s=t.className.split(" ").slice(0,-1);s.push(e),t.className=s.join(" ")}set avatar(e){this.#we.querySelector(".avatar").src=e}set region(e){const t=this.#we.querySelector(".flag-icon");t.className="flag-icon",e&&t.classList.add(`flag-icon-${e}`)}set mode(e){this.#we.setAttribute("mode",e)}get icon(){const e=this.#we.querySelector(Th);return new class{#ye;constructor(e){this.#ye=e}set name(e){this.#ye.setAttribute("name",e)}set id(e){this.#ye.setAttribute("value",String.fromCodePoint(parseInt(e||"f111",16)))}set color(e){this.#ye.style.color=e||"inherit"}set region(e){this.#ye.querySelector(".flag-icon").className=`flag-icon flag-icon-${e}`}}(e)}set admin(e){const t=this.#we.querySelector('button[name="admin"]');t&&(e?dom.showElement(t):dom.hideElement(t))}get toolbar(){return this.#we.querySelector(".toolbar")}get right(){return this.#we.querySelector(".right")}set onclick(e){this.#we.onclick=e}get headline(){return this.#we.querySelector(".headline")}button(e){return this.#we.querySelector(`button[name="${e}"]`)}role(e){return this.#we.querySelector(`[role="${e}"]`)}q(e){return this.#we.querySelector(e)}}class Lh{constructor(e){this.target=e}get contentEditable(){return!!this.target.contentEditable}getPos(){if(this.contentEditable){this.target.focus();let e=document.getSelection().getRangeAt(0),t=e.cloneRange();return t.selectNodeContents(this.target),t.setEnd(e.endContainer,e.endOffset),t.toString().length}return this.target.selectionStart}setPos(e){if(this.contentEditable){this.target.focus();try{document.getSelection().collapse(this.target,e)}catch(e){}}else this.target.setSelectionRange(e,e)}}function jh(e,t,s="auto"){const i=new Eh({},{triggerElement:e,referenceElement:e,position:s,hideOnClickOutside:!1});i.addEventListener("picker:close",(()=>{const e=t.tagName&&["INPUT","TEXTAREA"].includes(t.tagName)?t:t.element,s=new Lh(e),i=s.getPos();s.setPos(i+1),e.focus(),delete document._popup})),i.addEventListener("picker:open",(()=>{document._popup=i})),i.addEventListener("emoji:select",(e=>{console.log("Emoji selected:",e.emoji),t.value+=e.emoji+" ";t.parent.lastElementChild.disabled=!1})),e.blur(),i.open()}function Ih(e,t){const s=/(http(s):\/\/.)[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g,i=/(drive:\/\/)([-_a-zA-Z0-9]{2,256})([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g;let n;const o=[];for(;null!=(n=s.exec(t));){const t=n[0];try{const s=new URL(t);if(/youtube.com/.test(s.hostname)){const t=s.searchParams.get("v");if(!t)continue;const i=dom.createElement("a","yt","w3-padding","noevents");i.dataset.id=t;const n=dom.createElement("img");n.src=`https://img.youtube.com/vi/${t}/hqdefault.jpg`,i.appendChild(n),e.appendChild(i);continue}let i=s.pathname;const[,n]=fileX.getFilename(i);n&&fileX.isImage(n)&&o.push(t)}catch(e){console.error("Failed to parse URL:",t)}}for(;null!=(n=i.exec(t));){const e=n[0];"image"==new URL(e).searchParams.get("type")&&o.push(e)}o.length>0&&async function(e,t){let s;for(let e=0;e<t.length;++e)if(s=t[e],s.startsWith("drive")){const[,i,n]=s.match(/drive:\/\/([^?]+)\?type=([a-z]+)/),o=await app.google.loadImage(i);o&&(t[e]=o)}const i=dom.renderTemplate("slideshow",t,"div margin-top");e.appendChild(i)}(e,o)}class Dh{#r;#be;#ve;#q=0;#ke;#_e;#xe="";#Ce;get results(){return this.#Ce}get resultsElement(){return this.#r.querySelector(".results")}getResult(e){return this.#Ce.get(e)}constructor(e,t){this.#r=e,this.#be=e.querySelector('a[name="more"]'),this.#ve=e.querySelector('a[name="less"]'),this.#ke=`search-${t}-results`,this.#_e=app.ds(t)}async search(e=new Set,...t){dom.hideElement(this.#ve),dom.hideElement(this.#be);const s=this.#r;this.clear(),s.classList.add("loading3");const i=await delayResolve(this.#_e.search(this.#xe,...t),1200);if(console.debug("Got results:",i),i&&i.length>0){i.local=e;const t=dom.renderTemplate(this.#ke,i);if(dom.insertBefore(t,s.lastElementChild),i.length>Sh){dom.showElement(this.#be);const e=Array.from(t.childNodes).slice(Sh);for(const t of e)dom.hideElement(t)}}return s.classList.remove("loading3"),this.#Ce=new Map(i.map((e=>[e.id,e]))),i}disableResult(e){const t=this.resultsElement.querySelector(`.item[data-id="${e}"]`);if(t){const e=t.querySelector(".actions");dom.removeElement(e),t.classList.add("italic","watermark")}return this.#Ce.get(e)}cloneResultElement(e,t,s=!1){let i,n=this.resultsElement.querySelector(`.item[data-id="${e}"]`);if(n){if(i=n.cloneNode(!0),t){let e=i.querySelector(".actions");dom.removeElement(e),e=dom.renderTemplate(t),i.appendChild(e)}if(s){const e=n.querySelector(".actions");dom.removeElement(e),n.classList.add("italic","watermark")}}return i}clear(){let e=this.resultsElement;e&&dom.removeElement(e),e=this.#r.querySelector(".input-area");const t=e.firstElementChild;t.value="",t.focus();e.lastElementChild.disabled=!0,dom.hideElement(this.#ve),dom.hideElement(this.#be),this.#q=0}showMore(){this.#q+=Sh;const e=this.resultsElement,t=Array.from(e.childNodes),s=t.slice(this.#q,this.#q+Sh);for(const e of s)dom.showElement(e);this.#q+Sh>=t.length&&dom.hideElement(this.#be),dom.showElement(this.#ve)}showLess(){const e=this.resultsElement,t=Array.from(e.childNodes).slice(this.#q,this.#q+Sh);for(const e of t)dom.hideElement(e);this.#q-=Sh,0==this.#q&&dom.hideElement(this.#ve),dom.showElement(this.#be)}onInput(e){const t=e.value;this.#xe=t}}class Mh{#r;#F;#Ee;#Se;#Te;constructor(e){this.#F=e.querySelector("progress"),this.#Ee=e.querySelector('[role="speed"]'),this.#Se=parseInt(e.dataset.size),this.#Te=Date.seconds(),this.#r=e,e.setAttribute("state","downloading")}progress(e){if(1==e){const e=this.#r.dataset.id;return void this.done(e)}this.#F.value=Math.floor(100*e);const t=Math.floor(this.#Se*e),s=Date.seconds()-this.#Te;this.#Ee.innerText=`${fileX.formatSize(t/s)}/s`}done(e){console.debug("On torrent done:",e),this.#F.value=100,this.#r.setAttribute("state","done")}}const Oh=Ql.string({name:"status",title:"Status"});Ql.name;class Ph extends UX.Page{get area(){return this.container}constructor(e,t){const s=t?dom.renderTemplate(t):dom.createElement("div","container-col","settings","fade","hidden");e.appendChild(s),super(s)}}Object.assign(Ph.prototype,UX.ListMixin);class Rh extends Ph{}class $h extends Ph{#Ae;constructor(e){super(e,"editor-add-code")}async load(){const e=this.querySelector('textarea[name="code"]');this.#Ae=await Zo.bind(e,"js",!0)}set value(e){this.#Ae.setValue(e||"")}get value(){return this.#Ae.getValue()}async onAction(e,t,s){}}class zh extends Ph{#Ce;constructor(e,t="scraper"){super(e,"editor-add-test");const s=this.querySelector(".results");this.#Ce=UX.List.createMixin(s)}async onAction(e,t,s){if(this.#Ce.clear(),t.domain)if(console.debug("Sending SCRAPER test request for domain:",t.domain,t.location||"/"),t.code){console.debug(t.code);try{let e="channel-feed",s=await ajax.post("/api/scrap/test",t);if(Array.isArray(s)||"object"==typeof s&&(s=s.data),console.debug("GOT result:",s.length),Array.isArray(s))for(const t of s)this.#Ce.addItemTemplate(e,t);else"string"==typeof s&&(result.innerHTML=dom.markdown(s))}catch(e){console.error("Test request failed:",e)}}else console.error("Test request without code!");else console.error("Test request without domain!")}}class Bh extends UX.ListPage{static kOptions={};static register(e,t,s){s&&(t.onAdd=s),Bh.kOptions[e]=t}static kPreview={};static preview(e,t){Bh.kPreview[e]=t}#Le;#je;#Ie={};#De;#Me;#Oe;#Pe;#Re;get id(){return"add"}get storageId(){return this.id+"-"+this.type}get dragOptions(){return{directory:!1,hover:!1,files:["image"]}}get excludeFromStack(){return!0}constructor(e="add-editor"){super(e),this.pages=new Map;let t=this.headerElement.querySelector('button[name="submit"]');const s=this.editorElement;this.#je=s.querySelector(".tabbar");const i=new Rh(this.area);this.addPage("main",i);const n=new Zl(i);n.onvalidchange=e=>t.disabled=!e,this.#Le=n}get inputSelector(){return"input:not([type=radio]),select,textarea,input[type=radio]:checked"}onFileDrop(e){this.#Le.onFileDrop(e)}onAction(e){switch(e){case"submit":this.onAddClicked(this.#Le.getData());break;case"cancel":app.cancelEditor()}}onEditorAction(e,t,s){switch(this.current){case"code":{const t=this.#Le.getData();this.#De.onAction(e,t,s)}break;case"test":{const t=this.#Le.getData();t.code=this.#De?this.#De.value:"",this.#Oe.onAction(e,t,s)}}}open(e,t,s){if(!s.reload&&this.type==t)return;if(!s.items){const e=Bh.kOptions[t];Array.isArray(e)?s.items=e:Object.assign(s,e)}console.log("ADD editor open",e,t),this.type=t;const{icon:i,desc:n,items:o,onAdd:a,info:r,onPreview:c}=s;let l=`${e.capitalizeFirstLetter()} ${t.toLowerCase()}`;"edit"==e&&(l+=` '${r.name}'`);const d=new Ah(this.headerElement);d.icon=i,d.title=l,d.desc=n||"no description";let h=r;if(!r){const e=this.storageId;h=localStorage.getItem(e)||void 0,h&&(h=JSON.parse(h))}this.#Le.load(o,h),this.#Pe=o.onAdd||a,this.#Re=c||function(){};const u=o.filter((e=>"edit"==e.type)),p=o.filter((e=>["test","preview"].includes(e.type)));if(0==u.length)dom.hideElement(this.#je);else{dom.showElement(this.#je),this.#Ie={};let e=this.#je.firstElementChild.nextElementSibling;for(;e;){const t=e;e=e.nextElementSibling,dom.removeElement(t)}for(const e of u)this.#$e(e.name),this.#Ie[e.name]=r?r[e.name]||"":e.val||"";for(const e of p)this.#$e(e.name)}this.#je.firstElementChild.classList.add("active"),this.switchTo("main")}async onTabChange(e,t){if(console.debug("On TAB change",e),!["main","preview","test"].includes(t)){const e=this.#De?this.#De.value:"// add code here\n";this.#Ie[t]=e}let s=!1;if("preview"==e){if(s=!0,!this.#Me){const e=new(0,Bh.kPreview[this.type])(this.area);e.updateSize(this.height),this.addPage("preview",e),this.#Me=e}const e=Object.values(this.#Ie)[0];this.#Me.loadFromCode(e)}else if("main"!=e)if("test"==e){if(!this.#Oe){const e=new zh(this.area);this.addPage("test",e),this.#Oe=e}}else{if(s=!0,!this.#De){const e=new $h(this.area);this.#De=e,await e.load(),this.addPage("code",e)}this.#De.current=e,this.#De.value=this.#Ie[e],e="code"}s?this.area.classList.add("max-height"):this.area.classList.remove("max-height"),this.switchTo(e)}onAddClicked(e){console.log("ADD CLICK",e),e.name&&(e.name=e.name.trim().replace(/\s+/g," "));const t=this.storageId;localStorage.setItem(t,JSON.stringify(e)),this.#Pe&&("main"!=this.current&&(this.#Ie[this.#De.current]=this.#De.value),Object.assign(e,this.#Ie),console.debug("ON Add:",e),this.#Pe(e))}#$e(e){const t=dom.createElement("span","tab");t.innerText=e,t.setAttribute("tab",e),this.#je.appendChild(t)}}async function Nh(e,t,s=!1,i=!1){let n,o="";if(s?n=t:(n=dom.createElement("span","article","md","nomargin","fade"),t&&(i?dom.insertBefore(n,t.lastElementChild):t.appendChild(n))),n.classList.add("loading3"),e.content)o=e.content;else{const s="string"==typeof e?e:e.id,i=app.ds("news");let a;try{a=await i.local.get(s),a&&a.content?o=a.content:(a=await delayResolve(i.remote.get(s),1200),o=a.content,await i.local.put(a))}catch(e){return console.error("Failed to load article"),t&&dom.removeElement(n),n.classList.remove("loading3"),null}}o=toMarkdown(o);const a=dom.markdown(o);return n.classList.remove("loading3"),s?n.innerHTML+=a:n.innerHTML=a,n}Object.assign(Bh.prototype,UX.PageControllerMixin),window.AddEditor=Bh;class Fh extends UX.ListPage{static id="find";static kAttributes={};static register(e,t){this.kAttributes[e]=t}#e;#ze;#xe="";#Be;#Ne=new Set;get excludeFromStack(){return!0}constructor(e){e||((e=dom.renderTemplate("editor-base",{},"div",["editor-header-grid","editor-find-toolbar"],"editor-find-base")).id="find-editor",dom.hideElement(e)),super(e),this.area.classList.add("cc","m2","results","list"),this.#Be=this.editorElement.querySelector('button[name="search"]')}set search(e){this.#Be.disabled=e}onAction(e,t,s){this.#Fe(e,s)}onEditorAction(e,t,s){if("search"===e)s.disabled=!0,this.#qe();else{const s=t.dataset.id,i=this.#ze.get(s);this.#e.onaction&&this.#e.onaction(e,i),t.classList.add("local")}}onClick(e,t){const s=t.dataset;if(console.log("Find editor click",e),"select"==this.#e.type)return void(s.selected="false"==s.selected);const i=this.#e.onclick;i&&i(t.dataset)}onInput(e,t){e.target;const s=e.value,i=s.length>=3;e.nextElementSibling.disabled=!i,1!=s.length&&this.filter(s),this.#xe=i?s:""}onKeyPress(e,t){"Enter"==t&&this.#xe.length>0&&this.#qe()}open(e,t={ds:e,mode:"ls"}){if(console.log("Opening FIND:",e),this.action==e&&!t.force&&this.#e&&t.mode==this.#e.mode&&t.type==this.#e.type)return;t.ds||(t.ds=e),t.mode||(t.mode="ls"),this.action=e;const s=new Ah(this.headerElement);s.title=t.title||`Find ${e}`,s.desc=t.desc||`Search database for ${e}`,s.icon.name=e;const i=t.type||"find";this.#Ue(i,s,!!t.add);const n=s.button("new");t.add?dom.showElement(n):dom.hideElement(n),this.clear(),this.#He(t)}async#He(e){const{local:t,remote:s,ds:i,cmd:n}=e;if(!e.result&&i&&(e.result=`find-${i}-item`),n?(this.area.setAttribute("group",i||t),this.area.setAttribute("cmd",n)):(this.area.removeAttribute("group"),this.area.removeAttribute("cmd")),this.#ze=null,this.#e=e,i)return this.#We(e);if(this.search=!s,!t)return;const o=await app.db.ls(t);if(0==o.length)return;qh(o,this.#Ne);const a=new Map;for(const e of o)a.set(e.id,e),this.#Ve(e);this.#ze=a}async#We({ds:e,result:t,results:s,mode:i,type:n}){if(this.search=!1,"string"==typeof e&&(e=app.ds(e)),"ls"===i){const i=await e.ls();let n,o;qh(i,this.#Ne);for(const a of i)o=a.ds||e.name,n=s&&s[o]||t,this.#Ve(a,n);this.#ze=new Map(i.map((e=>[e.id.toString(),e])))}}async#qe(){const e=this.#xe;console.log("Do search:",e);let t,{remote:s,index:i,local:n,table:o,ds:a}=this.#e;if(this.toggleLoading(),a){"string"==typeof a&&(a=app.ds(a));const e=Fh.kAttributes[a.name]||[];t=await delayResolve(a.search(this.#xe,e,i)),n&&(n=a)}else t=await delayResolve(o?this.#Xe(o,null,this.#xe):this.#Ge(s,i||"name",e.toLowerCase()));if(t){this.#ze||(this.#ze=new Map);const e=this.#ze,s=[];let i;for(const n of t)if(i=n.id.toString(),e.has(i)){const e=this.getItem(i);e&&dom.showElement(e)}else n.user&&(n.user=await app.loadContact(n.user)),n.remote=!0,s.push(n),e.set(i,n),this.#Ve(n,null,!0);if(n&&s.length>0){console.log("# Adding remote results",s);try{"string"==typeof n?await app.db.add(n,s,"add"):await n.put(s)}catch(e){console.error("Failed to add results into local db",e)}}}this.toggleLoading()}async#Ge(e,t,s){const i=s?await app.firebase.search(e,t,s):await app.firebase.ls(e);return i?Object.toArray(i):[]}async#Xe(e,t,s){let i;try{let t=`/api/search/${e}`;if(s){t+="?"+new URLSearchParams({what:s}).toString()}i=await ajax.get(t)}catch(e){console.error("Failed to query database")}return i}#Ve(e,t,s=!1){const{result:i,type:n,isselected:o,purge:a}=this.#e;e.id;t=t||i;const r=this.addItemTemplate(t,e,s);if(r.dataset.name=e.display||e.name,e.remote||r.classList.add("local"),"select"==n){const t=dom.createElement("i","fa","check","fa-circle","stroke","w3-text-blue");r.dataset.selected=!!o&&o(e),r.removeAttribute("cmd"),r.appendChild(t)}else if("cmd"==n);else if("rm"==n){const e=dom.createElement("button","icon","fa","display-hover");e.name="remove",e.title="Remove";const t=this.#e.ds,s=a?"purge":"rm";e.setAttribute("cmd",s+"-"+t),r.appendChild(e)}else{const t=dom.createElement("button","icon","fa","display-hover");t.name="add",t.title="Add",r.appendChild(t),e.remote||r.classList.add("local")}}#Ue(e,t,s=!1){const i=t.button("new");dom.showElement(i,s);const n=t.button("submit");dom.showElement(n,"select"==e)}#Fe(e,t){switch(e){case"new":case"add":return void app.executeCommand("add","new",this.action);case"submit":if(this.#e.ondone){const e=Array.from(this.getItems("selected","true")).map((e=>e.dataset.id)),t=e.map((e=>this.#ze.get(e)));this.#e.ondone(t);for(const t of e)this.#Ne.add(t)}break;case"select":return}app.cancelEditor()}}function qh(e,t){e.sort(((e,s)=>t.has(e.id)?-1:t.has(s)?1:0))}window.FindEditor=Fh;class Uh extends UX.PageController{static#oe={};static register(e,t=e.id){Uh.#oe[t]=e}#Ye=0;#Ke;#r;#Ze=[];#Je;#Qe;#et;#B;#tt;get currentEditor(){return this.#B}get loadingElement(){return document.getElementById("editor-loading")}get showHover(){return this.#Ke&&this.#Ke.hover}get container(){return this.#r}constructor(e="editor"){super();const t=document.getElementById(e);this.#r=t,t.onclick=e=>this.#st(e.target,{x:e.clientX,y:e.clientY}),t.oninput=e=>this.onInput(e.target,e.data),t.onkeyup=e=>{if("Enter"==e.key&&!e.shiftKey){e.preventDefault();const t=e.target,s=t.closest(".search-area");let i=!0;s&&(i=!Wh(s)),i&&this.onKeyPress(t,e.key)}},t.onkeydown=e=>{"Enter"!=e.key||e.shiftKey||e.preventDefault()},t.onchange=e=>this.onChange(e.target,e.target.value),this.#it()}registerMouseEvents(){document.onmousedown=e=>{const t=e.target;if(t.classList.contains("v-sash")){const s=t.previousElementSibling,i=t.classList.contains("reverse"),n=e.clientX,o=s.offsetWidth;document.body.style.cursor="e-resize";const a=e=>{const t=n-e.clientX,a=i?o+t:o-t;s.style.width=`${a}px`},r=e=>{document.documentElement.removeEventListener("mousemove",a,!1),document.documentElement.removeEventListener("mouseup",r,!1),document.body.style.cursor="default";const t=s.id;if(t){const e=parseInt(s.style.width);this.updateWidth(t,e)}};document.documentElement.addEventListener("mousemove",a,!1),document.documentElement.addEventListener("mouseup",r,!1)}}}onAction(e,t,s){const i=[];switch(e){case"send":{const e=s.closest(".input-area");if(e){s.disabled=!0;const t=e.firstElementChild;let n;t.hasAttribute("contenteditable")?(n=t.innerText,t.innerText=""):(n=t.value,t.value=""),n=n.trim(),s.inputValue=n,i.push(n)}}break;case"play":{const e="pause"==s.value?"play":"pause";s.value=e,s.title=e.capitalizeFirstLetter()}}const n=s.getAttribute("link");if(n){const[,...e]=n.split("/");return void app.openEditor(...e)}let o=s.getAttribute("cmd");if(/^cmd-/.test(e)&&(o=e.substr(4)),o&&this.#nt(o,t,s,...i))return;const a=this.currentEditor;if(!a)return;const r=a.headerElement;if(r&&r.contains(s))return void a.onAction(e,t,s);const c=a.sidebar;if(c&&c.container.contains(s))return void c.onAction(e,t,s);if(a.hasComments){if(s.closest("[comments]"))return void app.comments.onAction(s)}let l=t;switch(e){case"call":return void app.openEditor("video","call",t.dataset.id,{audio:!0,video:!1});case"emoji":{const e=function(e){return"INPUT"==e.tagName?e:new class{#ot;constructor(e){this.#ot=e}get element(){return this.#ot}get parent(){return this.#ot.parentElement}get value(){return this.#ot.innerText}set value(e){this.#ot.innerText=e}set oninput(e){return this.#ot.oninput=e}set onkeydown(e){this.#ot.onkeydown=e}focus(){this.#ot.focus()}}(e)}(s.parentElement.firstElementChild);jh(s,e,"top-end")}return;case"share":if(t.dataset.type)return void app.share(t.dataset.type,t.dataset.id);break;case"cancel":case"submit":"edit"==t.getAttribute("mode")&&(t.removeAttribute("mode"),l=t.querySelector('[role="edit"]'),dom.removeElement(l));break;case"remove":case"delete":dom.removeElement(t)}a.onEditorAction(e,t,s)}onClick(e,t){let s=this.currentEditor;if(!s)return;const i=s.sidebar;if(i&&i.container.contains(e))s=i;else{if(e.hasAttribute("contenteditable")||["INPUT","SELECT"].includes(e.tagName))return;if(s.hasComments){const t=e.closest("[comments]");if(t)return void app.comments.onClick(e,t)}}if(e.hasAttribute("expandable")){const t=e.closest("[data-id]");t&&(e=t)}let n,o,a;if(e.classList.contains("item")){e.removeAttribute("new"),e.classList.remove("new");const t=e.querySelector("[collapsable]");t&&t.classList.toggle("hidden"),e.hasAttribute("selected")?(a=!1,e.removeAttribute("selected")):(a=!0,e.setAttribute("selected","")),n=e.dataset.id;const i=e.closest("[group]");o=i?i.getAttribute("group"):null;let r=e.getAttribute("cmd");!r&&i&&(r=i.getAttribute("cmd")),r&&this.#nt(r,e),s.onClick(n,e,a,o)}else{const i=e.getAttribute("tab");if(i){if(!e.classList.contains("active")){const t=e.parentElement;let n=t.querySelector(".tab.active");n.classList.remove("active"),e.classList.add("active");const o=n.getAttribute("tab"),a=t.nextElementSibling;if("tab-area"==a.getAttribute("role")){let e;e=a.querySelector(`[page="${o}"]`),dom.hideElement(e),e=a.querySelector(`[page="${i}"]`),dom.showElement(e)}else s.onTabChange(i,o)}return}let n=e.getAttribute("cmd");if(n){const t=e.closest(".item");this.#nt(n,t,e)}s.onElementClick(e,t)}}onInput(e,t){Vh(e);const s=e.getAttribute("name"),i=this.currentEditor;let n,o=!1;if("INPUT"==e.tagName){const n=e.value.trim();if(t){if(n.isExpression())return e.setAttribute("exp",!0),e.setAttribute("_ph",e.placeholder),e.placeholder="expression",e.spellcheck=!1,e.value="",void(o=!0);o=e.hasAttribute("exp")}else""==n&&e.hasAttribute("exp")&&(e.placeholder=e.getAttribute("_ph"),e.removeAttribute("_ph"),e.removeAttribute("exp"));if("search"==s){const t=e.parentElement.lastElementChild,s=n.length>2;t.disabled=!s;return t.previousElementSibling.disabled=0==n.length,void(i&&i.onFilter(n,e))}}if(i)if("comment"!=s){if(!o){if(n=e.getAttribute("ds"),n){const t=app.ds(n);t&&(this.#tt=e,async function(e,t){e._items||(e._items=await t.ls());Xh(e,e._items)}(e,t))}n=e.getAttribute("_ac"),n&&(this.#tt=e,async function(e,t,s){const i=await t.loadAutocomplete(s);if(!i)return void t.onInput(e);Xh(e,i)}(e,i,n)),e.hasAttribute("contenteditable")&&(e.value=e.innerText)}i.onInput(e,t,o)}else{const t=e.innerText;e.parentElement.lastElementChild.disabled=!/.{2,2000}/.test(t.trim())}}onKeyPress(e,t){const s=this.currentEditor;if(s){if(s.hasComments){if(e.closest("[comments]"))return void app.comments.onKeyPress(e,t)}if("Enter"==t){let t=e.tagName.toLowerCase(),s=e.value;if(e.hasAttribute("contenteditable")?(s=e.innerText,t="input",e.innerText=""):e.value="",["input"].includes(t)){s=s.trim(),e.inputValue=s;if("comment"===e.getAttribute("name")){const t=e.parentElement,i=t.lastElementChild,n=i.getAttribute("cmd");if(n){const e=t.closest("[data-id]");e&&e.removeAttribute("selected"),this.#nt(n,e,i,s)}}}}s.onKeyPress(e,t)}}onChange(e,t){if("SELECT"!=e.tagName)return;Vh();const s=this.currentEditor;s&&s.onChange(e,t)}onElementClick(){}handleCommand(){}scrollTo(e){this.#Qe&&this.#Qe.scrollTo(e)}scrollBottom(){this.#Qe&&this.#Qe.scrollBottom()}switchTo(e){let t=this.currentEditor;if(t){if(this.current==e)return t;const s=this.loadingElement;t.hide(),dom.showElement(s),t=this.getPage(e),setTimeout((()=>{dom.hideElement(s),super.switchTo(e)}),800)}else t=super.switchTo(e);return t&&this.#at(t),t}addToStack(){const e=this.current;if(!e)return;this.currentPage.excludeFromStack||0!=this.#Ze.length&&this.#Ze[this.#Ze.length-1]==e||this.#Ze.push(e)}handleEvent(e){switch(e.stopPropagation(),e.preventDefault(),e.type){case"dragenter":return 0==this.#Ye++&&this.showHover&&this.#r.classList.add("hover"),e.target.classList.contains("dropzone")&&(console.debug("DROPZONE element enter"),e.target.classList.add("hover")),!1;case"dragleave":return 0==--this.#Ye&&this.#r.classList.remove("hover","error"),e.target.classList.contains("dropzone")&&(console.debug("DROPZONE element leave"),e.target.classList.remove("hover")),!1;case"drop":this.onDrop(e)}}addPage(e,t,s=!0){const i=super.addPage(e,t);s&&this.#r.appendChild(i.container)}open(e,t,...s){"string"!=typeof e&&(e=e.id),this.addToStack(e),this.#Ye=0;let i=this.switchTo(e);if(!i){const t=Uh.#oe[e];if(!t)throw console.error("Invalid editor:",e),new Error("Invalid editor "+e);let s;t.create&&(s=t.create()),i=new t(s),this.addPage(e,i),this.switchTo(e)}this.#Ke=i.dragOptions,console.log("EDITOR: open =>",e,t,"drag=",!!this.#Ke),this.#Ke?this.#rt():this.#ct(),i.open(t,...s)}back(){const e=this.#Ze.pop();console.log("Editor back",e),this.switchTo(e)}cancel(e){if(console.log("STACK: ",this.#Ze),0==this.#Ze.length)return;const t=this.#Ze[this.#Ze.length-1];this.switchTo(t)}notify(e,t="success"){const s=this.currentEditor;if(!s)return;const i=s.editorElement,n=dom.createElement("div","popup","top-right","w3-container","w3-padding","w3-round");n.setAttribute("value",t),n.innerHTML=e,i.appendChild(n),setTimeout((()=>dom.removeElement(n)),3e3)}async onDrop(e){const t=e.dataTransfer,s=(t.files,[...t.items].filter((e=>"file"===e.kind)).map((e=>e.getAsFileSystemHandle()))),i=[];for await(const e of s)if("directory"===e.kind)console.log(`Directory: ${e.name}`),await Hh(e,i);else{console.log(`File: ${e.name}`);const t=await e.getFile();i.push(t)}if(this.#Ye=0,this.#r.classList.remove("hover"),i.length>0){console.log("FILE TYPE:",i[0].type);const e=[],s=[],n=[];for(const t of i){const i=fileX.getExtension(t.name);fileX.isImage(i)?e.push(t):fileX.isMedia(i)?s.push(t):n.push(t)}0,s.length>0&&await app.importAudioFiles(s);const o=function(e,t){return t?Array.from(e).filter((e=>t.files.includes(e.type?fileX.getType(e.type):fileX.getTypeFromFilename(e.name)))):[]}(i,this.#Ke);o.length>0&&await this.currentPage.onFileDrop(o,t),console.log("EDITOR: emitting files drop event"),app.emit("filesdropped",i)}else{const e=t.getData("type"),s=this.currentPage.dragOptions;if(s.items&&!s.items.includes(e))return;let i=t.getData("data");if(i)i=JSON.parse(t.getData("data"));else{const s=t.getData("id");if(!s)return void console.error("No data assigned");const n=app.ds(e);if(!n)return void console.error("DataSource not exists:",e);i=await n.get(s)}this.currentPage.onDrop(i,e)}}#st(e,t){if(this.#tt){if(e==this.#tt)return;const t=this.#tt;if(this.#tt=null,e.classList.contains("autocomplete-item")){const s=e.querySelector("input"),i=s.value,n=s.dataset.id,o=e.parentElement,a=o.previousElementSibling;a.value=i,a.dataset.id=n,dom.removeElement(o);let r=this.currentEditor;return void(r&&r.onInput(t))}const s=t.nextElementSibling;s&&dom.removeElement(s)}if(!e.hasAttribute("contenteditable")&&!UX.List.handleClick(e))switch(e.tagName){case"A":if(e.classList.contains("yt"))app.player.playYoutube(e);else{const s=e.getAttribute("name");if(["next","prev"].includes(s)){const t=e.closest(".slideshow-container");if(t){const e=t.querySelectorAll("img");for(let i=0;i<e.length;++i){const n=e[i];if(dom.isHidden(n))continue;"prev"==s?--i<0&&(i=e.length-1):++i,i%=e.length;t.querySelector(".number").innerText=`${i+1} / ${e.length}`,dom.hideElement(n),dom.showElement(e[i]);break}return}}else if(["more","less"].includes(s)){const t=e.closest(".search-area");if(t){const s=t.querySelector(".results").firstElementChild.querySelectorAll(".item.hidden"),i=Array.from(s).slice(0,10);for(const e of i)dom.showElement(e);return void(i.length<10&&dom.hideElement(e))}}if(!this.currentEditor)break;const i=e.getAttribute("link");if(i&&i.startsWith("#")){const e=i.slice(1),t=(e.startsWith("/")?e.slice(1):e).replaceAll("/","-");app.executeCommand("open-page-wiki",t)}else this.onClick(e,t)}break;case"BUTTON":{let t=e.getAttribute("state");if(t){const s=t;switch(t){case"on":t="off";break;case"off":t="on"}e.setAttribute("state",t);const i=e.title;if(i){let n=i.lastIndexOf(t);-1!=n&&(e.title=i.slice(0,n)+s)}}switch(e.name){case"like":{const t=e.querySelector(".reaction");t&&dom.removeElement(t),e.disabled=!0}break;case"search":{const t=e.closest(".search-area");if(t&&Wh(t))return}break;case"clear":{const t=e.closest(".search-area");if(t){!function(e){const t=e.querySelector(".input-area");t.firstElementChild.value="";const s=t.lastElementChild;s.disabled=!0;let i=e.querySelector(".results");i&&dom.removeElement(i)}(t);let s=this.currentEditor;return void(s&&s.onFilter("",e))}}}let s=e.closest("[data-id]")||e.parentElement;switch(e.name){case"accept":{const t=e.nextElementSibling;e.disabled=!0,t.disabled=!0}break;case"reject":{const t=e.previousElementSibling;e.disabled=!0,t.disabled=!0}}this.onAction(e.name,s,e)}break;case"I":if(e.hasAttribute("tooltip")){const t=e.closest("button"),s=e.getAttribute("value");t.value=s;let i=t.closest("[container]")||t.parentElement;if("like"==t.name){t.disabled=!0;const s=e.parentElement;dom.removeElement(s)}this.onAction(t.name,i,t);break}default:this.onClick(e,t)}}#nt(e,t,s,...i){if(this.handleCommand(e,t,s))return!0;const[n,...o]=e.split("-");if(i.unshift(...o),s&&"play"===s.name){const e=s.getAttribute("state"),t="play"==e?"pause":"play";s.setAttribute("state",t),s.title=t.capitalizeFirstLetter(),i.push(e)}switch(n){case"copy":{const e=i.shift();if("code"===e){const e=s.previousElementSibling;if(e){const t=e.innerText;console.debug("Copied to clipboard:",t),navigator.clipboard.writeText(t),this.notify("Copied to cliboard")}}else console.error("Copy not implemented:",e)}break;case"find":return app.find(...i),!0;case"share":{const e=i.shift();let s;switch(e){case"channel":if(!t&&"channel"==this.#B.type){const e=this.#B.id;return app.share("channel",e),!0}break;case"post":case"article":if("channel"===this.#B.type)s=this.#B.current;else{const e=t.closest("[data-channel]");e&&(s=e.dataset.channel)}}const n=t.dataset.id;let o;s&&(o={channel:s}),app.share(e,n,o)}return!0;case"follow":if(!t&&"channel"==this.#B.type){let e=this.#B.follow;const t=this.#B.id,i=this.#B.type;return e?(console.log("Unsibscribing from channel:",t),e=!1):(console.log("Sibscribing from channel:",t),e=!0),s.value=e,s.title=e?"Unfollow":"Follow",app.executeCommand("follow","channel",i,t),!0}break;case"torrent":{const e=t.dataset.id,s=new Mh(t);app.downloadTorrent(e,s)}break;case"load":{const e=t,s=e.dataset.link,i=e.dataset.id;e.removeAttribute("cmd");const n=e.querySelector(".md");n&&Nh({id:i,link:s},n,!0)}break;default:if("pin"===n)dom.removeElement(s)}let a;if(t){let e,o=t;return a=o.dataset.id,a||(o=s.closest("[data-id]"),o&&(a=o.dataset.id)),o&&(e=Object.assign({},o.dataset)),app.executeCommand(n,...i,a,e),s&&this.#B.onAction(s.name||n,t,s),!0}return app.executeCommand(n,...i),!1}#at(e){this.#B=e,this.#Qe&&(this.#Qe.unregisterEvents(),this.#Qe=null),this.#et&&(this.#et.unregisterEvents(),this.#et=null);let t=e.editorElement.querySelector(".scrollable");t&&(this.#Qe=new UX.Scrollable(t),this.#Qe.registerEvents(),this.#Qe.onScrollY=(...e)=>this.#B.onScrollY(...e),this.#Qe.onHeightChange=(...e)=>this.#B.onResize(...e));const s=e.sidebarElement;s&&(t=s.querySelector(".scrollable"),this.#et=new UX.Scrollable(t),this.#et.registerEvents())}#rt(){this.#r.addEventListener("dragenter",this,!0),this.#r.addEventListener("dragleave",this,!0),this.#r.addEventListener("dragover",this,!0),this.#r.addEventListener("drop",this,!0)}#ct(){this.#r.removeEventListener("dragenter",this),this.#r.removeEventListener("dragleave",this)}#it(){this.addPage("add",new AddEditor),this.addPage("find",new Fh)}#lt(){this.#Je=new MutationObserver((e=>{let t=0,s=0;for(const i of e)t+=i.addedNodes,s+=i.removedNodes;console.debug("Editor node observer:",t,s)}))}#dt(e){const t=e.editorElement;t&&(console.debug("Editor adding MO for:",e.id),this.#Je.observe(t,{childList:!0}))}}async function Hh(e,t){const s=e.name;for await(const i of e.values())if("file"==i.kind){const[e,n]=fileX.getFilename(i.name),o={album:s};if(fileX.isMedia(n)){const t=e.match(/^([0-9]{1,2})([ -.]+)?(.*)/);t&&(o.title=t[3],o.track=parseInt(t[1]))}const a=await i.getFile();a.meta=o,t.push(a)}console.log("READING meta",t.map((e=>e.meta)))}async function Wh(e){const t=e.getAttribute("ds"),s=e.getAttribute("template"),i=e.querySelector(".input-area"),n=i.firstElementChild.value;i.lastElementChild.disabled=!0;let o=e.querySelector(".results");o&&dom.removeElement(o);const a=!1;if(app){const i=app.ds(t);if(i){e.classList.toggle("loading3");try{const t=await delayResolve(i.search(n),1200);o=dom.renderTemplate("search-area-results",t,"div",s),e.appendChild(o),a=!0}catch(o){}e.classList.toggle("loading3")}}return a}function Vh(e){for(var t=document.getElementsByClassName("autocomplete-items"),s=0;s<t.length;s++)dom.removeElement(t[s])}function Xh(e,t){var s,i,n,o=e.value;if(!o||0==t.length)return!1;let a,r,c;for((s=dom.createElement("div","autocomplete-items")).setAttribute("id",e.name+"autocomplete-list"),e.parentNode.appendChild(s),n=0;n<t.length;n++)if(c=null,"string"==typeof t[n]?(a=t[n].capitalizeFirstLetter(),r=t[n]):(a=t[n].display||t[n].name.capitalizeFirstLetter(),r=t[n].id||t[n].name,c=t[n].photo||t[n].avatar),a.substr(0,o.length).toUpperCase()==o.toUpperCase()){let e="";c&&(e+=`<img src="${c}" class="photo x24 w3-margin-right">`),e+=`<strong>${a.substr(0,o.length)}</strong>`,e+=a.substr(o.length),e+=`<input type='hidden' value='${a}' data-id='${r}'>`,(i=dom.createElement("div","noevents","autocomplete-item","row","ci","w3-padding-small")).innerHTML=e,s.appendChild(i)}}const Gh=["editor-header-avatar","editor-video-toolbar"];class Yh extends UX.Page{static id="video";#ht;#ut;#U;get excludeFromStack(){return!0}constructor(){const e=dom.renderTemplate("editor-base",{},"div",Gh,"editor-video-base");e.id="video-editor",e.classList.add("video-editor"),super(e),this.editorElement.classList.add("dark"),this.#ut=this.headerElement.querySelector(".ns"),app.on("answer",(e=>this.#pt("call"))),app.on("hangup",(e=>this.#pt("initial")))}async open(e,t,s={audio:!0,video:!0}){"string"==typeof t&&(t=await app.loadContact(t)),console.log("Account editor open:",e,t,s);const i=t.photo||app.defaultAvatar,n=new Ah(this.headerElement);n.title=t.display||t.name,n.desc="Ringing ...",n.avatar=i;switch(this.container.querySelector("#remote-video").style.background=`transparent url(${i}) no-repeat center center`,e){case"call":case"incomingcall":this.#pt("ringing")}}#pt(e){switch(this.container.setAttribute("state",e),this.#ht&&(clearInterval(this.#ht),this.#ht=null),e){case"ringing":break;case"call":this.#U=0,this.#ht=setInterval((()=>{var e,t,s;this.#ut.innerText=(e=++this.#U,((t=Math.floor(e/60))<10?"0"+t:t)+":"+((s=e%60)<10?"0"+s:s))}),1e3)}}#Fe(e,t){switch(e){case"hangup":app.hangup();break;case"answer":app.answer()}}}class Kh extends Uh{constructor(e="editor"){super(),this.#it(),app.on("timeupdate",(e=>this.#mt(e.detail)))}set dirty(e){this.currentPage.dirty=e}#it(){this.addPage("video",new Yh)}#mt(e){this.currentEditor.updateTimes(e)}static defaultSettings(){return{menu:{panel:{width}}}}}class Zh{#B="home";#gt;#r;get selected(){return this.#r.querySelector("button.selected")}get active(){return this.#B}constructor(e="navbar"){const t=document.getElementById(e);t.onclick=e=>{const t=e.target;if("BUTTON"!=t.tagName)return;const s=t.name;s&&this.switchTo(s,t)},this.#r=t,app.on("channelmsg",(e=>this.#ft("channel",e.detail))),app.on("chatmsg",(e=>this.#ft("contact",e.detail))),app.on("roommsg",(e=>this.#ft("contact",e.detail))),app.on("gamemsg",(e=>this.#ft("game",e.detail))),app.on("hangup",(e=>{e.detail.missed&&this.#ft("contact",data.detail)}))}e;item(e){return this.#r.querySelector(`button[name="${e}"]`)}addAction({id:e,icon:t}){const s=this.#r.querySelector(".actions"),i=dom.createElement("button","icon","item");i.title=e.capitalizeFirstLetter(),i.dataset.action=e.toLowerCase(),i.innerHTML=`<i class="fa ${t}"></i>`,s.appendChild(i)}show(){dom.showElement(this.#r)}hide(){dom.hideElement(this.#r)}switchTo(e,t){if(this.#B==e)return void(["home","task"].includes(e)||(this.#gt&&this.#gt.classList.toggle("selected"),this.toggle()));this.clearSelection(),this.select(e,t);const s=t.querySelector(".badge");s&&t.removeChild(s),this.onChange(e)}clearSelection(){if(this.#B){const e=this.selected;e&&e.classList.remove("selected"),this.#B=null}}select(e,t){t||(t=this.item(e)),this.#B=e,this.#gt=t,t.classList.add("selected")}onOpenEditor(e){this.#B!=e&&("home"==this.#B&&this.clearSelection(),["task","help"].includes(e)&&(this.clearSelection(),this.select(e)))}addNotification(e,t){const s=this.item(e);let i=s.querySelector(".badge"),n=0;if(i){const e=i.innerText;if("9+"==e)return;n=Number(e)}else i=document.createElement("div"),i.classList.add("badge"),s.appendChild(i);n++,i.innerText=n>9?"9+":`${n}`}onChange(){}toggle(){}#ft(e,t){this.selected&&e==this.selected.name||t.own||this.addNotification(e,t)}}class Jh extends UX.List{static#wt={};static register(e,t=e.id){Jh.#wt[t]=e}#r;#yt=new Map;#B=null;#bt;#vt;#kt;#I;#_t;#xe;#xt;#Ct=!0;#Et;set width(e){this.parentElement.style.width=e}constructor(e="sidebar"){const t="string"==typeof e?document.getElementById(e):e;super(t.querySelector(".scrollable")),this.#r=t,this.width=app.ui.sidebar.width,this.registerEvents(),this.registerClickHandlers();const s=t.querySelector(".head");this.#bt=s.querySelector("i.fa.icon"),this.#vt=s.querySelector(".title"),this.#kt=s.querySelector('input[name="filter"]'),this.#I=s.querySelector('button[name="add"]'),this.#_t=s.querySelector('button[name="import"]'),this.#xe=s.querySelector('button[name="search"]'),this.#I.onclick=()=>this.#St(),this.#xe.onclick=()=>this.#Tt(),this.#_t.onclick=()=>this.onAction("import",null,this.#_t),this.#xt=new Zh,this.#xt.onChange=e=>{switch(console.debug("SIDEBAR on nav change:",e),e){case"home":case"task":app.openEditor(e);break;default:this.open(e)}},this.#xt.toggle=()=>this.toggle(),this.#kt.oninput=e=>this.#At(e.target,e.data),this.area.ondragstart=e=>{const t=e.dataTransfer,s=e.target,i=s.dataset.id,n=s.parentElement.getAttribute("group");console.debug("Start draging",i,n),t.setData("type",n),t.setData("id",i)},app.on("timeupdate",(e=>this.#mt(e.detail)))}toggle(){this.#Ct=this.#r.classList.toggle("collapsed")}show(){dom.showElement(this.#r)}hide(){dom.hideElement(this.#r)}async open(e){if(this.#Ct&&this.toggle(),this.#B&&this.#B.type==e)return;this.#xt.active!=e&&this.#xt.switchTo(e);let t=this.#yt.get(e);t||(t=this.#Lt(e),await t.load()),this.#B&&this.#B.hide(),this.#B=t;const s=t.filter;s?(this.#kt.value=s,this.#jt(s)):this.#kt.value="";const i=t.title||e;this.#It(t),this.#Dt(i),t.show()}onClick(e,t,s){if(console.log("SIDEBAR on click",e),s&&"A"===s.tagName){const e=s.getAttribute("link");if(e){const[t,s,i]=e.slice(1).split("/");if("add"===s)app.add(t,i);return}}if(this.selectItem(e),t.classList.remove("missed"),this.#B){let s,i;const n=t.closest("[group]");if(n&&(s=n.getAttribute("group"),i=n.getAttribute("cmd")),i||(i=t.getAttribute("cmd")),i){const e=t.dataset.id;app.executeCommand(...i.split("-"),e)}this.#B.onClick(e,t,s)}}onAction(e,t,s){const i=s.getAttribute("cmd");if(i){const[e,...s]=i.split("-");if("find"===e)app.find(s[0]);else app.executeCommand(e,...s,t)}else this.#B&&this.#B.onAction(e,t,s)}onOpenEditor(e,t,s){switch(console.debug("SIDEBAR on editor open:",e,this.#B),this.#xt.onOpenEditor(e),e){case"contact":case"channel":this.selectItem(s);break;case"home":case"task":this.#Ct||this.toggle(),this.clearSelection()}}switchTo(e){return this.open(e)}load(e){}has(e){return this.#yt.has(e)}#Lt(e){const t=Jh.#wt[e];if(!t)throw console.error("Sidebar: unknown page",e),new Error("Invalid sidebar page:",e);const s=dom.createElement("div",`sb-${e}`,"fit","fade","hidden");s.dataset.type=e;const i=new t(s);return this.append(s),this.#yt.set(e,i),i}#Dt(e){const t=this.#B.icon;t?this.#bt.setAttribute("icon-id",t):this.#bt.removeAttribute("icon-id"),this.#vt.innerText=e.toUpperCase()}#It(e){const t=!!e.showFilter,s=!!e.showAdd,i=!!e.showSearch;t?dom.showElement(this.#kt):dom.hideElement(this.#kt),s?dom.showElement(this.#I):dom.hideElement(this.#I),i?dom.showElement(this.#xe):dom.hideElement(this.#xe);const n=e.showImport;this.#_t.title="Import",this.#_t.removeAttribute("cmd"),n?("string"==typeof n?this.#_t.title=n:"object"==typeof n&&(this.#_t.title=n.title,n.cmd&&this.#_t.setAttribute("cmd",n.cmd)),dom.showElement(this.#_t)):(this.#_t.title="Import",this.#_t.removeAttribute("cmd"),dom.hideElement(this.#_t))}#St(){this.#B&&app.executeCommand("add","new",this.#B.type)}#Tt(){this.#B&&app.find(this.#B.type)}#mt(e){this.#B&&this.#B.updateTimes(e)}#At(e,t){this.#Et||(this.#Et=setTimeout((()=>{if(!this.#B)return;const e=this.#kt.value.trim();this.#jt(e),this.#Et=null}),2e3))}#jt(e){const t=this.#B.querySelectorAll("[group]");e&&(this.#B.filter=e);for(const s of t){UX.List.createMixin(s).filter(e)}}static defaultSettings(){return{width:"260px"}}}Object.assign(Jh.prototype,UX.PageMixin);const Qh={interval:30,log:!1},eu=86400;class tu{#$=[];#Mt;#Ot;#Pt=!1;get interval(){return this.#Ot.interval}set interval(e){this.#Ot.interval=e}constructor(e=Qh){this.#Ot=Object.assign({},Qh,e)}setTimeout(e,t,s=!1,i=e,n=""){const o=this.createTask(t,n);return s&&(o.interval=e),this.push(i,o),this.#Pt||this.#Te(),o}suspend(){this.#Pt=!0,this.#Rt()}resume(){this.#Pt=!1,this.#$.length>0&&this.#Te()}reset(){console.debug("Runner RESET"),this.#Rt(),this.#$=[],this.#Pt=!1,this.#Te()}execute(){return this.#$t()}setInterval(e){const t=this.interval;if(e==t)return;const s=[],i=function(e){return Array.from(e.entries()).filter((e=>null!=e[1]&&e[1].size>0))}(this.#$);if(e<t){const n=Math.floor(t/e);for(const[e,t]of i)s[e*n]=t}else{let n,o=Math.floor(e/t);for(const[e,t]of i)n=Math.floor(e/o),s[n]=t}this.interval=e,this.#$=s,this.#zt()}createTask(...e){return tu.createTask(...e)}checkStop(){0==this.#$.length&&this.#Rt()}push(e,t){let s=Math.round(e/this.#Ot.interval);s>0&&--s;let i=this.#$[s];i?i.add(t):this.#$[s]=new Set([t]),t.queue=this.#$[s]}shift(){return this.#$.shift()}#Te(){if(this.#Mt)return;const e=this.interval;this.#Mt=setInterval((()=>this.execute()),1e3*e)}#Rt(){this.#Mt&&(clearInterval(this.#Mt),this.#Mt=void 0)}#zt(){this.#Pt||(console.debug("Runner restart:",this.interval),this.#Rt(),this.#Te())}#$t(){const e=this.#$.shift();if(e)for(const t of e)t.interval&&this.push(t.interval,t),t.execute(!1);this.checkStop()}static createTask(e,t){return{name:t,callback:e,cancel(){this.queue.delete(this)},execute(e=!0){return console.debug(Date.formatTimeDate(),"Task execute ...",this.name),e?(this.forced=!0,this.callback(this)):this.forced?void delete this.forced:this.callback(this)},skipNext(){this.forced=!0}}}}class su extends tu{#Bt;#Nt;constructor(e=[1800,600,60]){e.sort(((e,t)=>t-e)),super({interval:e[e.length-1]}),this.#Bt=e,this.#Nt=e.map((e=>0)),console.debug("Task runner:",this.#Bt)}setTimeout(e,...t){const s=this.#Bt;let i,n;for(let t=0;t<s.length-1;++t){const o=s[t];if(e>=o){let s=e/o;if(s-=Math.floor(s),s>.9||s<.1){i=o,n=t;break}}}if(i||(n=s.length-1,i=s[n]),1==++this.#Nt[n]){let e=!0;for(let t=n+1;t<this.#Nt.length;++t)if(this.#Nt[t]>0){e=!1;break}(e||i<this.interval)&&this.setInterval(i)}const o=super.setTimeout(e,...t);return o._index=n,o.cancel=()=>{o.queue.delete(o),o.interval=0;if(0==--this.#Nt[n])for(let e=n-1;e>=0;--e)if(this.#Nt[e]>0){this.setInterval(this.#Bt[e]);break}},o}async execute(){const e=this.shift();if(e){let t,s=[];for(const i of e)t=i.execute(!1),isPromise(t)?(s.push(t),t.then((()=>this.checkPush(i)))):this.checkPush(i);s.length>0&&await Promise.all(s)}this.checkStop()}checkPush(e){e.interval&&super.push(e.interval,e)}createDailyRunner(e=0,t=5,s=6,i=14){return new iu(this,e,t,s,i)}createDailyRunner2(e=0){return new nu(this,e)}}class iu{#Ft;#Nt=[];#Te;#qt;#Ut=1;#Mt=1;constructor(e,t,s,i,n){const o=Date.seconds(),[a,r]=ou(t,o);this.#Mt=s,console.log(Date.formatTimeDate(o),"Starting daily runner in",Math.floor(a/60),"mins"),this.#Te=e.setTimeout(eu,(()=>{this.#Ft=e.setTimeout(60*s,(()=>this.#$t()),!0)}),!0,a),this.#qt=e.setTimeout(eu,(()=>this.#Ft.cancel()),!0,r)}setInterval(e,t){const s=Math.ceil(e/this.#Mt)-1;console.debug("Setting interval:",e,s),this.#Nt[s]?this.#Nt[s].push(t):this.#Nt[s]=[t]}#$t(){const e=new Date;console.debug(e.formatTimeDate(),"Executing daily runner");const t=[];for(let e=0;e<this.#Nt.length;++e){if(this.#Ut%(e+1))continue;const s=this.#Nt[e];s&&t.push(...s)}++this.#Ut,t.length>0&&function(e){console.debug("TASK call:",e);const t=e.shift();"function"!=typeof t&&console.debug("###>> ",t);if(t(),e.length>0){const t=setInterval((()=>{e.shift()(),0==e.length&&clearInterval(t)}),2e3)}}(t)}}class nu{#Ht;#$=[];#Nt=[];#Wt=!1;#Vt;constructor(e,t){const[s,i,n]=function(e,t=Date.seconds()){const s=Math.floor(t/eu)*eu;let i=s+3600*(6-e),n=s+3600*(20-e),o=!1;t>=i?(i=i+eu-t,t<n?(o=!0,n-=t):n=i+50400):(i-=t,n-=t);return[i,n,o]}(t);e.setTimeout(eu,(()=>this.#Xt()),!0,s,"Daily start task"),e.setTimeout(eu,(()=>this.#Gt()),!0,i,"Daily stop task"),this.#Ht=e,console.debug("Daily runner",s,i,n),n&&this.#Xt()}setInterval(e,t,s=!1,i=""){this.#$.push({interval:e,cb:t}),this.#Wt&&this.#Yt(e,t,s,i)}#Xt(){this.#Vt=[...this.#$],this.#Wt=!0,console.debug("Starting tasks:",this.#Vt.length),this.#Ht.setTimeout(20,(e=>{const t=this.#Vt.shift();if(!t)return console.debug("Canceling start task"),void e.cancel();this.#Yt(t.interval,t.cb)}),!0,0,"Starter Task")}#Gt(){for(const e of this.#Nt)e.cancel();this.#Wt=!1,this.#Nt=[]}#Yt(e,t,s=!0,i=""){const n=s?0:Math.ceil(.2*e*Math.random());console.debug("START task delay",i,n);const o=this.#Ht.setTimeout(e,t,!0,n,i);this.#Nt.push(o)}}function ou(e,t=Date.seconds()){const s=Math.floor(t/eu)*eu;let i=s+3600*(6-e),n=s+3600*(20-e);return t>=i?t<n?(i=0,n-=t):(i=i+eu-t,n=i+50400):(i-=t,n-=t),[i,n]}const au={initEvents(){this.event=new EventTarget},on(e,t){this.event.addEventListener(e,t)},emit(e,t){this.event.dispatchEvent(new CustomEvent(e,{detail:t}))}};class ru extends UX.Page{static Editor=Kh;static Sidebar=Jh;static Commands={register(e,t){this[e]=t}};#Kt=!1;#Zt=!1;#Jt={};#Qt;#es;#ts;#Le={};#Ht=new su([1800,300,60]);#ss=new tu({interval:5,log:!0});#is;#et;#De;get runner(){return this.#Ht}get monitor(){return this.#ss}get sidebar(){return this.#et}get editor(){return this.#De}get expanded(){return!0}get ui(){return this.#Qt}get currentEditor(){return this.editor.currentEditor}get db(){return this.#es}get fs(){return this.#ts.root}get musicDirectory(){return this.#Jt?this.#Jt.music:null}get defaultAvatar(){return"/ui/svg/contact.svg"}get defaultRoom(){return"/ui/svg/contact-green.svg"}get recent(){return this._recent}get recentPath(){return"recent"}handleCommand(e,...t){const s=ru.Commands[e];return!!s&&(s(...t),!0)}isme(e){return!!e&&("string"==typeof e?e.isEmail()?e==this.email:e==this.uid:e.id==this.uid)}memberOf(){return!1}constructor(e="main"){super(e),window.app=this,this.event=new EventTarget,this._={};!function(e,t){if(null!==e)return e;if(t.matches)return"dark"}(localStorage.getItem("theme"),window.matchMedia("(prefers-color-scheme: dark)"));window.onbeforeunload=()=>this.unload(),document.onvisibilitychange=()=>document.hidden?this.onBlur():this.onFocus(),document.onclick=e=>{const t=e.target;if(document._popup&&document._popup.onDocumentClick(e),t.hasAttribute("expandable"))["A","CODE"].includes(t.tagName)||t.classList.toggle("expanded");else if("BUTTON"===t.tagName)if(t.closest("#titlebar"))return void this.onAction(t.name,t)},document.onchange=e=>{const t=e.target;if("SELECT"===t.tagName)if(t.hasAttribute("tab")){const e=t.parentElement.querySelector(`[data-tab="${t.value}"]`);dom.insertAfter(e,t)}},document.onmousedown=e=>{const t=e.target;if(t.classList.contains("v-sash")){const s=t.previousElementSibling,i=t.classList.contains("reverse"),n=e.clientX,o=s.offsetWidth;document.body.style.cursor="e-resize";const a=e=>{const t=n-e.clientX,a=i?o+t:o-t;s.style.width=`${a}px`},r=e=>{document.documentElement.removeEventListener("mousemove",a,!1),document.documentElement.removeEventListener("mouseup",r,!1),document.body.style.cursor="default";const t=s.id;if(t){const e=parseInt(s.style.width);this.updateWidth(t,e)}};document.documentElement.addEventListener("mousemove",a,!1),document.documentElement.addEventListener("mouseup",r,!1)}},document.oncopy=e=>{const t=e.target;if(t.hasAttribute("contenteditable"))return e.clipboardData.setData("text/plain",t.textContent.trim()),void e.preventDefault()},window.addEventListener("freeze",(e=>{console.debug("# On Hibernate !!!")}),{capture:!0}),window.addEventListener("resume",(e=>{console.debug("# On hibernate resume !!!")}),{capture:!0})}createDatabase(){return new Fo}async setupDatabase(){}async load(){try{this.#ts=await fs.init()}catch(e){console.error("Failed to initialize TMPFS",e)}const e=this.createDatabase();try{await e.init(),this.#es=e}catch(e){console.error("Failed to initialize IndexedDB",e)}await this.loadSettings(),this.#et=new Jh,this.#De=new Kh,this.#Zt=!0;try{await Notification.requestPermission(),this.#Kt=!0}catch(e){this.#Kt=!1}console.log("Notifications enabled?",this.#Kt),this.#ns(),this.player=new Vo,this.player.registerEvents()}unload(){console.log("Unloading app")}onFocus(){this.#Zt=!0,this.#ss.resume(),console.debug("# Resuming monitor"),this.#is?(clearTimeout(this.#is),this.#is=void 0):(this.runner.resume(),this.emit("idle",!1))}onBlur(){this.#Zt=!1,this.#ss.suspend(),console.debug("## Susspending monitor"),this.#is=setTimeout((()=>{this.#is=void 0,this.runner.suspend(),this.emit("idle",!0)}),12e4)}onHibernate(){this.db.updateHistory()}onResume(){}async setHomeDirectory(e){console.log("Setting home directory",e);const t=e.getDirectoryHandle("Pictures",{create:!0}),s=e.getDirectoryHandle("Music",{create:!0});return this.#Jt={root:e,images:t,music:s},this.#es.put("settings",{type:"storage",root:e})}getRootDirectory(e){return fs.directory(this.fs,e,{create:!0})}async getImagesDirectory(){return this.#Jt.images||(this.#Jt.images=await this.getRootDirectory("Images")),this.#Jt.images}async loadSettings(){const e=localStorage.getItem("ui");e?this.#Qt=JSON.parse(e):this.defaultSettings();const t=await this.db.ls("settings");for(const e of t){const t=e.type;if(delete e.type,"storage"===t)this.#Jt=e;else this.#Le[t]=e}console.log("SETTINGS loaded",t)}initUser(){}defaultSettings(){this.#Qt={sidebar:Jh.defaultSettings()},this.updateSettings()}setUserInfo(){const e=this.container.querySelectorAll('[role="username"]'),t=this.displayName;for(const s of e)s.innerText=t}updateSettings(){localStorage.setItem("ui",JSON.stringify(this.#Qt))}updateWidth(e,t){const s=this.#Qt[e];s?s.width=t:this.#Qt[e]={width:t},this.updateSettings()}updateSetting(e,t){const s=this.#Qt[e];s?Object.assign(s,t):this.#Qt[e]=t,this.updateSettings()}async startIdleDetecton(){if("granted"===await IdleDetector.requestPermission())try{const e=new IdleDetector;e.addEventListener("change",(()=>{const t=e.userState,s=e.screenState;console.log(`Idle change: ${t}, ${s}.`)})),await e.start({threshold:6e4,signal}),console.log("IdleDetector is active.")}catch(e){console.error(e.name,e.message)}else console.error("Idle detection permission denied.")}startLifecycle(e=!0){const t=new Date,s=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1);setTimeout((()=>{this.emit("datechange"),setInterval((()=>this.emit("datechange")),864e5)}),s-t),e&&this.#Ht.setTimeout(120,(()=>this.emit("timeupdate",Date.now())),!0)}openEditor(...e){this.onOpenEditor(...e),this.editor.open(...e)}cancelEditor(){this.editor.cancel()}onOpenEditor(e,...t){console.log("APP: Opening editor",e),["find","add","video"].includes(e)||this.sidebar.onOpenEditor(e,...t)}doOpenEditor(...e){this.editor.open(...e)}doSave(){console.log("Updating storage"),localStorage.setItem("objects",JSON.stringify([...this.objects]))}save(e=!1){e?this.doSave():this.saveTimeout||(console.log("APP: Starting save timer ..."),this.saveTimeout=setTimeout((()=>{this.doSave(),delete this.saveTimeout}),kSaveTimeout))}async add(e,t,s=!1){this.editor.notify(`'${e}' ${s?"updated":"added"}`),s||this.emit(`${e}add`,t)}startPushClient(){const e=`ws://${location.host}/push/ws`;console.log("HOST:",e);const t=new WebSocket(e);t.onopen=e=>{console.debug("WS PUSH TEST CONNECTION: connected"),t.send(JSON.stringify({method:"bind",user:this.uid}))},t.onmessage=e=>{const t=e.data,s=JSON.parse(t);console.debug("## PUSH received:",s);const[,i,n]=s.to.match(/\/topics\/(channel-)?(.+)/),o=s.data;if(i)return o.id=n,void this.onChannelPush(o);let a=o.msg;if(o.user&&o.user.startsWith("chat-")){const e=o.msg.match(/\[(.+)\]: (.+)/);if(!e)return void console.error("Message not matching room format:",o);const[,t,s]=e;o.room=o.user.slice(5),o.user=t,a=s}const r="json"==s.type||/^\{.*\}$/.test(a);o.msg=r?JSON.parse(a):a,this.onPush(o)},t.onclose=()=>{console.log("PUSH socket remote close")},t.onerror=e=>{console.error("PUSH socket error",e)}}getInfo(e,t){if("channel"===e){const e=ru.kVirtualChannels[t];if(e)return e}return this.db.get(e,t)}showNotification(e,t,s="warning",i=2e3){let n;if("editor"===e){n=document.getElementById("editor").querySelector('[role="popup-area"]')}if(!n)return;const o=dom.renderTemplate("popup-item",{msg:t});n.appendChild(o),setTimeout((()=>dom.removeElement(o)),i)}onAction(e,t){let s;(s=t.getAttribute("cmd"))&&this.executeCommand(...s.split("-"))}#ns(){}static kVirtualChannels={support:{id:"support",display:"Support",desc:"Get help from Support Team",icon:"f059"}};get virtualChannels(){return ru.kVirtualChannels}}Object.assign(ru.prototype,au),window.App=ru;class cu{#os;get name(){return this.#os}constructor(e){this.#os=e}ls(){}count(){}get(){}put(){}set(){}search(){}}class lu extends cu{ls(...e){return app.db.ls(this.name,...e)}lsByIndex(...e){return app.db.lsByIndex(this.name,...e)}lsByRange(...e){return app.db.lsByRange(this.name,...e)}count(){return app.db.count(this.name)}async get(e){const t=await app.db.get(this.name,e);return t&&t.content&&"string"!=typeof t.content&&(t.content=unzip(t.content)),t}async getByIndex(e,t){const s=await app.db.getByIndex(this.name,e,t);return s&&s.content&&"string"!=typeof s.content&&(s.content=unzip(s.content)),s}put(e){const t=Array.isArray(e)?e:[e];for(const e of t)e.content&&(e.content=zip(e.content));return app.db.put(this.name,e)}update(e,...t){const s=[e,...t];"object"==typeof e&&s.unshift(e.id);const i=s[1];return i&&i.content&&(i.content=zip(i.content)),app.db.update(this.name,...s)}rm(e){return app.db.rm(this.name,e)}}class du extends lu{#as;constructor(e,t){super(e),this.#as=t}async get(e){const t=await app.db.getByIndex(this.name,this.#as,e);return t&&t.content&&"string"!=typeof t.content&&(t.content=unzip(t.content)),t}}class hu extends cu{#rs;get path(){return`${this.#rs}/${this.name}`}constructor(e,t="/api"){super(e),this.#rs=t}async ls(e=0,t=50,s=0){const i=new URLSearchParams;i.set("offset",e),i.set("limit",t),s&&i.set("ts",s);return await ajax.get(`${this.path}?${i.toString()}`)||[]}async get(e){const t=await this.query(null,e);return t&&Array.isArray(t)?t.length>0?t[0]:null:t}query(e,t){let s=this.path;if(e&&(s+=`/${e}`),"object"==typeof t){s+=`?${new URLSearchParams(Object.entries(t)).toString()}`}else s+=`/${t.toString()}`;return ajax.get(s)}search(e,t,s=0,i=20){let n=`${this.#rs}/search/${this.name}?`;"string"==typeof e&&(e={what:e});const o=new URLSearchParams(e);return t&&t.length>0&&(t.push("id"),o.set("attr",t.join(","))),o.set("offset",s),o.set("limit",i),n+=o.toString(),ajax.get(n)}}class uu extends hu{put(e){return ajax.post(this.path,e)}rm(e){return ajax.delete(`${this.path}/${e}`)}}class pu extends hu{async ls(e,t){const s=await app.firebase.ls(this.name);if(!s)return null;const i=Object.toArray(s);for(const e of i)e.user=await app.loadContact(e.user);return i}get(e){return app.firebase.get(this.name,e)}async search(e,t,s){const i=await app.firebase.search(this.name,s,e.toLowerCase());return i?Object.toArray(i):null}set(...e){return app.firebase.set(...e)}}class mu extends cu{#cs;#ls;get local(){return this.#cs}get remote(){return this.#ls}constructor(e,t=e){super("string"==typeof e?e:e.name),this.#cs="string"==typeof e?new lu(e):e,this.#ls="string"==typeof t?new pu(t):t}ls(...e){return this.#cs.ls(...e)}count(){return this.#cs.count()}async get(e){let t=await this.#cs.get(e);if(!t&&(t=await this.#ls.get(e),t)){if("string"==typeof t){t={id:e,content:t}}else t.id=e,t.remote=!0;await this.#cs.put(t)}return t}async put(e,t=!1){const s=await this.#ls.put(e);s&&!Array.isArray(e)&&Object.assign(e,s),await this.#cs.put(e)}async search(...e){return await this.#ls.search(...e)}async pull(e){let t;return t=await this.#ls.ls(0,50,e),t.length>0&&await this.#cs.put(t),t}update(...e){return this.#cs.update(...e)}rm(e){return this.#cs.rm(e)}async purge(e){return await this.#ls.rm(e),this.#cs.rm(e)}}const gu=function(e){return class extends e{#ds;#Ot;get local(){return this.#ds||super.local}constructor(...e){const t={maxCacheSize:1e3,maxCacheTime:1728e5},s=e[e.length-1];"object"==typeof s&&"Object"==s.constructor.name&&(e.pop(),Object.assign(t,s)),super(...e),this.#Ot=t}async ls(...e){if(!this.#ds){this.#ds=new CacheMap(this.#Ot);let t=await super.ls(...e);if(t)for(const e of t)this.#ds.set(e.id,e)}return this.#ds.values()}async get(e){await this.ls();let t=this.#ds.get(e);return t||(t=await super.get(e),t&&(t.id=t.id||e,this.#ds.set(e,t)),t)}put(e){if(this.#ds){e=Array.isArray(e)?e:[e];for(const t of e)this.#ds.set(t.id,t)}return super.put(e)}update(e,t,s={}){if(this.#ds){let i=this.#ds.get(e);i?Object.assign(i,t):this.#ds.set(e,Object.assign({id:e},s,t))}return super.update(e,t,s)}}},fu=gu(mu),wu=gu(lu);gu(du);class yu extends mu{get path(){return this.remote.path}constructor(e,t=e,...s){super(e,"string"==typeof t?new hu(t,...s):t)}async ls(){let e=await this.local.ls();return 0==e.length&&(e=await this.remote.ls(),e.length>0&&await this.local.put(e)),e}async rm(e){await this.remote.rm(e),await this.local.rm(e)}}class bu extends cu{#hs;#us;get fb(){return this.#us}constructor(e){super(e),this.#hs=new hu(e),this.#us=new pu(e)}ls(...e){return this.#us.ls(...e)}get(...e){return this.#us.get(...e)}put(...e){return this.#hs.put(...e)}search(...e){return this.#hs.search(...e)}rm(e){return this.#hs.rm(e)}}class vu extends cu{#ps;constructor(...e){super(e.map((e=>e.name)).join("-")),this.#ps=[...e]}async ls(){let e=[];for(const t of this.#ps){const s=await t.ls(),i=t.name;for(const t of s)e.push({...t,ds:i})}return e}}class ku{#_e;#kt;constructor(e,t=(e=>!0)){this.#_e=e,this.#kt=t}get name(){return this.#_e.name}get(...e){return this.#_e.get(...e)}put(...e){return this.#_e.put(...e)}update(...e){return this.#_e.update(...e)}async ls(...e){return(await this.#_e.ls(...e)).filter(this.#kt)}async search(...e){const t=await this.#_e.search(...e);return t?t.filter(this.#kt):null}}const _u=new lu("update");class xu extends yu{#m;#ms;constructor(e,t=e){super(e,t),this.#ms="string"==typeof e?e:e.name}async ls(e=0,t=50){const s=Date.now();let i,n=!1;if(this.#m?s-this.#m>7200&&(n=!0):n=!0,n){this.#m=s;const n=await _u.get(this.#ms);if(n){const s=n.ts;i=await this.remote.ls(e,t,s),i.length>0&&await this.local.put(i)}await _u.put({id:this.#ms,ts:s})}return i=await super.ls(),0==i.length&&(i=await this.remote.ls(),i.length>0&&this.local.put(i)),i}}const Cu={support:{topic:"Support channel room"}};const Eu={cache:new class{async get(e,t){let s=await app.db.getByIndex("cache","uid",[t,e]);return s&&(s.content=function(e){const t=unzip(e);return/^[{\[](.*)[}\]]$/.test(t)?JSON.parse(t):t}(s.content)),s}async load(e,t,s=3600){const i=Date.seconds();let n,o=await this.get(e,t);if(o&&o.expire>i)return o.content;if("channel"===e)n=`/channel/${t}`;else n=`/api/content/${e}/${t}`;const a=await ajax.fetch(n,{cache:"reload"});if(a){const n=function(e){const t="string"==typeof e?e:JSON.stringify(e);return zip(t)}(a);await app.db.put("cache",{id:t,type:e,content:n,expire:i+s})}else console.error("Failed to pull content:",e,t);return a}delete(e,t){return app.db.rm("cache",t)}update(e,t,s){return"string"==typeof s&&(s=zip(s)),app.db.updateByIndex("cache","uid",[t,e],{content:s},{id:t,type:e})}},initUser(){const e=new fu(new Ru("contact"),"user"),t=new mu(new wu("channel"),new bu("channel")),s=new yu("news"),i=new Lu,n=new ju,o=new ku(e,(e=>!this.isme(e.id))),a=new ku(t,(e=>this.sudo?"blog"==e.type:this.isme(e.user)));this._.contacts=o,this._.channel=t,this._.room=i,this.domains=new fu("domain"),this.scrapers=new yu("scraper"),this._.task=new xu("task"),this._.post=n,this._.article=s,this._.latest=new CacheMap({maxCacheSize:500}),this._.recent=new lu("recent"),this._.share=new vu(o,i),this._.sharex=new vu(o,i,a),this._.torrent=new Pu,this._.comment=new Iu,this._.pin=new lu("pin"),this._.channelnews=new ku(t,(e=>"news"==e.type)),this._.channeladm=a,this._.wiki=new Mu("wiki"),this._.radio=new mu("radio",new bu("radio")),this.initUserGames(),this.initUserPlayer()},initUserGames(){this._.game=new Du(this.cache),this._.games=function(e,...t){class s extends e{async ls(...e){const t=await super.ls(...e);return await app.loadContacts(t),t}async lsByIndex(...e){const t=await super.lsByIndex(...e);return await app.loadContacts(t),t}async lsByRange(...e){const t=await super.lsByRange(...e);return await app.loadContacts(t),t}async get(e){const t=await super.get(e);return t&&await app.loadContact(t),t}async getByIndex(...e){const t=await super.getByIndex(...e);return t&&await app.loadContact(t),t}}return new s(...t)}(lu,"games")},initUserPlayer(){this._.playlist=new lu("playlist")},addDS(e,t){this._[t||e.name]=e},ds(e,t=!1){let s;switch(e){case"scraper":s=this.scrapers;break;case"news":s=this._.article;break;default:s=this._[e]}return t?new Au(s):s},dsFilter(e,t){const s="string"==typeof e?this.ds(e):e;return new ku(s,t)},async updateProfileOld({name:e,photo:t,status:s}){let i=this.displayName,n=this.avatar;const o=this.email;try{e?i=e:e=i,t?(n=await this.firebase.uploadPhoto(t),t=n):t=n;const a={name:e,photo:t,email:o,username:e.toLowerCase()};s&&(a.status=s);const r=`/user/${app.uid}`;await this.firebase.update(r,a),await this.firebase.updateProfile({displayName:i,photoURL:n}),this.emit("profile",{photo:t,name:e})}catch(e){return console.error("Failed to update profile:",e),!1}return!0},getContacts(){return this._.contacts},async loadContact(e){if(e==this.uid)return{id:e,photo:this.avatar,name:this.displayName};const t=this.ds("contact");let s;return"object"==typeof e?(s=await t.get(e.user),Object.assign(e,{name:s.name,photo:s.photo||app.defaultAvatar,user:s})):s=await t.get(e),s.photo=s.photo||app.defaultAvatar,s},async loadContacts(e){const t={};for(const s of e)if("string"==typeof s){const e=await this.loadContact(s);t[e.id]=e}else await this.loadContact(s);return t},async loadRoom(e){let t;if(!t){const s=this.ds("room");if(t=await s.get(e),!t)throw console.error("Ignorring message from unknown room",e),new Error("Message from unknown user!")}return t},async loadChannel(e){const t=this.ds("channel");let s;if("object"==typeof e){const i=e.channel||e.id;s=await t.get(i),e.channel?e.channel=s:Object.assign(e,s)}else s=await t.get(e);return s},async loadChannels(e){if(e){const t={};for(const s of e){const e=await this.loadChannel(s);t[s]=e}return t}const t=this.ds("channel");return e=await t.ls(),Object.fromArray(e)},async createChannel(e){let t,s=e.display||e.name;s=s.trim().replace(/[ \t]+/," "),e.owner=app.uid,"private"==e.access?delete e.name:(e.name=s,e.index=`${e.type}${e.region}`);{const s=await ajax.post("/api/channel",e);t=s.id,s.key&&(e.key=s.key)}return e.admin=!0,t},async loadContent(e){let t,s,i;if(e.startsWith("/")){const[n,o]=e.split("?");if([s,i]=n.slice(1).split("/"),t=await this.db.get(s,i),!t){const e=this.ds(s);if(!e)return void console.error("Unknown DataSource:",s);if(t=await e.get(i),!t)return void console.error("Not found",s,i)}if(o){const e=new URLSearchParams(o);Object.assign(t,Object.fromEntries(e))}t.channel&&"string"==typeof t.channel&&(t.channel=await this.loadChannel(t.channel)),t.user&&"string"==typeof t.user&&(t.user=await this.loadContact(t.user))}return[t,s]},userKey:(e,t=16)=>Uint8Array.from(e.toByteArray().slice(0,t)),share(e,t,s){const i={title:"Share",desc:"Share files, contacts and torrents",ds:"share",results:{contact:"find-contact-item",room:"find-room-item"},mode:"ls",type:"select",force:!0,ondone:async i=>{console.log("Sharing",e,"with",i);const n={_type:e};if("object"==typeof t)s&&Object.assign(t,s);else{let i;if("room"==e)i=this.ds("room"),t=await i.get(t);else{let i=`${e}://${t}`;s&&(i+="?"+new URLSearchParams(Object.entries(s)).toString()),n.url=i}}switch(e){case"torrent":case"playlist":n.info=await this.createTorrentFromPlaylist(t);break;default:n.url||Object.assign(n,function(e,t){if("post"===t)return{id:e.id,channel:e.channel};return e}(t,e))}console.log("Sharing",e,"with",i);for(const e of i){const t="string"==typeof e?e:e.id;switch(e.ds){case"room":await this.sendRoomMessage(t,n);break;case"channel":await Tu(t,n.info,this._.latest);break;default:await this.sendMessage(t,n)}}}};switch(e){case"article":case"item":i.ds="sharex",i.results.channel="find-channel-item"}this.openEditor("find","contact",i)},find(e){let t;switch(e){case"contact":t={index:"username",local:!0,onaction(e,t){if("add"===e)app.add("contact",t)}};break;case"channel":t={desc:"Search, add or remove public channels",add:!0,onaction(e,t){if("add"===e)app.add("channel",t,"import")}};break;case"game":t={desc:"Search for games",add:!0,onaction(e,t){if("add"===e)app.add("game",t,"import")}};break;case"scraper":t={index:"name",type:"cmd",onclick:(e,t)=>app.executeCommand("edit",null,"scraper",e)};break;case"radio":t={desc:"Listen online radio"}}t.mode="ls",t.ds||(t.ds=e),this.openEditor("find",e,t)},async subscribe(e){try{await ajax.post(`/api/subscribe/${e}`,{}),await app.db.update("channel",e,{follow:!0})}catch(t){console.error("Failed to subscribe for channel:",e)}},registerGameHandler(e){e?(this.event.removeEventListener("gamemsg",Su),this.event.addEventListener("gamemsg",e)):this.event.addEventListener("gamemsg",Su)},async importAudioFiles(e){const t=[];for(const s of e){const e=s.name.hashCode(),i=await app.db.get("audio",e);if(i){s.meta=i.meta;continue}const n=s.meta||await fileX.getMeta(s),o=fileX.getExtension(s.name),a={id:e,type:fileX.isVideo(o)?"video":"audio",file:s};console.log("# Importing file:",s.name),a.rating=0,a.meta=n,a.album=n.album?n.album.toLowerCase().hashCode():0,await app.db.put("audio",a),t.push(a)}app.emit("audioadd",t)}};async function Su(e){}async function Tu(e,t,s){let i,n=t;if("string"==typeof t){const[e,o]=t.split("?"),[,a]=o.split("=");if(i=s.get(t),!i)return void console.error("Failed to create post",n)}else i=t,n=i.link;const o=await toMarkdown(i,"article"),a=Date.seconds(),r=`data/channel/${e}`,c={content:o,user:app.uid,ts:a,likes:{l:0,s:0,o:0,u:0},replies:{count:0},link:n};return app.firebase.push(r,c)}class Au{#_e;#ds=new Map;constructor(e){this.#_e=e}async get(e){let t=this.#ds.get(e);return t||(t=await this.#_e.get(e),this.#ds.set(e,t)),t}async ls(){const e=await this.#_e.ls();return this.#ds=new Map(e.map((e=>[e.id,e]))),e}}class Lu extends wu{constructor(){super("room")}get(e){let t=Cu[e];return t?Object.assign({id:e,name:e.capitalizeFirstLetter()},t):super.get(e)}async ls(){return(await super.ls()).filter((e=>!["notify"].includes(e.id)))}}class ju extends lu{constructor(){super("post")}async get(e,t){let s=await super.get(e);if(s||(s=await app.firebase.value("data","channel",t,e),s&&(s.id=e,await super.put(s))),s.md||(s.md=s.content),!s.title){const e=fromMarkdown(s,"post");Object.assign(s,e)}return await app.loadChannel(s),s}}class Iu extends lu{constructor(){super("comment")}async ls(){const e=await super.ls();return this.#gs(e)}async lsByIndex(...e){const t=await super.lsByIndex(...e);return this.#gs(t)}async getByIndex(...e){const t=await super.getByIndex(...e);return t?this.#gs(t):t}async get(e){const t=await super.get(e);return t?this.#gs(t):t}async put(e,t=!1){if(app.isme(e.user)&&e.channel!=e.parent){const t={reply:e.id};await super.update(e.gid,t)}return super.put(e)}async#gs(e){const t=async function(e){await app.loadContact(e),await app.loadChannel(e),e.own=app.isme(e.user);const t=e.replies;if(t&&t.count>0){const e=[];let s;for(const i of t.recent)s=await app.loadContact(i),e.push(s);t.recent=e}else e.reply&&(e.replies={count:1,recent:[app.userinfo]});return e.canreply=function(){return this.level<2},e};if(!Array.isArray(e))return t(e);const s=new Map(e.map((e=>[e.id,e]))),i=app.ds("post",!0);for(const n of e){const e=n.gid;if(n.parent==n.channel){const t=await i.get(e);n.post=t}else{const e=n.gid;n.comment=s.get(e)}await t(n)}return e}}class Du extends yu{#ds;constructor(e){super("game"),this.#ds=e}async search(...e){const t=await this.local.ls(),s=new Set(t.map((e=>e.id))),i=await super.search(...e),n=[];for(const e of i)s.has(e.id)||(e.remote=!0,n.push(e));return n.length>0&&this.local.put(n),i}async put(e){return await super.put(e),this.#ds.update("game",e.id,e.content)}async get(e){let t;return t=await super.get(e),t.user=await app.loadContact(t.user),t}}class Mu extends mu{constructor(e){super(e,new bu(e))}async get(...e){const t=await super.get(...e);return t&&await this.#gs(t),t}async ls(...e){const t=await super.ls(...e);for(const e of t)await this.#gs(e);return t}async search(...e){const t=await super.search(...e);for(const e of t)await this.#gs(e);return t}async#gs(e){e.user&&(e.user=await app.loadContact(e.user))}}class Ou extends Mu{#ze=new Map;#as;constructor(e,t=(e=>e.name||e.title)){super(e),this.#as=t}async ls(...e){const t=await super.ls(...e);for(const e of t)this.#ze.set(e.id,this.#as(e));return t}async search(...e){const t=await super.search(...e);if(t.length>0){await this.addRemotes(t);for(const e of t)this.#ze.has(e.id)&&(e.local=!e.remote)}return t}addRemotes(e){const t=e.filter((e=>!this.#ze.has(e.id)));return t.map((e=>e.remote=!0)),this.local.put(t)}}class Pu extends Ou{constructor(){super("torrent")}async ls(...e){return(await super.ls(...e)).filter((e=>e.local))}async update(e,t){if(await super.update(e,t),"done"==t.state){const t=this.remote.fb,s=`data/${this.name}/${e}/${app.uid}`;await t.set(s,Date.seconds())}}}class Ru extends lu{ls(e=0,t=50){return super.lsByIndex("ts",null,e,t,!0)}}const $u={chat:[],channel:[],comment:[],post:[],player:[],game:[]},zu={async loadRecent(){const e=localStorage.getItem(this.recentPath),t=e?JSON.parse(e):$u,s=[];for(const e of s)e.channel&&(getPostInfo(e),"string"==typeof e.channel&&(e.channel=await this.loadChannel(e.channel)),e.link&&(e.id=e.link.hashCode().toString()));t.post=s;const i=Date.seconds(),n=await this.db.lsByRange("recent","latest",["chat",0],["chat",i],!0);for(const e of n)await this.loadContact(e);t.chat=n;const o=await async function(){app.ds("comment",!0);const e=await app.db.lsByRange("recent","latest",["comment",0],["comment",Date.seconds()],!0);let t,s=[];for(const i of e){t=i.channel;const e=await app.db.get("comment",i.id),n=await app.db.lsByIndex("comment","topic",[t,i.gid]);console.debug("Loaded childs:",n),e.childs=n,await Bu(i),await Bu(e);for(const e of n)await Bu(e);s.push(e)}return s}();t.comment=o;const a=t.game;for(const e of a)await this.loadContact(e);return this._recent=t,t},async addRecent(e,t){}};async function Bu(e){await app.loadContact(e),e.channel=await app.loadChannel(e.channel),e.canreply=function(){return!this.own&&this.level<2}}const Nu={async executeCommand(e,t,s,...i){const n=e.split("-");if(n.length>1){e=n.shift();t&&(s&&i.unshift(s),s=t),t=n.shift(),n.length>0&&(s&&i.unshift(s),s=n.shift()),i.unshift(...n)}const o=[e,t,s].filter((e=>!!e)).join("-");if(this.handleCommand(o,...i))return;if("edit"==e||"add"==e&&"new"==t){let n,o=!1;"edit"==e&&(n=s,s=t,t="update",o=!0);const a={};let r;if("profile"==s?a.info={name:app.displayName,status:app.status,photo:app.avatar}:i.length>0&&(r=i[0],"string"==typeof r&&(n=r)),n){let e=app.ds(s);if(e&&(r=await e.get(n),o&&"scraper"===s))if(!r.code&&(e=app.ds("code"),e)){console.debug("Pulling code from database");try{const t=(await e.get(n)).content;r.code="string"==typeof t?t:unzip(t)}catch(e){console.error("Scraper code not exists:",n)}}}return r&&(a.info=r),Object.assign(a,{async onAdd(i){if(n&&(i.id=n),"add"==e&&"task"===s)i.ts=Date.seconds();if(i.user=app.uid||"admin",await app.add(s,i,t),i.id){if("task"===s)return app.openEditor("support","task",i.id,!0);app.cancelEditor()}}}),o?(a.reload=!0,this.openEditor("add","edit",s,a)):this.openEditor(e,t,s,a)}let a=i.pop();switch(e){case"share":return this.share(s,a,...i);case"find":return this.find(s);case"add":return this.add(s,a);case"join":return a=s,s=t,console.debug("Joining",s,"=>",a),this.add(s,a,"import");case"help":if(console.log("Openning help editor"),"editor"===s){const e=this.editor.currentEditor;if(e){const t=e.type;return this.openEditor("wiki","wiki",t)}}return;case"task":return this.openEditor("support","task",s);case"player":switch(t){case"file":return this.player.playFile(s);case"radio":return this.player.playRadio(a,s)}case"import":{const e=this.ds(t),i=this.ds(s);if("torrent"==t&&a.startsWith("magnet:")){const{hash:e}=parseMagnetURI(a);a=e}const n=function(e,t){const s=e=>e;if("torrent"===e)if("playlist"===t)return e=>Object({id:e.id,genre:e.genre||"pop",display:e.title,name:e.title.toLowerCase(),tracks:e.files,torrent:e.uri});return s}(t,s);let o=await e.get(a);o=n(o),await i.put(o),app.emit(`${s}add`,o)}return;case"rm":{a=a||s,s=t;const e=this.ds(s);await e.rm(a),app.emit(`${s}rm`,a)}return;case"purge":{a=s,s=t;const e=this.ds(s);await e.purge(a),app.emit(`${s}rm`,a)}return;case"pin":{const e=await app.ds(s).get(a);if(e){const{id:t,channel:i,content:n,ts:o,user:a}=e;this.add("pin",{id:t,channel:i,content:n,ts:o,user:a,type:s})}}return;case"select":if("channel"===t)switch(s){case"scraper":{const e=`data/scraper/${a}/scrapers`,t=await app.firebase.ls(e)||{};console.debug("Scrapers for channel",a,t);const s={icon:"fa-scissors",title:"Edit scrapers",desc:"Add or remove channel scrapers",ds:"scraper",type:"select",force:!0,isselected:e=>!!t[e.id],ondone:async e=>{console.log("Channel scrapers:",e);const t={channel:a,scrapers:e.map((e=>e.id))};try{await ajax.post("/channel/scrapers",t),console.debug("Scrapers updated successfully")}catch(e){console.error("Failed to update scrapers")}}};app.openEditor("find","scraper",s)}break;case"admin":{const e={title:this.name,desc:"Add or remove channel admin users",ds:"contact",type:"select",force:!0,isselected:e=>!!this.admins&&this.admins[e.id],ondone:async e=>{console.log("Channel permision change",e),this.admins;try{const t={};for(const s of e)t[s]=!0;await app.db.update("channel",this.channel,{admins:t}),await app.firebase.update(this.adminPath,t),this.admins=t}catch(e){console.error("Failed to updates channel admins",e)}}};app.openEditor("find","channel-admin",e)}break;default:console.error("CMD: Invalid select channel:",s)}else console.error("CMD: Invalid select:",t);return;case"follow":if("channel"===t)console.log("CMD: Subcribing for channel:",a),app.subscribe(a);break;case"open":return this.openEditor(s,t,...i,a)}}};const Fu=SIP.Web.SimpleUser,qu=Config.messagetone||Config.sip.messagetone||"/ui/ogg/popsound.mp3";function Uu(e,...t){e("SIP",(new Date).toLocaleTimeString()+":",...t)}function Hu(...e){return Uu(console.log,...e)}function Wu(...e){return Uu(console.debug,...e)}class Vu{#fs;#Ot;#ws;#P="idle";#ys;#bs;#vs;#ks;#_s;get uri(){return this.ua.options.aor}get domain(){return this.#Ot.domain}constructor(e=!0){this.channels=new Set,this.audio=new Audio,this.#ks=e}get connected(){return this.ua.isConnected()}get registering(){return this.ua.registerRequested}get localView(){return document.getElementById("local-video")}get remoteView(){return document.getElementById("remote-video")}get remoteAudio(){return document.getElementById("remote-audio")}get canCall(){return this.#P="idle"}getURI(e){return`sip:${e}@${this.domain}`}async addAccount(e,t){const s=Config.sip.url||Config.sip.proxy||`ws://${location.host}/messenger/sip`,i=s.startsWith("/")?`${"http:"==location.protocol?"ws":"wss"}://${location.host}${s}`:s;this.#Ot=Object.assign({},{domain:"ftalk.net",registrationExpires:600,inactiveTimeout:60,userAgent:"ftalk-beta"},Config.sip),console.log("Adding account:",e,i);const n=this.localView,o=this.remoteView,a=(this.remoteAudio,new Fu(i,{delegate:this,aor:`sip:${e}`,media:{constraints:{audio:!0,video:!1},local:{video:n},remote:{video:o,audio:o}},userAgentOptions:{displayName:t,logLevel:"error",userAgentString:this.#Ot.userAgent,sessionDescriptionHandlerFactoryOptions:{iceGatheringTimeout:5e3,peerConnectionConfiguration:{iceServers:[,{urls:"stun:stun.l.google.com:19302"}],iceTransportPolicy:"all",rtcpMuxPolicy:"require"}}}}));this.ua=a,await this.#xs()}async offline(){Hu("Go offline"),await this.unregister(),await this.ua.disconnect()}register(){return this.#Cs()}unregister(){return this.ua.unregister()}async publish(e,t="presence"){this.#_s||(this.#_s=this.ua.publisher(this.uri,t));let s='<?xml version="1.0" encoding="UTF-8"?>';if("presence"===t)s+=function(e,t="presence"){const s=document.implementation.createDocument(null,null,null),i=s.createElement(t);function n(e,t){if(t._attr){const s=t._attr;for(const t of s)e.setAttribute(t[0],t[1]);delete t._attr}for(const[i,o]of Object.entries(t)){const t=s.createElement(i);if("object"==typeof o)n(t,o);else{const e=s.createTextNode(o);t.appendChild(e)}e.appendChild(t)}}n(i,e),s.appendChild(i);return(new XMLSerializer).serializeToString(s)}({tuple:{_attr:[["id","status"]],status:{basic:"open",im:"online"},...e}},t);return Wu("Sending PUBLISH:",s),await this.#Cs(),this.#_s.publish(s)}subscribe(e,t="presence"){const s=`sip:${e}@${this.#Ot.domain}`;return this.ua.subscribe(s,t)}onServerConnect(){Hu("Connected to server")}onServerDisconnect(){!function(...e){Uu(console.error,...e)}("Disconnected!!!")}onRegistered(){Hu("Registered"),this.#Es(),this.#ws||(this.#ws=!0,app.onStarted())}onUnregistered(){Hu("Unregistered"),this.#fs=null,app.onUnregister()}onNotify({request:e}){Wu("notification received:",e);new DOMParser;const t=e.body,s=e.from.uri.user;let i=function(e){const t=new DOMParser,s=t.parseFromString(e,"application/xml");function i(e){const t={};for(const s of e.childNodes)s.nodeType===Node.ELEMENT_NODE&&(s.childNodes.length>1||1===s.childNodes.length&&s.firstChild.nodeType===Node.ELEMENT_NODE?t[s.nodeName]=i(s):t[s.nodeName]=s.textContent.trim());return t}return i(s.documentElement)}(t);i.tuple&&app.onNotify(s,i.tuple)}onCallCreated(){console.log("Outgoing call"),this.#Ss()}onCallReceived(e){console.log("Incomming call ",e),this.#P="ringing",this.#Ss();const t=this.audio;t.src=Config.ringtone,t.loop=!0,t.play(),app.onIncomingCall(e)}onCallAnswered(){console.log("Call answer"),this.#P="incall",this.audio.pause(),app.onAnswer()}onCallHangup(e){console.log("On hangup"),dom.hideElement(this.localView);let t="ringing"==this.#P;this.#P="idle",this.#ys&&(this.#ys.stop(),this.#ys=null),this.#Es(),this.audio.pause(),app.onHangup(e,t)}onMessageReceived(e,t,s){let i;if(this.#Es(),i=s.Timestamp)e.ts=parseInt(i[0].raw);else if(i=s.Expires)e.ts=parseInt(i[0].raw)-864e5;else if(i=s.Date){const t=new Date(i[0].raw);e.ts=t.getTime()}if(/chat-/.test(e.user)){if(/^\*\*\* (.+)$/.test(t))return void console.log("Channel notification received:",t);const s=t.match(/\[(.+)\]:\s+(.+)/s);if(!s)return void console.error("Message not matching room format:",t);const[,i,n]=s,[,o]=e.user.match(/chat-([^@]+)/);e.user=i,e.room=o,t=n.trim()}/^\{.*\}$/.test(t)?(t=JSON.parse(t),!e.ts&&t.ts&&(e.ts=t.ts)):/^\[.*\]$/.test(t),"string"==typeof t&&(t=t.replaceAll("\\n","\n").trim()),e.tid=((e.user.hashCode()^e.ts)>>>0).toString(16),console.log("<=",e,t),app.onMessage(e,t)}playNotification(){if("idle"==this.#P){const e=this.audio;e.src=qu,e.loop=!1,e.play()}}async send(e,t,s=!0){console.log("=>",e,t),await this.#Cs(),this.#Es();const i=`sip:${e}`,n=[`Timestamp: ${Date.now()}`];if(s&&(n.push("X-push: 1"),"object"==typeof s))for(const[e,t]of Object.entries(s))n.push(`X-${e}: ${t}`);return console.debug("Messnger send:",n),this.ua.message(i,t,n)}sendMessage(e,t,s=!0){const i=`${e}@${this.domain}`;return"string"==typeof t&&(t=t.replace(/\n/g,"\\n")),console.debug("## Sending message:",t),this.send(i,t,s)}sendRoomMessage(e,t,s){const i=Config.sip.room,n=e.startsWith(i)?e:i+e;let o;return o="string"==typeof t?t.startsWith("#")?" "+t:t:JSON.stringify(t),this.sendMessage(n,o,s)}sendRoomCommand(e,t,...s){const i=Config.sip.room,n="#"+t+" "+s.join(" "),o=e.startsWith(i)?e:i+e;this.sendMessage(o,n,!1)}createChannel(e,t=!1){const[s,i]=function(e,t){return[`chat-${e}@${kDomain}`,"#join"]}(e);return this.channels.add(s),this.send(s,i)}lsChannel(e){const[t,s]=function(e){return[`chat-${e}@${kDomain}`,"#members"]}(e);return this.send(t,s)}room(e,t){const s=`chat-${e}@${this.#Ot.domain}`;return this.send(s,"#"+t)}joinChannel(e){return this.send(`chat-${e}@${this.#Ot.domainChannel}`,"#join")}call(e,t={audio:!0,video:"dummy",muted:!1}){if("idle"!=this.#P)return void console.error("Already in call!");this.#P="calling";const s=this.audio;s.src=Config.ringbacktone,s.loop=!0,s.play();const i=`sip:${e}@${this.#Ot.domain}`,n={constraints:t};console.log("Calling",i,t.muted),this.ua.muted=t.muted;const o=this.localView;dom.hideElement(o),this.ua.call(i,{sessionDescriptionHandlerOptions:n})}callTest(e,t={audio:!0,video:!0,muted:!1}){if("idle"!=this.#P)return void console.error("Already in call!");this.#P="calling";const s=this.audio;s.src="/ui/ogg/ringback-tone.ogg",s.loop=!0,s.play();const i=this.local;i&&(t.video?dom.hideElement(i):dom.showElement(i))}answer(){this.#P="incall",this.audio.pause(),this.ua.answer()}hangup(){const e=this.#P;switch(this.#P="idle",dom.hideElement(this.localView),this.audio.pause(),e){case"calling":case"incall":this.ua.hangup();break;default:this.ua.decline()}}async startVideo(){const e=await async function(){try{const e={video:!0,audio:!1};return await navigator.mediaDevices.getUserMedia(e)}catch(e){console.error("failed to get local screen",e)}}(),t=e.getVideoTracks()[0],s=this.#Ts();this.#bs=Xu(s,t),this.#vs=t,this.localView.srcObject=e;this.localView.classList.remove("hidden")}async stopVideo(){Xu(this.#Ts(),this.#bs),this.#vs.stop(),dom.hideElement(this.localView)}async startScreenSharing(){const e=await async function(){try{const e={video:{cursor:"always",mediaSource:"screen"},audio:!1};return await navigator.mediaDevices.getDisplayMedia(e)}catch(e){console.error("failed to get local screen",e)}}(),t=e.getVideoTracks()[0];if(t){const e=this.#Ts();console.log("replace camera track with screen track"),this.#ys=Xu(e,t),t.onended=()=>{console.log("Screen capture stopped"),Xu(e,this.#ys),this.#ys=null}}}async#xs(){await this.ua.connect(),this.registering||(Wu("Registering ...",this.#Ot.registrationExpires),await this.ua.register({expires:this.#Ot.registrationExpires})),this.#Es()}#Cs(){if(!this.connected)return this.#xs()}#Ss(){this.#fs&&clearTimeout(this.#fs)}#Es(){this.#ks&&(this.#Ss(),this.#fs=setTimeout((()=>this.offline()),1e3*this.#Ot.inactiveTimeout))}#Ts(){if(!this.ua.session)throw new Error("Session does not exist.");const e=this.ua.session.sessionDescriptionHandler.peerConnection;if(!e)throw new Error("Peer connection closed.");return e}#As(){try{const e=this.#Ts();for(const t of e.getSenders())t.track.stop()}catch(e){console.error("Peerconnection release:",e)}}}function Xu(e,t){if(!t)return;const s=e.getSenders().find((e=>e.track.kind===t.kind));if(!s)return void console.warn("failed to find sender");const i=s.track;return s.replaceTrack(t),i}const Gu={recentUpdaters:new Map,startMessenger(e=!0){const t=new Vu(!this.sudo&&e);t.addAccount(this.sipUri,this.displayName),this.messenger=t,this._.pushed=[],this._confirm=new Map,this._caller,this._video,document.getElementById("answer-btn").addEventListener("click",(function(){Ju(),app.answer()})),document.getElementById("reject-btn").addEventListener("click",(function(){Ju(),app.hangup()}))},inCall(){return!this.messenger.canCall},isInternalRoom:e=>["support"].includes(e),onStarted(){this.publish()},publish(){if(Config.sip.publish){const e={name:app.displayName,note:app.status||"No status"};app.photo&&(e.photo=encodeURIComponent(app.photo)),this.messenger.publish(e,"presence")}},async sendMessage(e,t,s=!1,i=!0){const n=this._confirm.get(e);n&&(n.cancel(),this._confirm.delete(e));const o=Yu(t);try{await this.messenger.sendMessage(e,o,i);const n=Date.seconds(),a="string"==typeof t?t:{...t},r={ts:n,own:!0,msg:t};switch(r.user=await this.loadContact(e),t._type){case"seed":case"push":case"comment":return;case"game":return r.id=`${e}@${t.id}`,r.type=t.id,void this.emit("gamemsg",r)}[r.short,r.shortHTML]=Ku(t,!0);let c=this.recentUpdaters.get(e);if(c||(c=new Zu(this.recentUpdaters,e,app.ds("contact"))),c.update(r.short,n),this.emit("chatmsg",r),this.addRecent("chat",r),s&&!t._type){const t={uid:e,own:!0,ts:n,msg:a,recent:1};this.db.addHistory(t)}}catch(e){throw console.error("APP: Failed to send message",e),e}},async sendRoomMessage(e,t,s=!1){const i=Yu(t),n=i.ts||Date.seconds(),o=this.ds("room");await this.messenger.sendRoomMessage(e,i,!0);const a={user:this.user,own:!0,room:e};if(a.room=await o.get(e),"object"==typeof t?Object.assign(a,t):a.msg=t,"seed"===a.type)return;[a.short,a.shortHTML]=Ku(t,!0);let r=this.recentUpdaters.get(e);if(r||(r=new Zu(this.recentUpdaters,e,o)),r.update(a.short,n),this.emit("chatmsg",a),this.addRecent("chat",a),s){const s={uid:e,msg:t,own:!0,ts:n,user:this.uid,recent:1};this.db.addHistory(s)}},async sendRoomInvite(e,t){const s=t.map((e=>this.messenger.getURI(e))),i=app.ds("room"),n=await i.get(e);n._type="info",await this.messenger.sendRoomCommand(e,"invite",...s),await this.messenger.sendRoomMessage(e,n,!1)},subscribeUserPresence(e){if(Config.sip.publish)return this.messenger.subscribe(e,"presence")},sendConfirm(e){this._confirm.delete(e);return console.debug("APP: Sending confirm"),this.messenger.sendMessage(e,{_type:"confirm"},!1)},async joinRoom(e,t=!0){if(this.isInternalRoom(e))return;const s=this.ds("room");if(s){const t=await s.get(e);t?t.join||await s.update(e,{join:!0}):(console.log("Room not exists"),await s.put({id:e,join:!0}))}t&&this.messenger.room(e,"join")},async leaveRoom(e){if(this.isInternalRoom(e))return;const t=this.ds("room");return await t.get(e)&&await t.update(e,{join:!1}),this.messenger.room(e,"leave")},onUnregister(){this._.pushed=[]},async onMessage(e,t,s=!1){if("confirm"==t._type)return console.debug("CONFIRM received:",e),void this.emit("confirm",{...e,...t});const i=e.ts||Date.now(),n=e.tid;if(console.debug("### TID",n,e.user,i),""==t)return void console.error("Ingoring empty message!");if(e.domain==Config.sip.internal)return this.handleInternalMessage(e,t);const o=!!e.room,a=e.user;if(o){const s=this.ds("room");if("info"==t._type){try{delete t._type,await s.update(e.room,t,t)}catch(t){console.error("Failed to update room info",e.room)}return}e.room=await s.get(e.room),"string"==typeof e.user&&(e.user=await this.loadContact(e.user))}else if(!e.name||!e.photo){let t;try{t=await this.loadContact(e.user)}catch(t){return void console.error("Cannot load contact information",e)}e.user=Object.assign({photo:app.defaultAvatar},t)}let r=!0,c=!(s||o),l="string"==typeof t?t:{...t},d={...e,own:!1,ts:Date.toSeconds(i)};if("string"==typeof t)d.text=t;else{let e=t.link||t.url;if(e){if(e.startsWith("/"));else{const s=new URL(e),i=s.protocol.slice(0,-1);let n=s.host||s.pathname.slice(2);isNaN(n)||(n=parseInt(n)),t._type=i,t.id=n;for(const[e,i]of s.searchParams)t[e]=i;const o=this.ds(i);if(o){const e=await o.get(n);e&&Object.assign(t,e)}}l=e}switch(d.msg=t,t.channel&&"string"==typeof t.channel&&(t.channel=await this.loadChannel(t.channel)),t.user&&"string"==typeof t.user&&(t.user=await this.loadContact(t.user)),t._type){case"game":return d.id=`${d.user.id}@${t.id}`,d.type=t.id,d.invite=!!t.params,this.handleGameMessage(d),void this.emit("gamemsg",d);case"room":await app.ds("room").update(t.id,{},{name:t.name,topic:t.topic,domain:t.domain||Config.sip.domain});case"contact":l=`${t._type}://${t.id}`;break;case"comment":c=!1,r=!1;break;case"task":case"wiki":c=!1;break;default:r=!1}d.md||(d.md=toMarkdown(t,t._type))}if(this.messenger.playNotification(),c){const t=e.user.id;let s=this._confirm.get(t);s||(s=this.runner.setTimeout(30,(()=>this.sendConfirm(t))),this._confirm.set(t,s))}if(r){const e={uid:a,own:!1,msg:l,ts:d.ts,recent:1};d.room&&(e.uid=d.room.id,e.user=d.user.id),this.db.addHistory(e)}if([d.short,d.shortHTML]=Ku(t,!1),"comment"===t._type)await this.comments.onComment(d);else this.emit("chatmsg",d)},handleInternalMessage(e,t){if("task"===t.type)this.task.update(t)},async onNotify(e,t){console.debug("App on notify",e,t),t.photo&&(t.photo=decodeURIComponent(t.photo)),t.status=t.note,delete t.note;try{const s=this.ds("contact");await s.update(e,t),t.id=e,this.emit("status",t)}catch(e){console.error("Failed to update user status",e)}},call(e,t={audio:!0,video:"dummy"}){this.messenger.canCall&&(this.emit("call",{id:e}),console.log("Calling contact",e),this.messenger.call(e,t),this.openEditor("video","call",e,t))},onIncomingCall(e){console.log("Icomming call:",e),this.emit("call",{id:e});const t=e.uri.user;this._caller=t,async function(e){!function(){if("granted"===Notification.permission){new Notification("Incoming Call",{body:"You have an incoming call..."}).onclick=function(){this.close(),window.parent.focus()}}}();const t=await app.loadContact(e),s=document.getElementById("notification-popup"),i=s.querySelector(".name"),n=s.querySelector(".avatar");i.innerText=t.name,n.src=t.photo||app.defaultAvatar,dom.showElement(s)}(t)},onHangup(e,t){console.log("APP: On hangup"),"video"==this.editor.current&&this.editor.cancel(),Ju(),this.emit("hangup",{user:e,missed:t})},onAnswer(){Ju(),this.emit("answer")},answer(){this.messenger.answer(),this.openEditor("video","incall",this._caller)},hangup(){try{this.messenger.hangup()}catch(e){this.emit("hangup")}},toggleCamera(){this._video?this.messenger.stopVideo():this.messenger.startVideo(),this._video=!this._video}};function Yu(e){let t=e;if("object"==typeof e)switch(e.type){case"torrent":{const t={...e},s={...e.info};return s.files=e.info.files.map((e=>Object({name:e.name,type:e.type,size:e.size}))),t.info=s,t}case"comment":{const{channel:e,id:s,gid:i,msg:n,ts:o,user:a,name:r,photo:c}=t;t={channel:e,id:s,gid:i,msg:n,ts:o,user:a,name:r,photo:c}}}return t}function Ku(e,t){let s;s="string"==typeof e?e.split("\n").slice(0,1).map((e=>e.replace(/^#{1,6}[ \t]+/,"").replace(/```(.+?)```/gs,"***code***"))).join("\n"):`**Share a ${e._type}**`,t&&(s="*you:* "+s);const i=dom.escapeTags(s).replace(/\*\*(.+?)\*\*/g,((e,t)=>`<b>${t}</b>`)).replace(/\*(.+?)\*/g,((e,t)=>`<i>${t}</i>`)).replaceAll("\n","<br>");return[s,dom.renderEmojis(i)]}App.Commands.register("send-chat-message",((e,t,s)=>{console.debug("Send user message ",t,e),s&&s.room?app.sendRoomMessage(t,e,!0):app.sendMessage(t,e,!0)}));class Zu{#Ls;#js;constructor(e,t,s){e.set(t,this),app.runner.setTimeout(120,(()=>{e.delete(t),this.#js&&s.update(t,{msg:this.#js,ts:this.#Ls})}))}update(e,t=Date.seconds()){this.#js=e,this.#Ls=t}}function Ju(){const e=document.getElementById("notification-popup");dom.hideElement(e)}var Qu=__webpack_require__(867);const ep="https://www.googleapis.com/drive/v3/files",tp="https://photoslibrary.googleapis.com",sp=Config.gapi?Config.gapi.key:Config.gapiKey,ip={async startGoogleAPI(){},google:{signOut(){this.token=null},async contacts(){const e=[];try{const t=await this.refreshToken();if(!t)throw new Error("GAPI: No access token");const s={authorization:`Bearer ${t}`,accept:"application/json"},i=await ajax.get("https://people.googleapis.com/v1/people/me/connections?personFields=names,emailAddresses,photos",s);if(i.connections)for(const t of i.connections){const s={};if(s.name=t.names[0].displayName,t.photos&&(s.photo=t.photos[0].url),t.emailAddresses){for(const e of t.emailAddresses)if(e.value.endsWith("gmail.com")){s.email=e.value;break}s.email?e.push(s):console.debug("GAPI skiping contact with non gmail address:",name)}else console.debug("GAPI skiping contact without email:",name)}}catch(e){console.error("GAPI Failed to load contacts:",e)}return e},async files(){try{const e=await gapi.client.drive.files.list({pageSize:10,fields:"files(id, name)"});console.debug("GAPI ls got result:",e)}catch(e){return void console.error("GAPI FAILED to list files",this.token,e)}},async upload(e,t,s,i){i||("function"==typeof t?i=t:"function"==typeof s&&(i=s)),e instanceof Blob?(t=e.type,e instanceof File&&(s=e.name)):(t=fileX.getMimeType(t),e=new Blob([e],{type:t}));const n=app.drivePublicDir,o={name:s,mimeType:t,parents:[n]};console.debug("DRIVE metadata",o);const a=await this.refreshToken();return t=fileX.getType(t),new Promise(((s,n)=>{var r=new FormData;r.append("metadata",new Blob([JSON.stringify(o)],{type:"application/json"})),r.append("file",e);var c=new XMLHttpRequest;c.open("post","https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart"),c.setRequestHeader("Authorization","Bearer "+a),c.responseType="json",c.onload=()=>{const e=c.response;if(e.error)return void n(e.error);console.log("### FILE uploaded successfully",e),i&&i(e);const o=`drive://${e.id}?type=${t}`;s(o)},c.send(r)}))},async getDirectoryId(e){const t=await this.refreshToken(),s=ep+"?q="+encodeURIComponent(`parents in 'root' and mimeType = 'application/vnd.google-apps.folder' and name ='${e}'`),i=await ajax.token(t).get(s),n=i.files.length>0?i.files[0].id:null;return console.debug("DRIVE PUBLIC DIR:",n),n},async refreshToken(e=Date.now()){if(this.token||(this.token={token:app.user.accessToken,expire:app.user.accessTokenExpire}),!this.token.token||this.token.expire<e){console.debug("GAPI: Requesting new access token");const e={};app.loggedIn&&(e.uid=app.uid),this.token=await ajax.post("/auth/refresh",e)}return console.debug("Token expires in:",Math.ceil((this.token.expire-e)/6e4),"min"),this.token.token},viewLink:e=>"https://drive.google.com/file/d/$id}/view",async loadImage(e,t=600){let s;const i=new URLSearchParams;i.set("fields","thumbnailLink"),i.set("key",sp);const n=ep+"/"+e+"?"+i.toString();console.debug("GAPI Image load request:",n);try{s=(await ajax.get(n)).thumbnailLink;const e=s.lastIndexOf("=");-1!=e&&(s=s.slice(0,e)),s+=`=s${t}`}catch(t){console.error("Failed to load image from Google Drive",e)}return s},async createAlbum(e,t=!0){try{const e=await this.refreshToken(),t=await ajax.token(e).post(tp+"/v1/albums",{album:{title:"sipme"}});console.debug("Album created",t)}catch(e){console.error("Failed to create Photo library album",e)}},async listAlbums(){let e;try{const t=await this.refreshToken();e=await ajax.token(t).get(tp+"/v1/albums"),console.debug("Albums",e)}catch(e){console.error("Failed to create Photo library album",e)}return e},async uploadPhoto(e){let t;try{const s=await this.refreshToken(),i={"Content-type":"application/octet-stream","X-Goog-Upload-Content-Type":e.type,"X-Goog-Upload-Protocol":"raw"},{post:n,post2:o,options:a}=ajax.token(s),r=await n("https://photoslibrary.googleapis.com/v1/uploads",e,i);console.debug("Image uploaded token:",r);const c=await n("https://photoslibrary.googleapis.com/v1/mediaItems:batchCreate",{newMediaItems:[{description:"item-description",simpleMediaItem:{fileName:e.name,uploadToken:r}}]});console.debug("Media item created:",c);const{mediaItem:l}=c.newMediaItemResults[0];t=l.productUrl}catch(e){console.error("Failed to upload image",e)}return t}}};const np=(e=>{var t={};return __webpack_require__.d(t,e),t})({initializeApp:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_app_js_97f2d8e8__.initializeApp});const op=(e=>{var t={};return __webpack_require__.d(t,e),t})({connectAuthEmulator:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_auth_js_2c88a4ff__.connectAuthEmulator,getAuth:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_auth_js_2c88a4ff__.getAuth,onAuthStateChanged:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_auth_js_2c88a4ff__.onAuthStateChanged,signInWithCustomToken:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_auth_js_2c88a4ff__.signInWithCustomToken,signOut:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_auth_js_2c88a4ff__.signOut,updateProfile:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_auth_js_2c88a4ff__.updateProfile});const ap=(e=>{var t={};return __webpack_require__.d(t,e),t})({connectDatabaseEmulator:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_database_js_4fdd5b49__.connectDatabaseEmulator});const rp=(e=>{var t={};return __webpack_require__.d(t,e),t})({connectStorageEmulator:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_storage_js_e5eea211__.connectStorageEmulator,getDownloadURL:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_storage_js_e5eea211__.getDownloadURL,getStorage:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_storage_js_e5eea211__.getStorage,ref:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_storage_js_e5eea211__.ref,uploadBytes:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_storage_js_e5eea211__.uploadBytes,uploadString:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_storage_js_e5eea211__.uploadString});const cp=(e=>{var t={};return __webpack_require__.d(t,e),t})({getMessaging:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_messaging_js_6c0776cf__.getMessaging,getToken:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_messaging_js_6c0776cf__.getToken,onMessage:()=>__WEBPACK_EXTERNAL_MODULE_https_www_gstatic_com_firebasejs_10_7_0_firebase_messaging_js_6c0776cf__.onMessage});class lp{#fs;#Is;#P="disconnected";#Ds=[];#Ms;get currentUser(){return this.auth.currentUser}get connected(){return"connected"==this.#P}get offline(){return"disconnected"==this.#P}constructor(){const e=Config.firebase,t=Config.firebase.emulator||!1,s=location.protocol.startsWith("https");if(!t&&!s)return void console.error("Failed to connect to firebase on not secured connection");const i=(0,np.initializeApp)(e),n=op.getAuth(i),o=rp.getStorage(i),a=cp.getMessaging();if(t){const e=location.hostname;console.log("Firebase: Using emulator =>",e),op.connectAuthEmulator(n,kEmulators.auth.url,{disableWarnings:!0}),ap.connectDatabaseEmulator(db,kEmulators.database.host,kEmulators.database.port),rp.connectStorageEmulator(o,kEmulators.storage.host,kEmulators.storage.port)}cp.onMessage(a,(e=>this.#ft(e))),this.auth=n,this.storage=o,this.messaging=a}async connect(e){return e=Array.isArray(e)?e[0]:e,op.signInWithCustomToken(this.auth,e)}onAuthStateChanged(...e){op.onAuthStateChanged(this.auth,...e)}signOut(){op.signOut(this.auth)}async uploadImage(e,t,s="png"){const{ref:i,uploadString:n,getDownloadURL:o}=rp,a=i(this.storage,e),r=await n(a,t,"data_url"),c=await o(r.ref);return console.log("Upload result",c),c}async uploadFile(e,t,s="png"){const{ref:i,uploadBytes:n,getDownloadURL:o}=rp;e+="/"+t.name;const a=i(this.storage,e),r="string"==typeof s?{contentType:fileX.getMimeType(s)}:s,c=await n(a,t,r),l=await o(c.ref);return console.log("Upload result",l),l}async uploadPhoto(e,t="png"){const s=`/photo/${app.uid}`,i=this.uploadImage(s,e,t);return URL.revokeObjectURL(e),i}async loadContacts(){var e=app.accessToken;console.debug("USING ACCESS TOKEN:",e);var t=new XMLHttpRequest;t.open("get","https://people.googleapis.com/v1/people/me/connections"),t.setRequestHeader("Authorization","Bearer "+e),t.responseType="json",t.onload=()=>{console.log("### CONTACTS loaded",t.response)},t.send()}updateProfile(e){return op.updateProfile(this.auth.currentUser,e)}getRegistrationToken(e){const t={vapidKey:Config.firebase.vapidKey};return e&&(t.serviceWorkerRegistration=e),cp.getToken(this.messaging,t)}#ft(e){console.debug("FCM message received"),app.onPushMessage(e)}}const dp={_pushMessages:new CacheMap({maxCacheTime:3e4}),async startFirebase(){const e=this.user.firebaseToken;try{if(console.debug("Connecting firebase: ",e),e){const t=new lp,s=await t.connect(e);console.debug("Firebase connected:",s),await async function(e){if("serviceWorker"in navigator){const t=`did-${app.uid}`;let s,i=localStorage.getItem(t);const n={scope:"/"},o="/sw.js?"+new URLSearchParams(Object.entries(Config.firebase)).toString(),a=await navigator.serviceWorker.register(o,n);a.installing?s=a.installing:a.waiting?s=a.waiting:a.active&&(s=a.active),i||async function(e,t,s){try{let i=await e.getRegistrationToken(t);console.log("Registration token:\n",i),await ajax.post("/api/register",{token:i}),localStorage.setItem(s,i)}catch(e){console.error("Failed to register device token")}}(e,a,t),navigator.serviceWorker.addEventListener("message",(function(e){app.onPushMessage(e.data)}))}}(t),this.firebase=t}}catch(e){console.error("Firebase failed to connect:",e)}},async onPushMessage(e){if(e.messageType)return void console.debug("Click notification skipped!");const{notification:t,data:s,messageId:i,fcmMessageId:n}=e;let{body:o,title:a}=t;console.debug("APP push received",e);const{user:r,room:c,type:l}=s;if("invite"===l)console.debug("PUSH incomming call"),this.messenger.register();else{const e={user:r};c&&(e.room=c),s.body&&(o=JSON.parse(s.body)),this.onMessage(e,o,!0)}}};const hp="contact",up="recent",pp="history",mp="room",gp="games",fp="audio",wp="task",yp="chat",bp="cache";class vp extends Fo{get version(){return 7}onUpgrade(e,t,s){switch(s){case 0:vp.addTable(e,"settings"),vp.addTable(e,up),vp.addTable(e,hp),vp.addTable(e,pp,!0),vp.addTable(e,mp),vp.addTable(e,fp),vp.addTable(e,"playlist"),vp.addTable(e,"torrent"),vp.addTable(e,"game"),vp.addTable(e,wp),vp.addTable(e,yp,!0),vp.addTable(e,gp),vp.addTable(e,bp),vp.addTable(e,"pin"),vp.addTable(e,"radio"),vp.addTable(e,"enum"),vp.addIndex(up,["_type","ts"],t,!1,"latest"),vp.addIndex(hp,"email",t,!0),vp.addIndex(hp,"ts",t),vp.addIndex(pp,"uid",t),vp.addIndex(fp,"rating",t),vp.addIndex(fp,"type",t),vp.addIndex(yp,"uid",t),vp.addIndex(yp,"ts",t),vp.addIndex(bp,["id","type"],t,!0,"uid"),vp.addIndex("pin","type",t),vp.addIndex(mp,"uid",t),vp.addIndex(gp,"type",t),vp.addIndex(gp,"user",t),vp.addIndex(gp,["type","ts"],t,!1,"recent");case 1:vp.addTable(e,"wiki");case 2:vp.addIndex(wp,["owner","time"],t,!0,"own"),vp.addIndex(wp,["reporter","time"],t,!0,"reported");case 3:vp.addIndex(wp,"time",t,!1,"created"),vp.addIndex(wp,"time",t,!1,"updated");case 4:vp.addIndex(wp,["owner","changetime"],t,!0,"ownu"),vp.addIndex(wp,["reporter","changetime"],t,!0,"reportedu");case 5:vp.addIndex(yp,["uid","ts"],t,!1,"user");case 6:vp.addIndex(yp,["ts","recent"],t,!1,"latest")}}}const kp="/api/ticket/",_p=["medium","low","high","critical"],xp=["minor","major","blocker","critical","trivial"],Cp=["new","assigned","closed"],Ep=60*Config.task.update,Sp=new yu("task",new uu("ticket"));class Tp{#Os=!1;#Nt=[];#Ps;#Rs;#$s;#zs;get components(){return this.#Rs}get milestones(){return this.#Ps}get severity(){return _p}get priority(){return xp}get status(){return Cp}constructor(){app.addDS(new Lp),app.addDS(new jp),app.addDS(this,"task")}async init(){const e=app.db;let t;t=await e.get("enum","component"),this.#Rs=t.value,t=await e.get("enum","milestone"),this.#Ps=t.value;const s=(new Date).toJSON(),i=[app.email,s],n=[app.email,"1985-05-03T00:00:00.000Z"],o=await app.db.lsByRange("task","ownu",n,i,!0,30),a=await app.db.lsByRange("task","reportedu",n,i,!0,30);new Set([...o.map((e=>e.id.toString())),...a.map((e=>e.id.toString()))]);let r;if(o.length>0&&(r=o[0].changetime),a.length>0&&(!r||r<a[0].changetime)&&(r=a[0].changetime),r){const e=await Sp.remote.query("updates",{time:r});if(console.debug("TASK updates",e.length),e.length>0){const t=Object.groupBy(e,(({ticket:e})=>e.toString()));let s,i,n;console.debug("###",t);for(const[e,o]of Object.entries(t)){n=parseInt(e),s=o.map((({ticket:e,...t})=>t)),i=s[s.length-1].time,await app.db.pushValue("task",n,"change",s);const t={changetime:i};for(const e of s)"comment"!=e.field&&(t[e.field]=e.newvalue);await app.db.update("task",n,t)}}}}async load(e=Ip){let t,s=localStorage.getItem("task_update");try{let i;t=await Sp.local.ls(),t.sort(((e,t)=>String.sort(t.time,e.time))),!s&&t.length>0&&(s=t[0].time),console.debug("TASK loaded:",t);for(const s of t.uniqueId())await Mp(s),i=e.add(s)}catch(e){console.error("Failed to load tasks",e)}return this.#Nt.push(e),app.runner.setTimeout(Ep,(async()=>{console.debug("TASK updater",s);try{const t=await Sp.remote.ls(0,20,s);if(t.length>0){let i;await Sp.local.put(t),s=t[t.length-1].time,localStorage.setItem("task_update",s);for(const s of t)await Mp(s),i=e.add(s,!0),i.classList.add("new"),dom.highlightElement(i);let n=`### ${t.length} new tickets\n`;for(const e of t)n+=`+ ${e.summary} (**${e.type}**)\n`;app.showNotification("editor",n,"info",1e4)}}catch(e){console.error("TASK failed to pull from remote")}}),!0,300),t}wrap(e,t="editor-taskboard-edit-task"){return Op(e),new Dp(e,t)}async update({id:e,data:t}){const s=app.ds("email"),i=document.querySelectorAll(`[task][data-id="${e}"]`);t.author=await s.get(t.author);for(const e of i)await zp(e,t),e.classList.add("new"),dom.moveTop(e),dom.highlightElement(e)}async updateOld({id:e,data:t}){let s;for(const i of this.#Nt){if(s=i.get(e),s)await zp(s,t.field,t.newvalue,t.author),i.handleUpdate&&(s=i.handleUpdate(e,t)||s);else{await $p(e,t);const n=app.ds("task"),o=await n.get(e);s=i.add(o)}s&&(s.classList.add("new"),dom.moveTop(s),dom.highlightElement(s))}}perm(e,t){return!(!app.sudo&&!app.isme(t.reporter))||"rm"!=e&&"comment"===e}static async setup(e){let t;t=await ajax.get("/api/ticketenum"),console.debug("TICKET enums",t);for(const e of t)"string"==typeof e.value&&(e.value=JSON.parse(e.value));await e.put("enum",t),t=await ajax.get("/api/ticket/own"),console.debug("Own tasks",t),t.length>0&&await e.put("task",t)}}class Ap{#Bs;#Ns;#as;#Fs;get name(){return"taskown"}constructor(e,t){this.#as=e,this.#Fs=t}async load(e){this.#Bs||(this.#Bs=new Date);let t,s=!0;const i=e.childCount(),n=Sp.local,o=Sp.remote,a=app.email;try{if(t=await n.lsByIndex(this.#as,[a,this.#Bs],!0,i,5),t.length>0&&(this.#Ns=t[t.length-1].time),t.length<5){const i={limit:5,user:this.#Fs};this.#Ns&&(i.time=this.#Ns),s=!1;const a=await o.query(null,i);let r;a.length>0&&(console.debug("GOT results",a),await n.put(a),t.push(...a),s=a.length>=5,this.#Ns=a[a.length-1].time);for(const s of t)await Mp(s),r=e.add(s),Op(r)}}catch(e){console.error("Failed to load own tasks:",e)}return s}}class Lp extends Ap{get name(){return"taskown"}constructor(){super("own","owner")}}class jp extends Ap{get name(){return"taskreported"}constructor(){super("reported","reporter")}}const Ip={add(){},get(){}};class Dp{#r;#ke;constructor(e,t){this.#r=e,this.#ke=t}async open(e){let t,s;try{t="object"==typeof e?e:await Sp.get(e);const i=app.email;if(t.reporter!=i&&t.owner!=i){const s=t.time,i=await Sp.remote.query(t.id,{time:s});i&&i.length>0&&(await app.db.pushValue("task",e,"change",i),t.change||(t.change=[]),t.change.push(...i))}await Mp(t),this.#r.innerHTML="",s=dom.renderTemplate(this.#ke,t),this.#r.appendChild(s)}catch(s){console.error("Failed to load task",s)}return t}}async function Mp(e){const t=app.ds("email");let s=await t.get(e.reporter);if(s&&(e.reporter=s),e.owner&&(s=await t.get(e.owner),s&&(e.owner=s)),e.change)for(const s of e.change)[s.label,s.text]=Rp(s.field,s.newvalue||s.value),s.author=await t.get(s.author)}function Op(e){e.onclick=e=>{const t=e.target;let s=!1;switch(t.tagName){case"BUTTON":s=function(e){let t=!0;const s=e.closest("[data-id]");switch(e.name){case"comment":{const t=function(e){const t=e.parentElement.firstElementChild,s=t.innerText.trim();return t.innerText="",s}(e);t&&async function(e,t){const s=e.dataset.id;console.debug("Adding ticket comment",s,t);const i={author:app.user,value:t,field:"comment",time:new Date};try{await zp(e,i)}catch(e){console.error("Failed to add comment",e)}}(s,t)}break;case"edit":{const t=e.parentElement,i=t.querySelector("textarea"),n=s.querySelector('button[name="submit"]');t.setAttribute("edit","");const o=MDE.wrap(i);o.codemirror.on("update",(e=>n.disabled=!1)),i.mde=o}break;case"submit":Pp(s,!0);break;case"cancel":Pp(s,!1);break;default:t=!1}return t}(t);break;case"A":s=function(e){const t=e.getAttribute("name"),s=e.closest("[data-id]");switch(t){case"assign":zp(s,"owner",app.email),zp(s,"status");break;case"unassign":case"close":zp(s,"status");break;default:return!1}return!0}(t)}s&&e.stopPropagation()},e.onchange=e=>{const t=e.target;let s=!1;switch(t.tagName){case"SELECT":!function(e){const t=e.name,s=e.value;let i=e.closest("[data-id]");zp(i,{field:t,value:s,time:new Date,author:app.user})}(t);case"TEXTAREA":s=!0}s&&e.stopPropagation()}}function Pp(e,t=!0){const s=e.querySelector("[edit]");if(s){s.removeAttribute("edit");const i=s.querySelector("textarea");if(i.mde&&(i.mde.toTextArea(),delete i.mde,t)){const t=i.value;console.debug("Description update:",t),zp(e,"description")}}e.querySelector('button[name="submit"]').disabled=!0}function Rp(e,t){return"comment"==e?["commented",t]:["updated "+e]}async function $p(e,t){t.author=app.email,await app.db.pushValue("task",e,"change",t);const s={};s[t.field]=t.newvalue,s.changetime=t.time||Date.now(),await app.db.update("task",e,s),app.emit("taskupdate",{id:e,data:t})}async function zp(e,t){const{field:s,value:i}=t,n=e.dataset.id;await async function(e,{field:t,value:s,author:i,time:n}){console.debug("Update ticket field",e,t,s),"object"==typeof i&&(i=i.id);const o={value:s,field:t,time:n};try{if(isNaN(e)||(e=parseInt(e)),app.isme(i)){const t=await ajax.post(kp+`update/${e}`,o);o.time=t.time}o.newvalue=s,delete o.value,await $p(e,o)}catch(e){console.error("Failed to add comment",e)}return o}(n,t),function(e,t,s){switch(t){case"description":!function(e,t){e.querySelector(".md").innerHTML=dom.markdown(t);Date.now();const s=e.querySelector("time");s.dataset.time=Date.seconds(),s.innerText="now"}(e,s);break;case"owner":!async function(e,t){if("string"==typeof t){const e=app.ds(t.isEmail()?"email":"contact");t=await e.get(t)}Bp(e,"owner",t||"")}(e,s);break;case"comment":break;default:Bp(e,t,s)}}(e,s,i);const o=e.querySelector('[role="updates"]');if(o){const e=UX.List.wrapGroup(o);[t.label,t.text]=Rp(s,i),e.add(t)}}function Bp(e,t,s){let i;if(i=e.querySelector(`[role="${t}"]`),i)if(["owner"].includes(t))i.innerHTML="",i.appendChild(dom.renderTemplate(`task-${t}`,s));else if("SELECT"===i.tagName)i.value=s;else i.innerText=s}const Np=[Ql.string({name:"summary",title:"Title"}),Ql.option({name:"type",options:["issue","task","improvement","feature"]}),Ql.option({name:"component",options:function(){return app.task.components}}),Ql.option({name:"milestone",options:function(){return app.task.milestones}}),Ql.option({name:"severity",options:_p}),Ql.option({name:"priority",options:xp}),Ql.text({name:"description",md:!0})];AddEditor.register("task",Np,(async e=>{console.debug("On add new task",e);try{e.description=e.description||"**todo**: *add description*",e.status="new",await Sp.put(e),e.time=e.changetime=Date.now(),app.openEditor("task","ticket",e),app.emit("taskadd",e)}catch(e){console.error("Failed to add new task",e)}}));const Fp={board:{title:"Task Board",desc:"Monitor project progress",icon:"tasks"},ticket:{title:"Ticket",desc:"Edit ticket content",icon:"tasks"}},qp=["editor-header-grid",null,"editor-taskboard-actions"],Up=["editor-scrollable","editor-taskboard-base"];class Hp extends UX.ListPage{static id="task";#B;#qs;#Us;#Hs=!1;#Os=!1;#R;#Ft;#Nt;set mode(e){this.#R=e,this.container.setAttribute("mode",e)}get current(){return this.#R}constructor(){super(dom.renderTemplate("editor-base",Fp.board,"div",qp,Up)),this.mode="board",this.area.classList.add("hide"),this.#Nt=new Wp(this);const e=this.querySelector('[view="edit"]');this.#Ft=app.task.wrap(e,"editor-taskboard-edit"),app.on("taskadd",(e=>this.#Ws(e.detail)))}async open(e,t,s=!1){if((e=e||"board")!=this.current){const t=new Ah(this.headerElement),{title:s,desc:i,icon:n}=Fp[e];t.title=s,t.desc=i,t.icon=n}if(t){let e;return this.mode="task",this.toggleLoading(),isNaN(t)||(t=parseInt(t)),e=await delayResolve(this.#Ft.open(t),1200),this.toggleLoading(),void(this.#B=e)}if(this.mode="board",this.#B&&(this.#B=null),"board"===e)this.#Os||(this.#Os=!0,this.#Vs())}onAction(e){if("reload"===e)return this.open(this.current,null,!0)}onInput(e){if(console.debug("Task editor on input",e.name),"mode"===e.name){const t=this.editorElement.querySelector('[view="main"]');t&&t.setAttribute("mode",e.value)}}#Xs(e){e.value.trim().length<5?(e.classList.add("error"),this.#Hs=!0,this.#qs.disabled=!0):(e.classList.remove("error"),this.#Hs=!1,this.#qs.disabled=!1)}#Ws(e){this.#Nt.add(e,!0)}#Gs({id:e,data:t}){if(!this.#B||this.#B.id!=e)return;let s=this.querySelector('[view="edit"]');s&&Task.update(s,t)}#Ys(e){const t=this.querySelector('[view="edit"]');t.innerHTML="";const s=dom.renderTemplate("editor-taskboard-edit",e);t.appendChild(s)}#Vs(){return app.task.load(this.#Nt,!1)}}class Wp{#Ks;#Zs;#Nt;#Js;#Qs;#ei;constructor(e){this.#Ks=e,this.#Zs=e.wrapGroup("issue"),this.#Nt=e.wrapGroup("task"),this.#Js=e.wrapGroup("enhancement"),this.#Qs=e.wrapGroup("assigned"),this.#ei=e.wrapGroup("closed")}add(e,t){return this.#ti(e.status,e.type).add(e,t)}get(e){return this.#Ks.getElement(e)}rm(e){let t=this.get(e);return dom.removeElement(t)}#ti(e,t){let s;switch(e){case"assigned":s=this.#Qs;break;case"closed":s=this.#ei;break;default:switch(t){case"task":s=this.#Nt;break;case"enhancement":s=this.#Js;break;default:s=this.#Zs}}return s}handleUpdate(e,t){const{field:s,newvalue:i}=t;if("status"==s){const t=this.rm(e);if(t){this.#ti(i).insertTop(t)}}}}const Vp=["editor-scrollable","editor-welcome-content"];class Xp extends UX.ListPage{static id="welcome";#zs;#si;#Os=!1;#Nt;#ii;#ni;#oi;#ai;#ri;#ci={};#li=[];constructor(){let e;super(dom.renderTemplate("editor-base",{},"div","editor-welcome-header",Vp)),this.#Nt=this.wrapGroup("task"),this.#ii=this.wrapGroup("chat"),this.#ni=this.wrapGroup("chat","editor-room-item"),e=this.querySelector('[role="game"]'),this.#ai=this.wrapGroup(e),e=this.querySelector('[role="track"]'),this.#ri=this.wrapGroup(e),app.on("chatmsg",(e=>{const t=!this.#li.length;this.#li.push(e.detail),t&&this.#ft(e.detail)})),app.on("trackchange",(e=>this.#di(e.detail))),app.on("trackstop",(e=>this.#hi(e.detail))),app.on("taskadd",(e=>this.#ui(e.detail))),app.on("gamemove",(e=>this.#pi(e.detail))),app.on("gameover",(e=>this.#mi(e.detail)))}async load(){let e;console.debug("Welcome editor on load");try{this.loadGroups(),e=await app.game.load();for(const t of e)this.#ai.add(t)}catch(e){console.error("Failed to load Welcome page",e)}}async open(){this.#Os||(this.#Os=!0,await this.load())}async onClick(e,t,s,i){console.debug("Welcome page on click",e,i)}#gi(e,t,s=!1){console.log("WELCOME: sending message",t),"string"==typeof s&&(s="true"==s),s?app.sendRoomMessage(e,t):app.sendMessage(e,t)}#ft(){let e;for(;e=this.#li.shift();){console.log("Welcome mesage received",e);const t=e.room?e.room.id:e.user.id;let s;if(s=this.#ii.getItem(t),s){s.querySelector(".msg").innerHTML=e.shortHTML;const t=s.querySelector("time");t.dataset.time=Date.seconds(),t.innerText="now"}else{s=(e.room?this.#ni:this.#ii).add(e),s.classList.add("new")}this.#ii.moveTop(s,!0),dom.highlightElement(s)}}#pi(e){const{id:t,own:s}=e,i=this.#ai.getItem(t);i?s&&dom.removeElement(i):s||this.#ai.add(e)}#mi({id:e}){const t=this.#ai.getItem(e);dom.removeElement(t)}#di(e){console.debug("Welcome on track change",e.id);const t=this.#ri,s=t.getElementByClass("playing");if(s){if(s.dataset.id==e.id)return;s.classList.remove("playing")}let i=t.getElement(e.id);i?t.moveTop(i):i=t.add(e,!0),i.classList.add("playing")}#hi(){const e=this.#ri.getElementByClass("playing");e&&e.classList.remove("playing")}#ui(e){this.#Nt.add(e,!0,"new")}}App.Editor.register(Xp,"home");const Gp=["editor-header-grid","editor-admin-actions"],Yp=["editor-scrollable","editor-admin-content"],Kp={user:{title:"Users",desc:"Invite, remove users and update permissions",icon:"fa-user"},room:{title:"Rooms",desc:"Create, remove rooms",icon:"fa-user-friends"}};class Zp extends UX.ListPage{static id="admin";#zs;#si;#Os=!1;#R;#fi;#wi;get mode(){return this.container.getAttribute("mode")}set mode(e){this.container.setAttribute("mode",e)}constructor(){let e;super(dom.renderTemplate("editor-base",{},"div",Gp,Yp)),e=this.querySelector('[role="main"]'),this.#fi=this.wrapGroup(e,"editor-admin-user-item"),this.#wi=this.wrapGroup(e,"editor-admin-room-item"),app.on("memberadd",(e=>this.#yi(e.detail))),app.on("useradd",(e=>this.#bi(e.detail))),app.on("roomadd",(e=>this.#vi(e.detail)))}async open(e){console.debug("Admin editor open:",e);if(this.mode==e)return;this.mode=e;const t="room"==e,s=t?this.#wi:this.#fi;s.clear();const i=Kp[e],n=new Ah(this.headerElement);let o,a,r;n.title=i.title,n.desc=i.desc,n.icon=i.icon;try{if(o=app.ds(t?"room":"contact"),a=await o.ls(),t)for(const e of a)e.members?(r=await app.loadContacts(e.members),e.members=Object.toArray(r)):e.members=[];for(const e of a)s.add(e)}catch(e){console.error("Failed to load Admin page",e)}}onAction(e){if("add"===e)this.#St()}async onClick(e,t,s,i){console.debug("Admin page on click",e,i)}async onElementClick(e){console.debug("Admin page on click element")}async onEditorAction(e,t,s){console.debug("Admin on action:",e)}#St(){switch(this.container.getAttribute("mode")){case"user":app.executeCommand("invite-new-user");break;case"room":app.executeCommand("create-new-room")}}#yi({room:e,users:t}){let s=this.#wi.getItem(e);if(s){const i=s.querySelector('[role="members"]'),n=this.wrapGroup(i,"editor-admin-room-member");for(const i of t)s=n.getItem(i.id),s||n.add(i,!0,[e])}}#bi(e){this.#fi.add(e,!0)}#vi(e){this.#wi.add(e,!0)}}AddEditor.register("user",{title:"New user",desc:"Invite user to join",icon:"fa-user",items:[Ql.firstname,Ql.lastname,Ql.email]}),App.Editor.register(Zp),App.Commands.register("invite-new-user",(()=>{app.openEditor("add","new","user",{async onAdd(e){console.debug("On new user",e),e.name=e.firstname+" "+e.lastname,delete e.firstname,delete e.lastname;const t=app.ds("user");try{await t.put(e),app.emit("useradd",e)}catch(e){console.error("Failed to add user",e)}app.editor.cancel()}})})),App.Commands.register("create-new-room",(()=>{app.openEditor("add","new","room",{async onAdd(e){console.debug("On new room",e),e.members=[];const t=app.ds("room");try{await t.put(e),app.emit("roomadd",e)}catch(e){console.error("Failed to add room",e)}app.editor.cancel()}})})),App.Commands.register("room-rm-user",(async(e,t)=>{console.debug("CMD: room rm user",t,e);try{await app.db.deleteValueByIndex("room","uid",parseInt(e),"members",t),await ajax.delete(`/api/member/${e}/${t}`)}catch(e){console.error("Failed to add user",e)}})),App.Commands.register("room-add-user",(async e=>{e=parseInt(e);const{members:t}=await app.ds("room").local.getByIndex("uid",e),s=app.ds("user"),i=new Set(t),n={title:"Users",desc:"Invite users",ds:new DataSourceFilter(s,(e=>!i.has(e.id))),result:"find-contact-item",mode:"ls",type:"select",force:!0,ondone:async t=>{console.debug("Adding new users",e,t);try{const s=t.map((e=>e.id));await ajax.post(`/api/member/${e}`,s),await app.db.pushValueByIndex("room","uid",e,"members",s),app.emit("memberadd",{room:e,users:t})}catch(e){console.error("Failed to update room members",e)}}};app.openEditor("find","contact",n)}));const Jp=650;function Qp(e){const t=e?new Date(1e3*e):new Date,s=t.getHours(),i=t.getMinutes();return`${s>9?s:"0"+s}:${i>9?i:"0"+i}`}function em(e){const t="number"==typeof e?new Date(e):e,s=t.toLocaleString("default",{month:"short"});return`${t.getDate()} ${s}`}class tm extends UX.Page{#ki;#_i=1;#q=Date.seconds();#xi;#B;#Ci;#Ns;#be=!0;#Ei=!1;#Si=Date.tomorrowSeconds();#Ti=new nm;#Ai;#Li=new Map;get groupTemplate(){return"editor-contact-chat-message"}constructor(e,t){const s=dom.createElement("div","show-empty","fit","container-col","reverse");s.dataset.type=e.id,t.append(s),super(s),this.#ki=e}get id(){return this.#ki.id}get uri(){return this.id}get username(){return this.#ki.username}get name(){return this.#ki.display||this.#ki.name}get email(){return this.#ki.email}get photo(){return this.#ki.photo||app.defaultAvatar}get info(){return this.#ki}get status(){return this.#ki.desc||this.#ki.email}get offset(){return this.#q}get more(){return this.#be}get isChannel(){return!1}set y(e){this.#_i=e}get y(){return this.#_i}get area(){return this.container}get loading(){return this.#Ei}set loading(e){this.toggleLoading(),this.#Ei=e}load(){return this.loadHistory()}show(){this.#Ai&&(this.#Ai.cancel(),this.#Ai=null),super.show()}hide(e){this.#Ai=app.runner.setTimeout(300,(()=>e.destroyContent(this))),super.hide()}clearChat(){this.clearContent()}onDestroy(){console.debug("Chat content: on destroy:",this.id),this.removeSelf()}async loadHistory(){if(!this.#be||this.loading)return;console.log("### Loading history:",this.#q),this.loading=!0;const[e,t]=await delayResolve(app.db.getHistory(this.id,this.#q),1200);if(this.#be=t,e.length>0){const t=e[0].ts,s=e[e.length-1].ts;this.#q=s,this.#xi&&this.#xi.matchTimestapm(s)||(this.#xi=this.#ji(s)),!this.#Ci&&Date.today()<t&&(this.#Ci=this.#xi);for(const t of e)t.user=await app.loadContact(this.isChannel?t.user:t.uid),"string"==typeof t.msg&&(t.text=t.msg),this.#xi.matchTimestapm(t.ts)||(this.#xi=this.#ji(t.ts)),this.#xi.add(t)}this.loading=!1}async loadHistoryOld(){if(!this.#be||this.loading)return;console.log("### Loading history:",this.#q),this.loading=!0;const e=await delayResolve(app.db.getHistory(this.id,this.#q),1200);if(e){this.#q++;const[t,s]=e;0!=this.#q||s||this.#q++;let i,n=0;for(const e of t)if((!i||e.ts>=n)&&(i=this.#ji(e.ts,s),n=Date.dayStartSeconds(e.ts,1)),e.time=Qp(e.ts),e.own?e.name="you":(!e.name&&e.user&&await app.loadContact(e),e.name=e.name||this.name,this.isChannel&&(e.avatar=e.photo||app.defaultAvatar,e.user={name:e.name,photo:e.avatar})),"string"!=typeof e.msg)e._type&&await this.#Ii(e,i);else{const t=[];e.msg=e.msg.replace(/(contact|channel|room|article|news|task):\/\/(.*)/,((e,s,i)=>(isNaN(i)||(i=parseInt(i)),t.push([s,i]),`**${s.capitalizeFirstLetter()} share**`))),e.text=e.msg,delete e.id;const s=i.add(e);for(const[e,i]of t){const t=app.ds(e),n=await t.get(i);if(n){const t=`${e}-share`,i=dom.renderTemplate(t,n);s.appendChild(i)}}}if(s){const e=t[t.length-1],s=Date.dayStartSeconds();e.ts>s&&(this.#Ci=i)}}else this.#be=!1;this.loading=!1}onMessage(e){}onDateChange(){this.#Ci=null}addMessage(e){e.ts=e.ts||Date.seconds(),e.time=Qp(e.ts),e.name||(e.name=e.own?"you":this.name),this.#Ci?e.ts>this.#Si&&(this.#Ci=this.#ji(),this.#Si=Date.tomorrowSeconds()):this.#Ci=this.#ji();let t=!1;if(this.#Ns){const s=this.#Ns.msg;e.own==s.own&&(e.own||s.user.id==e.user.id)&&e.ts-s.ts<90&&(t=!0)}let s,i=e.text||e.msg;if(i._type&&e.own&&(e.text=`**Share ${i._type}:** *${i.name}*`),t){const t=dom.renderTemplate("editor-contact-chat-message-item",e);s=this.#Ns.container,s.appendChild(t)}else s=this.#Ci.add(e,!0,null,"fade"),this.onRenderMessage(e,s),this.#Ns={msg:e,container:s};!e.own&&e.text&&Ih(s,e.text)}onRenderMessage(){}async uploadFiles(e){try{const t=await async function(e){console.log("UPLOAD local files",e.length);const t=[],s=[],i=[],n=[],o=[],a=[];for(const r of e)switch(fileX.getType(r.type)){case"image":{const e=await loadImage(r,Jp);e.classList.add("image"),e.dataset.id=r.name.hashCode(),e.name=r.name,e.size=r.size,t.push(e)}break;case"audio":s.push(r);break;case"video":i.push(r);break;case"text":n.push(r);break;case"zip":o.push(r);break;case"pdf":a.push(r)}const r=t.length+s.length+i.length,c=[];1==n.length&&0==[o,a].reduce(((e,t)=>e.length+t.length),0)&&n[0].size<2048&&c.push("message");if(c.push("drive"),app.sudo&&c.push("storage"),0==c.length)return void console.error("No available destinations");const l={images:t,audio:s,video:i,total:r,text:n,zip:o,pdf:a,options:c};console.log("RENDER template",l);const d=dom.createElement("div","container-col","max-width","w3-padding-bottom"),h=dom.renderTemplate("file-upload-message",l);if(t.length>0){const e=h.querySelectorAll("img");e.length>1&&Array.from(e).slice(1).map((e=>dom.hideElement(e)))}dom.openTab(h,"torrent"),d.appendChild(h);for(const e of i){const t=await loadVideoThumb(e);d.appendChild(t)}return d}(e),s=e[0].name,i=generatePushID(s);t.dataset.id=i,this.#Li.set(i,e),this.appendChild(t,!0)}catch(e){console.error("Failed to upload files:",e)}}async sendFile(e){const t=await fileX.readFile(e);let s=`##### ${e.name}\n`;s+="```\n"+t+"\n```",this.handleSendMessage(s)}addImageFromFile(e){this.#B.addImageFromFile(e)}addAudioFromFile(e,t){console.log(t)}addContact(e){this.#B.addContact(e)}destroy(){dom.removeElement(this.container)}async sendImage(e,t){let s;if("torrent"==e){const e=[];for(const s of t){const t=await app.db.get("file",s);e.push(t.file)}const i=await app.seed(e);s={type:"torrent",info:{link:i.magnetURI,files:e}},console.log("Uploading torrent",i)}try{await this.sendMessage(s)}catch(e){console.error("Failed to send torrent link",e)}}handleSendMessage(e){const t="string"==typeof e?{text:dom.escapeTags(e)}:{msg:e};t.own=!0,this.#Ti.send(e,this),this.addMessage(t)}onAction(e,t){const s=t.dataset.id;switch(e){case"cancel":console.debug("Cancel upload:",s),dom.removeElement(t),this.#Li.delete(s);break;case"submit":this.#Di(s,t)}}sendMessage(e){let t=!1;"string"==typeof e&&(e=e.trim(),t=!0);const s=this.id;return app.sendMessage(s,e,!0)}#ji(e,t=!1){e?"number"==typeof e&&(e=Date.fromSeconds(e)):(e=new Date,t=!0);const s={id:e.getTime(),item:this.groupTemplate,title:em(e),titlestyles:"bold text-center",header:"small watermark-8 w3-padding-small",content:"cc reverse m5 w3-container",hide:!0,actions:[{name:"remove",cmd:"chat-remove-history"}]},i=this.addGroup(s,t),n=Date.today(e);return i.area.dataset.id=n,i.startTimestamp=n,i.matchTimestapm=function(e){return e>=this.startTimestamp},i}async#Ii(e,t=this.#Ci){let s;if(e.time=Qp(e.ts),e.own)e.msg=`<span><b>Share ${e._type}:</b>' <i>${e.info.name}</i></span>`,s=t.add(e,!1);else{let i=e.info;const n=[];switch(e.type&&n.push(`${e.type}-share`),e.type){case"article":if("string"==typeof i&&i.startsWith("/")&&(i=await app.loadContent(i)),i.time=new Date(1e3*i.ts),!i.logo){const e=new URL(i.link);i.logo=e.origin+"/favicon.ico"}i.short||(i.short=i.title);break;case"task":e.md&&(i.md=e.md)}s=t.add(e,!1,n)}this.#Ns={msg:e,container:s}}async#Di(e,t){const s=this.#Li.get(e);this.#Li.delete(e);const i=t.querySelector("[actions]");dom.removeElement(i);const n=t.querySelector("[options]");dom.removeElement(n);const o=n.querySelector('input[name="type"]:checked').value,a=t.querySelector("[files]"),r=t.querySelectorAll('input[type="checkbox"]');for(const e of r)e.disabled=!0;const c=[];for(const e of s){const t=e.name.hashCode(),s=fileX.getExtension(e.name),i=a.querySelector(`[data-id="${t}"]`);if(!i.querySelector('input[type="checkbox"]').checked)continue;const n=i.querySelector("progress");let r;switch(dom.showElement(n),o){case"drive:":r=app.google.upload(e);break;case"google":r=app.google.uploadPhoto(e);break;case"firebase":r=app.firebase.uploadFile("uploads",e,s)}const l=await delayResolve(r,1200);console.debug("Uploaded URL:",l),e.link=l,dom.removeElement(n),c.push(e)}if(dom.removeElement(t),c.length>0){let e=toMarkdown(c,"files");this.handleSendMessage(e)}}}Object.assign(tm.prototype,UX.ListMixin);class sm extends tm{#Mi;get key(){return this.#Mi}get status(){const e=this.info;return e.status||e.email}get type(){return"contact"}addMessage(e){if(!e.own){const t=this.container.querySelectorAll('[state="new"]');for(const e of t)e.setAttribute("state","sent");if("confirm"==e._type)return}super.addMessage(e)}onRenderMessage(e,t){e.own&&t.setAttribute("state","new")}async loadKey(){return this.key||(this.#Mi=await app.loadUserKey(this.id)),this.#Mi}}class im extends sm{get topic(){return this.info.topic}get status(){return this.topic}get isChannel(){return!0}get type(){return"room"}get groupTemplate(){return"editor-contact-room-message"}addMessage(e){e.own||(e.avatar=e.photo||app.avatar),super.addMessage(e)}destroy(){super.destroy(),app.leaveRoom(this.id).then((()=>{}),(e=>{}))}sendMessage(e){return"string"==typeof e&&(e=e.trim()),app.sendRoomMessage(this.uri,e,!0)}}class nm{#fs;#Oi="";send(e,t){"string"==typeof e?(this.#fs||(this.#fs=setTimeout((()=>{const e=this.#Oi;this.#Oi="",this.#fs=null,t.sendMessage(e)}),3e3)),this.#Oi+=e+"\n"):t.sendMessage(e)}}class om extends UX.ListPage{static id="contact";#Zt=!1;get active(){return this.#Zt}constructor(e){super(e),this.bottom=!0}get type(){return om.id}get loadingElement(){return this.area.querySelector(".loading")}get contentElement(){return this.area.querySelector(".chat-content")}get dragOptions(){return{directory:!1,hover:!0,files:["image","audio","video","text","pdf","zip"],items:["contact","room","channel","playlist"]}}show(){this.#Zt=!0,super.show()}hide(){this.#Zt=!1,super.hide()}toggleLoading(){this.loadingElement.classList.toggle("hidden")}showLoading(e=!0){const t=this.loadingElement;e?t.classList.remove("hidden"):t.classList.add("hidden")}}App.Editor.register(class extends om{#Pi=null;get uri(){return this.#Pi.uri}get id(){return this.#Pi.id}get isChannel(){return this.#Pi.isChannel}set mode(e){this.container.setAttribute("mode",e);this.headerElement.querySelector('button[name="share"]').setAttribute("cmd",`share-${e}`)}constructor(e){e||((e=dom.renderTemplate("editor-base",{},"div","editor-header-contact","editor-chat")).id="contact-editor"),super(e),this.mode="contact",this.cache=new Map,this.lastMsgDay=0,app.on("chatmsg",(e=>this.onMessage(e.detail))),app.on("confirm",(e=>this.onMessage(e.detail))),app.on("gamemsg",(e=>this.onGameMessage(e.detail))),app.on("status",(e=>this.updateStatus(e.detail))),app.on("answer",(e=>{const t=this.area.querySelectorAll("iframe, video");for(const e of t)if("video"===e.tagName.toLowerCase())e.pause();else{const t=e.src;e.src=t}})),app.on("contactadd",(e=>this.#Ri(e.detail))),app.on("daychange",(()=>{this.#Pi&&this.#Pi.onDateChange()}))}get current(){return this.id}get head(){const e=this.headerElement;return{title:e.querySelector("h2"),ns:e.querySelector(".ns"),avatar:e.querySelector("img.avatar"),call:e.querySelector('button[name="call"]'),header:e}}onAction(e,t,s){if(this.#Pi&&"clear"===e)this.#Pi.clearChat()}onEditorAction(e,t,s){if("send"===e)this.#$i(null,s);else this.#Pi.onAction(e,t,s)}onCommand(e,t){}onInput(e){const t=e.innerText.trim(),s=e.parentElement.lastElementChild;""!=t?(t.length,s.disabled=!1):s.disabled=!0}onKeyPress(e,t){"Enter"==t&&this.#$i(e)}async open(e,t){let s;if("object"==typeof t&&(s=t,t=s.id),this.#Pi){if(e==this.#Pi.type&&t==this.#Pi.id)return;this.#Pi.y=this.posY,this.#Pi.hide(this)}const i=this.cache.get(t);let n,o=!1;if(i)n=i.content;else{console.log("Contact: Content not exists!",t,typeof t);let i=s;"room"==e?(i||(i=await app.loadRoom(t)),n=new im(i,this)):(i||(i=await app.loadContact(t)),n=new sm(i,this)),this.cache.set(t,{contact:i,content:n}),o=!0}this.mode=e;const{title:a,ns:r,avatar:c,call:l,header:d}=this.head,h=n.name,u=n.status;d.dataset.id=t,a.innerText=h,r.innerHTML=dom.renderEmojis(u),c.src=n.photo,l.disabled=n.isChannel,this.#Pi=n,o&&(await n.load(),n.isChannel||app.subscribeUserPresence(t)),n.show(this)}async sendMessage(e){if(e=e.trim()){console.log("Sending message",this.id,e);try{await this.#gi(this.id,e),this.posY=1}catch(e){console.error("Exception",e)}}}destroyContent(e){const t=e.id;this.cache.delete(t),e.onDestroy()}async onMessage(e){const t=(e.room||e.user).id;let s;console.log("Editor: On message",t);let i=!1;if(this.#Pi&&t==this.id)s=this.#Pi,i=!0;else{const e=this.cache.get(t);e&&(s=e.content)}s&&!e.own&&("object"==typeof e&&e.encrypted,s.addMessage(e)),this.active&&i&&app.editor.scrollBottom()}onGameMessage(e){e.params&&this.onMessage(e.user,e)}updateStatus(e){if(this.#Pi&&e.id==this.id){const t=this.headerElement;dom.updateValues(t,e)}}onScrollY(e){e>10||this.#Pi&&this.#Pi.more&&(console.debug("Contact content on scroll:",e),this.#Pi.loadHistory())}onResize(e,t,s){this.#Pi&&this.#Pi.more&&t<=s&&this.#Pi.loadHistory()}async onFileDrop(e){if(1==e.length){const t=e[0];if(t.size<2600&&"text"==fileX.getFileType(t))return void this.#Pi.sendFile(t)}console.log("Contact editor on file drop:",e.length);const t=[];this.#Pi.uploadFiles(e),t.length>0&&console.error("Skipped files:",t.length)}async onDrop(e,t){if(console.log("Chat editor on drop",t,e),this.id!=e.id)return e._type=t,this.#gi(this.id,e);console.debug("Skiping to send to same user!")}async onClick(e,t,s){if(console.log("Contact editor on click",e),"BUTTON"!==s.tagName){if(t.classList.contains("feed")){let s=t.querySelector(".article");if(s)return void s.classList.toggle("hidden");const i={id:e};return dom.getValues(t,i),void await Nh(i,t)}}else this.#Fe(s.name,s,e,t)}#gi(e,...t){return this.#Pi.handleSendMessage(...t)}#zi(){console.log("Contact editor on update");const e=Date.now();for(const[t,s]of this.cache){const i=s.content;i!=this.#Pi&&(i.timeout<e&&(i.destroy(),this.cache.delete(t)))}}#Fe(e,t,s,i){if("remove"===e)dom.removeElement(i)}#$i(e,t){let s;t?e||(e=t.parentElement.firstElementChild,s=t.inputValue):(t=e.parentElement.lastElementChild,s=e.value||e.innerText),t.disabled=!0;const i=s.trim();i&&this.sendMessage(i)}#Ri({id:e}){this.#Pi.id==e&&(this.mode="contact")}}),App.Commands.register("chat-clear-history",(async(e,t)=>{console.debug("Deleting chat history:",e);try{await app.db.rmByIndex("chat","uid",e),await app.db.rmByIndex("history","uid",e)}catch(e){console.error("Failed to delete history")}})),App.Commands.register("chat-add-contact",(async e=>{app.add("contact",e)})),App.Commands.register("chat-invite-users",(async e=>{let t=[];const s=await app.ds("room").local.get(e);s&&s.members&&(t=s.members),t.push(app.uid);const i=new Set(t),n=app.ds("contact"),o={title:"Users",desc:"Invite users",ds:new ku(n,(e=>!i.has(e.id))),result:"find-contact-item",mode:"ls",type:"select",force:!0,ondone:async t=>{console.debug("Adding new users",e,t);const s=t.map((e=>e.id));if(0!=s.length)try{await app.db.pushValue("room",e,"members",s),await app.sendRoomInvite(e,s),app.emit("memberadd",{room:e,users:s})}catch(e){console.error("Failed to update room members",e)}}};app.openEditor("find","contact",o)})),App.Commands.register("add-new-room",(()=>{const e={icon:"fa-user-friends",desc:"Create new room and invite users",async onAdd(e){const t=app.uid;e.id=generatePushID(e.name),e.ts=Date.seconds(),e.user=t,e.members=[t];try{await app.add("room",e,"new"),app.openEditor("contact","room",e)}catch(e){console.error("Failed to create room")}}};app.openEditor("add","new","room",e)})),App.Commands.register("import-gmail-contacts",(async()=>{try{const e=await app.google.contacts(),t=[];if(e.length>0){const s=Date.seconds(),i=app.ds("email");let n;for(const o of e){if(n=await i.get(o.email),n){if("contact"==n.type)continue;o.ts=s,o.status=n.status,o.user=n}else o.id=o.email.hashHex(),n={...o},o.ts=s,o.type="gmail",o.remote=!0,await i.put(o),Object.assign(o,{user:n,status:"not invited"});t.push(o)}t.length>0&&app.emit("useradd",t)}}catch(e){console.error("Failed to import Gmail contact:",e)}}));const am=[{...Ql.name,placeholder:"room name"},Ql.string({name:"topic",title:"Topic"})];AddEditor.register("room",am);const rm=Ql.string({name:"status",title:"Status"}),cm=[Ql.name,rm,{type:"photo",name:"photo",title:"Avatar"}];AddEditor.register("profile",{title:"Profile",desc:"Change photo and nickname",icon:"profile",items:cm,onAdd(e){app.executeCommand("update-user-profile",e),app.cancelEditor()}}),App.Commands.register("update-user-profile",(async e=>{console.debug("UPDATE profile:",e);const{photo:t,...s}=e,i=new FormData;for(const[e,t]of Object.entries(s))i.append(e,t);if(t)if(app.firebase)try{const e=await app.firebase.uploadPhoto(t);i.append("photo",e)}catch(e){console.error("Failed to upload photo into Firebase",e)}else{const e=function(e){const t=e.split(","),s=t[0].indexOf("base64")>=0?atob(t[1]):decodeURI(t[1]),i=t[0].split(":")[1].split(";")[0],n=new Uint8Array(s.length);for(let e=0;e<s.length;e++)n[e]=s.charCodeAt(e);return new Blob([n],{type:i})}(t);i.append("file",e,"avatar.png")}try{const e=await ajax.post("/api/profile",i);await app.updateProfile(e)}catch(e){console.error("Failed to update profile",e)}}));class lm extends UX.List{#l;#Bi;#Ni;#Fi;#xt;#Ct=!1;pages=new Map;get collapsed(){return this.#Ct}constructor(e,t,s=[]){let i;e?i=e.nextElementSibling:(i=dom.createElement("div","v-sash","reverse"),e=dom.renderTemplate("editor-sidebar",s),parent.appendChild(e),parent.appendChild(i));super(e.querySelector(".scrollable")),this.container=e,this.#Ni=i,this.#Fi=e.querySelector(".tabbar"),this.#xt=e.querySelector(".navbar");let n=250,o=!1;if(t){e.id=t;const s=app.ui[t];s&&(o=!!s.collapsed,n=s.width||n)}e.style.width=`${n}px`,o&&this.toggle()}onAction(e,t,s){switch(e){case"collapse":case"expand":this.toggle();break;default:this.handleAction(e,t,s)}}onElementClick(){}handleAction(){}toggle(){const e=this.container.classList.toggle("collapsed");let t;e?(this.#Ni&&dom.hideElement(this.#Ni),this.#l=this.container.style.width,this.container.style.width=null,t=!1):(this.#Ni&&dom.showElement(this.#Ni),this.container.style.width=this.#l,t=!0),this.#Ct=!t;const s=this.container.closest(".sidebar").id;return s&&app.updateSetting(s,{collapsed:e}),t}show(){this.#Ct=!1,dom.showElement(this.container),this.container.style.width=this.#l,this.#Ni&&dom.showElement(this.#Ni)}hide(){this.#Ct=!0,dom.hideElement(this.container),this.#Ni&&dom.hideElement(this.#Ni)}load(e,t=e){}loadTabs(e=0){const t=this.tabs;console.log("Editor sidebar tabs:",t);for(const e of t)this.#qi(new dm(e,!0));this.switchTo(t[e])}onTabChange(e,t){this.switchTo(e)}add(e,t=!1){const s=e.renderTab();this.#Fi.insertBefore(s,this.#Fi.lastElementChild),this.#qi(e),t&&(s.classList.add("active"),this.switchTo(e.name))}onClick(){}#qi(e){this.area.appendChild(e.container),this.addPage(e.id,e)}#Ui(e){this.#Fi.querySelector(".active").classList.remove("active"),e.classList.add("active");const t=e.dataset.tab;this.switchTo(t)}updateTimes(){this.getCurrentPage().updateTimes()}}Object.assign(lm.prototype,UX.PageControllerMixin);class dm extends UX.Page{#os;constructor(e,t=!1){const s=dom.createElement("div","column","fit","hidden");t&&s.classList.add("show-empty"),super(s),this.reverse&&s.classList.add("reverse"),this.#os=e}get id(){return this.#os}get area(){return this.container}get name(){return this.#os}renderTab(){const e=dom.createElement("span","tab","text-center","fit");if(this.icon){const t=dom.createElement("i","fa",...this.icon.split(" "));e.classList.add("icon"),e.appendChild(t)}return e}updateTimes(){const e=Date.now(),t=this.container.querySelectorAll("time[data-time]");for(const s of t){const t=1e3*Number(s.dataset.time),i=new Date(t);s.innerText=i.offsetFrom(e)}}createList(){return UX.List.createMixin(this.container)}}Object.assign(dm.prototype,UX.ListMixin);class hm extends lm{static getTabs(){return[{name:"active",icon:"fa-user-friends watermark-6"},{name:"recent",icon:"fa-list alt watermark-6"}]}get tabs(){return hm.getTabs().map((e=>e.name.toLowerCase()))}#Zt;#Hi;#z;#Os=!1;constructor(e){super(e,"sidebar-game")}toggle(){if(super.toggle()&&!this.#Os)return this.#He()}onClick(e,t,s){"BUTTON"==s.tagName&&s.name}update(e){console.debug("Game siebar update",e)}onMove(e,t,s){if(!this.#Os)return;let i;const n=`${e.id}@${e.user}`;if(e.isover)this.#Zt.delete(n),i=this.#Wi(e,!0);else if(e.invite)e.own||n==t||(i=this.#Hi.getElement(n),i||(i=this.#Hi.add(e,!0)));else{this.#Hi.delete(n);let s=!0;i=this.#Zt.getElement(n),i?(dom.moveTop(i),n==t&&(i.removeAttribute("new"),s=!1)):i=this.#Zt.add(e,!0),!e.own&&s&&i.setAttribute("new","")}dom.highlightElement(i)}onOver(e){this.#Os&&(this.#Zt.delete(e.id),this.#Wi(e,!0))}async#He(){this.#Os=!0,this.loadTabs();const e={badge:!0,content:"w3-padding-tiny"};let t=this.getPage("recent");this.#z=t.addGroup({item:"sidebar-game-recent-item",template:null}),t=this.getPage("active"),this.#Zt=t.addGroup({...e,name:"active",icon:"fac-play-recent",empty:!0,item:"sidebar-game-active",cmd:"game-open-user"}),this.#Hi=t.addGroup({...e,name:"invites",icon:"fa-clock w3-color-green",hide:!0,item:"sidebar-game-invite",cmd:"game-open-user"});const s=await app.db.ls("games");await app.loadContacts(s);const i=[];for(const e of s)e.invite?this.#Hi.add(e):e.state?this.#Zt.add(e):i.push(e);i.sort(((e,t)=>t.ts-e.ts));for(const e of i)this.#Wi(e)}#Wi(e,t=!1){let s=this.#z.getElement(e.id);return s?t&&dom.moveTop(s):s=this.#z.add(e,t),s}}class um extends UX.Page{#Vi;get ctx(){return this.#Vi}get canvas(){return this.#Vi.canvas}set width(e){this.canvas.width=e,this.canvas.style.width=`${e}px`}set height(e){this.canvas.height=e,this.canvas.style.height=`${e}px`}get width(){return this.canvas.width}get height(){return this.canvas.height}get clientRect(){return this.canvas.getBoundingClientRect()}get viewport(){return this.container.getBoundingClientRect()}constructor(e){let t=e.querySelector("canvas");t||(t=dom.createElement("canvas"),e.appendChild(t)),super(e),this.#Vi=t.getContext("2d"),t.onmousemove=e=>this.onMouse(e),t.onclick=e=>this.onClick(e)}registerHandlers(){const e=this.canvas;e.onmousemove=e=>this.onMouse(e),e.onclick=e=>this.onClick(e);const t=new ResizeObserver((e=>this.handleResize(e[0].contentRect)));t.observe(this.container)}init(){}onMouse(e){this.handleMouseMove(this.#Xi(e),this.width,this.height)}onClick(e){this.handleClick(this.#Xi(e),this.width,this.height)}handleClick(){}handleMouseMove(){}handleResize(){}#Xi(e){var t=this.clientRect,s=t.width,i=t.height,n={x:e.clientX-t.left,y:e.clientY-t.top};return n.xp=parseFloat(n.x/s*50).toFixed(2),n.yp=parseFloat(n.y/i*50).toFixed(2),n}}class pm extends um{#Gi=new Map;#B;#Yi;#ms;get gid(){return`${this.#ms}-${this.#Yi}`}get uri(){return`${this.#ms}@${this.#Yi}`}get info(){return this.#B?{score:this.#B.current,stat:this.#B.stat}:null}get id(){return this.#B.id}constructor(e){const t=dom.createElement("div","preview","fade","fit","noverflow","max-height");super(t),e.appendChild(t),this.registerHandlers()}async load(e,t,s){this.#B=await app.game.load(t,e,s),this.handleResize(this.viewport)}#i(){const{game:e,state:t}=this.#B;e.render(t,this.ctx)}async reload(){await app.game.reload(this.id),this.#i()}async handleMove(){this.#i()}async resign(e){const t=this.#B;await app.db.update("games",this.uri,{last:void 0,state:void 0}),t.reset(),t.render(this)}updateSize(e){this.container.style.height=e-10+"px"}handleClick(e){if(this.#B){this.#B.game.onclick(this.#B.state,e,this.ctx)&&this.#Ki()}}handleResize(e){if(console.debug("Preview on viewport change",e),this.#B){const t=this.#B.game.ratio;let s=e.width,i=Math.floor(s*t);i>e.height&&(i=e.height,s=Math.floor(i*(1/t))),this.width=s,this.height=i,this.#i()}}async update(e){}#Ki(){const e=this.#Yi;this.#Yi=null,app.openEditor("game","over",this.#ms,e)}}AddEditor.preview("game",pm);const mm=["editor-header-avatar-grid","game-editor-toolbar",null];class gm extends UX.ListPageController{static id="game";#Zi;#et;#ai;#Jt;#Yi;#ms;get sidebar(){return this.#et}set id(e){this.#ms=e,e?this.container.dataset.id=e:delete this.container.dataset.id}constructor(e){e||((e=dom.renderTemplate("editor-base-sidebar",{},"div",mm,"editor-scrollable",hm.getTabs())).id="game-editor"),super(e);const t=this.editorElement,s=(mo.createMixin(t.querySelector(".history"),"li"),new hm(this.sidebarElement));s.toggle(),this.#et=s,this.#Jt=new fm(this.area),this.#ai=new wm(this.area,s),this.addPage("home",this.#Jt),this.addPage("game",this.#ai),app.on("gamemove",(e=>this.#Ji(e.detail))),app.on("gameover",(e=>this.#Qi(e.detail)))}async open(e,t,s,i){const n=new Ah(this.headerElement);if("over"==e){const s=i;this.#et.onOver(t,s),e="home"}if("home"==e){const e=await app.ds("game").get(t);n.title="Game",n.desc="Home page",n.mode="new";const s=n.icon;return s.id=e.icon,s.color=e.iconcolor,this.id=null,this.switchTo("home"),this.#Jt.open(e)}"string"==typeof s&&(s=await app.loadContact(s));const o=`${s.id}@${t}`;if("game"!=this.current||o!=this.#ms)return this.switchTo("game"),n.avatar=s.photo||app.defaultAvatar,n.title=s.name,n.desc=t,n.mode="game",this.#Yi=s,this.id=o,this.#ai.open(t,s.id,i);i&&this.#ai.open(t,s.id,i)}switchTo(e){"game"==e?this.area.classList.add("max-height"):this.area.classList.remove("max-height"),super.switchTo(e)}onAction(e){switch(e){case"chat":app.openEditor("contact","chat",this.#Yi.id);break;case"call":app.openEditor("video","call",this.#Yi.id,{audio:!0,video:!1});break;case"reload":this.#ai.reload();break;default:this.currentPage.onAction(e,this.#Yi)}}#Ji(e){e.id==this.#ms&&this.#ai.onMove(e)}#Qi(e){const{id:t,type:s}=e;this.#et.onOver(e),t==this.#ms&&this.open("home",s)}}class fm extends UX.Page{constructor(e){const t=dom.createElement("div","w3-container","hidden");super(t),e.appendChild(t)}async open(e){let t;this.removeChilds();const s=function(e){const t=e.name||e.id;return`\n# ${t.capitalizeFirstLetter()}\n\n|  |  |\n|--|--|\n|**Author**|*${e.user.name}*|\n|**Type**|*${e.type}*|\n\n${e.desc||e.description}\n`}(e);e.md=s,t=dom.renderTemplate("editor-game-info",e),this.appendChild(t);const i=app.ds("games"),n=[e.id,Number.MAX_SAFE_INTEGER],o=await i.lsByRange("recent",null,n,!0);t=dom.renderTemplate("editor-game-recent",o,"div",[e.id]),this.appendChild(t)}}class wm extends UX.Page{#en;#et;#tn;get uri(){return this.#en.uri}get info(){return this.#en.info}constructor(e,t){const s=dom.renderTemplate("editor-game-base");super(s),e.appendChild(s);const i=s.querySelector('[role="stat"]');i&&(this.#tn=new ym(i)),this.#en=new pm(s),this.#et=t}async open(...e){try{await this.#en.load(...e)}catch(t){app.openEditor("game","home",...e)}}reload(){this.#en.reload()}async onMove(e){if(e.own||await this.#en.handleMove(e),this.#tn){const{stat:t}=e;this.#tn.stat={score:[t.score.win,t.score.loss],total:[t.total.win,t.total.loss],game:[t.win,t.loss]}}}}class ym{#r;constructor(e){this.#r=e}set score(e){this.#sn("score",e)}set stat(e){for(const[t,s]of Object.entries(e))this.#sn(t,s)}#sn(e,t){const s=this.#r.querySelector(`[role="${e}"]`).querySelectorAll("[data-count]");s[0].dataset.count=t[0],s[1].dataset.count=t[1]}}App.Editor.register(gm),App.Commands.register("game-open-user",(async e=>{const[t,s]=e.split("@");app.openEditor("game","open",s,t)})),App.Commands.register("game-invite-user",(async e=>{console.debug("New game:",e);const t=app.ds("game"),s=["opponent"],i=await t.get(e);let n,o=await app.game.params(e);for(const[e,t]of Object.entries(o))n={name:e},Array.isArray(t)?(n.type=t.length<5?"radio":"option",n.options=t.map((e=>e.toString()))):t?n.type=t:n=e,s.push(n);return o={desc:"Create new game",items:s,icon:i.icon,reload:!0,onAdd({opponent:t,...s}){console.log("Creating new game:",s),app.openEditor("game","open",e,t,s)}},app.openEditor("add","new","game",o)})),App.Commands.register("game-resign-user",(async e=>{console.debug("CMD game resign:",e),app.game.resign(e)})),FindEditor.register("game",["id","description","user","info"]),App.Commands.register("video-call-user",(e=>app.call(e))),App.Commands.register("video-call-hangup",(e=>app.hangup())),App.Commands.register("video-toggle-camera",(e=>app.toggleCamera())),App.Commands.register("video-screen-share",(()=>{app.messenger.startScreenSharing()}));Ql.string({name:"title",validate:e=>e.length>3}),Ql.string({name:"tags",validate:e=>/[a-z][a-z0-9]{2,}/.test(e)});const bm=["editor-header-grid","editor-wiki-toolbar"],vm=["editor-scrollable","wiki-editor-content"],km=[{name:"pin",icon:"pin watermark-6"}];class _m extends UX.ListPage{#Ks;#et;#B;#ms;#in;#rs=[];static id="wiki";get sidebar(){return this.#et}constructor(){const e=dom.renderTemplate("editor-base-sidebar",{},"div",bm,vm,km);e.id="wiki-editor",super(e),this.mode="view";const t=new Ah(this.headerElement);t.title="Wiki",t.desc="Search the database for examples and tips",t.icon="fa-search";const s=this.editorElement,i=s.querySelector(".main");this.#Ks=UX.List.createMixin(i);const n=this.sidebarElement;this.#et=new lm(n),this.#et.toggle();const o=s.querySelector("textarea");this.#in=new MDE({element:o,spellChecker:!1,autoDownloadFontAwesome:!1})}async open(e,t){if(t&&this.#ms==t)return;"start"==e&&(e="page",this.#rs=[]),this.#B=e,this.#ms=t,this.container.dataset.id=t,console.log("Wiki editor open:",e);if("search"===e)this.mode="search";else this.mode="view",await this.#nn(t)}onAction(e){if("edit"===e)this.#on(this.#ms,!1)}async onEditorAction(e,t,s){if(console.log("Wiki editor on action",e),"A"==s.tagName){const e=s.getAttribute("link");return void(e&&this.#Fe(e))}const i=t.dataset.id;switch(e){case"submit":{const e=this.#in.value();this.mode="view",this.#an(i,e)}break;case"cancel":this.mode="view";break;case"edit":this.#on(i,!1)}}onLinkClick(e){if(e.startsWith("/"))this.#nn(e);else{const t=`#${this.#B}_${e}`,s=this.#Ks.querySelector(t);s&&app.editor.scrollTo(s)}}async#an(e,t){const s=t.trim();console.log("Updating document",e,s),this.#Ks.toggleLoading(),this.#Ks.removeContent();const i=app.ds("wiki");try{const t={id:e,content:s,tags:"wiki"};await delayResolve(i.put(t),1200),this.#rn(e,s)}catch(t){console.error("Failed to update document",e)}this.#Ks.toggleLoading()}async#on(e,t=!1){this.mode="edit";let s="";if(!t){const t=await xm(e);t&&(s=t)}this.editorElement.querySelector('[role="edit"]').dataset.id=e,this.#in.value(s)}async#Fe(e){if(console.debug("WIKI handle link click"),e.startsWith("#")){const t=`#${this.#B}_${e.substr(1)}`,s=this.#Ks.querySelector(t);s&&this.scrollTo(s)}else this.#nn(e)}async#nn(e){if(e.startsWith("/")){const t=e.slice(1).split("/");e=t.join("-")}this.#Ks.toggleLoading();const t=await delayResolve(xm(e),1200);if(this.#Ks.toggleLoading(),t){const s=this.#rs.indexOf(e);s<0?this.#rs.push(e):this.#rs.splice(s+1,this.#rs.length-(s+1)),this.#ms=e,this.container.dataset.id=e,this.#rn(e,t)}else if(app.sudo)return console.log("Switching to edit mode"),this.#on(e,!0)}#rn(e,t,s=!0){(s||e!=this.#ms)&&(this.#Ks.removeContent(),this.posY=0,this.#Ks.appendTemplate("editor-wiki-doc-content",{id:e,text:t,marked:Cm(e)},"div"),this.#cn())}#cn(){const e=this.#Ks.querySelector(".path");console.debug("WIKI updating path:",this.#rs),dom.removeChilds(e);for(const t of this.#rs.slice(0,-1)){const s=t.split("-"),i=`#/${s.join("/")}`,n=dom.createElement("a","smaller");n.setAttribute("link",i),n.innerText=s.join(" "),e.appendChild(n)}}}function xm(e){return app.cache.load("wiki",e)}function Cm(e){return{headerIds:!0,headerPrefix:e+"_"}}App.Editor.register(_m);class Em extends UX.ListPageController{#Zt;#ln=!1;get active(){return this.#Zt}get header(){const e=this.headerElement;return new Ah(e)}get opened(){return this.#ln}show(){this.#ln=!0,super.show()}hide(){this.#ln=!1,super.hide()}switchTo(e){this.#Zt=super.switchTo(e)}onInput(...e){this.#Zt&&this.#Zt.onInput(...e)}onFilter(...e){this.#Zt&&this.#Zt.onFilter(...e)}onKeyPress(...e){this.#Zt&&this.#Zt.onKeyPress(...e)}onClick(...e){this.#Zt&&this.#Zt.onClick(...e)}onElementClick(e,...t){if(this.#Zt)switch(e.tagName){case"A":case"BUTTON":return this.#Zt.onAction(e.getAttribute("name"),null,e)}}onEditorAction(...e){this.#Zt&&this.#Zt.onAction(...e)}onAction(){}onFileDrop(){}onScrollY(){}onResize(){}}class Sm extends lm{static getTabs(){return[{name:"recent",icon:"fa-clock"}]}#B;#$;#z;get tabs(){return Sm.getTabs().map((e=>e.name.toLowerCase()))}constructor(e){super(e,"sidebar-player"),this.loadTabs();const t=this.getPage("recent"),s={visible:100,badge:!0,hide:!0,icon:"fac-queue",name:"queue",item:"editor-player-sidebar-queue-item",actions:[{name:"clear"}]};this.#$=t.addGroup(s),s.icon="fac-play-recent",s.name="recent",s.item="editor-player-sidebar-playlist-file",s.actions=[{name:"add",cmd:"add-new-playlist"},{name:"clear"}],this.#z=t.addGroup(s),app.on("trackqueued",(e=>this.#dn(e.detail))),app.on("trackchange",(e=>this.#di(e.detail)))}handleAction(e,t,s){switch(console.debug("Sidebar player on action:",e),e){case"delete":{const e=t.getAttribute("group");if(console.log("Deleting item",id,e),"queue"===e)app.player.remove(parseInt(id)),this.#$.remove(id)}break;case"clear":app.player.clear(),this.#z.clear()}}onClick(e,t,s){console.debug("PLAYER sidebar onclick")}async#dn(e){const t=await app.db.get("audio",e);t.title||(t.title=fileX.getTitleFromMeta(t)),this.#$.add(t)}#di(e){const t=e.id;if(this.#$.delete(t),t!=this.#B){e.title||(e.title=fileX.getTitleFromMeta(e));const t=e.meta;!e.album&&t.album&&(e.album=t.year?`${t.album} - ${t.year}`:t.album),this.#z.add(e,!0)}this.#B=t}}class Tm extends UX.Page{get area(){return this.container}constructor(e,t,s="editor-player-content-base"){const i=dom.renderTemplate(s,{});i.classList.add(t,"hidden"),e&&e.appendChild(i),super(i)}load(){}search(){}onClick(){}onInput(){}onAction(){}onFilesDrop(){}onTabChange(){}onTrackChange(){}onTrackStop(){}}Object.assign(Tm.prototype,UX.ListMixin);class Am extends Tm{static id="files";#q=0;#Se=0;#ri;#be=!1;constructor(e){super(e,Am.id),app.on("audioadd",(e=>this.#hn(e.detail)))}open(e){const t=this.container;e?(t.setAttribute("playlist",""),this.loadPlaylist(e.tracks)):t.removeAttribute("playlist")}async load(){this.#q=0,this.#Se=await app.db.count("audio");const e=await app.db.lsByRating("audio",this.#q);return this.loadFiles(e)}loadFiles(e){console.log("PLAYER ED: Loading files: ",this.#q,e.length,this.#Se),this.#q+=e.length,this.#be=e.length>=50;for(const t of e)this.#un(t);if(this.sort(Lm),app.player.isPlaying){const e=app.player.current;let t=this.getElementBy("id",e.id);t||(t=this.#un(e,!0)),t.classList.add("playing"),this.#ri=e.id}}async loadPlaylist(e){const t=this.getElementsBy("playlist","true");for(const e of t)delete e.dataset.playlist;for(const t of e){let e=this.getElement(t.id);e||(e=this.#un(t)),e.dataset.playlist=!0}}onFilesDrop(e){console.log("Importing media files",e.length)}onClick(e){console.log("Playing file:",e),app.player.playFile(e,!0)}onAction(e,t,s){if("delete"===e)return dom.removeElement(s),app.db.rm("audio",parseInt(t))}onTrackChange(e){console.log("Player editor on track change:",e),this.state="playing",this.#pn(),this.#ri=e.id;const t=this.getElement(e.id);if(!t)return;t.classList.add("playing");const s=t.querySelector(".title"),i=Math.floor(s.innerText.length/4);if(s.style["animation-duration"]=`${i}s`,"video"==t.dataset.type){const e=app.player.videoElement;t.appendChild(e)}return function(e,t){const s=e.querySelector(".time");s.innerText=fileX.getDuration(t)}(t,e.duration),t}onTrackStop(){this.#pn()}#pn(){if(!this.#ri)return;const e=this.getElement(this.#ri);if(!e)return;e.classList.remove("playing");const t=e.querySelector("video");t&&dom.removeElement(t)}#un(e,t=!1){const s=e.name||e.filename||e.file.name,i=e.type?fileX.getType(e.type):function(e){const t=fileX.getExtension(e);return fileX.isVideo(t)?"video":"audio"}(s),n={id:e.id||s.hashCode(),title:fileX.getTitleFromMeta(e),desc:fileX.getDescriptionFromMeta(e),rating:e.rating,type:i};e.meta&&e.meta.duration&&(n.duration=e.meta.duration);const o=this.addItemTemplate("edior-player-track-item-file",n,t);return o.dataset.name=n.title.slice(0,8).toLowerCase(),o.dataset.type=i,o}#hn(e){for(const t of e)this.#un(t,!0)}}function Lm(e,t){return e.dataset.rating==t.dataset.rating?e.dataset.name>t.dataset.name?1:-1:parseInt(t.dataset.rating)-parseInt(e.dataset.rating)}class jm{#F;#Ee;#Te;#Se;#ki;#fs;#mn=0;#be=!0;get id(){return this.#ki.id}get uri(){return this.#ki.uri}constructor(e){this.#F=e.querySelector("progress"),this.#Ee=e.querySelector(".speed")}download(e){this.#ki=e,this.#Te=Date.seconds(),this.#Se=e.files.reduce(((e,t)=>e+t.size),0),this.#fs=setInterval((()=>this.#x()),1e4),app.downloadTorrent(e.uri,this)}progress(e){console.log("Torrent download progress:",e),this.#fs=clearInterval(this.#fs),this.#F.value=Math.floor(100*e);const t=Math.floor(this.#Se*e),s=Date.seconds()-this.#Te;this.#Ee.innerText=`${fileX.formatSize(t/s)}/s`}done(){app.db.update("torrent",this.id,{progress:100}),app.firebase.set("data/torrent",this.id,app.uid,Date.seconds()),this.ondone()}error(e){}ondone(){}async#x(){!this.#be&&this.#mn>0&&(this.#mn=0,this.#be=!0);let e=0;const t=this.id,s=await app.firebase.ls(`data/torrent/${t}`,3,this.#mn,!0);if(s){for(const i of Object.keys(s)){const s={type:"push",torrent:t};console.log("Sending torrent push:",t),await app.sendMessage(i,s,!1),e+=1}this.#mn+=e,e<3&&(this.#be=!1)}else this.#be=!1}}class Im extends Tm{static id="torrent";#q=0;#be=!1;#Ce;#Ks;#cs;get more(){return this.#Ce&&10==this.#Ce.length}get ds(){return app.ds("torrent")}constructor(e){super(e,Im.id,"editor-player-content-torrent");const t=this.container.querySelector(".search-area");this.#Ce=new Dh(t,"torrent"),this.#Ks=UX.List.createMixin(this.container.querySelector(".main")),app.on("torrentdownloading",(e=>this.#gn(e.detail)))}load(){return this.#He()}open(){}onAction(e,t,s){switch(e){case"more":this.#Ce.showMore();break;case"less":this.#Ce.showLess();break;case"clear":this.#Ce.clear();break;case"search":this.#Ce.search(this.#cs);break;default:this.#Fe(e,t,s)}}onFilesDrop(e,t){this.#fn(e,t)}async search(e){console.log("Sending search request:",e);try{await this.#Ce.search(e)}catch(e){console.error("Search request failed",e)}}onInput(e){if("search"===e.getAttribute("name"))this.#Ce.onInput(e)}async#He(){const e=this.ds,t=await e.ls(!1,this.#q),s=t.filter((e=>!e.remote));console.log("PLAYER ED: Loading files: ",this.#q,t.length),this.#q+=t.length,this.#be=t.length>=50;const i=[];for(const e of s){const t=this.#Ks.addItemTemplate("editor-player-torrent",e,!1,["torrent-actions"]);e.progress<100&&(t.classList.add("downloading"),i.push([e,t]))}this.#wn(),this.#cs=new Set(s.map((e=>e.id)))}#wn(){this.#Ks.sort(((e,t)=>e.progress<100?-1:t.progress<100||Number(e.dataset.rating)<Number(t.dataset.rating)||e.dataset.name>t.dataset.name?1:-1))}#fn(e,t){e.sort(((e,t)=>e.meta&&e.meta.track&&t.meta&&t.meta.track?e.meta.track-t.meta.track:-1));const s=e.map((e=>Object({name:e.meta&&e.meta.title?e.meta.title:fileX.getName(e.name),size:e.size,type:fileX.getType(e.type)})));let i=dom.renderTemplate("editor-player-torrent-new",s);this.append(i,!0);const n=i.querySelector('button[name="submit"]'),o=i.querySelector('input[name="title"]');for(const t of e)if(t.meta&&t.meta.album){o.value=t.meta.album;break}let a=e.length;i.onclick=t=>{const s=t.target;switch(s.tagName){case"BUTTON":switch(s.name){case"submit":{const t=Array.from(i.querySelectorAll('input[type="checkbox"]:not(:checked)')).map((e=>e.dataset.index));console.log("Creating new torrent, skiped",t.length);for(const s of t)e[parseInt(s)]=null;e=e.filter((e=>!!e)),console.log("Selected files:",e.map((e=>e.name)));const s=o.value,n={id:e.map((e=>e.name.hashCode())).reduce(((e,t)=>e^t),0)>>>0,title:s,rating:0,files:[]};for(const t of e){const e={name:t.name,size:t.size};t.meta&&t.meta.title&&(e.display=t.meta.title),n.files.push(e)}dom.removeElement(i),this.#yn(n,e)}break;case"cancel":dom.removeElement(i)}break;case"INPUT":"checkbox"==s.type&&(a+=s.checked?1:-1,n.disabled=0==a)}}}async#yn(e,t){try{if(t){const s=await app.seed(t);console.log("Seeding torrent:",s.infoHash),e.hash=s.infoHash,e.uri=s.magnetURI;const i=await ajax.post("/api/torrent",e);console.log("Torrent created:",i.id),e.id=i.id}await app.db.put("torrent",e),this.#Ks.addItemTemplate("editor-player-torrent",e,!0)}catch(e){console.error("Failed to add torrent",e)}}async#Fe(e,t,s){let i=t.dataset.id;if(i&&i.startsWith("magnet:")){const{hash:e}=parseMagnetURI(i);i=e}if("download"===e){const e=t.dataset.id;this.#Ce.disableResult(e);const s=this.#Ce.getResult(i);s&&(this.#bn(s),app.downloadTorrent(e))}}#vn(e,t){const s=new jm(t);s.ondone=()=>{const e=t.querySelector(".progress");dom.removeElement(e),t.classList.remove("downloading"),dom.highlightElement(t)},s.download(e)}async#gn(e){const t=e.infoHash;let s=this.#Ce.getResult(t);s||(s=await this.ds.get(t));const i=this.#bn(s),n=new Mh(i);app.addTorrentMonitor(t,n)}#bn(e,t="downloading"){let s=this.#Ks.getElement(e.id);return s||(s=this.#Ks.addItemTemplate("editor-player-torrent",e,!0,["torrent-actions"]),s.dataset.id=e.id),s.setAttribute("state",t),s}}class Dm extends Tm{static id="radio";pages=new Map;#kn;#_n;#z;#$;#ii;#ms;constructor(e){super(e,Dm.id);const t=dom.renderTemplate("editor-player-radio",{name:"Nula",desc:"Classic jazz, soul",code:777});this.#ii=UX.List.createMixin(t.querySelector('[role="chat"]')),this.container.appendChild(t),this.addPage("main",new UX.Page(t)),this.switchTo("main"),app.on("radiomsg",(e=>this.#ft(e.detail)))}async open(e){if(this.#ms==e)return;this.#ms=e,this.toggleLoading(),console.debug("Open radio:",e);const t=this.switchTo("main");t.removeChilds();const s=app.ds("radio"),i=await delayResolve(s.get(e),1200);this.toggleLoading(),t.addTemplate("editor-player-radio",i)}load(){}onTabChange(e,t){let s=this.switchTo(e);if(!s){if("player"===e)s=this.#xn();this.addPage(e,s),this.switchTo(e)}}onAction(...e){this.onEditorAction(...e)}onEditorAction(e,t,s){if("send"===e)this.#$i(s)}onKeyPress(e,t){"Enter"==t&&this.#$i(e)}#$i(e){const t=e.inputValue;this.#Cn(t)}#Cn(e){console.debug("Radio editor chat:",e);const t={name:"Alice Freeman",own:!0,msg:e};this.#ii.addItemTemplate("editor-contact-chat-message",t,!0),app.sendRoomMessage("radio",e,!1)}#xn(){const e=dom.renderTemplate("editor-player-remote");this.container.appendChild(e);const t=e.querySelector('[role="tracks"]'),s=e.querySelector('[role="playlist"]');this.#_n=UX.List.createMixin(t);const i=UX.List.createMixin(s);return this.#$=i.addGroup({name:"next",badge:"true",hidable:!0,count:!0}),this.#En(),new UX.Page(e)}#ft(e){e.avatar=e.avatar||e.photo||"/ui/svg/contact.svg",this.#ii.addItemTemplate("editor-contact-chat-message",e,!0)}async#En(){if(this.#kn)return;const e=`ws://${location.host}:9084`;console.log("HOST:",e);const t=new WebSocket(e);t.onopen=e=>{console.debug("WS RADIO CONNECTION: connected"),t.send(JSON.stringify({method:"ls"})),t.send(JSON.stringify({method:"bind"}))},t.onmessage=e=>{const t=e.data,s=JSON.parse(t);console.debug("MSG received:",s);const{method:i,...n}=s;if("ls"==i)for(const e of n.tracks)console.debug("TRACK:",e),this.#_n.addItemTemplate("edior-player-track-item-file",e);else switch(i){case"queue":this.#$.addTemplate("editor-player-sidebar-queue-item",n).dataset.id=n.id;break;case"onchange":{const e=n.id,t=this.#$.getElement(e);t&&dom.removeElement(t)}}},t.onclose=()=>{console.log("RADIO socket remote close"),this.#kn=null},t.onerror=e=>{console.error("PUSH socket error",e),this.#kn=null},this.#kn=t}}Object.assign(Dm.prototype,UX.PageControllerMixin);const Mm={files:{title:"Local files",desc:"Play and share with friends your media files"},youtube:{title:"Youtube",desc:"Play and share with friends your favorite videos"},torrent:{title:"Torrents",desc:"Play and share with friends your media files"},radio:{title:"Radio",desc:"Listen online radio"}};class Om extends Em{static#yt={};static register(e){this.#yt[e.id]=e}static id="player";#et;#Sn=[];#q=0;#be=!1;#Ei;#P;#F;#ki;get sidebar(){return this.#et}get dragOptions(){return{directory:!1,hover:!0,files:["audio","video","image"],items:["playlist"]}}set state(e){if(e==this.#P)return;this.#P=e,this.container.setAttribute("state",e);this.container.querySelector('.header button[name="play"]').title="playing"==e?"Pause":"Play"}constructor(e){e||((e=dom.renderTemplate("editor-base-sidebar",{},"div","editor-player-header","editor-player-base",Sm.getTabs())).id="player-editor",e.classList.add("dark","player")),super(e),console.log("Creating player editor ...."),this.#Tn(),this.#An();const t=this.header,s=(t.icon,t.q(".progress"));this.#F=new Pm(s),app.on("trackchange",(e=>this.#di(e.detail))),app.on("trackstop",(e=>this.#hi(e.detail))),app.on("trackpause",(e=>this.#Ln(e.detail))),app.on("trackprogress",(e=>this.#jn(e.detail))),app.on("filesdropped",(e=>this.#In(e.detail)));const i=this.editorElement;this.#Dn(i),this.#Sn.push(t.button("play")),this.#Sn.push(t.button("prev")),this.#Sn.push(t.button("next")),this.state=app.player.isPlaying?"playing":"paused"}async open(e,...t){let s;this.#ki=null,this.container.setAttribute("view",e),console.log("Player page open:",e);const i=this.header,n=i.icon,o=Mm[e];switch(e){case"torrent":case"files":case"radio":i.title=o.title,i.desc=o.desc,n.name=e,this.#Mn(e);break;default:{const o=app.ds("playlist");s=t.shift(),s=s||e;let a=await o.get(s);i.title=a.display||a.name,i.desc=`${a.genre}, ${a.tracks.length} tracks`,n.name="playlist",this.#ki=a,this.#Mn("files",a.tracks)}}}onAction(e,t,s){switch(e){case"next":app.player.playNext();break;case"prev":app.player.playPrev();break;case"play":"paused"==this.#P?app.player.resume():app.player.pause();break;case"share":app.share("playlist",this.#ki)}}onFileDrop(e,t){console.log("Player editor on file drop:",e.length);const s=[],i=[],n=[];for(const t of e){const e=fileX.getExtension(t.name);fileX.isImage(e)?s.push(t):fileX.isMedia(e)?i.push(t):n.push(t)}i.length&&this.active.onFilesDrop(i,s,n)}onTabChange(...e){this.active&&this.active.onTabChange(...e)}async#Mn(e,...t){return console.log("Player OPEN:",e),this.switchTo(e),this.active||(this.#qi(e),this.switchTo(e),await this.active.load()),this.#ki&&t.unshift(this.#ki),this.active.open(...t)}#On(e){console.debug("Openning radio:",e)}#qi(e){const t=new(0,Om.#yt[e])(this.area);return this.addPage(e,t),t}#Tn(){this.editorElement;this.registerEvents(),this.onScrollY=(e,t)=>{if(this.#be&&t-e<30&&!this.#Ei){console.log("Loading more files:",this.#q);const e=content.offsetY;this.#Ei=dom.createElement("div","loader"),this.append(this.#Ei),setTimeout((async()=>{this.offsetY=e,dom.removeElement(this.#Ei),this.#Ei=null}),1200)}}}#An(){const e=this.sidebarElement,t=new Sm(e);this.#et=t}#di(e){this.#F.resume();const t=this.active.onTrackChange(e);t&&app.editor.scrollTo(t),this.state="playing"}#hi(){console.log("Editor Player: track stop"),this.state="paused",this.active.onTrackStop()}#Ln(){console.log("Editor Player: track pause"),this.state="paused"}#jn({sec:e,total:t}){this.#F.update(e,t)}#In(e){console.log("Player on files dropped")}#Dn(e){e.querySelector('input[name="filter"]')}#Pn(e){const t=e.querySelector('input[name="magnet"]'),s=e.querySelector('button[name="download"]');let i;e.querySelector('button[name="stop"]').onclick=()=>{i&&app.cancelTorrent(i),t.disabled=!1,s.disabled=!1},s.onclick=async()=>{if(i=t.value,""==i)return void console.log("Cannot download empty torrent");t.disabled=!0,s.disabled=!0,console.log("Downloading magnet:",i);const e=await app.firebase.get("torrent",i);app.downloadTorrent(e.uri,{progress(){},done(){t.disabled=!1,s.disabled=!1}})}}}class Pm{#Rn;#Bs;constructor(e){this.#Rn=e.querySelector('input[type="range"]'),this.#Bs=e.querySelector("time")}update(e,t){this.#Rn.value=Math.round(e/t*100);let s=t-e;s<0&&(s=0),this.#Bs.innerText=fileX.getDuration(s)}pause(){this.#Rn.disabled=!0}resume(){this.#Rn.disabled=!1,dom.showElement(this.#Bs)}end(){this.#Rn.value=0,this.#Rn.disabled=!0,dom.hideElement(this.#Bs)}}Om.register(Am),Om.register(Im),Om.register(Dm),App.Editor.register(Om),AddEditor.register("playlist",[Ql.string({name:"display",title:"Name",required:!0}),Ql.option({name:"genre",options:["Pop","Rock","Folk","Classic","Jazz","Punk","Metal"]}),Ql.list({name:"tracks",template:"editor-player-sidebar-playlist-file"})]),App.Commands.register("add-new-playlist",(()=>{const e=app.player.recent;console.log("# Creating playlist:",e);const t={icon:"",desc:"Create a new playlist",reload:!0,onAdd(t){t.name=t.display.toLowerCase(),t.id=t.name.hashCode().toString();const s=e.filter((e=>!t.tracks.includes(e.id)));for(const e of s)e.filename=e.file.name,e.size=e.file.size,delete e.file;t.tracks=s,app.add("playlist",t,"new")}};t.info={tracks:e},app.openEditor("add","new","playlist",t)}));class Rm extends UX.Page{#$n;get type(){return this.#$n}get area(){return this.container}get showFilter(){return!0}get filter(){}set filter(e){}constructor(e,t){super(t),this.#$n=e}onDragStart(){}getIconId(){}static registerOptions(e,t){AddEditor.register(e,t.items)}}const $m={clearSelection(){const e=document.querySelector("#sidebar .list2");UX.List.clearSelection(e)},add(e,t=!1){"string"==typeof e?e={id:e}:e.id||(e.id=e.name);return this.addTemplate(this.template_,e,t)},getDataType(){return this.opt.dataType},onAdd(){}};Object.assign(Rm.prototype,UX.ListMixin,$m);class zm extends Rm{static id="contact";#fi;#kt;get title(){return"chat"}get filter(){return this.#kt}set filter(e){this.#kt=e}get showImport(){return!(!app.user.google||!app.user.google.contact)&&{title:"Import Gmail contacts",cmd:"import-gmail-contacts"}}constructor(e="sidebar-contact"){super(zm.id,e),app.on("chatmsg",(e=>this.#ft(e.detail))),app.on("contactadd",(e=>this.add("contact",e.detail))),app.on("roomadd",(e=>this.add("room",e.detail))),app.on("useradd",(e=>this.add("user",e.detail))),app.on("status",(e=>this.#zn(e.detail))),app.on("hangup",(e=>this.#Bn(e.detail)))}reload(){}async load(e){await this.loadContacts(),await this.loadRooms();const t=this.addGroup({name:"user",title:"Users",visible:100,badge:!0,hide:!0,item:"sidebar-user-item",cmd:"open-user-contact"});this.#fi=t}async loadContacts(){const e=app.ds("contact"),t=this.addGroup({title:"friends",name:"contact",visible:8,badge:!0,draggable:!0,item:"sidebar-contact-item",cmd:"open-contact-contact",actions:[{name:"add",icon:"add",cmd:"find-contact"}]}),s=(await e.ls()).filter((e=>!e.remote)),i=app.recent.chat;s.sort(((e,t)=>{const s=i.findIndex((t=>t.user==e.id)),n=i.findIndex((e=>e.user==t.id));return s>-1&&(e.short=i[s].short),n>-1&&(t.short=i[n].short),(s>>>0)-(n>>>0)}));for(const e of s)app.isme(e.id)||(e.uri=e.uri||e.email,t.add(e));this.contacts=t}async loadRooms(){const e=this.addGroup({name:"room",visible:8,badge:!0,draggable:!0,cmd:"open-room-contact",item:"sidebar-room-item",actions:[{name:"add",icon:"add",cmd:"add-new-room"}]}),t=app.ds("room");await e.load(t,Bm),this.channels=e}add(e,t){switch(console.log("Sidebar (contact): adding",e,t),e){case"contact":{const e=t.id;this.contacts.getElement(e)||this.contacts.add(t,!0),this.#fi.delete(e)}break;case"room":{const e=t.id,s=`chat-${e}@ftalk.net`;console.log("SIDEBAR: adding room:",t);this.channels.getElement(e)||this.channels.add({...t,uri:s},!0)}break;case"user":{const e=Array.isArray(t)?t:[t];this.#fi.push(...e)}}}onClick(e,t,s){let i=t.querySelector("[data-count]");i&&(i.dataset.count=0),i=t.querySelector("[data-missed]"),i&&(i.dataset.missed=0)}async#ft(e){if("confirm"==e._type)return;const t=e.room?e.room.id:e.user.id,s=this.getElement(t);if(!s)return void(e.room?(e.id=e.room.id,e.display=e.room.name,this.channels.add(e,!0)):(this.#fi.add(e),console.error("Sidebar contact. URI not found:",t)));let i=e.shortHTML;if(e.room){const t=e.own?app.avatar:e.user.photo||app.defaultRoom;n=t,s.querySelector(".avatar").src=n}var n;!function(e,t,s,i=Date.seconds()){if(!s&&!e.hasAttribute("selected")){const t=e.querySelector("[data-count]"),s=parseInt(t.dataset.count);t.dataset.count=s+1}const n=e.querySelector("time");n.dataset.time=i,n.innerText=Date.secondsElapsed(i);const o=e.querySelector(".msg");o.innerHTML=t}(s,i,e.own,e.ts),dom.moveTop(s),dom.highlightElement(s)}#zn(e){const t=this.contacts.getItem(e.id);t&&(dom.updateValues(t,e),dom.highlightElement(t))}#Bn({user:e,missed:t}){if(!t)return;const s=[this.contacts,this.#fi];let i;for(const t of s)if(i=t.getItem(e),i){if(!i.hasAttribute("selected")){const e=i.querySelector("[data-missed]"),t=parseInt(e.dataset.missed);e.dataset.missed=t+1}break}}static defaultSettings(){return{contact:{visible:10,order:[]}}}}function Bm(e,t){var s=e.name,i=t.name;return s<i?-1:s>i?1:0}const Nm=zm;class Fm extends Rm{static id="game";#Nn;#Fn;#Zt;get showAdd(){return!0}get showSearch(){return!0}constructor(e="sidebar-game"){super(Fm.id,e),app.on("gameadd",(e=>this.#Nn.add(e.detail,!0))),app.on("gamemsg",(e=>this.#ft(e.detail))),app.on("gameover",(e=>this.#qn(e.detail)))}async load(e){const t={name:"invites",visible:100,badge:!0,item:"sidebar-game-invite-item",hide:!0,cmd:"game-open-user"},s=this.addGroup(t);t.name="active";const i=this.addGroup(t),n=app.ds("games"),o=await n.ls();o.sortTimestamp();for(const e of o)e.invite?s.add(e):e.state&&!e.own&&i.add(e);return this.#Fn=s,this.#Zt=i,this.#He()}async#He(){console.log("SB: load games");const e={visible:100,badge:!0,item:"sidebar-base-item",cmd:"open-home-game"},t={add:"game-invite-user"},s={board:[{id:"backgammon"}]};for(const[i,n]of Object.entries(s)){e.name=i;const s=this.addGroup(e);for(let{id:e,icon:i}of n)i||(i=e),s.add({id:e,icon:i,...t})}}async#Un(e=app.uid){const t=this.addGroup({name:"own",badge:!0,hide:!0,item:"sidebar-base-item",cmd:"edit-own-game"}),s=app.ds("game"),i=await s.ls();for(const s of i)(app.sudo||e==s.user)&&t.add(s);this.#Nn=t}#ft(e){const t=e.id;let s=this.#Fn.getItem(t);e.own?(dom.removeElement(s),s=this.#Zt.getItem(t),s&&dom.removeElement(s)):e.invite?s||this.#Fn.add(e,!0):(s=this.#Zt.add(e,!0),dom.highlightElement(s))}#qn({id:e}){const t=this.#Zt.getItem(e);dom.removeElement(t)}}class qm extends Rm{static id="player";#Hn;get icon(){return""}constructor(e="sidebar-player"){super(qm.id,e),app.on("playlistadd",(e=>this.#Wn(e.detail,!0))),app.on("playlistrm",(e=>this.#Vn(e.detail)))}load(e){return this.#Xn()}async#Xn(){this.#Gn(),this.#Yn();const e=this.addGroup({name:"playlist",icon:"playlist",visible:100,badge:!0,draggable:!0,hide:!0,cmd:"open-playlist-player",item:"sidebar-player-item-playlist"});this.#Hn=e;const t=app.ds("playlist"),s=await t.ls();for(const e of s)this.#Wn(e)}add(e,t){console.log("Sidebar (contact): adding",e,t)}#Gn(){const e=[{display:"Local files",id:"files",icon:"folder",cmd:"open-files-player"},{display:"Torrents",id:"torrent",icon:"torrent",cmd:"open-torrent-player"}];for(const t of e)this.addItemTemplate("sidebar-player-item",t)}async#Yn(){const e=this.addGroup({name:"radio",visible:5,badge:!1,draggable:!0,item:"sidebar-radio-item",cmd:"open-radio-player",actions:[{name:"add",icon:"add",cmd:"find-radio"}]}),t=app.ds("radio"),s=await t.ls();console.debug("Loading radios",s);for(const t of s)e.add(t)}#Wn(e,t=!1){t&&this.#Hn.getElement(e.id)||this.#Hn.add(e)}#Vn(e){this.#Hn.delete(e)}static defaultSettings(){return{playlist:{visible:10,order:[]}}}}const Um=qm;class Hm extends Rm{static id="help";static action={id:"wiki",icon:"wiki"};get title(){return"Support"}get showFilter(){return!1}constructor(e="sidebar-game"){super(Hm.id,e)}load(e){console.log("SB: load wiki"),this.addItemTemplate("sidebar-base-item",{icon:"fa-search",name:"Search",cmd:"open-search-wiki"}),this.addItemTemplate("sidebar-base-item",{icon:"tasks",name:"Task board",cmd:"open-task-support",add:"add-new-task"});const t={item:"sidebar-base-item",actions:[]};let s;t.name="help",t.cmd="open-start-wiki",s=this.addGroup(t),s.add({id:"wiki",icon:"fa-wikipedia-w"}),s.add({id:"contact",icon:"fa-user-friends"}),s.add({id:"about",icon:"fa-address-card"}),t.name="channel",t.visible=100,t.badge=!0,t.cmd="open-channel",s=this.addGroup(t),s.add({id:"support",icon:"support"})}}const Wm=class extends Rm{static id="admin";#oe;constructor(e="admin"){super("admin",e)}get showFilter(){return!1}reload(){console.log("ADMIN: reloading")}async load(e){const t=this.addGroup({name:"site",badge:!0,item:"sidebar-base-item",actions:[]});t.add({id:"user",icon:"fa-user",add:"invite-new-user",cmd:"open-user-admin"}),t.add({id:"room",icon:"fa-user-friends",add:"create-new-room",cmd:"open-room-admin"})}add(e){}update(){}onAction(e,t){if(console.debug("SB Admin on action:",e,t),"add"===e)this.#Kn(t)}async onClick(e){console.debug("Sidebar admin on click:",e)}#Kn(e){e}static defaultSettings(){return{admin:{visible:16}}}},Vm=Config.sip.room;class Xm extends ru{#Yi;get sipUri(){return`${this.#Yi.id}@${Config.sip.domain}`}get email(){return this.#Yi.email}get displayName(){return this.#Yi.name}get avatar(){return this.#Yi.photo||app.defaultAvatar}get photo(){return this.#Yi.photo}get status(){return this.#Yi.status||"No status"}get uid(){return this.#Yi.id}get sudo(){return this.#Yi.su}get user(){return this.#Yi}constructor(e){super(document.getElementById("app-page")),e&&(window.Config=e),this.task=new Tp}createDatabase(){return new vp}async setupDatabase(e){try{await Tp.setup(e);const t=await ajax.get("/api/game");t.length>0&&await e.put("game",t)}catch(e){console.error("Failed to setup databse",e)}}async load(e){console.log("APP: on load");const t=location.protocol.startsWith("https"),s=!!Config.firebase&&t;this.#Yi=e,this.initDataSource(),await super.load(),await this.loadRecent(),await this.task.init(),this.startLifecycle(),this.startMessenger(s),this.initGame(),await this.startGoogleAPI(),await this.startFirebase(),this.sudo&&document.body.setAttribute("su",""),this.openEditor("home")}initDataSource(){const e=new Gm("contact"),t=new fu(e,new hu("users")),s=new ku(t,(e=>!this.isme(e.id))),i=new wu("room");this.addDS(s),this.addDS(new Km,"email"),this.addDS(i),this.addDS(new vu(s,i),"share"),this.addDS(new mu("radio",new hu("radio"))),this.sudo&&(this.addDS(new yu(e,new uu("login")),"user"),this._.room=new yu(new lu("room"),new Zm)),this.addDS(new yu(new Jm("wiki"),new uu("wiki"))),this.initUserGames(),this.initUserPlayer()}async signOut(){console.debug("Signing out ..."),console.debug("Redirecting"),window.location.href="/logout"}async updateProfile(e){try{const t=this.ds("contact");await t.update(this.uid,e,this.#Yi),Object.assign(this.#Yi,e),app.publish()}catch(e){}}async add(e,t,s="import"){const i=app.ds(e);let n,o=!1;if("string"==typeof t){if(n=t,!(t=await i.get(n)))return void console.error("Failed to",s,e,n)}else n=t.id;try{if("import"===s){!0&&(t.remote=void 0,i.update(t,s))}else o=!0;let n=["update","edit"].includes(s);o&&i&&await i.put(t,n),console.log("APP: add",e,t),super.add(e,t,n)}catch(t){console.error("APP: failed to add =>",e,t)}return t.id}}Object.assign(Xm.prototype,Gu,Eu,zu,Nu,Qu.E,ip,dp),Xm.Editor.register(Hp),Xm.Sidebar.register(Nm),Xm.Sidebar.register(Fm),Xm.Sidebar.register(Um),Xm.Sidebar.register(class extends Rm{static id="account";constructor(e){super("account",e)}get showFilter(){return!1}load(e){let t,s;t={name:"info",icon:"fa-info-circle stroke",badge:!0,item:"sidebar-base-item",actions:[]},s=this.addGroup(t),s.add({id:"profile",icon:"fa-fw fa-xs profile wm6",cmd:"edit-profile"})}}),Xm.Sidebar.register(Hm),Xm.Sidebar.register(Wm);class Gm extends lu{put(e){e=Array.isArray(e)?e:[e];for(const t of e)t.data&&(Object.assign(t,t.data),delete t.data),t.type=t.type||"user",t.username=t.email.split("@")[0];return super.put(e)}update(e,t,...s){return"import"==t?(e.type="contact",super.update(e)):super.update(e,t,...s)}}class Ym extends hu{constructor(){super("users")}get(e){const t=e.isEmail()?{email:e}:e;return super.get(t)}}class Km extends fu{constructor(){super(new du("contact","email"),new Ym)}async get(e){const t=app.isme(e)?app.user:await super.get(e);return t&&t.data&&(Object.assign(t,t.data),delete t.data),t}}class Zm extends uu{constructor(){super("room")}async ls(...e){let t=await super.ls(...e);return this.#Zn(t)}async put(e){const t=await super.put(e);return{id:Qm(t.name),uid:t.id,name:t.display||eg(t.name)}}async search(...e){let t=await super.search(...e);return this.#Zn(t)}#Zn(e){return e.map((e=>({uid:e.id,id:"number"==typeof e.id?Qm(e.name):e.id,name:e.display||eg(e.name),topic:e.topic||"No topic",domain:e.domain||Config.sip.domain,members:e.members||[]})))}}class Jm extends lu{async put(e){const t=e.content;delete e.content,await super.put(e),await app.cache.update(this.name,e.id,t)}async get(e){const t=await super.get(e);return t&&!t.content&&(t.content=await app.cache.load(this.name,e)),t}}function Qm(e){return e.startsWith(Vm)?e.slice(Vm.length):e}function eg(e){return(e=Qm(e)).replaceAll("-"," ").capitalizeFirstLetter()}})();var __webpack_exports__App=__webpack_exports__.g;export{__webpack_exports__App as App};